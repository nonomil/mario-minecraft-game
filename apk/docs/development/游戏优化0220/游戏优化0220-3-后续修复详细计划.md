# 游戏优化0220-3 后续修复详细计划

## 1. 目标与范围
本计划覆盖以下需求：
- 词屋室内“桌子残影/叠图”移除。
- 词屋挑战触发稳定化（短按/长按/连续按都可触发，且支持靠近自动触发）。
- 村庄词屋挑战改为 10 题「英文词 -> 选中文义」，提供提示按钮，每题奖励 1 钻石。
- 商人房屋在门口范围内自动进入，并保证按键触发稳定。
- 档案按钮与排行榜联动：保存用户名和成绩，退出后本地持久化。
- 单词挑战弹窗字体/风格统一整理。

不在本轮范围：
- 新增远端云同步。
- 重构整个学习挑战引擎（仅做村庄挑战模式切换与样式统一）。

## 2. 当前实现与问题定位（代码级）

### 2.1 词屋桌子叠图残留
- 文件：`apk/src/modules/18-village.js`
- 位置：`renderVillageInterior()` 的 `buildingType === "word_house"` 分支前后。
- 现状：词屋分支仍绘制“桌面+桌腿”基底，再覆盖书本，导致可见半桌。
- 根因：旧室内标记图层未完全清除，书本层只做局部覆盖。

### 2.2 词屋挑战触发仍不稳定
- 文件：`apk/src/modules/18-village.js`
- 位置：`triggerVillageInteriorChestAction()`、`updateVillageInteriorMode()`、`triggerVillageInteriorAutoDoor()`。
- 现状：仅“宝箱键+近距”触发，且与自动门离开冷却共享，边界情况下体感像“长按才行”。
- 根因：
  - 触发入口单一（仅按键）。
  - 动作冷却与门口冷却耦合。
  - 缺少“靠近动作点自动触发”的兜底通道。

### 2.3 村庄挑战题型与题量不符
- 文件：`apk/src/modules/12-village-challenges.js`
- 现状：默认题量取 `challengeQuestionCount`（默认 3），题型为“补字母”。
- 根因：村庄挑战使用独立模块，不受通用 `12-challenges.js` 题型配置影响。

### 2.4 商人房屋自动进入缺失
- 文件：`apk/src/modules/18-village.js`
- 位置：`INTERIOR_BUILDING_TYPES`、`tryAutoEnterVillageInterior()`、`handleVillageInteraction()`。
- 现状：自动进入仅覆盖 `bed_house/word_house`，`trader_house` 必须手动交互。
- 根因：交易屋未接入自动进入规则与门口判定。

### 2.5 档案与排行榜保存链路
- 文件：`apk/src/modules/08-account.js`、`apk/src/modules/10-ui.js`、`apk/Game.html`
- 现状：
  - `saveCurrentProgress()` 已保存账号进度。
  - `saveToLeaderboard()` 已写本地排行榜。
  - 但档案弹窗缺少“一键保存并进入排行榜”的直达交互。
- 根因：功能有基础能力，但用户路径分散。

### 2.6 挑战弹窗风格不统一
- 文件：`apk/src/styles.css`、`apk/src/modules/12-village-challenges.js`
- 现状：通用挑战有样式系统，村庄挑战大量 inline style，字号与配色不统一。
- 根因：村庄挑战弹窗没有复用统一 CSS 变量与组件类。

## 3. 实施方案（分阶段）

## 阶段A：交互稳定与视觉修复（高优先级）
1. 词屋室内去桌子
- 在 `renderVillageInterior()` 中删除词屋桌面/桌腿绘制语句。
- 保留单词书图标与动作锚点。
- 验收：词屋仅显示书，不出现左右半桌。

2. 词屋挑战三种按法都可触发 + 靠近自动触发
- 保留按键触发：短按/长按/连续按都能触发同一动作（去重而非吞事件）。
- 新增自动触发：玩家进入动作点范围并停留 `250~350ms` 自动触发（仅一次，离开后重置）。
- 冷却拆分：
  - `doorCooldownUntil` 只管门。
  - `actionCooldownUntil` 只管床/词屋动作。
- 验收：
  - 不按键，靠近书本也会自动开题。
  - 短按一次可开题；长按不会误触发“退出房屋”。

3. 商人房屋自动进入
- 为 `trader_house` 增加门口判定和自动进入逻辑（与词屋一致的范围+抖动保护）。
- 进入后直接打开交易弹层，增加 reopen cooldown 防止反复弹开。
- 验收：在门口范围内可自动打开交易；按键短按/长按都能打开。

## 阶段B：村庄挑战玩法重构（高优先级）
1. 题量改为 10 题
- `DEFAULT_VILLAGE_CONFIG.challengeQuestionCount` 改为 10。
- 允许 `config/village.json` 覆盖。

2. 题型改为“英文 -> 选中文义”
- 在 `12-village-challenges.js` 重构 `showVillageQuestion()`：
  - 题干显示英文单词。
  - 选项为 4 个中文含义（1 正确 + 3 干扰）。
- 干扰项来自同群系词库，不足时跨词库补齐。

3. 提示按钮
- 每题显示“提示”按钮：点击后删除 2 个错误选项或高亮正确选项。
- 规则：提示只影响当题，不影响已答对题。

4. 每题奖励 1 钻石
- 每题答对立即 `inventory.diamond += 1` 并更新 UI。
- 结束页展示本局累计钻石。
- 与最终奖励规则去重，避免双倍发放冲突（保留可配置总奖励但默认只统计题目奖励）。

5. 验收
- 单局固定 10 题。
- 无补字母题。
- 每题答对立即 +1💎。
- 提示按钮可用，答对后不再需要提示。

## 阶段C：档案-排行榜链路与持久化（中优先级）
1. 档案弹窗新增“保存并查看排行榜”按钮
- 位置：`Game.html` 的 `profile-modal`。
- 行为：
  - 先执行 `saveCurrentProgress()`。
  - 使用当前用户名调用 `saveToLeaderboard()`（无名时回填账号名）。
  - 自动打开排行榜弹窗。

2. 退出游戏前保存
- 在“退出到登录/重开”路径上统一调用 `saveCurrentProgress()`。
- 排行榜继续使用本地 `MMWG_STORAGE` 持久化。

3. 验收
- 点击档案按钮后，可一键保存并进入排行榜。
- 退出游戏后再次进入，排行榜记录仍在。

## 阶段D：挑战弹窗样式统一（中优先级）
1. 样式系统化
- 在 `styles.css` 增加村庄挑战专用类：
  - `.village-challenge-modal`、`.village-challenge-question`、`.village-challenge-options` 等。
- 移除 `12-village-challenges.js` 内联字号与颜色，改用 class。

2. 字体层级统一
- 标题、题干、选项、提示、结果使用统一字号梯度（desktop/mobile clamp）。
- 中英混排统一行高与字重。

3. 验收
- 通用挑战与村庄挑战在字号、按钮、间距风格一致。
- 手机与桌面均无文字拥挤、遮挡、溢出。

## 4. 任务拆分与改动文件清单

核心代码：
- `apk/src/modules/18-village.js`
- `apk/src/modules/12-village-challenges.js`
- `apk/src/modules/16-events.js`（仅必要时微调触控触发）
- `apk/src/modules/10-ui.js`
- `apk/src/modules/08-account.js`
- `apk/src/styles.css`
- `apk/Game.html`
- `apk/config/village.json`（若需覆盖 10 题）

测试：
- 新增/更新 `apk/tests/e2e/specs/`：
  - `p0-village-wordhouse-trigger.spec.mjs`
  - `p0-village-trader-auto-enter.spec.mjs`
  - `p1-village-quiz-10q-zh-option.spec.mjs`
  - `p1-profile-leaderboard-persistence.spec.mjs`

## 5. 验收标准（可执行）
1. 词屋室内不出现桌子图形。
2. 词屋挑战可由短按/长按/连续按触发，且可近距自动触发。
3. 村庄挑战固定 10 题，题型为英文选中文；每题答对 +1💎。
4. 商人屋门口范围自动进入稳定，按键触发稳定。
5. 档案可一键保存并进入排行榜；重启后排行榜保留。
6. 挑战弹窗字号与风格统一，移动端可读性达标。

## 6. 风险与回滚策略
1. 风险：自动触发过于激进导致误触。
- 方案：增加最小停留时间 + 触发后离区重置。

2. 风险：奖励逻辑重复发放。
- 方案：集中在 `finishVillageChallenge()` 做一次性结算开关校验。

3. 风险：样式改动影响通用挑战。
- 方案：村庄挑战样式使用独立 class 命名空间，避免覆盖全局。

4. 回滚策略
- 每个阶段独立提交；若线上异常，可按阶段回滚提交。

## 7. 建议执行顺序
1. 阶段A（先修可用性痛点）
2. 阶段B（题型与奖励核心变更）
3. 阶段D（样式统一）
4. 阶段C（档案-排行榜联动收尾）

---
更新时间：2026-02-20
文档用途：0220-3 后续需求实施基线（面向开发与测试）
