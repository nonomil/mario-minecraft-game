# 游戏优化0219-下一步计划

日期: 2026-02-19  
对应报告: `apk/docs/development/游戏优化-0219/游戏优化0219-问题分析报告.md`

## 1. 目标与范围

本计划覆盖 4 条主线:

1. 修复村庄“触发可见性”问题（P0）。  
2. 修复村庄测验 `undefined` 与退出后卡死问题（P0）。  
3. 实现“单词 -> 对应短语”的可配置掉落策略（P1）。  
4. 完成幼儿园词库审查、CSV/文档化输出与分层清理（P1）。

## 1.1 当前状态快照（2026-02-19）

已完成:

1. 村庄渲染重复相机偏移修复，且 `apk` 与 root 双目录已同步。  
2. 村庄测验 `undefined` 与退出冻结问题修复。  
3. Playwright 回归通过（`6 passed / 0 failed`）:
   - `p0-render-path.spec.mjs`
   - `p2-biome-config.spec.mjs`
   - `p0-village-visibility.spec.mjs`
   - `p0-village-quiz-stability.spec.mjs`

待继续:

1. 阶段B：单词-短语联动掉落策略落地。  
2. 阶段C：幼儿园词库审查导出与清理。  
3. 阶段D：手工回归与发布准备。

## 2. 执行原则

- 先恢复玩家可见体验，再优化学习策略，再做数据治理。  
- 每个阶段都要有可回归的验收项，不做“代码改了但无验证”。  
- 配置优先，可参数化的行为尽量放配置而非硬编码。

## 3. 分阶段计划

## 阶段A: 村庄可见性修复（P0，已完成）

目标: 村庄触发后可稳定显示，且相机移动下位置正确。  
状态: 已完成并通过 E2E 回归验证。

任务:

1. 统一村庄渲染坐标体系（二选一，推荐方案 1）。  
2. 方案 1（推荐）: 保持 `draw()` 的 `ctx.translate(-cameraX,0)`，移除 `18-village-render.js` 内部所有 `-cameraX`。  
3. 方案 2: 将 `drawVillages()` 移到 `ctx.restore()` 之后，保留 `-cameraX` 写法（不推荐，改动面更大且易与其他对象层级冲突）。  
4. 清理与坐标相关的重复偏移点: 建筑、背景、装饰、NPC、横幅、床。  
5. 同步检查 `settings.villageFrequency` 是否接入生成间隔（若不接入，需在文档中明确废弃该设置）。  
6. 执行前校验 `apk/src/modules/18-village-render.js` 与 `src/modules/18-village-render.js` 一致性；`apk/scripts/sync-web.js` 仅负责 `apk -> out -> android-app/web`，不负责 root/apk 源码同步。

验收（已满足）:

- 分数到 500/1000/1500 时，村庄在屏幕内可见。  
- 入村提示、安全区清怪、村庄内刷词/宝箱仍正常。  
- 不出现“村庄闪现/瞬移/反向滚动”。

## 阶段B: 单词-短语联动掉落（P1，1~1.5 天）

目标: 满足“单词出现后，下一个或隔两个出现对应短语”的学习节奏需求。

任务:

1. 在掉落调度层新增“跟随队列”结构（Follow-up Queue），不直接改词库原始字段。  
2. 当掉落 `wordObj` 且其有 `phrase/phraseTranslation` 时，向队列压入一个“短语任务”。  
3. 新增可配置策略（建议写入设置与 UI）:
   - `direct`: 下一个就是对应短语（gap=1）
   - `gap2`: 隔两个普通词再出对应短语（gap=2）
   - `hybrid`: 按比例混合（例如 70% direct + 30% gap2）
4. 重复频率改造:
   - 保留当前 `INTERVALS` 的间隔思想；
   - 增加“短期重复保护窗口”（同一词/同一短语在 N 次掉落内不重复）；
   - 将“挑战对错反馈”与“普通收集反馈”都纳入词条质量更新。
5. 对 UI 兼容:
   - 黄圈文本长度超限时启用缩写/滚动（避免短语过长挤压画面）；
   - 词卡继续展示 `en + zh + phrase + phraseTranslation`。

验收:

- 在 `direct` 模式下，抽样 100 次掉落，“词后对应短语”命中率 >= 95%。  
- 在 `gap2` 模式下，短语平均间隔接近 2（允许小波动）。  
- `avoidWordRepeats` 开启时，不出现高频短期重复。

## 阶段C: 幼儿园词库审查与文档化（P1，1.5~2 天）

目标: 给出“可复核、可执行”的词库清理结果，并满足“导出到 docs”要求。

任务:

1. 跑现有词库工具链（已存在）:
   - `npm run vocab:db:import`
   - `npm run vocab:db:export`
   - `npm run vocab:db:validate`
   - `npm run vocab:db:dedup`
2. 在 `docs` 下新增审查产物目录（建议）:
   - `apk/docs/development/游戏优化-0219/data/`
3. 输出文档化清单（最少 3 份）:
   - `kindergarten-all.csv`（幼儿园可见词条全集）
   - `kindergarten-suspect-sentences.csv`（句子型/疑似超纲）
   - `kindergarten-encoding-suspects.csv`（音标/翻译疑似编码异常）
4. 清理策略（先规则、后改库）:
   - 幼儿园包默认只保留启蒙词和短短语；
   - 长句/战斗指令类词条迁回小学或 Minecraft 包；
   - 修复明显截断翻译与乱码音标。  
5. 调整默认词库选择:
   - 从 `vocab.kindergarten`（完整）切到更稳妥的 `vocab.kindergarten.basic`（或首启推荐 basic）。

验收:

- `docs` 中可直接查看审查清单。  
- 幼儿园包句子型词条占比显著下降。  
- 默认新用户不再直接进入“幼儿园完整包”。

## 阶段D: 回归与发布准备（0.5~1 天）

目标: 保证修复不引入明显回归。

任务:

1. 手工回归清单:
   - 村庄触发与交互（休息屋/学习屋/存档石碑）
   - 词条掉落与词卡展示
   - 挑战系统与发音
   - 词库切换与保存读档
2. E2E 基线（当前已具备）:
   - 村庄触发可见性检查（已完成）
   - 村庄测验稳定性检查（已完成）
   - 渲染路径与配置基线检查（已完成）
3. 后续补点:
   - 词后短语联动策略检查（阶段B完成后新增）
4. 更新开发文档与版本变更记录。

验收:

- 无阻断级 Bug。  
- 关键流程一次通过。  
- 文档与配置一致。

## 4. 优先级与里程碑

- M1（当日）: 村庄可见性修复完成并验收。  
- M2（+1 天）: 单词-短语联动策略可切换并稳定运行。  
- M3（+2~3 天）: 幼儿园词库审查结果与 docs 导出完成。  
- M4（+3~4 天）: 回归完成，可进入发布分支。

## 5. 风险与预案

- 风险: 村庄坐标修复后出现层级/遮挡问题。  
  预案: 保留单独开关快速回退到旧渲染分支对照。  
- 风险: 短语掉落导致黄圈文本过长影响可读性。  
  预案: 增加短语渲染裁剪与词卡承载。  
- 风险: 词库清理影响已有学习进度映射。  
  预案: 保持 `lemma_key` 稳定；迁移前导出映射表。

## 6. 下一批可执行动作

1. 提交阶段A/F/E的最小稳定变更集（代码+测试+文档）。  
2. 落地阶段B配置骨架（`direct/gap2/hybrid`）与默认值。  
3. 跑阶段C数据导出，把首版审查 CSV 放进 `docs/development/游戏优化-0219/data/`。  
4. 基于首版 CSV 与样例词条开评审，确定第一批下架/迁移词条列表。  
5. 阶段B落地后补充对应 E2E 用例并并入回归命令。
