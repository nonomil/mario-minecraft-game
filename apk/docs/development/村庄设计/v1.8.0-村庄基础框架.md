# v1.8.0 â€” æ‘åº„åŸºç¡€æ¡†æ¶ + åŒºåŸŸç”Ÿæˆ + å»ºç­‘æ¸²æŸ“

> ç±»å‹ï¼šMINOR | versionName: 1.8.0 | versionCode: 59

## ä¸€ã€æœ¬ç‰ˆæœ¬ç›®æ ‡

å»ºç«‹æ‘åº„ç³»ç»Ÿçš„å®Œæ•´æ•°æ®åŸºç¡€ï¼Œå®ç°åŒºåŸŸç”Ÿæˆå’Œå»ºç­‘å¯è§†åŒ–ã€‚ç©å®¶åœ¨åˆ†æ•°è¾¾åˆ° 500 æ—¶èƒ½çœ‹åˆ°ç¬¬ä¸€ä¸ªæ‘åº„ï¼ˆå«å»ºç­‘ã€è£…é¥°ç‰©ã€åœ°é¢æ ‡è®°ï¼‰ã€‚

## äºŒã€æ–°å¢æ–‡ä»¶

### 2.1 `config/village.json`

æ‘åº„å…¨å±€é…ç½®æ–‡ä»¶ï¼š

```json
{
  "enabled": true,
  "spawnScoreInterval": 500,
  "villageWidth": 800,
  "safeZone": true,
  "restHealFull": true,
  "challengeQuestionCount": 3,
  "challengeReward": {
    "perfect": { "score": 100, "diamonds": 1 },
    "partial": { "score": 50, "diamonds": 0 }
  },
  "npcSpeed": 0.3,
  "npcGreetDistance": 80,
  "maxActiveVillages": 3,
  "buildings": {
    "bed_house": { "w": 80, "h": 60, "offset": 100 },
    "word_house": { "w": 100, "h": 80, "offset": 300 },
    "save_stone": { "w": 40, "h": 50, "offset": 550 },
    "special": { "w": 80, "h": 60, "offset": 700 }
  },
  "biomeWords": {
    "forest": ["tree", "leaf", "bird", "flower", "grass", "wood", "deer", "owl"],
    "snow": ["snow", "ice", "cold", "coat", "hat", "scarf", "ski", "sled"],
    "desert": ["sand", "sun", "hot", "water", "cactus", "camel", "oasis", "dry"],
    "mountain": ["rock", "iron", "gold", "pick", "cave", "stone", "gem", "ore"],
    "ocean": ["fish", "wave", "boat", "shell", "whale", "coral", "swim", "sea"],
    "nether": ["fire", "red", "lava", "dark", "flame", "ash", "smoke", "glow"]
  }
}
```

### 2.2 `src/modules/18-village.js`

æ‘åº„æ ¸å¿ƒé€»è¾‘æ¨¡å—ï¼Œæœ¬ç‰ˆæœ¬å®ç°ä»¥ä¸‹å‡½æ•°ï¼š

```javascript
/**
 * 18-village.js - æ‘åº„ç³»ç»Ÿæ ¸å¿ƒé€»è¾‘
 */

// ========== æ‘åº„é£æ ¼å®šä¹‰ ==========
const VILLAGE_STYLES = {
  forest: {
    buildingColors: { wall: '#8B6914', roof: '#2E7D32', door: '#5D4037' },
    groundColor: '#6D4C41',
    decorations: ['well', 'farm', 'fence', 'flower_pot'],
    specialBuilding: 'library'
  },
  snow: {
    buildingColors: { wall: '#ECEFF1', roof: '#1565C0', door: '#37474F' },
    groundColor: '#B0BEC5',
    decorations: ['snowman', 'ice_lamp', 'pine_fence'],
    specialBuilding: 'hot_spring'
  },
  desert: {
    buildingColors: { wall: '#D7CCC8', roof: '#FF8F00', door: '#4E342E' },
    groundColor: '#BCAAA4',
    decorations: ['cactus_pot', 'sand_lamp', 'oasis'],
    specialBuilding: 'water_station'
  },
  mountain: {
    buildingColors: { wall: '#78909C', roof: '#455A64', door: '#37474F' },
    groundColor: '#607D8B',
    decorations: ['anvil', 'stone_lamp', 'mine_cart'],
    specialBuilding: 'blacksmith'
  },
  ocean: {
    buildingColors: { wall: '#4FC3F7', roof: '#0277BD', door: '#01579B' },
    groundColor: '#4DB6AC',
    decorations: ['anchor', 'barrel', 'fishing_rod'],
    specialBuilding: 'lighthouse'
  },
  nether: {
    buildingColors: { wall: '#4A148C', roof: '#880E4F', door: '#311B92' },
    groundColor: '#6A1B9A',
    decorations: ['soul_lantern', 'nether_wart_pot', 'chain'],
    specialBuilding: 'brewing_stand'
  }
};

// ========== åŠ è½½é…ç½® ==========
function loadVillageConfig() {
  // ä» config/village.json åŠ è½½ï¼Œå¤±è´¥æ—¶ç”¨é»˜è®¤å€¼
  // åœ¨ 17-bootstrap.js çš„ loadAllConfigs() ä¸­è°ƒç”¨
}

// ========== æ‘åº„ç”Ÿæˆ ==========
function maybeSpawnVillage(playerScore, playerX) {
  if (!settings.villageEnabled || !villageConfig.enabled) return;
  const interval = villageConfig.spawnScoreInterval || 500;
  // è®¡ç®—å½“å‰åˆ†æ•°åº”è¯¥ç”Ÿæˆçš„æ‘åº„ç¼–å·
  const villageIndex = Math.floor(playerScore / interval);
  if (villageIndex < 1) return; // 0åˆ†ä¸ç”Ÿæˆ
  if (villageSpawnedForScore[villageIndex]) return; // å·²ç”Ÿæˆ

  const biomeId = currentBiome || 'forest';
  const village = createVillage(playerX + 600, biomeId, villageIndex);
  activeVillages.push(village);
  villageSpawnedForScore[villageIndex] = true;

  // å›æ”¶è¿œç¦»çš„æ‘åº„
  cleanupVillages(playerX);
  console.log(`[Village] ç”Ÿæˆæ‘åº„ #${villageIndex} at x=${village.x}, biome=${biomeId}`);
}

function createVillage(startX, biomeId, index) {
  const style = VILLAGE_STYLES[biomeId] || VILLAGE_STYLES.forest;
  const cfg = villageConfig.buildings || {};
  return {
    id: index,
    x: startX,
    width: villageConfig.villageWidth || 800,
    biomeId: biomeId,
    style: style,
    buildings: [
      { type: 'bed_house',  x: startX + (cfg.bed_house?.offset || 100),  w: cfg.bed_house?.w || 80,  h: cfg.bed_house?.h || 60 },
      { type: 'word_house', x: startX + (cfg.word_house?.offset || 300), w: cfg.word_house?.w || 100, h: cfg.word_house?.h || 80 },
      { type: 'save_stone', x: startX + (cfg.save_stone?.offset || 550), w: cfg.save_stone?.w || 40,  h: cfg.save_stone?.h || 50 },
      { type: style.specialBuilding, x: startX + (cfg.special?.offset || 700), w: cfg.special?.w || 80, h: cfg.special?.h || 60 }
    ],
    npcs: [],       // v1.8.1 å®ç°
    decorations: style.decorations.map((d, i) => ({
      type: d, x: startX + 50 + i * 150
    })),
    visited: false,
    restUsed: false,
    questCompleted: false,
    saved: false
  };
}

function cleanupVillages(playerX) {
  const max = villageConfig.maxActiveVillages || 3;
  // ç§»é™¤ç©å®¶èº«åè¶…è¿‡ 2000px çš„æ‘åº„
  activeVillages = activeVillages.filter(v => {
    return (v.x + v.width) > playerX - 2000;
  });
  // å¦‚æœä»è¶…è¿‡ä¸Šé™ï¼Œç§»é™¤æœ€è¿œçš„
  while (activeVillages.length > max) {
    activeVillages.shift();
  }
}

// ========== æ‘åº„çŠ¶æ€æ›´æ–° ==========
function updateVillages() {
  if (!settings.villageEnabled) return;
  // æ£€æŸ¥æ˜¯å¦éœ€è¦ç”Ÿæˆæ–°æ‘åº„
  maybeSpawnVillage(score, player.x);
  // æ£€æµ‹ç©å®¶æ˜¯å¦åœ¨æ‘åº„å†…
  const wasInVillage = playerInVillage;
  playerInVillage = false;
  currentVillage = null;
  for (const v of activeVillages) {
    if (player.x >= v.x && player.x <= v.x + v.width) {
      playerInVillage = true;
      currentVillage = v;
      if (!v.visited) {
        v.visited = true;
        const biomeName = getBiomeById(v.biomeId)?.name || v.biomeId;
        showToast(`ğŸ˜ï¸ è¿›å…¥${biomeName}æ‘åº„`);
      }
      break;
    }
  }
  if (wasInVillage && !playerInVillage) {
    showToast('ğŸ‘‹ ç¦»å¼€æ‘åº„');
  }
}

// ========== è¾…åŠ©å‡½æ•° ==========
function isInVillageArea(x) {
  for (const v of activeVillages) {
    if (x >= v.x && x <= v.x + v.width) return true;
  }
  return false;
}

function getVillageAt(x) {
  for (const v of activeVillages) {
    if (x >= v.x && x <= v.x + v.width) return v;
  }
  return null;
}
```

### 2.3 `src/modules/18-village-render.js`

æ‘åº„æ¸²æŸ“æ¨¡å—ï¼š

```javascript
/**
 * 18-village-render.js - æ‘åº„æ¸²æŸ“
 */

function drawVillages(ctx) {
  if (!settings.villageEnabled) return;
  for (const village of activeVillages) {
    // è§†å£è£å‰ªï¼šåªæ¸²æŸ“å¯è§çš„æ‘åº„
    if (village.x + village.width < cameraX - 100) continue;
    if (village.x > cameraX + canvas.width + 100) continue;
    drawVillageGround(ctx, village);
    drawVillageDecorations(ctx, village);
    for (const b of village.buildings) {
      drawVillageBuilding(ctx, b, village.style);
    }
  }
}

function drawVillageGround(ctx, village) {
  const sx = village.x - cameraX;
  const w = village.width;
  // æ‘åº„åœ°é¢ï¼ˆçŸ³ç –è·¯ï¼‰
  ctx.fillStyle = village.style.groundColor || '#6D4C41';
  ctx.fillRect(sx, groundY, w, 6);
  // çŸ³ç –çº¹ç†
  ctx.strokeStyle = 'rgba(0,0,0,0.2)';
  ctx.lineWidth = 1;
  for (let i = 0; i < w; i += 20) {
    ctx.strokeRect(sx + i, groundY, 20, 6);
  }
  // æ‘åº„å…¥å£æ ‡è®°
  ctx.fillStyle = 'rgba(255,255,255,0.15)';
  ctx.fillRect(sx, groundY - 300, 4, 300);
  ctx.fillRect(sx + w - 4, groundY - 300, 4, 300);
}

function drawVillageBuilding(ctx, building, style) {
  const sx = building.x - cameraX;
  const sy = groundY - building.h;
  const colors = style.buildingColors;

  // å¢™ä½“
  ctx.fillStyle = colors.wall;
  ctx.fillRect(sx, sy, building.w, building.h);
  // å¢™ä½“çº¹ç†çº¿
  ctx.strokeStyle = 'rgba(0,0,0,0.15)';
  ctx.lineWidth = 1;
  for (let row = 0; row < building.h; row += 10) {
    ctx.beginPath();
    ctx.moveTo(sx, sy + row);
    ctx.lineTo(sx + building.w, sy + row);
    ctx.stroke();
  }

  // å±‹é¡¶ï¼ˆä¸‰è§’å½¢ï¼‰
  ctx.fillStyle = colors.roof;
  ctx.beginPath();
  ctx.moveTo(sx - 8, sy);
  ctx.lineTo(sx + building.w / 2, sy - 25);
  ctx.lineTo(sx + building.w + 8, sy);
  ctx.closePath();
  ctx.fill();

  // é—¨
  ctx.fillStyle = colors.door;
  const doorW = 16, doorH = Math.min(30, building.h - 5);
  ctx.fillRect(sx + building.w / 2 - doorW / 2, sy + building.h - doorH, doorW, doorH);

  // çª—æˆ·ï¼ˆå‘å…‰ï¼‰
  if (building.w >= 60) {
    ctx.fillStyle = '#FFEB3B';
    ctx.globalAlpha = 0.8;
    ctx.fillRect(sx + 8, sy + 8, 12, 12);
    if (building.w >= 80) {
      ctx.fillRect(sx + building.w - 20, sy + 8, 12, 12);
    }
    ctx.globalAlpha = 1.0;
  }

  // å»ºç­‘æ ‡è¯†å›¾æ ‡
  const icons = {
    bed_house: 'ğŸ›ï¸', word_house: 'ğŸ“š', save_stone: 'ğŸ’¾',
    library: 'ğŸ“–', hot_spring: 'â™¨ï¸', water_station: 'ğŸ’§',
    blacksmith: 'âš’ï¸', lighthouse: 'ğŸ—¼', brewing_stand: 'âš—ï¸'
  };
  const icon = icons[building.type] || 'ğŸ ';
  ctx.font = `${16 * worldScale.x}px serif`;
  ctx.textAlign = 'center';
  ctx.fillText(icon, sx + building.w / 2, sy - 30);
  ctx.textAlign = 'left';
}

function drawVillageDecorations(ctx, village) {
  for (const deco of village.decorations) {
    const sx = deco.x - cameraX;
    const sy = groundY;
    // ç®€å•åƒç´ è£…é¥°
    switch (deco.type) {
      case 'well':
        ctx.fillStyle = '#78909C';
        ctx.fillRect(sx, sy - 20, 20, 20);
        ctx.fillStyle = '#42A5F5';
        ctx.fillRect(sx + 3, sy - 17, 14, 10);
        break;
      case 'farm':
        ctx.fillStyle = '#5D4037';
        ctx.fillRect(sx, sy - 4, 30, 4);
        ctx.fillStyle = '#66BB6A';
        for (let i = 0; i < 5; i++) ctx.fillRect(sx + 2 + i * 6, sy - 12, 4, 8);
        break;
      case 'fence':
        ctx.fillStyle = '#8D6E63';
        for (let i = 0; i < 3; i++) {
          ctx.fillRect(sx + i * 12, sy - 18, 3, 18);
        }
        ctx.fillRect(sx, sy - 14, 26, 3);
        ctx.fillRect(sx, sy - 6, 26, 3);
        break;
      default:
        // é€šç”¨è£…é¥°ï¼šå°æ–¹å— + æ ‡ç­¾
        ctx.fillStyle = '#9E9E9E';
        ctx.fillRect(sx, sy - 12, 12, 12);
        ctx.fillStyle = '#FFF';
        ctx.font = '8px monospace';
        ctx.fillText(deco.type.charAt(0).toUpperCase(), sx + 2, sy - 3);
        break;
    }
  }
}
```

## ä¸‰ã€ä¿®æ”¹ç°æœ‰æ–‡ä»¶

### 3.1 `src/modules/01-config.js`

åœ¨å…¨å±€å˜é‡åŒºåŸŸæ–°å¢ï¼š

```javascript
// ===== æ‘åº„ç³»ç»Ÿ =====
let villageConfig = {};
let activeVillages = [];
let villageSpawnedForScore = {};
let playerInVillage = false;
let currentVillage = null;
```

### 3.2 `src/defaults.js`

åœ¨ `MMWG_DEFAULTS.settings` å¯¹è±¡ä¸­æ–°å¢ï¼š

```javascript
villageEnabled: true,
```

### 3.3 `src/modules/11-game-init.js`

åœ¨æ•Œäººç”Ÿæˆå‡½æ•°ï¼ˆ`spawnEnemyByDifficulty` æˆ–ç±»ä¼¼å‡½æ•°ï¼‰ä¸­ï¼Œç”Ÿæˆå‰æ£€æŸ¥ï¼š

```javascript
// åœ¨æ•Œäººç”Ÿæˆä½ç½®æ£€æŸ¥å‰åŠ å…¥
if (isInVillageArea(spawnX)) return; // æ‘åº„å®‰å…¨åŒºä¸åˆ·æ€ª
```

### 3.4 `src/modules/13-game-loop.js`

åœ¨ `update()` å‡½æ•°ä¸­ï¼Œ`updateCurrentBiome()` ä¹‹ååŠ å…¥ï¼š

```javascript
updateVillages();
```

### 3.5 `src/modules/14-renderer-main.js`

åœ¨ `draw()` å‡½æ•°ä¸­ï¼Œç»˜åˆ¶ enemies ä¹‹å‰åŠ å…¥ï¼š

```javascript
drawVillages(ctx);
```

### 3.6 `Game.html`

åœ¨ `<script src="src/modules/17-bootstrap.js">` ä¹‹å‰åŠ å…¥ï¼š

```html
<script src="src/modules/18-village.js"></script>
<script src="src/modules/18-village-render.js"></script>
```

åœ¨ `17-bootstrap.js` çš„é…ç½®åŠ è½½æµç¨‹ä¸­ï¼ŒåŠ å…¥ `village.json` çš„ fetchï¼š

```javascript
// åœ¨ loadAllConfigs() ä¸­æ–°å¢
fetch('config/village.json')
  .then(r => r.json())
  .then(data => { villageConfig = data; })
  .catch(() => { console.warn('[Village] ä½¿ç”¨é»˜è®¤é…ç½®'); });
```

## å››ã€éªŒè¯æ¸…å•

- [ ] æ¸¸æˆæ­£å¸¸å¯åŠ¨ï¼Œæ— æŠ¥é”™
- [ ] åˆ†æ•°è¾¾åˆ° 500 æ—¶ï¼Œæ§åˆ¶å°è¾“å‡º `[Village] ç”Ÿæˆæ‘åº„ #1`
- [ ] å±å¹•ä¸Šå‡ºç°åƒç´ é£æ ¼å»ºç­‘ç¾¤ï¼ˆ4 æ ‹å»ºç­‘ + è£…é¥°ç‰©ï¼‰
- [ ] å»ºç­‘é£æ ¼ä¸å½“å‰ biome åŒ¹é…ï¼ˆæ£®æ—=æ©¡æœ¨è‰²ã€é›ªåœ°=ç™½è‰²ç­‰ï¼‰
- [ ] æ‘åº„åŒºåŸŸå†…ä¸åˆ·æ€ª
- [ ] è¿›å…¥æ‘åº„æ˜¾ç¤º Toast "ğŸ˜ï¸ è¿›å…¥XXæ‘åº„"
- [ ] ç¦»å¼€æ‘åº„æ˜¾ç¤º Toast "ğŸ‘‹ ç¦»å¼€æ‘åº„"
- [ ] åˆ†æ•°è¾¾åˆ° 1000 æ—¶ç”Ÿæˆç¬¬äºŒä¸ªæ‘åº„
- [ ] è¿œç¦»çš„æ‘åº„è¢«è‡ªåŠ¨å›æ”¶ï¼ˆæœ€å¤šä¿ç•™ 3 ä¸ªï¼‰
- [ ] ç§»åŠ¨ç«¯æ­£å¸¸æ˜¾ç¤ºï¼Œæ— å¡é¡¿

## äº”ã€ç‰ˆæœ¬æ›´æ–°æ“ä½œ

### 5.1 æ›´æ–°ç‰ˆæœ¬å·

**`package.json`**ï¼ˆæ ¹ç›®å½•ï¼‰ï¼š
```
"version": "1.8.0"
```

**`android-app/package.json`**ï¼š
```
"version": "1.8.0"
```

**`android-app/android/app/build.gradle`**ï¼š
```
versionCode 59
versionName "1.8.0"
```

### 5.2 æ›´æ–° Progress.md

åœ¨ `docs/version/Progress.md` æ–‡ä»¶**é¡¶éƒ¨**æ’å…¥ï¼š

```markdown
## v1.8.0ï¼ˆå‘å¸ƒæ—¥æœŸï¼š2026-02-XXï¼‰
- ç±»å‹ï¼šMINOR
- APK ç‰ˆæœ¬ï¼šversionName = 1.8.0ï¼ŒversionCode = 59
- ä¸»è¦å˜æ›´
  - æ–°å¢ï¼šæ‘åº„ç³»ç»Ÿ - åŸºç¡€æ¡†æ¶ä¸åŒºåŸŸç”Ÿæˆ
  - åˆ†æ•°é©±åŠ¨æ‘åº„ç”Ÿæˆï¼ˆæ¯ 500 åˆ†å‡ºç°ä¸€ä¸ªæ‘åº„ï¼‰
  - 6 ç§ç¾¤ç³»é£æ ¼æ‘åº„ï¼ˆæ£®æ—/é›ªåœ°/æ²™æ¼ /å±±åœ°/æµ·æ´‹/åœ°ç‹±ï¼‰
  - åƒç´ é£æ ¼å»ºç­‘æ¸²æŸ“ï¼ˆä¼‘æ¯å±‹ã€å•è¯å±‹ã€å­˜æ¡£çŸ³ç¢‘ã€ç‰¹è‰²å»ºç­‘ï¼‰
  - æ‘åº„è£…é¥°ç‰©æ¸²æŸ“ï¼ˆæ°´äº•ã€å†œç”°ã€æ …æ ç­‰ï¼‰
  - æ‘åº„å®‰å…¨åŒºï¼ˆåŒºåŸŸå†…ä¸åˆ·æ€ªï¼‰
  - è¿›å…¥/ç¦»å¼€æ‘åº„ Toast æç¤º
- æŠ€æœ¯æ”¹è¿›
  - æ–°å¢ config/village.json æ‘åº„é…ç½®æ–‡ä»¶
  - æ–°å¢ 18-village.js æ‘åº„æ ¸å¿ƒé€»è¾‘æ¨¡å—
  - æ–°å¢ 18-village-render.js æ‘åº„æ¸²æŸ“æ¨¡å—
  - 01-config.jsï¼šæ–°å¢æ‘åº„å…¨å±€å˜é‡
  - defaults.jsï¼šæ–°å¢ villageEnabled é…ç½®é¡¹
  - 11-game-init.jsï¼šæ•Œäººç”Ÿæˆè·³è¿‡æ‘åº„å®‰å…¨åŒº
  - 13-game-loop.jsï¼šupdate å¾ªç¯é›†æˆæ‘åº„æ›´æ–°
  - 14-renderer-main.jsï¼šæ¸²æŸ“å¾ªç¯é›†æˆæ‘åº„ç»˜åˆ¶
  - Game.htmlï¼šå¼•å…¥æ‘åº„æ¨¡å—è„šæœ¬
```

### 5.3 Git æäº¤

```bash
git add config/village.json src/modules/18-village.js src/modules/18-village-render.js
git add src/modules/01-config.js src/defaults.js src/modules/11-game-init.js
git add src/modules/13-game-loop.js src/modules/14-renderer-main.js Game.html
git add package.json android-app/package.json android-app/android/app/build.gradle
git add docs/version/Progress.md
git commit -m "feat(village): v1.8.0 æ‘åº„åŸºç¡€æ¡†æ¶+åŒºåŸŸç”Ÿæˆ+å»ºç­‘æ¸²æŸ“"
git push
```
