# Step 4: v1.4.0 - BOSSæˆ˜æ¡†æ¶ + å‡‹é›¶ï¼ˆç¬¬ä¸€ä¸ªBOSSï¼‰

## ç‰ˆæœ¬ä¿¡æ¯
- **ç‰ˆæœ¬å·**: 1.4.0
- **versionCode**: 41
- **ä¸»é¢˜**: æ­å»ºBOSSæˆ˜å®Œæ•´æ¡†æ¶ + å®ç°å‡‹é›¶BOSS
- **å‰ç½®ç‰ˆæœ¬**: v1.3.2

## ç›®æ ‡
1. æ­å»ºå¯å¤ç”¨çš„BOSSæˆ˜æ¡†æ¶ï¼ˆåœºæ™¯åˆ‡æ¢ã€è¡€æ¡UIã€é˜¶æ®µç³»ç»Ÿã€å¥–åŠ±ç»“ç®—ï¼‰
2. å®ç°ç¬¬ä¸€ä¸ªBOSSï¼šå‡‹é›¶ï¼ˆä¸‰é˜¶æ®µæˆ˜æ–—ï¼‰

## è¿™æ˜¯å…³é”®ç‰ˆæœ¬
v1.4.0 æ­å»ºçš„æ¡†æ¶ä¼šè¢«åç»­3ä¸ªBOSSå¤ç”¨ï¼Œéœ€è¦è®¾è®¡å¥½æ‰©å±•æ€§ã€‚

## ä¿®æ”¹æ¸…å•

### 1. æ–°å¢ `src/modules/15-entities-boss.js` - BOSSåŸºç±»

**åˆ›å»ºæ–°æ–‡ä»¶**ï¼Œå®šä¹‰BOSSæˆ˜çš„é€šç”¨æ¡†æ¶ï¼š

```javascript
// ============ BOSS æˆ˜æ–—ç³»ç»Ÿ ============

// BOSS åŸºç±»
class Boss {
    constructor(config) {
        this.name = config.name;
        this.maxHp = config.maxHp;
        this.hp = config.maxHp;
        this.x = config.x || canvas.width / 2;
        this.y = config.y || 100;
        this.width = config.width || 96;
        this.height = config.height || 96;
        this.color = config.color || '#333';
        this.phase = 1;           // å½“å‰é˜¶æ®µ
        this.phaseThresholds = config.phaseThresholds || [0.6, 0.2]; // é˜¶æ®µåˆ‡æ¢è¡€é‡ç™¾åˆ†æ¯”
        this.alive = true;
        this.projectiles = [];    // BOSSå‘å°„çš„å¼¹å¹•
        this.attackTimer = 0;
        this.stunTimer = 0;       // çœ©æ™•è®¡æ—¶
        this.flashTimer = 0;      // å—å‡»é—ªçƒ
        this.particles = [];      // ç²’å­ç‰¹æ•ˆ
    }

    update(dt) {
        if (!this.alive) return;
        this.updatePhase();
        this.updateProjectiles(dt);
        this.updateParticles(dt);
        if (this.stunTimer > 0) { this.stunTimer -= dt; return; }
        this.updateBehavior(dt); // å­ç±»å®ç°
    }

    updatePhase() {
        const hpPercent = this.hp / this.maxHp;
        if (this.phase === 1 && hpPercent <= this.phaseThresholds[0]) {
            this.phase = 2;
            this.onPhaseChange(2);
        } else if (this.phase === 2 && hpPercent <= this.phaseThresholds[1]) {
            this.phase = 3;
            this.onPhaseChange(3);
        }
    }

    takeDamage(amount) {
        if (this.stunTimer > 0) amount *= 1.5; // çœ©æ™•æ—¶å—ä¼¤åŠ æˆ
        this.hp -= amount;
        this.flashTimer = 10; // å—å‡»é—ªç™½
        if (this.hp <= 0) {
            this.hp = 0;
            this.die();
        }
    }

    die() {
        this.alive = false;
        // æ­»äº¡åŠ¨ç”»å’Œå¥–åŠ±ç”± BossArena å¤„ç†
    }

    // å­ç±»å¿…é¡»å®ç°
    updateBehavior(dt) {}
    onPhaseChange(newPhase) {}
    render(ctx) {}
}
```

### 2. æ–°å¢ BOSSæˆ˜åœºç®¡ç†å™¨

**åœ¨åŒä¸€æ–‡ä»¶ä¸­æ·»åŠ  `BossArena` ç±»**:

```javascript
// BOSS æˆ˜åœºç®¡ç†å™¨
class BossArena {
    constructor() {
        this.active = false;
        this.boss = null;
        this.arenaWidth = canvas.width;
        this.arenaHeight = canvas.height;
        this.platforms = [];       // æˆ˜åœºå¹³å°
        this.victoryTimer = 0;
        this.defeatTimer = 0;
    }

    // è¿›å…¥BOSSæˆ˜
    enter(bossType) {
        this.active = true;
        this.boss = this.createBoss(bossType);
        this.platforms = this.generatePlatforms();
        // ä¿å­˜å½“å‰æ¸¸æˆçŠ¶æ€
        this.savedGameState = { ... };
        // æ’­æ”¾BOSSæˆ˜BGM
        playBossMusic();
    }

    // é€€å‡ºBOSSæˆ˜
    exit() {
        this.active = false;
        this.boss = null;
        // æ¢å¤æ¸¸æˆçŠ¶æ€
        restoreBossMusic();
    }

    // åˆ›å»ºBOSSå®ä¾‹
    createBoss(type) {
        switch(type) {
            case 'wither': return new WitherBoss();
            case 'ghast': return new GhastBoss();     // v1.4.1
            case 'blaze': return new BlazeBoss();      // v1.4.2
            case 'wither_skeleton': return new WitherSkeletonBoss(); // v1.4.3
        }
    }

    // ç”Ÿæˆæˆ˜åœºå¹³å°ï¼ˆå°é—­ç©ºé—´ï¼‰
    generatePlatforms() {
        return [
            // åœ°é¢
            { x: 0, y: arenaHeight - 40, w: arenaWidth, h: 40 },
            // å·¦å¢™
            { x: 0, y: 0, w: 20, h: arenaHeight },
            // å³å¢™
            { x: arenaWidth - 20, y: 0, w: 20, h: arenaHeight },
            // ä¸­é—´å¹³å°ï¼ˆä¾›è·³è·ƒèº²é¿ï¼‰
            { x: arenaWidth * 0.2, y: arenaHeight * 0.55, w: 120, h: 20 },
            { x: arenaWidth * 0.6, y: arenaHeight * 0.4, w: 120, h: 20 },
        ];
    }

    update(dt) {
        if (!this.active) return;
        this.boss.update(dt);
        this.checkCollisions();

        // BOSSæ­»äº¡ â†’ èƒœåˆ©
        if (!this.boss.alive) {
            this.onVictory();
        }
    }

    // èƒœåˆ©å¤„ç†
    onVictory() {
        this.victoryTimer++;
        if (this.victoryTimer === 1) {
            // æ‰è½å¥–åŠ±
            this.dropRewards();
            showFloatingText('ğŸ† BOSS DEFEATED!', canvas.width/2, canvas.height/2, '#FFD700');
        }
        if (this.victoryTimer > 180) { // 3ç§’åé€€å‡º
            this.exit();
        }
    }

    // å¥–åŠ±æ‰è½
    dropRewards() {
        // å¤§é‡é‡‘å¸ï¼ˆæ™®é€šå…³å¡5å€ï¼‰
        gameState.score += gameState.scorePerCoin * 5 * 10;
        // å¿…å®šæ‰è½é’»çŸ³ç›”ç”²
        inventory['armor_diamond'] = (inventory['armor_diamond'] || 0) + 1;
        // å¿…å®šæ‰è½5ä¸ªé“å—
        inventory['iron'] = (inventory['iron'] || 0) + 5;
    }

    render(ctx) {
        if (!this.active) return;
        this.renderArenaBackground(ctx);
        this.renderPlatforms(ctx);
        this.boss.render(ctx);
        this.renderBossHpBar(ctx);
    }

    // æ¸²æŸ“BOSSè¡€æ¡ï¼ˆå±å¹•é¡¶éƒ¨ï¼‰
    renderBossHpBar(ctx) {
        const barWidth = canvas.width * 0.6;
        const barHeight = 16;
        const x = (canvas.width - barWidth) / 2;
        const y = 20;
        const hpPercent = this.boss.hp / this.boss.maxHp;

        // èƒŒæ™¯
        ctx.fillStyle = '#333';
        ctx.fillRect(x, y, barWidth, barHeight);
        // è¡€é‡
        const hpColor = hpPercent > 0.5 ? '#4CAF50' : hpPercent > 0.2 ? '#FF9800' : '#F44336';
        ctx.fillStyle = hpColor;
        ctx.fillRect(x, y, barWidth * hpPercent, barHeight);
        // è¾¹æ¡†
        ctx.strokeStyle = '#FFF';
        ctx.strokeRect(x, y, barWidth, barHeight);
        // BOSSåç§°
        ctx.fillStyle = '#FFF';
        ctx.font = 'bold 14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(this.boss.name, canvas.width / 2, y - 4);
    }
}
```

### 3. å®ç°å‡‹é›¶BOSSï¼ˆWitherBossï¼‰

```javascript
class WitherBoss extends Boss {
    constructor() {
        super({
            name: 'å‡‹é›¶ Wither',
            maxHp: 30,
            color: '#1A1A1A',
            width: 96,
            height: 96,
            phaseThresholds: [0.6, 0.2]
        });
        this.floatOffset = 0;     // æµ®åŠ¨åç§»
        this.moveDir = 1;         // ç§»åŠ¨æ–¹å‘
        this.moveSpeed = 1.5;
        this.chargeTarget = null;  // å†²åˆºç›®æ ‡ä½ç½®
        this.charging = false;
        this.chargeTimer = 0;
    }

    updateBehavior(dt) {
        // æµ®åŠ¨åŠ¨ç”»
        this.floatOffset = Math.sin(Date.now() / 500) * 10;

        switch(this.phase) {
            case 1: this.phaseOneBehavior(dt); break;
            case 2: this.phaseTwoBehavior(dt); break;
            case 3: this.phaseThreeBehavior(dt); break;
        }
    }

    // === é˜¶æ®µä¸€ï¼šè­¦æˆ’çŠ¶æ€ ===
    // ç¼“æ…¢æ¨ªå‘é£˜ç§»ï¼Œæ¯3ç§’å‘å°„1ä¸ªé»‘çƒ
    phaseOneBehavior(dt) {
        // æ¨ªå‘ç§»åŠ¨
        this.x += this.moveSpeed * this.moveDir;
        if (this.x <= 40 || this.x >= canvas.width - 40 - this.width) {
            this.moveDir *= -1;
        }

        // æ¯3ç§’å‘å°„é»‘çƒ
        this.attackTimer++;
        if (this.attackTimer >= 180) { // 3ç§’@60fps
            this.shootBlackBall(1); // å‘å°„1ä¸ª
            this.attackTimer = 0;
        }
    }

    // === é˜¶æ®µäºŒï¼šæš´æ€’çŠ¶æ€ ===
    // é€Ÿåº¦+50%ï¼Œæ¯2ç§’3ä¸ªæ‰‡å½¢é»‘çƒï¼Œæ¯8ç§’å†²åˆº
    phaseTwoBehavior(dt) {
        if (this.charging) {
            this.executeCharge(dt);
            return;
        }

        // å¿«é€Ÿç§»åŠ¨
        this.x += this.moveSpeed * 1.5 * this.moveDir;
        if (this.x <= 40 || this.x >= canvas.width - 40 - this.width) {
            this.moveDir *= -1;
        }

        // æ¯2ç§’å‘å°„3ä¸ªæ‰‡å½¢é»‘çƒ
        this.attackTimer++;
        if (this.attackTimer >= 120) {
            this.shootBlackBall(3); // æ‰‡å½¢3ä¸ª
            this.attackTimer = 0;
        }

        // æ¯8ç§’å†²åˆº
        this.chargeTimer++;
        if (this.chargeTimer >= 480) {
            this.startCharge();
            this.chargeTimer = 0;
        }
    }

    // === é˜¶æ®µä¸‰ï¼šæ¿’æ­»ç‹‚æš´ ===
    // å›ºå®šä¸­å¤®ï¼Œæ¯1ç§’5ä¸ªå…¨æ–¹ä½æ•£å°„è¿½è¸ªå¼¹ï¼Œé˜²å¾¡é™ä½
    phaseThreeBehavior(dt) {
        // ç§»å‘ä¸­å¤®
        const centerX = canvas.width / 2 - this.width / 2;
        this.x += (centerX - this.x) * 0.05;

        // ç–¯ç‹‚æŠ–åŠ¨
        this.x += (Math.random() - 0.5) * 4;
        this.y += (Math.random() - 0.5) * 2;

        // æ¯1ç§’5ä¸ªè¿½è¸ªå¼¹
        this.attackTimer++;
        if (this.attackTimer >= 60) {
            this.shootTrackingBalls(5);
            this.attackTimer = 0;
        }
    }

    // å‘å°„é»‘çƒ
    shootBlackBall(count) {
        const playerX = player.x + player.width / 2;
        const playerY = player.y + player.height / 2;
        const bossCenter = { x: this.x + this.width/2, y: this.y + this.height/2 };

        for (let i = 0; i < count; i++) {
            const angle = Math.atan2(playerY - bossCenter.y, playerX - bossCenter.x);
            const spread = count > 1 ? (i - (count-1)/2) * 0.3 : 0; // æ‰‡å½¢å±•å¼€
            this.projectiles.push({
                x: bossCenter.x, y: bossCenter.y,
                vx: Math.cos(angle + spread) * 4,
                vy: Math.sin(angle + spread) * 4,
                damage: this.phase >= 2 ? 2 : 1,
                size: 12,
                color: '#1A1A1A',
                tracking: false
            });
        }
    }

    // å‘å°„è¿½è¸ªå¼¹ï¼ˆé˜¶æ®µä¸‰ï¼‰
    shootTrackingBalls(count) {
        for (let i = 0; i < count; i++) {
            const angle = (Math.PI * 2 / count) * i;
            this.projectiles.push({
                x: this.x + this.width/2,
                y: this.y + this.height/2,
                vx: Math.cos(angle) * 3,
                vy: Math.sin(angle) * 3,
                damage: 1,
                size: 10,
                color: '#4A0080',
                tracking: true,
                trackDelay: 60 // 1ç§’åå¼€å§‹è¿½è¸ª
            });
        }
    }

    // å†²åˆºæ”»å‡»ï¼ˆé˜¶æ®µäºŒï¼‰
    startCharge() {
        this.charging = true;
        this.chargeTarget = { x: player.x, y: player.y };
        this.flashTimer = 30; // å‘çº¢å…‰é¢„è­¦
    }

    executeCharge(dt) {
        const dx = this.chargeTarget.x - this.x;
        const dy = this.chargeTarget.y - this.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if (dist < 10) {
            this.charging = false;
            this.stunTimer = 30; // å†²åˆºåç¡¬ç›´0.5ç§’
            return;
        }
        this.x += (dx / dist) * 8;
        this.y += (dy / dist) * 8;
    }

    onPhaseChange(newPhase) {
        if (newPhase === 2) {
            this.color = '#8B0000'; // æ·±çº¢è‰²
            // çˆ†å‘ç²’å­
        }
        if (newPhase === 3) {
            // å‡ºç°è£‚ç—•ï¼Œç²’å­çˆ†å‘
        }
    }

    render(ctx) {
        // å—å‡»é—ªç™½
        if (this.flashTimer > 0) {
            ctx.fillStyle = '#FFF';
            this.flashTimer--;
        } else {
            ctx.fillStyle = this.color;
        }

        const drawY = this.y + this.floatOffset;

        // èº«ä½“ï¼ˆ3æ ¼å®½Ã—3æ ¼é«˜çš„æ–¹å—ï¼‰
        ctx.fillRect(this.x, drawY, this.width, this.height);

        // ä¸‰ä¸ªå¤´ï¼ˆå‡‹é›¶ç‰¹å¾ï¼‰
        const headSize = 24;
        ctx.fillStyle = '#0D0D0D';
        ctx.fillRect(this.x + 8, drawY - headSize, headSize, headSize);
        ctx.fillRect(this.x + this.width/2 - headSize/2, drawY - headSize - 8, headSize, headSize);
        ctx.fillRect(this.x + this.width - headSize - 8, drawY - headSize, headSize, headSize);

        // çœ¼ç›ï¼ˆç™½è‰²ï¼‰
        ctx.fillStyle = '#FFF';
        [this.x + 14, this.x + this.width/2 - 4, this.x + this.width - 22].forEach(ex => {
            ctx.fillRect(ex, drawY - headSize + 6, 4, 4);
            ctx.fillRect(ex + 8, drawY - headSize + 6, 4, 4);
        });

        // é˜¶æ®µä¸‰è£‚ç—•
        if (this.phase === 3) {
            ctx.strokeStyle = '#FFF';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(this.x + 20, drawY + 10);
            ctx.lineTo(this.x + 50, drawY + 50);
            ctx.lineTo(this.x + 30, drawY + 80);
            ctx.stroke();
        }

        // æ¸²æŸ“å¼¹å¹•
        this.projectiles.forEach(p => {
            ctx.fillStyle = p.color;
            ctx.fillRect(p.x - p.size/2, p.y - p.size/2, p.size, p.size);
        });

        // ç´«è‰²ç²’å­
        this.particles.forEach(p => {
            ctx.globalAlpha = p.life;
            ctx.fillStyle = '#8B008B';
            ctx.fillRect(p.x, p.y, 3, 3);
        });
        ctx.globalAlpha = 1;
    }
}
```

### 4. ä¿®æ”¹ `src/modules/13-game-loop.js` - BOSSæˆ˜è§¦å‘

**åœ¨å…³å¡åˆ‡æ¢é€»è¾‘ä¸­æ·»åŠ BOSSæˆ˜è§¦å‘**:

```javascript
// æ¯5å…³è§¦å‘BOSSæˆ˜
function checkBossTrigger(currentLevel) {
    if (currentLevel % 5 === 0 && currentLevel > 0) {
        const bossIndex = currentLevel / 5;
        const bossTypes = ['wither', 'ghast', 'blaze', 'wither_skeleton'];
        if (bossIndex <= bossTypes.length) {
            bossArena.enter(bossTypes[bossIndex - 1]);
            return true;
        }
    }
    return false;
}

// åœ¨ä¸»å¾ªç¯ä¸­
function gameLoop() {
    if (bossArena.active) {
        bossArena.update(dt);
        bossArena.render(ctx);
        return; // BOSSæˆ˜æœŸé—´ä¸æ‰§è¡Œæ™®é€šå…³å¡é€»è¾‘
    }
    // ... æ™®é€šå…³å¡é€»è¾‘ ...
}
```

### 5. ä¿®æ”¹ `Game.html` - åŠ è½½æ–°æ¨¡å—

**åœ¨ script æ ‡ç­¾ä¸­æ·»åŠ  boss æ¨¡å—çš„åŠ è½½**:

```html
<script src="src/modules/15-entities-boss.js"></script>
```

æ³¨æ„åŠ è½½é¡ºåºï¼šåœ¨ `15-entities-combat.js` ä¹‹åï¼Œ`16-events.js` ä¹‹å‰ã€‚

## æµ‹è¯•è¦ç‚¹

1. æ­£å¸¸æ¸¸æˆåˆ°ç¬¬5å…³ â†’ è‡ªåŠ¨è¿›å…¥BOSSæˆ˜åœºæ™¯
2. åœºæ™¯ä¸ºå°é—­ç©ºé—´ï¼Œæœ‰å¢™å£å’Œå¹³å°
3. å‡‹é›¶å‡ºç°åœ¨ä¸Šæ–¹ï¼Œæœ‰æµ®åŠ¨åŠ¨ç”»
4. å±å¹•é¡¶éƒ¨æ˜¾ç¤ºBOSSåç§°å’Œè¡€æ¡
5. é˜¶æ®µä¸€ï¼šç¼“æ…¢ç§»åŠ¨ï¼Œæ¯3ç§’å‘å°„1ä¸ªé»‘çƒ
6. è¡€é‡é™åˆ°60% â†’ è¿›å…¥é˜¶æ®µäºŒï¼Œå˜çº¢ï¼Œæ”»å‡»åŠ é€Ÿ
7. é˜¶æ®µäºŒï¼šæ‰‡å½¢3ä¸ªé»‘çƒ + å†²åˆºæ”»å‡»ï¼ˆæœ‰çº¢å…‰é¢„è­¦ï¼‰
8. è¡€é‡é™åˆ°20% â†’ è¿›å…¥é˜¶æ®µä¸‰ï¼Œå›ºå®šä¸­å¤®ï¼Œè¿½è¸ªå¼¹
9. å‡»æ€BOSS â†’ æ˜¾ç¤º"BOSS DEFEATED!"ï¼Œæ‰è½å¥–åŠ±
10. 3ç§’åè‡ªåŠ¨è¿”å›æ™®é€šå…³å¡
11. ç©å®¶æ­»äº¡ â†’ æ¶ˆè€—1æ¡å‘½ï¼Œé‡æ–°å¼€å§‹BOSSæˆ˜
12. æ²¡å‘½äº† â†’ Game Over

## æäº¤ä¿¡æ¯

```
feat: BOSSæˆ˜æ¡†æ¶ + å‡‹é›¶BOSS (v1.4.0)

- æ–°å¢BOSSåŸºç±»å’Œæˆ˜åœºç®¡ç†å™¨
- å®ç°å‡‹é›¶BOSSä¸‰é˜¶æ®µæˆ˜æ–—
- é˜¶æ®µä¸€ï¼šé»‘çƒæ”»å‡»
- é˜¶æ®µäºŒï¼šæ‰‡å½¢å¼¹å¹•+å†²åˆº
- é˜¶æ®µä¸‰ï¼šè¿½è¸ªå¼¹ç‹‚æš´
- æ¯5å…³è‡ªåŠ¨è§¦å‘BOSSæˆ˜
- BOSSè¡€æ¡UIå’Œèƒœåˆ©å¥–åŠ±
```
