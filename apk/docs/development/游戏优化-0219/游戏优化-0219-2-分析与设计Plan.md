# 游戏优化-0219-2：代码分析与设计 Plan

日期：2026-02-19  
范围：`apk` 子项目，针对 `游戏优化-0219-2.md` 中的 6/7/8/9 项需求，先做方案设计，不直接改业务逻辑。

## 0. 需求拆解（来自 0219-2）

1. 每一关/每个群系结束时，以“凋零 Wither”作为小 BOSS，击败后才能进入下一关。  
2. 村庄房子可进入/可退出，房子内有床，躺下可恢复血量。  
3. 樱花丛林、海洋持续过长；地狱/暗之领域持续偏短，需重平衡。  
4. 黄色圆圈的“单词 -> 对应短语”要形成强化记忆链路，并设计重复频率。

---

## 1. 代码现状分析（按需求映射）

## 1.1 小 BOSS 关卡门禁（需求 6）

### 现状
- 群系切换已改为“分数驱动”，旧 `nextLevel()` 已废弃：`apk/src/modules/13-game-loop.js:588`。  
- 当前 BOSS 触发与群系无关，是固定分数阈值：
  - `bossScores: [2000, 4000, 6000, 8000]`：`apk/src/modules/15-entities-boss.js:144`
  - 每帧自动 `checkSpawn()`：`apk/src/modules/13-game-loop.js:319`
- 群系切换由 `getBiomeIdForScore()` + `canLeaveBiome()` 控制：
  - `apk/src/modules/06-biome.js:30`
  - `apk/src/modules/06-biome.js:142`

### 差距
- 目前没有“群系结束 -> 强制打 BOSS -> 才允许切到下一群系”的门禁状态机。  
- 现有 BOSS 事件与群系切换流程是并行的，无法作为“过关条件”。

---

## 1.2 村庄房屋进出 + 室内床恢复（需求 7）

### 现状
- 村庄建筑交互是“靠近后直接触发功能”，不是“进屋场景”：
  - `handleVillageInteraction()`：`apk/src/modules/18-village.js:414`
- `bed_house` 直接调用 `performRest()`：`apk/src/modules/18-village.js:421`
- 当前床是画在房子外面的装饰：`drawVillageBed(...building.x + building.w + 8...)`，`apk/src/modules/18-village-render.js:239`
- 交互入口在全局 `handleInteraction()`，村庄建筑优先：`apk/src/modules/13-game-loop.js:1162`

### 差距
- 没有室内状态、没有“进入/退出房屋”UI/输入模型。  
- 床恢复逻辑是“户外触发”，不符合“躺床恢复”的沉浸式需求。

---

## 1.3 群系停留时长不平衡（需求 8）

### 现状
- 群系顺序与最小停留时长由 `config/biomes.json` 控制：`apk/config/biomes.json:1`
- 当前 `minStay`（部分）
  - `cherry_grove: score 80 / time 12s`：`apk/config/biomes.json:34`
  - `ocean: score 200 / time 40s`：`apk/config/biomes.json:39`
  - `nether: score 360 / time 75s`：`apk/config/biomes.json:41`
  - `deep_dark: score 250 / time 45s`：`apk/config/biomes.json:42`
- 切换判定使用“双门槛”（分数+时间都满足）：`apk/src/modules/06-biome.js:148-150`

### 差距
- 当前参数和主观体验未对齐，缺少“可观测数据 -> 参数回调”的闭环。  
- 群系时长调优仅靠静态 JSON，缺少可视化调试/统计输出。

---

## 1.4 单词后跟短语 + 重复频率（需求 9）

### 现状（⚠️ 已有大量基础实现，非从零开始）
- 地图掉落词由 `pickWordForSpawn()` 生成：`apk/src/modules/11-game-init.js:307`
- 选词器有简化版间隔复现逻辑（`INTERVALS` + `updateWordQuality`）：`apk/src/modules/11-game-init.js:136`
- **已实现 follow-up 队列：**
  - `followUpQueue` 全局变量 + 入队/出队逻辑：`apk/src/modules/11-game-init.js:267-305`
  - `createFollowUpPhraseItem()` 创建短语跟随项，带 `__followUpPhrase` / `__sourceWordEn` / `__gapRemaining` 标记：`apk/src/modules/11-game-init.js:240-255`
  - `maybeEnqueueFollowUpPhrase()` 支持 `off / direct(gap=0) / gap2 / hybrid` 四种模式：`apk/src/modules/11-game-init.js:267-286`
  - `maybeTakeFollowUpPhrase()` 带 gap countdown 和 exclude 去重：`apk/src/modules/11-game-init.js:288-305`
  - `pickWordForSpawn()` 已集成 follow-up 优先出队：`apk/src/modules/11-game-init.js:307-320`
- **已有配置项（`defaults.js`）：**
  - `phraseFollowMode: “hybrid”`, `phraseFollowGapCount: 2`, `phraseFollowDirectRatio: 0.7`, `wordRepeatWindow: 6`
- **已有校验（`09-vocab.js`）：**
  - `normalizeSettings()` 对上述配置做合法值校验和 clamp：`apk/src/modules/09-vocab.js:19-35`
- **已有去重窗口：**
  - `recentWords` 窗口去重：`apk/src/modules/11-game-init.js:145-158`

### 差距（真正缺失的部分）
- ❌ `hybrid-adaptive` 模式 — 当前 hybrid 只做随机比例（70/30），没有根据 mastery 自适应调整 gap。
- ❌ `mastery` 分数体系 — 当前 `stats[en]` 只有 `{ count, quality }`，缺少 `mastery / streak / wrong` 计数器。
- ❌ 加权排序选词 — 当前选词是遍历 bag 取最小 count 的到期词，不是基于 `priority = dueReadyScore + weakWordBoost - recentPenalty` 的加权排序。
- ❌ `updateWordQuality()` 只更新 quality 和 due，没有更新 mastery 分数：`apk/src/modules/11-game-init.js:225-232`。

---

## 2. 目标设计（不改代码先定方案）

## 2.1 方案 A：群系门禁 BOSS（Wither Gate）

### 核心思路
- 把 BOSS 从“独立事件”改成“群系切换门禁事件”。  
- 当系统检测到“将离开当前群系”时：
  - 若该群系本轮未清关，则先触发 Wither 门禁战；
  - 胜利后再正式切到下一个群系。

### 设计要点
1. 新增状态对象（建议在 `06-biome.js`）
- `biomeGateState = { pendingFromBiome, pendingToBiome, gateActive, clearedMap }`

2. 切换逻辑重排（`updateCurrentBiome()`）
- 先计算 `nextBiome`。  
- 若 `nextBiome !== currentBiome` 且 `canLeaveBiome=true`：
  - 检查 `clearedMap[currentBiome]`。  
  - 未清关：发起 `requestGateBoss('wither', currentBiome, nextBiome)`，并 `return`（阻止切换）。
  - 已清关：执行原切换。

3. BOSS 系统扩展（`15-entities-boss.js`）
- 新增 `enterGateBoss(payload)`，支持 `source='biome_gate'`。  
- `onVictory()` 回调中写回 `clearedMap[fromBiome]=true`，并触发一次“延迟切换确认”。

4. 与旧固定分数 BOSS 的关系
- 二选一：
  - 推荐：保留代码但默认关闭固定分数 BOSS（避免与门禁机制冲突）。

### ⚠️ 补充：代码审查发现的遗漏点

**A. BOSS 类型复用策略**
- 当前只有 4 种 BOSS（`wither, ghast, blaze, wither_skeleton`），但群系有 12 个：`apk/src/modules/15-entities-boss.js:143-199`。
- 需明确：是所有群系都打 wither，还是按群系映射不同 BOSS？
- 建议：`biomes.json` 的 `gateBoss` 配置中加 `bossType` 字段，允许每个群系指定门禁 BOSS 类型，默认 `"wither"`。

**B. `onVictory()` 缺少回调扩展点**
- 当前 `onVictory()` 直接给奖励然后结束：`apk/src/modules/15-entities-boss.js:211-221`。
- 没有回调机制通知群系系统"门禁已通过"。
- 需要在 `onVictory()` 中加 hook：若 `source === 'biome_gate'`，则写回 `clearedMap[fromBiome]=true` 并触发延迟切换。

**C. 视口锁定与群系渲染冲突**
- `enter()` 锁定 `lockedCamX = cameraX`，但若玩家在群系视觉过渡区触发门禁，两个群系的背景/粒子会混合渲染。
- 建议：门禁触发时强制将 `currentBiome` 锁定为当前群系，直到 BOSS 战结束后再执行切换。

**D. 固定分数 BOSS 冲突的具体处理**
- `bossScores: [2000, 4000, 6000, 8000]` 和群系 `unlockScore` 有重叠区间（如 nether 在 2100 解锁，wither BOSS 在 2000 触发）。
- `checkSpawn()` 当前无开关：`apk/src/modules/15-entities-boss.js:149-159`。
- 建议：新增 `settings.fixedBossEnabled: false` 配置项，在 `defaults.js` 中默认关闭。

### 配置建议
- `config/biomes.json` 增加：
  - `gateBoss: { enabled: true, defaultType: "wither", perBiomeOnce: true }`
  - 各群系可选覆盖：`"nether": { ..., "gateBossType": "ghast" }`
- `apk/src/defaults.js` 增加：
  - `fixedBossEnabled: false`

---

## 2.2 方案 B：村庄“可进可出房屋”室内化

### 核心思路
- 新增“室内子场景（Interior Mode）”，进入房屋后暂停外部交互，仅处理室内对象和退出。  
- `bed_house` 的回血改为“室内床位交互”。

### 设计要点
1. 新状态（建议 `18-village.js`）
- `villageInteriorState = { active, villageId, buildingType, returnPlayerX, returnPlayerY, bedUsed }`

2. 交互改造
- 在村庄外靠近房屋按交互键：
  - `bed_house` / `word_house` 先 `enterVillageBuilding()`，不直接 `performRest()`/挑战。  
- 室内按 `Q`（或 `Esc`）退出，回到门口。

3. 室内渲染
- `14-renderer-main.js` 增加 `drawVillageInterior(ctx)`（屏幕坐标层，`ctx.restore()` 后绘制）。  
- `18-village-render.js` 拆分出室内组件：床、书桌、门、提示 UI。

4. 室内功能映射
- `bed_house`：室内床交互后恢复血量（沿用 `performRest` 的血量计算规则）。  
- `word_house`：室内交互台触发 `startVillageChallenge()`。

5. 输入与暂停
- 复用现有 `pausedByModal` 语义，避免和挑战弹窗冲突（参考 `12-village-challenges.js:56`）。

### ⚠️ 补充：代码审查发现的遗漏点

**A. 需要室内化的建筑类型比 Plan 列的多**
- 除了 `bed_house` 和 `word_house`，还有 `save_stone` 和 `SPECIAL_BUILDING_EFFECTS` 中的特殊建筑：`apk/src/modules/18-village.js:420-444`。
- 需要决定：哪些建筑支持"进入"（室内场景），哪些保持户外交互。
- 建议：`bed_house` 和 `word_house` 做室内化；`save_stone` 和特殊建筑保持户外交互（靠近即触发）。

**B. 室内模式需要暂停的系统远不止 `pausedByModal`**
- 敌人 AI 和生成（`13-game-loop.js` 的敌人更新循环）
- 掉落物 / 投射物更新
- 群系粒子和天气系统
- BOSS 战（需与室内模式互斥）
- 自动存档计时器
- 建议：新增统一的 `interiorMode` 布尔标志，在 `gameLoop()` 主循环入口做短路判断，室内期间只运行室内渲染和交互逻辑。

**C. 退出室内后的状态恢复**
- 需要恢复的状态：`cameraX`、`player.x/y`、`paused`、`pausedByModal`、群系粒子池。
- 建议在 `villageInteriorState` 中保存快照，退出时批量恢复。

---

## 2.3 方案 C：群系时长重平衡（参数化 + 可观测）

### 核心思路
- 先做“参数重分配”，再加“调试指标导出”，避免只靠体感反复调。  

### 第一版建议参数（可直接落 `config/biomes.json`）
- `cherry_grove`: `score 60 / timeSec 10`（缩短）  
- `ocean`: `score 140 / timeSec 25`（明显缩短）  
- `nether`: `score 420 / timeSec 85`（延长）  
- `deep_dark`: `score 320 / timeSec 60`（延长）

### 观测补充
- 在 debug 面板增加 `getBiomeStayDebugInfo()` 的实时展示（已有函数：`apk/src/modules/06-biome.js:153`）。
- 增加每局统计输出：各群系实际停留秒数、切换时分数。

### ⚠️ 补充：数值与 stepScore 交互分析

**A. unlockScore 间距约束**

| 群系 | unlockScore | 到下一个间距 | 当前 minStay.score | Plan 建议 | 占间距比 |
|------|------------|-------------|-------------------|----------|---------|
| cherry_grove | 100 | 150 (→snow 250) | 80 | 60 | 40% ✅ |
| ocean | 1100 | 400 (→volcano 1500) | 200 | 140 | 35% ✅ |
| nether | 2100 | 700 (→deep_dark 2800) | 360 | 420 | **60% ⚠️** |
| deep_dark | 2800 | 1000 (→end 3800) | 250 | 320 | 32% ✅ |

- nether 建议值 420 偏高。地狱环境有持续掉血机制（每60秒0.5血，`updateExtremeHeatEnvironment()`），停留过久会导致玩家被环境伤害消耗殆尽。
- **修正建议：nether `minStay.score` 调整为 380，`timeSec` 调整为 80。**

**B. `stepScore` 全局步长的影响**
- 当前 `stepScore: 300` 是群系切换的全局步长（`getBiomeIdForScore()` 中 `cycle = score / step`）。
- `stepScore` 和 `minStay` 共同决定实际停留时间：即使 `minStay` 满足，若 `score / stepScore` 的 cycle 值未变，群系也不会切换。
- 单纯改 `minStay` 而不调 `stepScore`，效果可能不如预期。
- 建议：先只调 `minStay` 参数，观测实际效果后再决定是否调整 `stepScore`。

**C. 修正后的第一版建议参数**
- `cherry_grove`: `score 60 / timeSec 10`（缩短）
- `ocean`: `score 140 / timeSec 25`（明显缩短）
- `nether`: `score 380 / timeSec 80`（适度延长，兼顾环境伤害）
- `deep_dark`: `score 320 / timeSec 60`（延长）

---

## 2.4 方案 D：单词-短语串联调度 + 复现频率

### 核心思路（修正）
- follow-up 队列与 `direct/gap2/hybrid` 已有实现，当前不是从零搭建。  
- 本方案改为“在现有实现上增强”：先验证现有链路稳定性，再增量补 `hybrid-adaptive` 和 mastery 体系。

### 现有已实现
- `followUpQueue` + `createFollowUpPhraseItem()` + `maybeEnqueueFollowUpPhrase()` + `maybeTakeFollowUpPhrase()` 已完成。  
- `pickWordForSpawn()` 已集成 follow-up 优先出队。  
- `phraseFollowMode/phraseFollowGapCount/phraseFollowDirectRatio/wordRepeatWindow` 已在 `defaults.js` 和 `normalizeSettings()` 中落地。  
- `recentWords` 窗口去重已实现。

### 增量改造目标（真正缺失）
1. `hybrid-adaptive`：由当前固定 70/30 升级为按词掌握度动态决定 gap。  
2. `mastery` 体系：在 `stats[en]` 增加 `mastery/streak/wrong/seen`。  
3. 选词排序升级：由最小 count 到期优先，升级到“到期度 + 弱项加权 - 近期惩罚”的优先级评分。  
4. `updateWordQuality()` 扩展：除质量标签外同步更新 mastery 分。

### 配置建议（与现有键对齐）
- 保留：`phraseFollowMode`, `phraseFollowGapCount`, `phraseFollowDirectRatio`, `wordRepeatWindow`。  
- 新增：`phraseFollowAdaptive`（默认 `true`）、`wordRepeatBias`（`balanced | reinforce_wrong`）。

---

## 3. 实施计划（修正优先级）

## P0（先交付低风险、可验证收益）
1. 需求8：只调 `minStay`（含 nether 修正为 `score=380`）并补充停留统计输出。  
2. 需求9-M1：验证现有 follow-up 队列在 `direct/gap2/hybrid` 下稳定工作，修复链路 bug（非重写）。  
3. 每完成一项即跑一次回归（Playwright / `npm test`）确认主循环无回归。

## P1（中等改造）
1. 需求9-M2：加入 mastery/streak/wrong 统计与 `hybrid-adaptive`。  
2. 需求6：实现门禁 BOSS 状态机 + `fixedBossEnabled` 开关 + victory hook。

## P2（高改动）
1. 需求7：室内子场景（进出屋、室内床恢复、词屋室内交互）。  
2. 需求9-M3：设置面板暴露策略参数与观测指标。

---

## 4. 测试与验收标准

## 4.1 BOSS 门禁
- 任一群系尝试切换时，若未清关则必定进入 Wither 门禁战。  
- 未击败前不会切到下一群系。  
- 击败后 1 秒内自动切到目标群系。

## 4.2 村庄房屋
- 可稳定“进屋/出屋”，无卡死、无输入锁死。  
- 室内床交互触发回血，且次数限制符合配置。  
- 退出后玩家位置回到门口，镜头/暂停状态正常恢复。

## 4.3 群系时长
- 樱花、海洋平均停留时长低于当前版本。  
- 地狱、暗之领域平均停留时长高于当前版本。  
- 切换日志可回放验证（分数与时间均可追溯）。

## 4.4 单词-短语
- 当词条存在短语时，能按配置 gap=1 或 gap=2 跟随出现。  
- 错词在后续 2-5 次内重现概率显著高于正确词。  
- 地图掉落不出现 `undefined` 文本。

---

## 5. 风险与规避

1. 风险：BOSS 门禁与原固定分数 BOSS 重叠，导致双触发。  
- 规避：固定分数 BOSS 默认禁用，仅保留兼容开关。

2. 风险：室内模式和各类 modal（学习挑战/暂停）冲突。  
- 规避：统一通过会话对象恢复 `paused/pausedByModal`。

3. 风险：短语卡引入后掉落节奏过密。  
- 规避：`followupQueue` 设置最大长度与冷却窗口。

4. 风险：需求7室内模式与 BOSS 战并发，导致状态错乱。  
- 规避：强制互斥（`interiorMode` 激活时禁止 BOSS 触发；BOSS 激活时禁止进屋）。

5. 风险：仅调整 `minStay` 但忽略 `stepScore`，导致“体感未变化”。  
- 规避：同时记录每局群系停留日志，必要时二次调 `stepScore`。

6. 风险：需求9误判为“从零实现”导致重复开发和回归风险。  
- 规避：先做 M1 验证现有实现，再做 M2 增强，严禁大规模重写。

---

## 6. 建议新增/修改文件清单（设计级）

- 修改：`apk/src/defaults.js`（新增 `fixedBossEnabled`、`phraseFollowAdaptive` 等默认配置）  
- 修改：`apk/src/modules/06-biome.js`（群系门禁状态机）  
- 修改：`apk/src/modules/15-entities-boss.js`（支持 gate-boss 模式）  
- 修改：`apk/src/modules/13-game-loop.js`（门禁触发时序）  
- 修改：`apk/src/modules/18-village.js`（室内状态与进出逻辑）  
- 修改：`apk/src/modules/18-village-render.js`（室内渲染）  
- 修改：`apk/src/modules/11-game-init.js`（word/phrase 调度器）  
- 修改：`apk/src/modules/12-challenges.js`（挑战结果回传扩展，支持 mastery 统计）  
- 修改：`apk/config/biomes.json`（minStay 调参 + gateBoss 配置）  
- 可选新增：`apk/src/modules/18-village-interior.js`（若希望降低耦合）

---

## 7. 结论

当前代码已经具备 BOSS、村庄、群系切换、词库调度四套基础能力，但它们是“并行系统”，还没有按你的需求做“串联约束”。  
建议按本 Plan 先完成 P0/P1，把门禁与室内场景打通，再上 P2 的学习链路强化，这样改动风险最小且可验证性最好。
