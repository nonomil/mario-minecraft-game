# 游戏优化-0218-2 代码分析报告（基于当前源码）

日期：2026-02-18  
范围：`apk` 项目，聚焦“群系切换时长”和“BOSS战凋零异常”

## 1. 结论摘要

1. 火山环境“太短”不是单点配置问题，而是“分数步进 + 最小停留 + 单调进度分”三者叠加导致。  
2. 凋零“看不见但会掉血”的主因已定位：BOSS渲染链路存在相机偏移重复处理，导致实体可能被绘制到屏幕外。  
3. BOSS战地图模式当前代码已经是“固定竞技场”（相机锁定 + 左右墙）；不是可移动地图。  
4. “无法攻击”还有次因：凋零是飞行单位，玩家箭矢为 0 时近战几乎无解。

## 2. 群系切换机制全链路分析

### 2.1 实际切换条件

核心代码：
- `src/modules/06-biome.js:30` `getBiomeIdForScore()`
- `src/modules/06-biome.js:54` `updateCurrentBiome()`
- `src/modules/06-biome.js:142` `canLeaveBiome()`

实际生效逻辑：
1. 先按 `stepScore` 计算周期位：`cycle = floor(score/step)`。  
2. 再按 `order + unlockScore` 过滤已解锁群系。  
3. 候选群系为 `eligible[cycle % eligible.length]`。  
4. 只有 `canLeaveBiome()` 返回 true 才允许切换。  
5. `canLeaveBiome()` 同时要求：本群系累计分数达到 `minStay.score` 且停留时长达到 `minStay.timeSec`。

### 2.2 火山“短”的根因

关键配置：
- `config/biomes.json` `switch.stepScore = 200`
- `config/biomes.json` `switch.minStay.volcano = { score: 200, timeSec: 40 }`
- `config/biomes.json` `switch.unlockScore.volcano = 1500`

关键实现细节：
- 进度分使用 `runBestScore`（`src/modules/05-difficulty.js:5`），不是当前可回退分数。  
- `runBestScore` 在加分时只增不减（`src/modules/13-game-loop.js:451`）。  

直接结果：
1. 群系切换驱动分数是单调递增，玩家挨打扣分不会延缓下一次切换。  
2. 火山最小停留是“40秒且200分”，在中后期常被 200 分门槛先满足，体感偏短。  
3. 设置面板允许把 `biomeSwitchStepScore` 调到 50（`Game.html:209` + `src/modules/16-events.js:121`），会进一步缩短群系节奏。

### 2.3 现状评估

当前系统已经有“最小停留”保护，不是完全无节制轮换；问题在于阈值偏保守，尤其是高压群系（火山/地狱）停留时间仍偏短。

## 3. BOSS战（凋零）问题分析

### 3.1 当前BOSS战架构（与旧文档差异）

当前代码中，BOSS战是固定竞技场：
- 进入战斗时设置 `viewportLocked/leftWall/rightWall`（`src/modules/15-entities-boss.js:169-172`）  
- 更新时强制锁相机（`src/modules/13-game-loop.js:262-266`）  
- 限制玩家在左右墙内（`src/modules/13-game-loop.js:269-276`）

所以“固定地图 vs 可移动地图”在现实现里已经偏向固定地图。

### 3.2 “只掉血看不到BOSS”的主因

渲染流程：
- `draw()` 里先 `ctx.translate(-cameraX, 0)`（`src/modules/14-renderer-main.js:14`）
- 再调用 `renderBossSystem()`（`src/modules/14-renderer-main.js:71`）
- `renderBossSystem()` 又把 `cameraX` 传入 BOSS 渲染（`src/modules/14-renderer-entities.js:359-360`）
- BOSS绘制内部继续 `x - camX`（例如 `src/modules/15-entities-boss.js:486`）

这会形成“平移一次 + 坐标再减一次 cameraX”的双重相机偏移，BOSS和弹幕容易被画到屏幕外。  
但伤害与碰撞仍用世界坐标，故会出现“看不到敌人但持续掉血”。

### 3.3 “没法进攻”的次因

1. 凋零为飞行单位，近战命中窗口很小。  
2. 远程依赖箭矢，箭为 0 时会直接拒绝发射（`src/modules/04-weapons.js:55-68`）。  
3. 近战/远程打BOSS逻辑本身是存在的（`src/modules/04-weapons.js:164-168`、`src/modules/15-entities-combat.js:66-70`）。

## 4. 固定地图 vs 可移动地图评估

结论：建议继续使用固定竞技场，不建议改回可移动地图。

原因：
1. 当前代码已实现固定竞技场，改回可移动会引入新复杂度。  
2. 教育+动作混合玩法里，固定场景更利于“看清敌人 + 稳定操作 + 公平受击”。  
3. 当前主要故障在渲染坐标链路，不在竞技场模式本身。

## 5. 风险清单（按优先级）

1. P0：BOSS渲染双重偏移，直接导致战斗不可视。  
2. P1：火山/地狱停留阈值偏短，体验压缩。  
3. P1：步进分可被设置得过低（50），会造成群系“闪切”。  
4. P2：飞行BOSS战斗资源门槛（箭矢）缺少兜底提示与保底补给。

## 6. 建议改动方向（不在本报告内直接改代码）

1. 先修BOSS渲染坐标链路，保证可见可打。  
2. 再做群系节奏重平衡：上调火山/地狱最小停留阈值，并给 `biomeSwitchStepScore` 增加更合理下限。  
3. 最后补飞行BOSS战兜底：开战时箭矢不足给提示或临时补给。

下一步执行计划见：`docs/development/游戏优化-0218/游戏优化-0218-2-下一步计划-Plan.md`

## 7. 核心发现总结（按你给出的要点继续分析）

以下基于你给出的四条“核心发现”逐条复核：

### 7.1 群系切换问题（成立，建议采纳）

你给出的方向：`stepScore=200` 太短，建议调到 `500` 并拉大解锁间距。  
复核结论：方向正确，可执行。

补充建议：
1. 建议分两轮调参，先 `200 -> 300`，观察后再到 `500`，避免节奏骤变。  
2. 火山/地狱群系除 `stepScore` 外，还应同步提高 `minStay`，否则中后期仍会偏短。  
3. 要同时提高设置面板 `opt-biome-step` 的最小值（当前可到50），否则调参会被用户设置覆盖。

### 7.2 BOSS不可见致命BUG（结论成立，根因表述需校准）

你给出的方向：BOSS不可见是渲染参数问题。  
复核结论：成立；但“缺少 cameraX 参数在 `14-renderer-main.js:93-94`”这一描述与当前源码不一致。

当前代码事实：
1. `draw()` 内已 `translate(-cameraX,0)`（`src/modules/14-renderer-main.js:14`）。  
2. `renderBossSystem()` 仍传 `cameraX`（`src/modules/14-renderer-entities.js:359-360`）。  
3. BOSS内部再次 `x-camX` 绘制（例如 `src/modules/15-entities-boss.js:486`）。  

最终表现与您描述一致：玩家掉血但看不到BOSS。  
因此可保留“致命BUG”结论，但修复点应定位为“相机偏移重复处理”。

### 7.3 BOSS战地图模式（需校准）

你给出的方向：当前是可移动地图，建议改固定竞技场。  
复核结论：建议方向是对的，但“当前是可移动地图”不成立。

当前源码已经是固定竞技场机制：
1. 进入BOSS战设置 `viewportLocked/leftWall/rightWall`（`src/modules/15-entities-boss.js:169-172`）。  
2. 更新逻辑强制锁相机（`src/modules/13-game-loop.js:262-266`）。  
3. 限制玩家移动范围（`src/modules/13-game-loop.js:269-276`）。

所以当前更应做“修正渲染与战斗可打性”，不是从可移动改固定。

### 7.4 修复优先级（保留框架，微调内容）

你给出的优先级框架：
- P0 渲染参数
- P1 竞技场锁定
- P2 群系平衡
- P3 逐Boss检查

复核后建议：
1. `P0`：BOSS渲染链路修复（保持不变）  
2. `P1`：飞行BOSS可攻击兜底（箭矢/提示/补给）  
3. `P2`：群系切换节奏平衡（`stepScore + minStay + 解锁分差`）  
4. `P3`：逐个BOSS机制复核与回归

说明：竞技场锁定当前已存在，优先级可下调为“复核项”，不再作为主要开发项。
