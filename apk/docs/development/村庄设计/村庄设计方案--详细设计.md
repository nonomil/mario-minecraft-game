# æ‘åº„ç³»ç»Ÿè¯¦ç»†è®¾è®¡æ–¹æ¡ˆ

> åŸºäºåˆç¨¿ï¼Œç»“åˆ V1 apk å®é™…ä»£ç æ¶æ„ï¼ˆæ¨¡å—åŒ–22æ–‡ä»¶ã€Canvas 2Dæ¸²æŸ“ã€åˆ†æ•°é©±åŠ¨ç¾¤ç³»åˆ‡æ¢ï¼‰ç¼–å†™

## ä¸€ã€è®¾è®¡ç›®æ ‡

1. åœ¨æ¨ªç‰ˆè¿‡å…³æµç¨‹ä¸­åµŒå…¥"æ‘åº„å®‰å…¨åŒº"ï¼Œæä¾›ä¼‘æ¯ã€å­¦ä¹ ã€å­˜æ¡£åŠŸèƒ½
2. ä¸ç°æœ‰ biome ç³»ç»Ÿè”åŠ¨ï¼Œæ¯ä¸ªç¾¤ç³»æœ‰é£æ ¼åŒ–æ‘åº„
3. å¼ºåŒ–è‹±è¯­å­¦ä¹ æ ¸å¿ƒâ€”â€”æ‘åº„æ˜¯å­¦ä¹ çš„"å¥–åŠ±ç«™"è€Œé"æƒ©ç½šå…³"
4. æœ€å°åŒ–å¯¹ç°æœ‰ä»£ç çš„ä¾µå…¥ï¼Œå¤ç”¨æ¨¡å—åŒ–æ¶æ„

## äºŒã€æ ¸å¿ƒæ¦‚å¿µ

### 2.1 æ‘åº„å®šä½

æ‘åº„æ˜¯**æ¨ªç‰ˆå…³å¡ä¸­çš„ä¸€æ®µç‰¹æ®ŠåŒºåŸŸ**ï¼ˆçº¦ 800px å®½ï¼‰ï¼Œç©å®¶è·‘åˆ°è¯¥åŒºåŸŸæ—¶è‡ªåŠ¨è¿›å…¥æ‘åº„ã€‚æ‘åº„å†…ï¼š
- ä¸åˆ·æ€ªï¼ˆå®‰å…¨åŒºï¼‰
- æœ‰ NPC æ‘æ°‘ï¼ˆå¯äº¤äº’ï¼‰
- æœ‰åŠŸèƒ½å»ºç­‘ï¼ˆåºŠã€å•è¯å±‹ã€å­˜æ¡£çŸ³ç¢‘ï¼‰
- æœ‰è£…é¥°ç‰©ï¼ˆæ°´äº•ã€å†œç”°ã€è·¯ç¯ç­‰ï¼‰

### 2.2 è§¦å‘æœºåˆ¶

é‡‡ç”¨**åˆ†æ•°é©±åŠ¨**ï¼Œä¸ç°æœ‰ biome åˆ‡æ¢é€»è¾‘ä¸€è‡´ï¼š
- æ¯ **500 åˆ†**ç”Ÿæˆä¸€ä¸ªæ‘åº„åŒºåŸŸï¼ˆå¯åœ¨ `config/village.json` é…ç½®ï¼‰
- æ‘åº„å‡ºç°åœ¨ biome åˆ‡æ¢ç‚¹é™„è¿‘ï¼Œä½œä¸º"è¿‡æ¸¡ä¼‘æ¯ç«™"
- ç¬¬ä¸€ä¸ªæ‘åº„åœ¨ 500 åˆ†å‡ºç°ï¼ˆæ–°æ‰‹å¼•å¯¼æ‘åº„ï¼‰

### 2.3 æ‘åº„ä¸ Biome è”åŠ¨

| Biome | æ‘åº„é£æ ¼ | ç‰¹è‰²å»ºç­‘ | ä¸“å±å•è¯ä¸»é¢˜ |
|-------|---------|---------|-------------|
| forest | æ©¡æœ¨æ‘åº„ | å›¾ä¹¦é¦†ï¼ˆå•è¯å±‹ï¼‰ | è‡ªç„¶/åŠ¨ç‰© |
| snow | é›ªå±‹æ‘åº„ | æ¸©æ³‰å°å±‹ï¼ˆå›è¡€åŠ æˆï¼‰ | å¤©æ°”/è¡£ç‰© |
| desert | æ²™çŸ³æ‘åº„ | ç»¿æ´²æ°´ç«™ï¼ˆæ°´è¢‹é“å…·ï¼‰ | é£Ÿç‰©/æ°´æœ |
| mountain | çŸ³ç –æ‘åº„ | é“åŒ é“ºï¼ˆè£…å¤‡å¼ºåŒ–ï¼‰ | å·¥å…·/çŸ¿ç‰© |
| ocean | æ°´ä¸Šæ‘åº„ | ç¯å¡”ï¼ˆç…§äº®å‰æ–¹ï¼‰ | æµ·æ´‹/é±¼ç±» |
| nether | å ¡å’é—è¿¹ | ç‚¼è¯å°ï¼ˆè¯æ°´é“å…·ï¼‰ | é¢œè‰²/å½¢çŠ¶ |

## ä¸‰ã€åŠŸèƒ½æ¨¡å—è¯¦ç»†è®¾è®¡

### 3.1 æ‘åº„åŒºåŸŸç”Ÿæˆ

#### æ•°æ®ç»“æ„
```javascript
// æ‘åº„å®ä¾‹
{
  x: Number,           // æ‘åº„èµ·å§‹ x åæ ‡
  width: 800,          // æ‘åº„å®½åº¦ï¼ˆåƒç´ ï¼‰
  biomeId: String,     // æ‰€å±ç¾¤ç³»
  buildings: [],       // å»ºç­‘åˆ—è¡¨
  npcs: [],            // NPC åˆ—è¡¨
  decorations: [],     // è£…é¥°ç‰©åˆ—è¡¨
  visited: false,      // æ˜¯å¦å·²è®¿é—®
  questCompleted: false // å•è¯ä»»åŠ¡æ˜¯å¦å®Œæˆ
}
```

#### ç”Ÿæˆé€»è¾‘
åœ¨ `13-game-loop.js` çš„ `updateMapGeneration()` ä¸­æ’å…¥æ‘åº„ç”Ÿæˆæ£€æŸ¥ï¼š

```javascript
// ä¼ªä»£ç ï¼šæ‘åº„ç”Ÿæˆ
function maybeSpawnVillage(playerScore, playerX) {
  const cfg = villageConfig; // ä» config/village.json åŠ è½½
  const interval = cfg.spawnScoreInterval; // é»˜è®¤ 500
  const nextVillageScore = Math.ceil(playerScore / interval) * interval;

  if (playerScore >= nextVillageScore && !villageSpawnedForScore[nextVillageScore]) {
    const biome = getBiomeById(currentBiome);
    const village = createVillage(playerX + 600, biome);
    activeVillages.push(village);
    villageSpawnedForScore[nextVillageScore] = true;
  }
}
```

#### æ‘åº„å†…å®¹ç”Ÿæˆ
```javascript
function createVillage(startX, biome) {
  const style = VILLAGE_STYLES[biome.id] || VILLAGE_STYLES.forest;
  return {
    x: startX,
    width: 800,
    biomeId: biome.id,
    buildings: [
      { type: 'bed_house', x: startX + 100, w: 80, h: 60 },      // ä¼‘æ¯å±‹
      { type: 'word_house', x: startX + 300, w: 100, h: 80 },     // å•è¯å±‹
      { type: 'save_stone', x: startX + 550, w: 40, h: 50 },      // å­˜æ¡£çŸ³ç¢‘
      { type: style.specialBuilding, x: startX + 700, w: 80, h: 60 } // ç¾¤ç³»ç‰¹è‰²å»ºç­‘
    ],
    npcs: [
      { type: 'villager', x: startX + 200, role: 'greeter' },      // è¿æ¥æ‘æ°‘
      { type: 'villager', x: startX + 400, role: 'teacher' },      // æ•™å¸ˆæ‘æ°‘
    ],
    decorations: style.decorations.map((d, i) => ({
      type: d, x: startX + 50 + i * 120
    })),
    visited: false,
    questCompleted: false
  };
}
```

### 3.2 ä¼‘æ¯ç³»ç»Ÿ

#### äº¤äº’æµç¨‹
1. ç©å®¶èµ°åˆ°"åºŠ"å»ºç­‘é™„è¿‘ï¼ˆç¢°æ’æ£€æµ‹ AABBï¼‰
2. æ˜¾ç¤ºäº¤äº’æç¤ºï¼š"æŒ‰ Y é”®ä¼‘æ¯" / è§¦å±æ˜¾ç¤º"ä¼‘æ¯"æŒ‰é’®
3. è§¦å‘ä¼‘æ¯ï¼š
   - å±å¹•æ¸é»‘ â†’ æ˜¾ç¤º"ä¼‘æ¯ä¸­..." â†’ æ¸äº®
   - æ¢å¤ **æ»¡è¡€**ï¼ˆplayerHp = maxHpï¼‰
   - å¼¹å‡ºä¸€å¼ **å•è¯å¡ç‰‡**ï¼ˆæ¥è‡ªå½“å‰ biome çš„ reward_wordsï¼‰
   - æ’­æ”¾å•è¯å‘éŸ³ï¼ˆå¤ç”¨ `03-audio.js` çš„ `speakWord()`ï¼‰

#### ä»£ç é›†æˆç‚¹
- `13-game-loop.js`ï¼š`handleInteraction()` ä¸­æ–°å¢ bed äº¤äº’åˆ†æ”¯
- `10-ui.js`ï¼šæ–°å¢ä¼‘æ¯æŒ‰é’®ï¼ˆä»…æ‘åº„å†…æ˜¾ç¤ºï¼‰
- `03-audio.js`ï¼šå¤ç”¨ `speakWord()` æ’­æ”¾å•è¯

```javascript
// ä¼‘æ¯ç³»ç»Ÿæ ¸å¿ƒé€»è¾‘
function restOnBed(village) {
  if (village.restUsed) {
    showToast("ğŸ’¤ å·²ç»ä¼‘æ¯è¿‡äº†");
    return;
  }
  village.restUsed = true;

  // 1. å›æ»¡è¡€
  playerHp = gameConfig.player.maxHp;
  updateHpUI();
  showFloatingText("â¤ï¸ æ»¡è¡€æ¢å¤!", player.x, player.y - 30);

  // 2. å¼¹å‡ºå•è¯å¡ç‰‡
  const words = getVillageWords(village.biomeId);
  const word = words[Math.floor(Math.random() * words.length)];
  showWordCard(word);
  speakWord(word.en);

  // 3. å¥–åŠ±åˆ†æ•°
  score += 50;
  showFloatingText("+50 ğŸª™", player.x, player.y - 50);
}
```

### 3.3 å•è¯å­¦ä¹ å±‹

#### äº¤äº’æµç¨‹
1. ç©å®¶èµ°åˆ°"å•è¯å±‹"å»ºç­‘é™„è¿‘
2. æ˜¾ç¤ºäº¤äº’æç¤ºï¼š"æŒ‰ Y è¿›å…¥å•è¯å±‹"
3. è¿›å…¥åè§¦å‘**å•è¯å°æ¸¸æˆ**ï¼ˆå¤ç”¨ `12-challenges.js` çš„æŒ‘æˆ˜ç³»ç»Ÿï¼‰ï¼š
   - æ¨¡å¼Aï¼š**å­—æ¯å¡«ç©º**ï¼ˆå¤ç”¨ç°æœ‰ challenge modalï¼‰
   - æ¨¡å¼Bï¼š**å•è¯è¿çº¿**ï¼ˆå¤ç”¨ç°æœ‰ word matchï¼‰
   - é¢˜ç›®æ¥æºï¼šå½“å‰ biome çš„ä¸“å±å•è¯ + ä¹‹å‰ç­”é”™çš„å•è¯ï¼ˆé—´éš”é‡å¤ï¼‰
4. å®Œæˆå¥–åŠ±ï¼š
   - å…¨å¯¹ï¼š+100åˆ† + 1ğŸ’ + ç¾¤ç³»ä¸“å±é“å…·
   - éƒ¨åˆ†å¯¹ï¼š+50åˆ†
   - è§£é”æˆå°±ï¼š"XXæ‘åº„å­¦è€…"

#### ä»£ç é›†æˆç‚¹
- `12-challenges.js`ï¼šæ–°å¢ `startVillageChallenge(biomeId)` å‡½æ•°
- å¤ç”¨ç°æœ‰ `showLearningChallenge()` å’Œ `showWordMatchScreen()`
- `09-vocab.js`ï¼šæ–°å¢ `getVillageWords(biomeId)` ä» village é…ç½®è·å–å•è¯

```javascript
function startVillageChallenge(village) {
  if (village.questCompleted) {
    showToast("ğŸ“š å·²å®Œæˆå­¦ä¹ ä»»åŠ¡");
    return;
  }

  paused = true;
  const words = getVillageWords(village.biomeId);
  // å¤ç”¨ç°æœ‰æŒ‘æˆ˜ç³»ç»Ÿï¼Œä¼ å…¥æ‘åº„å•è¯
  showLearningChallenge({
    source: 'village',
    words: words,
    count: 3, // 3é“é¢˜
    onComplete: (correct, total) => {
      village.questCompleted = true;
      paused = false;
      if (correct === total) {
        score += 100;
        diamonds += 1;
        showFloatingText("ğŸ‰ å…¨å¯¹! +100ğŸª™ +1ğŸ’", player.x, player.y - 30);
        grantBiomeReward(village.biomeId);
      } else {
        score += 50;
        showFloatingText(`ğŸ“ ${correct}/${total} +50ğŸª™`, player.x, player.y - 30);
      }
    }
  });
}
```

### 3.4 å­˜æ¡£çŸ³ç¢‘

#### äº¤äº’æµç¨‹
1. ç©å®¶èµ°åˆ°"å­˜æ¡£çŸ³ç¢‘"é™„è¿‘
2. æ˜¾ç¤ºäº¤äº’æç¤ºï¼š"æŒ‰ Y å­˜æ¡£"
3. è§¦å‘å­˜æ¡£ï¼š
   - ä¿å­˜å½“å‰è¿›åº¦åˆ° localStorageï¼ˆå¤ç”¨ `storage.js`ï¼‰
   - æ˜¾ç¤º"âœ… å·²å­˜æ¡£"æç¤º
   - è®°å½•æ‘åº„ä½ç½®ä½œä¸ºå¤æ´»ç‚¹

#### ä»£ç é›†æˆç‚¹
- `storage.js`ï¼šæ–°å¢ `saveVillageCheckpoint()` å‡½æ•°
- å¤ç”¨ç°æœ‰ `saveProgress()` é€»è¾‘

```javascript
function saveVillageCheckpoint(village) {
  const checkpoint = {
    score: score,
    playerHp: playerHp,
    biome: currentBiome,
    villageX: village.x,
    inventory: { ...playerInventory },
    timestamp: Date.now()
  };
  saveToStorage('villageCheckpoint', checkpoint);
  showToast("âœ… è¿›åº¦å·²å­˜æ¡£");
  showFloatingText("ğŸ’¾ å­˜æ¡£æˆåŠŸ", player.x, player.y - 30);
}
```

### 3.5 NPC æ‘æ°‘ç³»ç»Ÿ

#### æ‘æ°‘ç±»å‹
| ç±»å‹ | è¡Œä¸º | äº¤äº’ |
|------|------|------|
| greeter | åœ¨æ‘å£æ¥å›èµ°åŠ¨ | æ˜¾ç¤ºæ¬¢è¿è¯­ + æ‘åº„ä»‹ç» |
| teacher | ç«™åœ¨å•è¯å±‹é—¨å£ | å¼•å¯¼è¿›å…¥å•è¯å±‹ |
| trader | ç«™åœ¨ç‰¹è‰²å»ºç­‘æ— | ç‰©å“äº¤æ˜“ï¼ˆé“å—æ¢é“å…·ï¼‰ |

#### æ‘æ°‘æ¸²æŸ“
```javascript
// åƒç´ é£æ ¼æ‘æ°‘ï¼ˆå¤ç”¨ drawSteve çš„ç»˜åˆ¶æ¨¡å¼ï¼‰
function drawVillager(ctx, npc) {
  const sx = npc.x - cameraX;
  const sy = groundY - 48; // ç«™åœ¨åœ°é¢ä¸Š

  // æ£•è‰²é•¿è¢ï¼ˆåŒºåˆ«äºç©å®¶ï¼‰
  ctx.fillStyle = '#8B4513';
  ctx.fillRect(sx + 4, sy + 16, 18, 24); // èº«ä½“

  // å¤§é¼»å­ï¼ˆMCæ‘æ°‘ç‰¹å¾ï¼‰
  ctx.fillStyle = '#D2B48C';
  ctx.fillRect(sx + 6, sy, 14, 14);       // å¤´
  ctx.fillStyle = '#C4A882';
  ctx.fillRect(sx + 10, sy + 6, 6, 4);    // é¼»å­

  // äº¤äº’æç¤ºæ°”æ³¡
  if (npc.showBubble) {
    drawSpeechBubble(ctx, sx + 13, sy - 20, npc.bubbleText);
  }
}
```

#### æ‘æ°‘ AIï¼ˆç®€å•æ¥å›èµ°åŠ¨ï¼‰
```javascript
function updateVillager(npc, dt) {
  // åœ¨æ‘åº„èŒƒå›´å†…æ¥å›èµ°åŠ¨
  npc.x += npc.direction * npc.speed;
  if (npc.x < npc.minX || npc.x > npc.maxX) {
    npc.direction *= -1;
  }

  // ç©å®¶é è¿‘æ—¶æ˜¾ç¤ºæ°”æ³¡
  const dist = Math.abs(player.x - npc.x);
  if (dist < 80) {
    npc.showBubble = true;
    npc.bubbleText = npc.greeting;
  } else {
    npc.showBubble = false;
  }
}
```

### 3.6 æ‘åº„è§†è§‰æ¸²æŸ“

#### å»ºç­‘æ¸²æŸ“ï¼ˆCanvas åƒç´ é£æ ¼ï¼‰
```javascript
function drawVillageBuilding(ctx, building, biomeStyle) {
  const sx = building.x - cameraX;
  const sy = groundY - building.h;
  const colors = biomeStyle.buildingColors;

  // å¢™ä½“
  ctx.fillStyle = colors.wall;
  ctx.fillRect(sx, sy, building.w, building.h);

  // å±‹é¡¶ï¼ˆä¸‰è§’å½¢ï¼‰
  ctx.fillStyle = colors.roof;
  ctx.beginPath();
  ctx.moveTo(sx - 5, sy);
  ctx.lineTo(sx + building.w / 2, sy - 20);
  ctx.lineTo(sx + building.w + 5, sy);
  ctx.fill();

  // é—¨
  ctx.fillStyle = colors.door;
  ctx.fillRect(sx + building.w/2 - 8, sy + building.h - 30, 16, 30);

  // çª—æˆ·ï¼ˆå‘å…‰æ•ˆæœï¼‰
  ctx.fillStyle = '#FFEB3B';
  ctx.fillRect(sx + 10, sy + 10, 12, 12);
  ctx.fillRect(sx + building.w - 22, sy + 10, 12, 12);

  // å»ºç­‘æ ‡è¯†å›¾æ ‡
  const icons = { bed_house: 'ğŸ›ï¸', word_house: 'ğŸ“š', save_stone: 'ğŸ’¾' };
  ctx.font = '16px serif';
  ctx.fillText(icons[building.type] || 'ğŸ ', sx + building.w/2 - 8, sy - 25);
}
```

#### ç¾¤ç³»é£æ ¼é…è‰²
```javascript
const VILLAGE_STYLES = {
  forest: {
    buildingColors: { wall: '#8B6914', roof: '#2E7D32', door: '#5D4037' },
    decorations: ['well', 'farm', 'fence', 'flower_pot'],
    specialBuilding: 'library'
  },
  snow: {
    buildingColors: { wall: '#ECEFF1', roof: '#1565C0', door: '#37474F' },
    decorations: ['snowman', 'ice_lamp', 'pine_fence'],
    specialBuilding: 'hot_spring'
  },
  desert: {
    buildingColors: { wall: '#D7CCC8', roof: '#FF8F00', door: '#4E342E' },
    decorations: ['cactus_pot', 'sand_lamp', 'oasis'],
    specialBuilding: 'water_station'
  },
  mountain: {
    buildingColors: { wall: '#78909C', roof: '#455A64', door: '#37474F' },
    decorations: ['anvil', 'stone_lamp', 'mine_cart'],
    specialBuilding: 'blacksmith'
  },
  ocean: {
    buildingColors: { wall: '#4FC3F7', roof: '#0277BD', door: '#01579B' },
    decorations: ['anchor', 'barrel', 'fishing_rod'],
    specialBuilding: 'lighthouse'
  },
  nether: {
    buildingColors: { wall: '#4A148C', roof: '#880E4F', door: '#311B92' },
    decorations: ['soul_lantern', 'nether_wart_pot', 'chain'],
    specialBuilding: 'brewing_stand'
  }
};
```

## å››ã€é…ç½®æ–‡ä»¶è®¾è®¡

### 4.1 æ–°å¢ config/village.json
```json
{
  "enabled": true,
  "spawnScoreInterval": 500,
  "villageWidth": 800,
  "safeZone": true,
  "restHealFull": true,
  "challengeQuestionCount": 3,
  "challengeReward": {
    "perfect": { "score": 100, "diamonds": 1 },
    "partial": { "score": 50, "diamonds": 0 }
  },
  "npcSpeed": 0.3,
  "npcGreetDistance": 80,
  "buildings": {
    "bed_house": { "w": 80, "h": 60, "offset": 100 },
    "word_house": { "w": 100, "h": 80, "offset": 300 },
    "save_stone": { "w": 40, "h": 50, "offset": 550 },
    "special": { "w": 80, "h": 60, "offset": 700 }
  },
  "biomeWords": {
    "forest": ["tree", "leaf", "bird", "flower", "grass", "wood", "deer", "owl"],
    "snow": ["snow", "ice", "cold", "coat", "hat", "scarf", "ski", "sled"],
    "desert": ["sand", "sun", "hot", "water", "cactus", "camel", "oasis", "dry"],
    "mountain": ["rock", "iron", "gold", "pick", "cave", "stone", "gem", "ore"],
    "ocean": ["fish", "wave", "boat", "shell", "whale", "coral", "swim", "sea"],
    "nether": ["fire", "red", "lava", "dark", "flame", "ash", "smoke", "glow"]
  }
}
```

### 4.2 æ‰©å±• config/biomes.json

åœ¨æ¯ä¸ª biome å¯¹è±¡ä¸­æ–°å¢ `village` å­—æ®µï¼š
```json
{
  "forest": {
    "village": {
      "enabled": true,
      "style": "forest",
      "specialBuilding": "library",
      "npcCount": 2,
      "rewardItem": "golden_apple"
    }
  }
}
```

### 4.3 æ‰©å±• defaults.js

åœ¨ `MMWG_DEFAULTS.settings` ä¸­æ–°å¢ï¼š
```javascript
villageEnabled: true,        // æ‘åº„åŠŸèƒ½æ€»å¼€å…³
villageFrequency: 500,       // æ¯å¤šå°‘åˆ†å‡ºç°æ‘åº„
villageAutoSave: true,       // è¿›å…¥æ‘åº„è‡ªåŠ¨å­˜æ¡£
```

## äº”ã€ä»£ç æ¶æ„

### 5.1 æ–°å¢æ–‡ä»¶

```
src/modules/
â”œâ”€â”€ 18-village.js          # æ‘åº„æ ¸å¿ƒé€»è¾‘ï¼ˆç”Ÿæˆã€æ›´æ–°ã€äº¤äº’ï¼‰
â”œâ”€â”€ 18-village-render.js   # æ‘åº„æ¸²æŸ“ï¼ˆå»ºç­‘ã€NPCã€è£…é¥°ï¼‰
```

### 5.2 ä¿®æ”¹æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|---------|
| `Game.html` | å¼•å…¥ 18-village.jsã€18-village-render.jsï¼›æ–°å¢æ‘åº„äº¤äº’ UI |
| `src/modules/01-config.js` | æ–°å¢æ‘åº„ç›¸å…³å…¨å±€å˜é‡ |
| `src/modules/06-biome.js` | `updateCurrentBiome()` ä¸­è§¦å‘æ‘åº„æ£€æŸ¥ |
| `src/modules/09-vocab.js` | æ–°å¢ `getVillageWords()` å‡½æ•° |
| `src/modules/11-game-init.js` | åœ°å›¾ç”Ÿæˆä¸­æ’å…¥æ‘åº„åŒºåŸŸ |
| `src/modules/12-challenges.js` | æ–°å¢æ‘åº„æŒ‘æˆ˜å…¥å£ |
| `src/modules/13-game-loop.js` | æ›´æ–°å¾ªç¯ä¸­åŠ å…¥æ‘åº„é€»è¾‘ |
| `src/modules/14-renderer-main.js` | æ¸²æŸ“å¾ªç¯ä¸­åŠ å…¥æ‘åº„ç»˜åˆ¶ |
| `src/modules/16-events.js` | ç»‘å®šæ‘åº„äº¤äº’äº‹ä»¶ |
| `src/defaults.js` | æ–°å¢æ‘åº„é»˜è®¤é…ç½® |
| `src/storage.js` | æ–°å¢æ‘åº„å­˜æ¡£é€»è¾‘ |
| `config/village.json` | æ–°å¢æ‘åº„é…ç½®æ–‡ä»¶ |

### 5.3 æ¨¡å—ä¾èµ–å…³ç³»

```
config/village.json
       â†“
01-config.js (åŠ è½½é…ç½®ã€å£°æ˜å…¨å±€å˜é‡)
       â†“
18-village.js (æ‘åº„æ ¸å¿ƒé€»è¾‘)
  â”œâ”€â”€ ä¾èµ– 06-biome.js (è·å–å½“å‰ç¾¤ç³»)
  â”œâ”€â”€ ä¾èµ– 09-vocab.js (è·å–å•è¯)
  â”œâ”€â”€ ä¾èµ– 12-challenges.js (è§¦å‘å­¦ä¹ æŒ‘æˆ˜)
  â””â”€â”€ ä¾èµ– storage.js (å­˜æ¡£)
       â†“
18-village-render.js (æ‘åº„æ¸²æŸ“)
  â””â”€â”€ ä¾èµ– 14-renderer-main.js (Canvas ä¸Šä¸‹æ–‡)
       â†“
13-game-loop.js (è°ƒç”¨æ‘åº„ update)
14-renderer-main.js (è°ƒç”¨æ‘åº„ draw)
```

## å…­ã€äº¤äº’è®¾è®¡

### 6.1 è¿›å…¥æ‘åº„
- ç©å®¶èµ°å…¥æ‘åº„åŒºåŸŸæ—¶ï¼š
  - æ˜¾ç¤º Toastï¼š"ğŸ˜ï¸ è¿›å…¥XXæ‘åº„"
  - åœæ­¢åˆ·æ€ªï¼ˆsafeZone = trueï¼‰
  - æ˜¾ç¤ºæ‘åº„ä¸“å± UI æŒ‰é’®

### 6.2 æ‘åº„å†…äº¤äº’
- é è¿‘å»ºç­‘/NPC æ—¶æ˜¾ç¤ºäº¤äº’æç¤º
- é”®ç›˜ï¼šY é”®äº¤äº’ï¼ˆå¤ç”¨ç°æœ‰ interact é”®ï¼‰
- è§¦å±ï¼šæ˜¾ç¤º"äº¤äº’"æŒ‰é’®ï¼ˆå¤ç”¨ç°æœ‰è§¦æ§æŒ‰é’®ä½ç½®ï¼‰

### 6.3 ç¦»å¼€æ‘åº„
- ç©å®¶èµ°å‡ºæ‘åº„åŒºåŸŸæ—¶ï¼š
  - æ˜¾ç¤º Toastï¼š"ğŸ‘‹ ç¦»å¼€æ‘åº„"
  - æ¢å¤æ­£å¸¸åˆ·æ€ª
  - éšè—æ‘åº„ UI

## ä¸ƒã€ç§»åŠ¨ç«¯é€‚é…

1. **è§¦æ§æŒ‰é’®**ï¼šæ‘åº„å†…äº¤äº’æŒ‰é’®å¤ç”¨ `10-ui.js` çš„è§¦æ§æŒ‰é’®ç³»ç»Ÿï¼Œä»…åœ¨æ‘åº„å†…æ˜¾ç¤º
2. **æ€§èƒ½**ï¼šæ‘åº„å»ºç­‘é‡‡ç”¨æ‡’æ¸²æŸ“ï¼Œä»…å½“å»ºç­‘åœ¨è§†å£å†…æ—¶ç»˜åˆ¶
3. **UI ç¼©æ”¾**ï¼šæ ¹æ® `deviceMode` è‡ªåŠ¨è°ƒæ•´å»ºç­‘/NPC å¤§å°
4. **ç¦»çº¿æ”¯æŒ**ï¼šæ‘åº„é…ç½®å’Œå•è¯æ‰“åŒ…åˆ° `Game.offline.html`

## å…«ã€æ€§èƒ½è€ƒè™‘

1. æ‘åº„æ•°é‡é™åˆ¶ï¼šåŒæ—¶æœ€å¤šä¿ç•™ **3 ä¸ª**æ‘åº„å®ä¾‹ï¼Œè¶…å‡ºèŒƒå›´çš„è‡ªåŠ¨å›æ”¶
2. NPC æ›´æ–°ä¼˜åŒ–ï¼šä»…æ›´æ–°è§†å£å†…çš„ NPC
3. å»ºç­‘æ¸²æŸ“ï¼šä½¿ç”¨ Canvas åŸºæœ¬å›¾å½¢ç»˜åˆ¶ï¼Œæ— éœ€é¢å¤–è´´å›¾èµ„æº
4. ç¢°æ’æ£€æµ‹ï¼šå¤ç”¨ç°æœ‰ AABB ç¢°æ’ï¼Œæ‘åº„å»ºç­‘ä½œä¸ºå¹³å°/éšœç¢ç‰©
