# P3 执行计划：联调收尾

目标版本：v1.18.1（versionCode 102）
前置版本：v1.18.0（P2 完成后）

---

## Step 1：调试页更新（P3-1）

### 1.1 更新 GameDebug.html

操作：
1. 在 `apk/tests/debug-pages/GameDebug.html` 中补充以下快捷操作：
   - 一键切换群系（下拉选择 12 个群系，点击立即切换）
   - 一键设置群系轮次（输入框设置 `biomeVisitCount`，验证分层难度）
   - 一键触发指定 BOSS（下拉选择 wither/ghast/blaze/wither_skeleton）
   - 一键生成指定敌人（下拉选择敌人类型，含 drowned）
   - 一键触发单词挑战（可指定长词/短语/双空补全模式）
   - 显示当前群系停留分数和时间

2. 补充状态面板显示：
   - `biomeVisitCount` 各群系轮次
   - `biomeEntryScore` / `biomeEntryTime` 当前群系停留状态
   - `bossArena` 状态（active/viewportLocked/boss）

涉及文件：
- `apk/tests/debug-pages/GameDebug.html`

---

## Step 2：全量回归测试（P3-2）

### 2.1 回归测试清单

运行全部已有测试 + P0/P1/P2 新增测试：

```bash
# 全量运行
npm test

# 预期测试文件列表：
# tests/requirements.spec.js        ← 已有
# tests/login.spec.js               ← 已有
# tests/debug-actions.spec.js       ← 已有
# tests/village-integration.spec.js ← 已有
# tests/biomes-cherry-grove-freeze.spec.js ← 已有
# tests/biomes-fullrun.spec.js      ← 已有
# tests/p0-stability.spec.js        ← P0 新增
# tests/p1-experience.spec.js       ← P1 新增
# tests/p2-wither-boss.spec.js      ← P2 新增
# tests/p2-boss-visual.spec.js      ← P2 新增
```

验收标准：全部测试通过，0 失败

### 2.2 手动冒烟测试清单

| # | 场景 | 操作 | 预期结果 |
|---|------|------|---------|
| 1 | 树碰撞脱困 | 向右碰树 → 向左走 | 可以移动，不卡死 |
| 2 | 群系提示无乱码 | 依次进入沙漠/山地/火山 | toast 显示正常中文 |
| 3 | 樱花首轮低压 | 首次进入樱花丛林 | 只有蜜蜂，无中毒 |
| 4 | 樱花二轮升级 | 第二次进入樱花丛林 | 敌人种类增加，有中毒 |
| 5 | 蘑菇停留 | 进入蘑菇岛后快速加分 | 不会立即切走 |
| 6 | 海洋无树 | 进入海洋群系 | 无树木，有水草/珊瑚 |
| 7 | 海洋无爆炸 | 海洋中遇到敌人 | 无苦力怕，无爆炸 |
| 8 | 海洋溺尸 | 海洋中行走 | 可见溺尸实体 |
| 9 | 火山贴地 | 进入火山群系 | 装饰物与地面平齐 |
| 10 | 长词不溢出 | 触发长词挑战 | 选项按钮内文字不超出 |
| 11 | 双空补全 | 触发双字母补全 | 选项间有合理间隔 |
| 12 | 凋零可见 | 分数 2000 触发凋零 | 三头骨架清晰可见 |
| 13 | 凋零阶段 | 对凋零造成伤害 | 阶段切换有视觉反馈 |
| 14 | BOSS 锁定 | 进入 BOSS 战 | 视口锁定，不可逃离 |
| 15 | BOSS 击败 | 击败 BOSS | 视口解锁，恢复正常 |
| 16 | 恶魂外观 | 分数 4000 触发恶魂 | 方形大脸 + 触手可见 |
| 17 | 全群系遍历 | 从森林走到天空之城 | 无崩溃，无卡死 |

### 2.3 性能验证

操作：
1. 在 Chrome DevTools Performance 面板录制 30 秒游戏
2. 确认帧率稳定在 50+ FPS（桌面端）
3. 重点关注 BOSS 战渲染帧率（新增渲染复杂度）
4. 如有条件，在低端 Android 设备上测试

---

## Step 3：文档回填（P3-3）

### 3.1 更新总体执行计划

操作：
1. 在 `02-总体执行计划.md` 的进度追踪表中，填入所有阶段的完成日期、commit hash、测试结果
2. 将所有子任务状态按实际验收结果更新（未完成项保持 ⬜）

### 3.2 生成问题关闭清单

操作：
1. 对照原始需求 `游戏优化-0217.md` 的 22 条反馈，逐条标注关闭状态：

| 问题# | 描述 | 关闭版本 | 状态 |
|-------|------|---------|------|
| 1 | 树碰撞卡死 | v1.16.0 (P0) | ⬜ 待验收 |
| 2 | 樱花丛林太难 | v1.17.0 (P1) | ⬜ 待验收 |
| 3 | 群系难度无递进 | v1.17.0 (P1) | ⬜ 待验收 |
| 4 | 沙漠提示乱码 | v1.16.0 (P0) | ⬜ 待验收 |
| 6 | 蘑菇群系太短 | v1.17.0 (P1) | ⬜ 待验收 |
| 8 | 山地提示乱码 | v1.16.0 (P0) | ⬜ 待验收 |
| 10 | 海洋生态问题 | v1.17.0 (P1) | ⬜ 待验收 |
| 12 | 火山提示乱码 | v1.16.0 (P0) | ⬜ 待验收 |
| 13 | 火山悬浮 | v1.17.0 (P1) | ⬜ 待验收 |
| 15 | 单词溢出 | v1.17.0 (P1) | ⬜ 待验收 |
| 16 | 双空补全间隔 | v1.17.0 (P1) | ⬜ 待验收 |
| 19 | BOSS战可前进 | v1.16.0 (P0) | ⬜ 待验收 |
| 20 | 凋零不合理 | v1.18.0 (P2) | ⬜ 待验收 |
| 21 | 凋零形象 | v1.18.0 (P2) | ⬜ 待验收 |
| 22 | 其他BOSS优化 | v1.18.0 (P2) | ⬜ 待验收 |

### 3.3 记录参数变更

操作：
1. 汇总所有配置变更（`biomes.json` 新增字段、难度参数、阈值等）
2. 记录到本文档或单独的参数变更日志中

---

## Step 4：版本发布（P3-V）

### 4.1 更新版本号

- `apk/package.json`: `"version": "1.18.1"`
- `apk/android-app/package.json`: `"version": "1.18.1"`（CI release tag 来源）
- `apk/android-app/android/app/build.gradle`: `versionCode 102`, `versionName "1.18.1"`

### 4.2 更新版本记录

Progress.md 顶部插入：
```markdown
## v1.18.1（发布日期：2026-02-XX）
- 类型：PATCH
- APK 版本：versionName = 1.18.1，versionCode = 102
- 主要变更
  - 调试页更新：新增群系轮次/BOSS触发/挑战模式快捷操作
  - 全量回归测试通过（10 个 spec 文件）
  - 手动冒烟测试 17 项全部通过
  - 文档闭环：问题关闭清单 + 参数变更记录
  - 游戏优化-0217 全部需求关闭
```

CHANGELOG.md / VERSION-STATUS.md 同步更新。

### 4.3 Git 提交

```bash
git add apk/package.json apk/android-app/package.json apk/android-app/android/app/build.gradle \
       apk/tests/debug-pages/GameDebug.html \
       apk/docs/version/ \
       apk/docs/development/游戏优化-0217/
git commit -m "release(v1.18.1): P3 final - regression tests passed, docs closed"
git push origin main
```

### 4.4 更新总体计划进度

在 `02-总体执行计划.md` 中将 P3 行状态改为 ✅ 已完成。全部优化计划关闭。
