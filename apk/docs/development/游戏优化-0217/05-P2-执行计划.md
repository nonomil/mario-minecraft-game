# P2 执行计划：BOSS 世界观一致化

目标版本：v1.18.0（versionCode 101）
前置版本：v1.17.0（P1 完成后）

---

## Step 1：凋零外观重构（P2-1a）

### 1.1 重绘凋零渲染函数

操作：
1. 在 `apk/src/modules/15-entities-boss.js` 中定位 `WitherBoss` 的 `render(ctx, camX)` 方法
2. 替换当前纯矩形渲染为 Minecraft 风格 T 形三头骨架：

```js
render(ctx, camX) {
    const x = this.x - camX, y = this.y;
    const phase = this.phase; // 1/2/3

    // 颜色方案
    const bodyColor = phase >= 2 ? '#2A0A0A' : '#1A1A1A';
    const headColor = phase >= 2 ? '#3A0D0D' : '#0D0D0D';
    const eyeColor = phase >= 3 ? '#FF0000' : (phase >= 2 ? '#FF4444' : '#4488FF');

    // 中央躯干（竖直长条）
    ctx.fillStyle = bodyColor;
    ctx.fillRect(x + 36, y + 30, 24, 50);

    // 左右肋骨延伸（T 形横杆）
    ctx.fillRect(x + 8, y + 32, 80, 16);

    // 肋骨条纹
    ctx.fillStyle = '#333';
    for (let i = 0; i < 4; i++) {
        ctx.fillRect(x + 38, y + 40 + i * 10, 20, 2);
    }

    // 中间主头（较大）
    ctx.fillStyle = headColor;
    ctx.fillRect(x + 30, y, 36, 32);
    // 主头面部
    ctx.fillStyle = '#2A2A2A';
    ctx.fillRect(x + 34, y + 8, 28, 20);
    // 主头眼睛
    ctx.fillStyle = eyeColor;
    ctx.fillRect(x + 38, y + 12, 6, 6);
    ctx.fillRect(x + 52, y + 12, 6, 6);
    // 主头嘴
    ctx.fillStyle = '#1A1A1A';
    ctx.fillRect(x + 42, y + 22, 12, 4);

    // 左副头（较小）
    ctx.fillStyle = headColor;
    ctx.fillRect(x, y + 10, 24, 22);
    ctx.fillStyle = eyeColor;
    ctx.fillRect(x + 4, y + 16, 4, 4);
    ctx.fillRect(x + 14, y + 16, 4, 4);

    // 右副头（较小）
    ctx.fillStyle = headColor;
    ctx.fillRect(x + 72, y + 10, 24, 22);
    ctx.fillStyle = eyeColor;
    ctx.fillRect(x + 76, y + 16, 4, 4);
    ctx.fillRect(x + 86, y + 16, 4, 4);

    // 阶段 3：裂纹 + 闪烁
    if (phase >= 3) {
        ctx.strokeStyle = '#FF6600';
        ctx.lineWidth = 1;
        // 躯干裂纹
        ctx.beginPath();
        ctx.moveTo(x + 40, y + 35);
        ctx.lineTo(x + 50, y + 55);
        ctx.lineTo(x + 45, y + 70);
        ctx.stroke();
        // 闪烁效果
        if (Math.random() > 0.5) {
            ctx.globalAlpha = 0.3;
            ctx.fillStyle = '#FF0000';
            ctx.fillRect(x - 4, y - 4, 104, 88);
            ctx.globalAlpha = 1.0;
        }
    }
}
```

涉及文件：
- `apk/src/modules/15-entities-boss.js`

### 1.2 调整凋零尺寸与生成位置

操作：
1. 凋零尺寸保持 96x96，但生成 y 坐标下调至画面中上方（约 `canvasHeight * 0.2`），确保玩家能看到
2. 凋零的悬浮高度在 BOSS 战区域内上下缓动，增加存在感

涉及文件：
- `apk/src/modules/15-entities-boss.js`（WitherBoss constructor + update）

---

## Step 2：凋零攻击视觉优化（P2-1b）

### 2.1 投射物改为凋零之首

操作：
1. 在 `WitherBoss` 的投射物渲染中，替换黑色方块为骷髅头造型：
   ```js
   renderProjectile(ctx, proj) {
       const px = proj.x, py = proj.y, s = proj.size;
       // 骷髅头轮廓
       ctx.fillStyle = proj.tracking ? '#6644AA' : '#1A1A1A';
       ctx.fillRect(px, py, s, s);
       // 眼睛
       ctx.fillStyle = proj.tracking ? '#AA88FF' : '#444';
       ctx.fillRect(px + 2, py + 3, 3, 3);
       ctx.fillRect(px + s - 5, py + 3, 3, 3);
       // 拖尾粒子（3个渐隐小方块）
       ctx.globalAlpha = 0.6;
       ctx.fillStyle = proj.tracking ? '#8866CC' : '#333';
       ctx.fillRect(px - proj.velX * 3, py - proj.velY * 3, s * 0.6, s * 0.6);
       ctx.globalAlpha = 0.3;
       ctx.fillRect(px - proj.velX * 6, py - proj.velY * 6, s * 0.4, s * 0.4);
       ctx.globalAlpha = 1.0;
   }
   ```
2. 追踪弹使用紫色系配色，普通弹使用黑色系

涉及文件：
- `apk/src/modules/15-entities-boss.js`

### 2.2 冲撞攻击冲击波

操作：
1. 在凋零冲撞攻击命中时，生成扩散圆环效果：
   ```js
   // 冲撞命中后
   this.shockwave = { x: this.x + 48, y: this.y + 48, radius: 10, maxRadius: 80, alpha: 0.8 };
   ```
2. 在 render 中绘制冲击波：
   ```js
   if (this.shockwave) {
       ctx.strokeStyle = `rgba(100, 0, 200, ${this.shockwave.alpha})`;
       ctx.lineWidth = 3;
       ctx.beginPath();
       ctx.arc(this.shockwave.x, this.shockwave.y, this.shockwave.radius, 0, Math.PI * 2);
       ctx.stroke();
       this.shockwave.radius += 4;
       this.shockwave.alpha -= 0.04;
       if (this.shockwave.alpha <= 0) this.shockwave = null;
   }
   ```

涉及文件：
- `apk/src/modules/15-entities-boss.js`

---

## Step 3：其他 BOSS 视觉优化（P2-2）

### 3.1 恶魂（Ghast）重绘

操作：
1. 定位 `GhastBoss` 的 `render()` 方法
2. 替换为 Minecraft 风格：
   - 方形大脸（白色 64x64）
   - 9 条下垂触手（灰白色，长度不一，轻微摆动）
   - 表情切换：闭眼（默认）→ 张嘴红眼（攻击时）→ 流泪（哭泣状态）
   - 火球渲染改为橙红色球体 + 火焰拖尾

涉及文件：
- `apk/src/modules/15-entities-boss.js`

### 3.2 烈焰人（Blaze）重绘

操作：
1. 定位 `BlazeBoss` 的 `render()` 方法
2. 替换为：
   - 黄色发光核心（中心亮，边缘渐暗）
   - 12 根环绕烈焰棒（金色长条，绕核心旋转，角度均匀分布）
   - 火焰粒子效果（核心周围随机生成上升的橙色小方块）
   - 攻击时烈焰棒旋转加速

涉及文件：
- `apk/src/modules/15-entities-boss.js`

### 3.3 凋灵骷髅（Wither Skeleton）重绘

操作：
1. 定位 `WitherSkeletonBoss` 的 `render()` 方法
2. 替换为：
   - 高瘦黑色骷髅身形（48x96，比例修长）
   - 头部：黑色骷髅头 + 红色眼睛
   - 手持石剑（灰色剑形，攻击时挥动动画）
   - 煤灰粒子（身体周围缓慢飘落的深灰色小点）
   - 格挡状态：举盾姿态 + 蓝色护盾光效

涉及文件：
- `apk/src/modules/15-entities-boss.js`

### 3.4 统一阶段反馈

操作：
1. 所有 BOSS 阶段切换时统一播放：
   - 屏幕短暂闪白（100ms）
   - 顶部提示条更新阶段文案
   - BOSS 短暂无敌（30 帧）+ 身体闪烁
2. 确认 4 个 BOSS 的阶段门槛、反制窗口、奖励强度风格一致

涉及文件：
- `apk/src/modules/15-entities-boss.js`（各 BOSS 类）

---

## Step 4：Playwright 测试（P2-T）

### 4.1 编写测试用例

创建 `tests/p2-wither-boss.spec.js` 与 `tests/p2-boss-visual.spec.js`：

```js
// tests/p2-wither-boss.spec.js
// 测试 0：凋零基本触发与战斗状态
test('凋零BOSS可触发并进入战斗状态', async ({ page }) => {
  // debug 设置分数 2000 → 触发凋零
  // 验证 bossArena.active === true
  // 验证 bossArena.boss 存在且为 wither
});

// tests/p2-wither-boss.spec.js
// 测试 1：凋零三头可见
test('凋零BOSS可见且有三头', async ({ page }) => {
  // debug 设置分数 2000 → 触发凋零
  // 验证 bossArena.active === true
  // 验证 bossArena.boss 存在且为 wither
  // 截图验证凋零在画面中可见
});

// 测试 2：凋零阶段切换
test('凋零阶段切换有反馈', async ({ page }) => {
  // 触发凋零 → 对凋零造成伤害至 60% HP
  // 验证 phase 变为 2
  // 继续伤害至 20% HP → 验证 phase 变为 3
});

// 测试 3：各 BOSS 可触发
test('四个BOSS均可触发', async ({ page }) => {
  // 依次设置分数 2000/4000/6000/8000
  // 验证每个 BOSS 的 bossArena.boss 类型正确
  // 每个 BOSS 截图存档
});
```

### 4.2 运行测试

```bash
npm test -- tests/p2-wither-boss.spec.js tests/p2-boss-visual.spec.js
```

验收标准：全部测试通过

---

## Step 5：版本发布（P2-V）

### 5.1 更新版本号

- `apk/package.json`: `"version": "1.18.0"`
- `apk/android-app/package.json`: `"version": "1.18.0"`（CI release tag 来源）
- `apk/android-app/android/app/build.gradle`: `versionCode 101`, `versionName "1.18.0"`

### 5.2 更新版本记录

Progress.md 顶部插入：
```markdown
## v1.18.0（发布日期：2026-02-XX）
- 类型：MINOR
- APK 版本：versionName = 1.18.0，versionCode = 101
- 主要变更
  - 凋零 BOSS 重绘：T 形三头骨架 + 阶段演出 + 凋零之首投射物
  - 恶魂重绘：方形大脸 + 9 触手 + 表情切换
  - 烈焰人重绘：发光核心 + 12 环绕烈焰棒 + 火焰粒子
  - 凋灵骷髅重绘：高瘦骷髅 + 石剑 + 格挡光效
  - 统一 BOSS 阶段切换反馈
  - 新增 Playwright P2 BOSS 视觉测试
```

CHANGELOG.md / VERSION-STATUS.md 同步更新。

### 5.3 Git 提交

```bash
git add apk/package.json apk/android-app/package.json apk/android-app/android/app/build.gradle \
       apk/src/modules/15-entities-boss.js \
       apk/docs/version/ tests/p2-wither-boss.spec.js tests/p2-boss-visual.spec.js \
       apk/docs/development/游戏优化-0217/02-总体执行计划.md
git commit -m "release(v1.18.0): P2 boss visual - wither/ghast/blaze/wither_skeleton redesign"
git push origin main
```

### 5.4 更新总体计划进度

在 `02-总体执行计划.md` 中将 P2 行状态改为 ✅ 已完成。
