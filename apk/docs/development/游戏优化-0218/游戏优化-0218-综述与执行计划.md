# 游戏优化-0218：综述与执行计划（不改代码版）

日期：2026-02-18  
范围：`apk` 项目（村庄系统 + 触控操控系统）  
输入来源：`apk/docs/development/游戏优化-0218/游戏优化-0218.md`

## 1. 背景与目标

当前需求聚焦两件事：

1. 村庄从“建筑辨识度不足、区域感弱”升级为“多房屋、可进入、具备床位回血”的区域体验。  
2. 触控按钮布局按设备优化：平板维持底部；手机将左右移动按钮上移到更易单手操作的位置；优先自动识别设备，必要时允许手动切换。

本文档目标是输出可执行的综述计划，先统一方案与边界，不直接改代码。

## 2. 当前实现现状（代码基线）

### 2.1 村庄系统现状

- 村庄核心逻辑位于：`apk/src/modules/18-village.js`
- 村庄渲染位于：`apk/src/modules/18-village-render.js`
- 配置位于：`apk/config/village.json`

现状结论：

1. 村庄已存在，但形态是“固定结构+横向排列”，不是可进入的空间化场景。  
2. 建筑类型当前固定，基础配置以 `bed_house`、`word_house`、`save_stone`、`special` 为主。  
3. “休息回血”逻辑已实现，但触发机制是“靠近建筑后交互”，并非“进入房屋后躺床”流程。  
4. 村庄渲染以外立面与装饰为主，缺少室内层、入口切换、房间状态管理。

### 2.2 触控系统现状

- 触控事件绑定：`apk/src/modules/16-events.js`
- 触控显示与布局策略：`apk/src/modules/16-events.js` + `apk/src/styles.css`
- 触控样式：`apk/src/styles.css`
- 触控结构：`apk/Game.html`

现状结论：

1. 触控按钮功能完整（移动、跳跃、攻击、交互、切换、用钻石）。  
2. 当前布局为固定底部：左右与右侧动作区都锚定 `bottom: 20px`。  
3. 已有 `settings.touchControls` 开关，但没有“phone/tablet布局模式”策略层。  
4. 配置里存在 `deviceMode` 概念，但尚未形成可落地的自动判定和布局联动。

## 3. 问题综述（按优先级）

### P0（必须先解决）

1. **蘑菇岛崩溃 Bug（已修复 ✅）**：进入蘑菇岛时 `spawnEnemyByDifficulty` 抛出 `ReferenceError: take is not defined`，游戏直接崩溃。根因是 `if` 分支 fallback 引用了 `else` 分支才定义的变量，且 `biomePools` 缺少 `mushroom_island` 条目。已在 `11-game-init.js` 中修复（apk + 根目录）。
2. **村庄体验与需求不匹配**：现有表现不足以支撑"多房屋可进入、床位回血"的核心玩法意图。
3. **手机触控可用性不足**：固定底部布局在单手握持时，左右按钮触达不理想。
4. **缺少设备分型策略**：无自动判定与手动兜底切换机制，无法稳定覆盖手机与平板差异。

### P1（高优先）

1. **村庄交互语义不清**：目前是“靠近建筑交互”，新目标要求“进入房屋后再交互”。  
2. **配置与实现耦合偏高**：布局和建筑结构偏写死，后续扩展成本高。

### P2（中优先）

1. **可观测性不足**：缺少针对设备模式判定、触控布局切换、村庄进出状态的统一日志/调试出口。  
2. **回归测试口径不足**：缺少明确验收脚本与边界案例清单。

## 4. 目标定义（建议冻结）

### 4.1 村庄目标（MVP）

1. 村庄至少包含多个可识别房屋（视觉上明显区别于宝箱/散点装饰）。  
2. 提供“入口触发 -> 入室状态 -> 床位交互回血 -> 退出”的完整链路。  
3. 床回血保留现有规则（满血提示、单村一次等），但触发前提改为“室内床位”。

### 4.2 触控目标（MVP）

1. 平板：保持当前底部布局。  
2. 手机：左右按钮上移至屏幕中下段（而非紧贴底边）。  
3. 提供 `auto`（默认）+ 手动切换（`phone-mid` / `tablet-bottom`）两层控制。

## 5. 方案总览（不改代码，先定设计）

## 5.1 村庄系统重构思路

从“装饰型对象”升级为“区域状态机”：

1. `World Village`：世界中的村庄区域（入口、建筑分布、NPC、安全区）。  
2. `Building Instance`：建筑实例（类型、门口点、可交互点、室内映射）。  
3. `Interior State`：室内状态（当前房屋ID、玩家位置约束、室内交互表）。

交互流程建议：

1. 玩家接近门口 -> 显示“进入”提示。  
2. 触发进入 -> 切换到该房屋室内状态。  
3. 室内接近床位 -> 显示“躺下回血”提示并执行回血逻辑。  
4. 退出室内 -> 返回村庄外部坐标点。

## 5.2 触控布局策略思路

新增“布局策略层”，不改交互动作映射：

1. 布局模式：`auto | phone-mid | tablet-bottom`  
2. 自动判定依据建议：  
   - 最短边（CSS px）  
   - 宽高比  
   - 可视视口（`visualViewport`）  
3. 样式控制建议：由 CSS 变量驱动触控纵向定位，避免硬编码 `bottom: 20px`。

## 6. 分阶段执行计划

### 阶段 A：需求冻结与技术评审（0.5 天）

输出：

1. 设备判定阈值草案（phone/tablet）。  
2. 室内交互最小流程图（进入、躺床、退出）。  
3. 旧逻辑兼容清单（宝箱、挑战、存档、村庄buff）。

通过标准：

1. 目标行为可一句话定义，评审后不再反复变更。  
2. 能明确哪些属于本期，哪些延后。

### 阶段 B：触控布局策略先行（1 天）

目标：

1. 先解决手机手持操作问题，快速产生用户可感知收益。  
2. 保持现有触控事件逻辑不变，减少风险面。

产出：

1. 自动判定 + 手动覆盖的设置项方案。  
2. 布局变量方案与适配矩阵（手机竖屏/横屏、平板竖屏/横屏）。

验收：

1. 手机下左右按钮明显上移，单手连续移动操作稳定。  
2. 平板底部布局保持不退化。

### 阶段 C：村庄外观升级（1~1.5 天）

目标：

1. 村庄“多房屋区域化”落地，提升建筑辨识度与区域感。  
2. 保持现有村庄生成节奏与性能稳定。

产出：

1. 建筑模板池（至少 2~3 套外观差异）。  
2. 村庄内建筑分布规则（宽度、间距、高度层次）。

验收：

1. 玩家可明显感知“村庄区域”而非单点建筑。  
2. 不出现渲染异常、穿模、碰撞失真。

### 阶段 D：室内与床交互闭环（1.5~2 天）

目标：

1. 实现“进入房屋 -> 躺床回血 -> 退出”的完整交互链。  
2. 与现有回血/存档/挑战机制兼容。

产出：

1. 室内状态管理方案。  
2. 床交互点与回血触发规则。  
3. 退出机制（按钮/门口/超时可选其一或组合）。  
4. 摄像机策略（室内固定/跟随切换）与恢复策略。  
5. 碰撞与生成策略（室内时敌人生成/室外碰撞处理的屏蔽与恢复）。  

验收：

1. 仅在室内床位可触发“躺床回血”。  
2. 满血、已使用等分支提示一致且无歧义。  
3. 室内外切换时摄像机、碰撞、刷怪逻辑无异常。  

### 阶段 E：回归与发布准备（1 天）

目标：

1. 把功能可用转为稳定可发布。  
2. 固化测试口径，避免后续回归。

产出：

1. 回归脚本：触控、村庄、挑战、存档、横竖屏切换。  
2. 风险复核记录与发布说明草稿。

## 7. 风险与规避

1. **性能风险**：多建筑与室内切换可能增加渲染/状态开销。  
规避：先做最小室内模型，限制同屏活跃对象数量。

2. **交互冲突风险**：新“进入房屋”可能与现有“附近交互”冲突。  
规避：统一交互优先级，先入口状态再建筑动作。  

3. **设备误判风险**：自动识别 phone/tablet 边界机型可能误分。  
规避：提供手动覆盖；记录调试日志便于快速修正阈值。

4. **回归风险**：触控布局调整可能影响既有触屏响应。  
规避：保持事件绑定不动，优先改布局策略层与样式变量层。  
5. **范围蔓延风险**：NPC 行为增强会显著扩大改动面。  
规避：本期明确不改 NPC 行为，只做村庄空间与交互主链路。  

## 8. 测试与验收标准（建议）

### 8.1 功能验收

1. 村庄包含多房屋，且可进入至少一个室内。  
2. 仅在室内床位触发“躺下回血”。  
3. 手机默认采用中部偏下布局；平板默认底部布局。  
4. 设置可手动切换布局模式，并立即生效。

### 8.2 稳定性验收

1. 连续 10 分钟游戏无明显掉帧、无输入失效。  
2. 横竖屏切换后触控布局不漂移、不遮挡关键 UI。  
3. 村庄进出不会导致角色卡死、碰撞错位、状态丢失。

### 8.3 回归验收

1. 宝箱开箱、答题挑战、背包使用、村庄存档均正常。  
2. BOSS 战与环境切换不受村庄重构影响。  
3. 旧存档可继续游玩，不出现关键字段缺失崩溃。

## 9. 实施优先级建议

1. **先做触控布局策略（阶段B）**：投入小、收益快，直接改善手机手感。  
2. **再做村庄外观（阶段C）**：先完成“像村庄”的视觉目标。  
3. **最后做室内闭环（阶段D）**：把“躺床回血”做成完整交互，不仓促拼接。

## 10. 本文档结论

这次需求本质是“两个系统升级”：

1. 村庄系统从“装饰与近距交互”升级为“可进入空间交互系统”。  
2. 触控系统从“单布局”升级为“设备自适应 + 手动兜底”的策略系统。

建议按“先触控、后村庄外观、再室内闭环”推进，既能快速交付可感知改进，也能控制结构性改动风险。
