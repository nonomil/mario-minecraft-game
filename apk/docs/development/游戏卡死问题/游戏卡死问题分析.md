# 游戏卡死问题分析（重点：樱花丛林 cherry_grove）

## 1. 现象描述

用户反馈：
- 主角没有碰撞任何物体
- 进入樱花丛林（`cherry_grove`）后走几步就“卡死”
- 卡死后按钮/操作无响应
- 该问题反复出现，多次修复后仍复现

这里的“卡死”更符合 **主循环停止刷新（freeze）** 的表现，而不是传统意义的“碰撞被卡住不能走”：
- 如果 `requestAnimationFrame` 循环中的 `update()` 或 `draw()` 抛出未捕获异常，后续帧不会继续调度
- 画面会停留在异常发生的那一帧，看起来像“跳起卡在空中”“前进卡住”“按键没反应”

## 2. 结论（已验证的根因）

### 2.1 核心根因：樱花树 `CherryTree` 继承链错误导致运行时异常

在 `apk/src/modules/21-decorations-new.js` 中：
- `class CherryTree extends Tree`
- `CherryTree.reset()` 内调用了 `this.resetBase(...)`

但 `Tree` 基类（`apk/src/modules/15-entities-base.js`）并没有 `resetBase()` 方法。
`resetBase()` 属于装饰实体基类 `Decoration`（`apk/src/modules/15-entities-decorations.js`）。

因此，只要樱花丛林的装饰生成路径触发到“樱花树”分支，就会抛出异常：
- `TypeError: this.resetBase is not a function`

一旦异常在 RAF 主循环中未捕获抛出，就会造成整局 freeze，表现为“卡死”。

### 2.2 Playwright 实测复现与栈追踪（确定性）

通过 Playwright（Headless Chromium）对 `apk/Game.html` 做了最小化、确定性复现：
- 将 `Math.random()` 固定为 `0.1`，确保樱花丛林装饰生成走到 `cherry_tree` 分支
- 直接调用 `spawnBiomeDecoration('cherry_grove', 800, groundY, groundY)`

得到的异常信息（关键片段）：
- `this.resetBase is not a function`
- 栈路径命中：
  - `CherryTree.reset (src/modules/21-decorations-new.js:15)`
  - `new CherryTree (src/modules/21-decorations-new.js:11)`
  - `spawnCherryGroveDecoration (src/modules/21-decorations-new.js:474)`
  - `spawnBiomeDecoration (src/modules/21-decorations-new.js:451)`
  - `spawnDecoration/getPooledDecoration (src/modules/15-entities-base.js:235/228)`

说明：这是“必现型 bug”，不是概率性竞态。
只要触发樱花树生成就会异常。

## 3. 为什么进入樱花丛林后“走几步就卡死”

樱花丛林的装饰物配置在 `apk/config/biomes.json`：
- `cherry_tree: 0.35`
- `flower_cluster: 0.15`
- `butterfly: 0.15`
- `small_stream: 0.08`

地图生成流程在 `apk/src/modules/11-game-init.js`：
- `generatePlatform()` 每生成一段地面都会调用 `generateBiomeDecorations()`
- `generateBiomeDecorations()` 对每种装饰按概率触发生成
- 对 `cherry_tree/flower_cluster/butterfly/small_stream` 这类“新群系装饰”会调用 `spawnBiomeDecoration(...)`

因此：
- 玩家向前移动触发持续生成平台
- 樱花丛林装饰生成概率较高
- “樱花树分支”一旦被随机到，就会抛异常
- RAF 循环没有兜底捕获异常 -> 立刻 freeze

这解释了：
- “有时跳起来卡住”：异常发生在跳起那一帧，画面就停在空中
- “有时正常前进卡住”：异常发生在地面行走中某一帧，画面就停在行走中

## 4. 扩展风险：蘑菇岛等群系可能存在同类卡死

同文件 `apk/src/modules/21-decorations-new.js` 中：
- `class GiantMushroom extends Tree` 同样调用 `this.resetBase(...)`

如果该对象通过 `spawnBiomeDecoration('mushroom_island', ...)` 进入同一路径，也会触发同类异常，导致 freeze。
当前用户主要在樱花丛林触发，是因为樱花丛林更容易/更早触发到相关装饰生成。

## 5. 已排除/降低优先级的猜测点

### 5.1 蜜蜂 `BeeEnemy.startY` 未初始化导致 NaN（在当前 apk 构建中不成立）

此前怀疑 `BeeEnemy` 使用 `this.startY` 但基类未赋值。
实际检查发现 `Enemy` 构造函数中已设置 `this.startY = y`（`apk/src/modules/15-entities-combat.js`），因此该点不是樱花丛林卡死根因。

## 6. 人工验证步骤（不改代码）

### 6.1 桌面浏览器快速验证（最直接）

打开 `apk/Game.html`，打开 DevTools Console，执行：

```js
const r0 = Math.random;
Math.random = () => 0.1;
spawnBiomeDecoration('cherry_grove', 800, groundY, groundY);
Math.random = r0;
```

预期：
- 控制台出现 `TypeError: this.resetBase is not a function`
- 若异常发生在主循环中，画面会停止刷新（freeze）

### 6.2 DevTools 断点验证（定位到首次触发帧）

在 Chrome/Edge DevTools：
- 打开 “Pause on exceptions”
- 进入樱花丛林并向右移动

预期：
- 首次卡死会直接暂停在 `CherryTree.reset()` 的 `this.resetBase(...)` 行

## 7. 修复方向（仅方案，不在本阶段改代码）

必须满足的约束：
- `spawnBiomeDecoration()` 生成的对象如果进入 `decorations` 列表，则必须具备 `update()`，并且其初始化方法必须可用（不能调用不存在的 `resetBase()`）

两个可行的根修复方向（择一即可）：
1. 让 `CherryTree/GiantMushroom` 改为继承 `Decoration`，并实现/复用 `resetBase()` + `update()` 语义
2. 为 `Tree` 基类补齐 `resetBase()`（并确保与 `Tree` 的构造/坐标模型一致），同时保证被放入 `decorations` 的对象具备 `update()`

注意：
- 当前 `spawnCherryGroveDecoration()` 使用 `spawnDecoration(...)`，产物进入 `decorations`；这天然要求“装饰实体契约”
- 如果希望“樱花树”走 `trees` 列表（像普通树那样参与碰撞/受击），则生成路径和渲染路径也需要一起统一（否则会出现类型名不一致、更新链路不一致）

## 8. 涉及文件清单（便于后续修复定位）

- `apk/config/biomes.json`（`cherry_grove` 装饰概率）
- `apk/src/modules/11-game-init.js`（`generateBiomeDecorations()` 调用 `spawnBiomeDecoration()`）
- `apk/src/modules/21-decorations-new.js`（`CherryTree/GiantMushroom` 定义与 `spawnCherryGroveDecoration()`）
- `apk/src/modules/15-entities-base.js`（`Tree` 基类、`spawnDecoration/getPooledDecoration`）
- `apk/src/modules/15-entities-decorations.js`（`Decoration.resetBase()`/`Decoration.update()`）
- `apk/src/modules/14-renderer-main.js`（RAF 驱动：`requestAnimationFrame(() => { update(); draw(); })`）
