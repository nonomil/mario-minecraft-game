# 游戏优化综合计划 (2026-02-17)

> 说明：本稿已完成审查，执行请优先参考  
> `apk/docs/development/游戏优化-0217/01-游戏优化-0217-综合审查与修订计划.md`

## 一、问题总览

根据 `游戏优化-0217.md` 中列出的 22 条反馈，结合代码分析，归纳为以下 7 大类：

| 类别 | 涉及问题编号 | 优先级 | 核心文件 |
|------|-------------|--------|---------|
| A. 碰撞与移动 | #1 | P0 | `13-game-loop.js`, `15-entities-base.js` |
| B. 群系难度分级 | #2, #3 | P1 | `05-difficulty.js`, `06-biome.js`, `biomes.json`, `11-game-init.js` |
| C. 中文乱码 | #4, #8, #12 | P0 | `Game.html`, `06-biome.js`, `13-game-loop.js`, `build-singlefile.js` |
| D. 群系时长与切换 | #6 | P1 | `06-biome.js`, `biomes.json` |
| E. 海洋群系实体 | #10 | P1 | `15-entities-particles.js`, `15-entities-combat.js`, `11-game-init.js`, `21-decorations-new.js` |
| F. 单词测验 UI | #15, #16 | P1 | `12-challenges.js`, `styles.css` |
| G. BOSS 战系统 | #19, #20, #21, #22 | P0/P2 | `15-entities-boss.js`, `14-renderer-main.js`, `13-game-loop.js` |
| H. 火山群系悬浮 | #13 | P1 | `11-game-init.js`, `21-decorations-new.js`, `06-biome.js` |
| I. 测试与收尾 | — | P3 | `GameDebug.html`, 文档 |

---

## 二、各类问题分析与方案

---

### A. 碰撞与移动（问题 #1）

**现象**：向右走碰到树后，向左也走不了，必须砍掉树才能移动。

**代码分析**：
- `13-game-loop.js:173-198` 树干碰撞检测使用 `colCheckRect`，碰撞时直接 `player.velX = 0`
- 问题在于：碰撞检测只判断"是否重叠"，不区分碰撞方向与玩家移动方向
- 玩家向右碰树后嵌入树干 hitbox，此时向左移动仍检测到重叠，继续置零速度

**修复方案**：
1. 在树干碰撞处理中加入方向判断：只在玩家移动方向与碰撞方向一致时才阻止移动
2. 具体逻辑：`colCheckRect` 返回碰撞方向 `"l"/"r"`，若返回 `"r"`（玩家在树左侧）则只阻止向右移动，反之亦然
3. 增加位置修正：碰撞后将玩家推出树干 hitbox，避免嵌入

**改动范围**：`13-game-loop.js` 树干碰撞处理段（约 20 行）

---

### B. 群系难度分级（问题 #2, #3）

**现象**：樱花丛林首次进入就有大量蜜蜂、中毒敌人，难度过高。所有群系每轮都一样，缺乏挑战递进。

**代码分析**：
- 当前难度系统（`05-difficulty.js`）是纯积分驱动的全局难度，不区分群系
- 群系配置（`biomes.json`）中没有敌人种类/数量的分级定义
- 群系切换通过 `cycle = floor(score / stepScore)` 循环，但没有"第几轮"的概念

**修复方案**：
1. **引入群系轮次概念**：在 `06-biome.js` 中记录每个群系被访问的次数 `biomeVisitCount[biomeId]`
2. **群系内敌人分级表**：在 `biomes.json` 中为每个群系增加 `enemyTiers` 配置：
   ```json
   "cherry_grove": {
     "enemyTiers": [
       { "round": 1, "types": ["bee"], "spawnRate": 0.5, "poison": false },
       { "round": 2, "types": ["bee", "spore_bug"], "spawnRate": 0.8, "poison": true },
       { "round": 3, "types": ["bee", "spore_bug", "fox"], "spawnRate": 1.0, "poison": true }
     ]
   }
   ```
3. **修改敌人生成逻辑**：在 `11-game-init.js` 或敌人生成函数中，根据 `biomeVisitCount` 查询当前群系的敌人分级，决定生成哪些敌人、生成频率
4. **与全局难度叠加**：群系分级控制敌人种类和基础数量，全局难度系统控制数值缩放（伤害、血量倍率）

**改动范围**：`biomes.json`（配置）、`06-biome.js`（轮次追踪）、`05-difficulty.js`（分级查询接口）、`11-game-init.js`（敌人生成）

---

### C. 中文乱码（问题 #4, #8, #12）

**现象**：进入沙漠、山地、火山群系时，系统提示框显示乱码。

**代码分析**：
- `showToast()` 使用 `innerText` 设置文本，本身不会导致编码问题
- 中文字符串直接写在 JS 源码中，依赖文件编码为 UTF-8
- `tools/build-singlefile.js` 构建单文件时，可能在读取/拼接过程中破坏 UTF-8 编码
- 另一种可能：某些群系的提示文本使用了 `String.fromCharCode` 或转义序列拼接，导致乱码
- **`apk/Game.html` 自身已存在大量静态乱码文本**（非动态生成），属于源文件级编码损坏，必须优先排查

**排查与修复方案**：
1. **排查 Game.html 源文件**：逐行检查 `apk/Game.html` 中已损坏的中文字面量，直接修正为正确中文
2. **排查构建脚本**：检查 `build-singlefile.js` 中 `fs.readFileSync` 是否指定了 `'utf-8'` 编码
3. **排查提示文本来源**：在 `06-biome.js` 和 `13-game-loop.js` 中搜索沙漠/山地/火山群系切换时的 `showToast` 调用，确认文本是否为正常中文字面量
4. **检查 HTML charset**：确认 `Game.html` 中 `<meta charset="UTF-8">` 存在且位于 `<head>` 最前面
5. **建立文案治理规则**：所有中文文案统一收敛到配置/常量定义处（如 `BIOME_MESSAGES`、`UI_TEXTS` 等对象），JS 逻辑代码中不再散落中文字面量，从根源上避免后续乱码和遗漏

**改动范围**：`Game.html`（源文件乱码修正）、`06-biome.js`（提示文本集中化）、`build-singlefile.js`（编码检查）、各模块（文案抽取）

---

### D. 群系时长与切换（问题 #6）

**现象**：蘑菇群系太短，很快就切换到山地群系。

**代码分析**：
- `06-biome.js` 中群系切换逻辑：`cycle = floor(score / stepScore)`，`stepScore = 200`
- 每积累 200 分就切换一次群系，不考虑在当前群系停留的时间或距离
- 蘑菇岛解锁分数 550，山地解锁分数 800，间隔仅 250 分（约 1 个 stepScore 周期）

**修复方案**：
1. **增加最小停留双阈值机制**：为每个群系增加 `minStayScore`（最少需要在该群系内获得的分数）和 `minStayTimeSec`（最少停留秒数），两个条件同时满足才允许切换，避免单一阈值失真
2. **调整 stepScore 或解锁分数间距**：拉大相邻群系的解锁分数差距，如蘑菇岛 550 → 山地 900
3. **推荐方案**：在 `getBiomeIdForScore()` 中增加判断，只有当前群系内积分超过 `minStayScore` 且停留时间超过 `minStayTimeSec` 后才允许切换

**改动范围**：`06-biome.js`（切换逻辑、停留时间追踪）、`biomes.json`（增加 `minStayScore` + `minStayTimeSec` 配置）

---

### E. 海洋群系实体（问题 #10）

**现象**：海底有树（不合理）、缺少水草/珊瑚、水里有苦力怕和爆炸、设计中的鱼/海星/溺尸未出现。

**代码分析**：
- 海洋群系配置中 `treeTypes` 未设置为空，可能继承了默认的树生成逻辑
- `15-entities-particles.js` 中只实现了 `CodFish` 和 `Squid`，没有溺尸（Drowned）实体
- `biomes.json` 中海洋的 `decorations` 包含 `shell/starfish/seaweed/boat`，但这些是地面装饰，不是水中实体
- 苦力怕是通用敌人，没有按群系过滤排除
- **海洋敌人与群系敌池核心逻辑**在 `11-game-init.js`、`20-enemies-new.js`、`15-entities-combat.js`，苦力怕爆炸逻辑在 `15-entities-combat.js` 中缺少海洋禁爆守卫
- **海洋装饰生成**在 `21-decorations-new.js`，需在此确认无树木语义残留

**修复方案**：
1. **禁止海洋生成树**：在 `biomes.json` 中明确 `"treeTypes": []`，在 `11-game-init.js` 树生成逻辑中检查当前群系
2. **增加水中植物**：在 `21-decorations-new.js` 中新增大型水草、珊瑚装饰类型，提升可见度与出现概率
3. **海洋禁爆**：在 `15-entities-combat.js` 苦力怕爆炸逻辑中增加海洋群系守卫，禁止水中爆炸伤害
4. **过滤不合理敌人**：在 `11-game-init.js` / `20-enemies-new.js` 敌人生成逻辑中，海洋群系排除苦力怕（creeper）
5. **统一海洋敌人与海洋生物链路**：不重复新增 `Drowned` 类，复用现有敌人体系中的 `drowned`（由 `11-game-init.js` / `20-enemies-new.js` 管理）；明确海洋中两条并行链路——敌人链路（drowned/pufferfish 等战斗相关）与海洋生物链路（CodFish/Squid 等环境生物），统一刷怪/渲染入口避免重复
6. **增加海星实体**：作为可收集的装饰物或加分道具

**改动范围**：`biomes.json`（树/敌人配置）、`15-entities-combat.js`（海洋禁爆）、`11-game-init.js` + `20-enemies-new.js`（敌人过滤与链路统一）、`21-decorations-new.js`（水中装饰）、`15-entities-particles.js`（海洋生物）、`14-renderer-entities.js`（渲染）

---

### F. 单词测验 UI（问题 #15, #16）

**现象**：长单词/短语超出选项按钮框；双字母补全时选项缺少合理间隔。

**代码分析**：
- `12-challenges.js` 中选项按钮使用 CSS 类 `.challenge-option`，无动态字体调整
- `multi_blank` 模式生成字母组合选项，但没有在字母间插入视觉间隔
- 按钮宽度固定，长文本溢出
- 样式定义在 `apk/src/styles.css` 中的 `.challenge-fill-word` 等类，字号和字距固定

**修复方案**：
1. **自适应字体缩放**（替代原"整体缩小50%"方案，避免短词可读性下降）：在创建选项按钮时，根据文本长度分档设置 `fontSize`：
   ```js
   const len = optionText.length;
   if (len > 20) btn.style.fontSize = '10px';
   else if (len > 15) btn.style.fontSize = '12px';
   else if (len > 10) btn.style.fontSize = '14px';
   // 短词保持默认字号，不缩小
   ```
2. **按钮样式优化**：在 `styles.css` 中为 `.challenge-option` 增加 `word-break: break-word`、`overflow-wrap: break-word`、`min-height` 确保多行文本可显示
3. **字距按词长衰减**：`.challenge-fill-word` 的 `letter-spacing` 根据词长动态调整，长词减小字距
4. **双字母补全间隔**：在 `multi_blank` 选项生成时，根据原单词中两个空缺字母的实际位置，在选项显示中插入对应数量的 `·` 或空格作为间隔提示

**改动范围**：`12-challenges.js`（选项生成逻辑、动态字号）、`styles.css`（响应式样式）

---

### G. BOSS 战系统（问题 #19, #20, #21, #22）

**现象**：凋零 BOSS 战进入后地图仍可前进、看不到凋零、凋零外观不合理（悬浮方块/章鱼样）、其他 BOSS 也需优化。

**代码分析**：
- `15-entities-boss.js` 中 `WitherBoss` 渲染为纯矩形：黑色长方体 + 三个小黑方块头 + 白色眼睛
- 凋零生成在 y=80（画面上方），96x96 像素，容易被忽略
- BOSS 战没有锁定屏幕滚动的机制，玩家可以继续向右移动离开 BOSS 区域
- 凋零的攻击（黑色方块投射物）视觉上就是小黑方块，缺乏辨识度
- 其他 BOSS（恶魂、烈焰人、凋灵骷髅）也是简单几何图形，缺乏 Minecraft 风格
- **存在"双系统并行"风险**：代码中旧 `ender_dragon` 触发链与新 `bossArena` 同时存在（`13-game-loop.js`、`15-entities-boss.js`、`14-renderer-main.js`），导致"提示进入 BOSS 但实体未出现/场景未锁定"的错位

**修复方案**：

#### G0. BOSS 单轨化（P0 前提，必须先做）
1. 下线旧 `ender_dragon` 自动触发链，移除或注释相关代码
2. 仅保留 `bossArena` 作为唯一的 BOSS 进入/更新/渲染链路
3. 统一提示条、血条、阶段文案来源，确保提示与实体一致

#### G1. BOSS 战场景锁定
1. BOSS 战开始时锁定视口滚动：`viewportLocked = true`，禁止摄像机跟随玩家向右移动
2. 设置左右边界墙，限制玩家在 BOSS 战区域内移动
3. BOSS 击败后解锁视口，恢复正常游戏

#### G2. 凋零外观重绘
参考 Minecraft 凋零的经典形象重新设计渲染函数：
- **身体结构**：T 形骨架，中央躯干 + 左右肋骨延伸
- **三个头颅**：中间主头较大，两侧副头较小，均为骷髅造型（黑色底 + 深灰面部 + 蓝色/白色眼睛）
- **护甲纹理**：躯干上绘制深灰色肋骨条纹
- **阶段变化**：
  - 阶段 1：正常黑色，蓝色眼睛
  - 阶段 2：身体泛暗红光，眼睛变红
  - 阶段 3：全身闪烁，裂纹效果，红色粒子环绕

#### G3. 凋零攻击视觉优化
- 投射物改为"凋零之首"造型：小骷髅头形状，带黑色拖尾粒子
- 追踪弹增加蓝色/紫色光晕效果
- 冲撞攻击增加冲击波视觉（扩散的半透明圆环）

#### G4. 其他 BOSS 优化建议

| BOSS | 当前问题 | 优化方向 |
|------|---------|---------|
| 恶魂 (Ghast) | 白色方块 + 红点眼睛 | 绘制方形大脸、下垂触手（9条）、闭眼/张嘴表情切换 |
| 烈焰人 (Blaze) | 金色方块 + 旋转小方块 | 黄色核心发光体、12根环绕烈焰棒、火焰粒子效果 |
| 凋灵骷髅 (Wither Skeleton) | 黑色长方形 | 高瘦黑色骷髅、手持石剑、红色眼睛、煤灰粒子 |

**改动范围**：`15-entities-boss.js`（BOSS 逻辑与渲染）、`13-game-loop.js`（视口锁定）、`14-renderer-entities.js`（投射物渲染）

---

### H. 火山群系悬浮问题（问题 #13）

**现象**：火山设计悬浮于半空中，未与地面平齐。

**代码分析**：
- 火山群系的平台生成逻辑可能使用了与其他群系相同的随机高度算法
- 火山地形应以连续地面为主，辅以岩浆池和高台
- **核心问题更可能在装饰锚点**：`21-decorations-new.js` 中火山装饰物（黑曜石柱、热泉、岩浆裂缝）的 `groundY`/`y` 锚点语义不统一，导致装饰物悬浮或埋入地面

**修复方案**：
1. **优先排查装饰锚点**：在 `21-decorations-new.js` 中统一火山装饰的 `groundY` 锚点计算，确保所有装饰物以地面为基准定位
2. **校正具体装饰物**：黑曜石柱、热泉、岩浆裂缝的上下偏移逐一校正
3. **平台生成调整**：火山群系的平台生成增加"地面连续性"约束，大部分平台 y 坐标贴近画面底部
4. **火山锥体贴地**：火山锥体作为特殊地形元素，从地面向上延伸，而非悬浮

**改动范围**：`21-decorations-new.js`（装饰锚点，优先）、`11-game-init.js`（平台生成）、`06-biome.js`（火山地形参数）

---

## 三、实施优先级与顺序

```
P0 稳定性止血（必须先做）：
  ├── C. 中文乱码治理闭环     ← Game.html 静态乱码 + JS 文案集中化
  ├── G0. BOSS 单轨化         ← 下线旧 ender_dragon，统一 bossArena 链路
  ├── A. 树碰撞移动修复       ← 方向判定 + 推离修正
  └── G1. BOSS 战场景锁定     ← 视口锁定 + 边界墙

P1 主体验优化：
  ├── B. 群系难度分级          ← 轮次计数 + 敌人分层表
  ├── D. 群系时长调整          ← 双阈值：minStayScore + minStayTimeSec
  ├── E. 海洋群系实体          ← 禁爆 + 树过滤 + 溺尸/水草补全
  ├── H. 火山悬浮修复          ← 装饰锚点优先 + 平台贴地
  └── F. 单词测验 UI           ← 自适应缩放 + 断词 + 多空间隔

P2 BOSS 世界观一致化：
  ├── G2. 凋零外观重绘         ← T 形三头骨架 + 阶段演出
  ├── G3. 凋零攻击视觉优化     ← 凋零之首投射物 + 光晕拖尾
  └── G4. 其他 BOSS 优化       ← 恶魂/烈焰人/凋灵骷髅统一收敛

P3 联调收尾：
  ├── I. 调试页回归脚本化      ← GameDebug.html 一键切群系/触发BOSS
  ├── 冒烟清单                 ← 树卡位/群系切换/海洋禁爆/长词挑战/凋零三阶段
  └── 文档回填                 ← 参数变更记录 + 问题关闭清单
```

依赖说明：
- P0 必须先做：若编码与双 BOSS 系统不先收敛，后续体验调参会反复失真；若不先修树碰撞卡死，任何难度优化都会被"基础不可玩"掩盖
- P1 依赖 P0 完成后再开始
- P2 可与 P1 后半段并行，但 G0 单轨化是前提
- P3 在 P1+P2 完成后收尾

## 四、风险与注意事项

1. **BOSS 双系统并行**：代码存在旧 `ender_dragon` 与新 `bossArena` 两套链路共存，必须在 P0 阶段先单轨化，否则后续 BOSS 优化会"修新坏旧"
2. **文案分散风险**：中文文案散落在 HTML 和多个 JS 模块中，若不在 P0 阶段建立集中管理规则，后续改动会反复出现乱码/遗漏
3. **全局作用域**：所有模块共享全局作用域，新增变量需注意命名冲突，建议使用前缀（如 `boss_`、`biome_`）
4. **模块加载顺序**：修改 `06-biome.js` 中的难度分级需要调用 `05-difficulty.js` 的接口，加载顺序已满足
5. **构建兼容性**：修改后需验证 `build-singlefile.js` 构建的离线版本功能正常，特别是中文编码
6. **性能影响**：BOSS 重绘增加渲染复杂度，需在低端 Android 设备上测试帧率
7. **向后兼容**：群系难度分级引入 `biomeVisitCount`，需处理旧存档没有该字段的情况（默认值兜底）
8. **APK 同步**：根目录修改后需同步到 `apk/` 目录，通过 `node scripts/sync-web.js` 完成
9. **回归验证**：每个 P 阶段完成后需配合 `GameDebug.html` 调试页做快速回归，避免改动耦合导致连锁问题
