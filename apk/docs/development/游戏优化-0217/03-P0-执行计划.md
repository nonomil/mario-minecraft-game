# P0 执行计划：稳定性止血

目标版本：v1.16.0（versionCode 99）
前置版本：v1.15.7（versionCode 98）

---

## Step 1：乱码治理闭环（P0-1）

### 1.1 排查 Game.html 静态乱码

操作：
1. 打开 `apk/Game.html`，搜索所有中文文本，逐行检查是否有编码损坏
2. 对照 `apk/docs/version/CHANGELOG.md` 中 v1.9.x 以下版本的乱码段落（已确认从 v1.9.3 开始出现大量乱码），确认是构建产物还是源文件问题
3. 修正所有损坏的中文字面量

涉及文件：
- `apk/Game.html`

### 1.2 排查构建脚本编码

操作：
1. 检查 `tools/build-singlefile.js` 中所有 `fs.readFileSync` 调用，确认第二参数为 `'utf-8'`
2. 检查 `fs.writeFileSync` 输出是否指定 `'utf-8'`
3. 如有遗漏，补充编码参数

涉及文件：
- `tools/build-singlefile.js`

### 1.3 排查群系提示文本

操作：
1. 在 `apk/src/modules/06-biome.js` 中搜索 `showToast`、`showFloatingText` 调用
2. 在 `apk/src/modules/13-game-loop.js` 中搜索同上
3. 确认沙漠（desert）、山地（mountain）、火山（volcano）群系切换时的提示文本为正常中文
4. 如有 `String.fromCharCode` 或转义序列拼接，替换为中文字面量

涉及文件：
- `apk/src/modules/06-biome.js`
- `apk/src/modules/13-game-loop.js`

### 1.4 建立文案集中管理

操作：
1. 在 `apk/src/modules/01-config.js` 中新增 `BIOME_MESSAGES` 和 `UI_TEXTS` 常量对象
2. 将各模块中散落的中文提示文本迁移到这两个对象中
3. 各调用处改为引用常量

涉及文件：
- `apk/src/modules/01-config.js`（新增常量）
- `apk/src/modules/06-biome.js`（引用常量）
- `apk/src/modules/13-game-loop.js`（引用常量）
- `apk/src/modules/10-ui.js`（引用常量）

### 1.5 检查 HTML charset

操作：
1. 确认 `apk/Game.html` 中 `<meta charset="UTF-8">` 存在且位于 `<head>` 第一行

---

## Step 2：BOSS 单轨化（P0-2）

### 2.1 定位旧 ender_dragon 触发链

操作：
1. 在 `apk/src/modules/13-game-loop.js` 中搜索 `ender_dragon`、`dragon`、`enderDragon`
2. 在 `apk/src/modules/15-entities-boss.js` 中搜索同上
3. 在 `apk/src/modules/14-renderer-main.js` 中搜索同上
4. 记录所有旧链路代码位置

### 2.2 下线旧触发链

操作：
1. 注释或移除旧 `ender_dragon` 自动触发逻辑（分数触发、实体生成、渲染调用）
2. 保留 `bossArena` 作为唯一 BOSS 入口
3. 确认 `bossArena` 的 4 个 BOSS（wither/ghast/blaze/wither_skeleton）触发阈值不变

涉及文件：
- `apk/src/modules/13-game-loop.js`
- `apk/src/modules/15-entities-boss.js`
- `apk/src/modules/14-renderer-main.js`

### 2.3 统一 BOSS 提示与血条来源

操作：
1. 确认 BOSS 战进入时的顶部提示条文案来自 `bossArena` 统一管理
2. 确认血条 UI 只读取 `bossArena.boss` 的 HP
3. **明确下线旧 ender_dragon 血条 HUD**：`14-renderer-main.js` 中存在旧龙血条渲染逻辑（约 line 125 附近）与新 `bossArena` 血条（约 line 145 附近）并存，必须移除旧龙血条渲染代码，仅保留 `bossArena` 血条
4. 移除任何其他残留的旧 BOSS 血条/提示逻辑

涉及文件：
- `apk/src/modules/15-entities-boss.js`
- `apk/src/modules/14-renderer-main.js`

---

## Step 3：树碰撞脱困修复（P0-3）

### 3.1 修改树干碰撞逻辑

操作：
1. 定位 `apk/src/modules/13-game-loop.js` 约 173-198 行的树干碰撞段
2. 当前逻辑：`colCheckRect` 返回碰撞方向后直接 `player.velX = 0`
3. 修改为方向判定：
   ```js
   const dir = colCheckRect(player.x, player.y, player.width, player.height,
                            trunkX, trunkY, 30, 60);
   if (dir === "l" && player.velX < 0) {
       player.velX = 0;
       player.x = trunkX + 30; // 推离到树右侧
   } else if (dir === "r" && player.velX > 0) {
       player.velX = 0;
       player.x = trunkX - player.width; // 推离到树左侧
   }
   ```
4. 保留 step-up 逻辑不变

涉及文件：
- `apk/src/modules/13-game-loop.js`

### 3.2 验证卡死场景

操作：
1. 手动测试：向右走碰树 → 向左走 → 确认可以移动
2. 手动测试：向左走碰树 → 向右走 → 确认可以移动
3. 确认 step-up 仍正常工作

---

## Step 4：BOSS 战场景锁定（P0-4）

### 4.1 实现视口锁定

操作：
1. 在 `bossArena.enter(bossType)` 中，记录当前视口位置并设置 `bossArena.viewportLocked = true`
2. 在 `apk/src/modules/07-viewport.js` 或 `13-game-loop.js` 的摄像机更新逻辑中，检查 `bossArena.viewportLocked`，若为 true 则不更新摄像机 X 位置
3. 在 `bossArena.onVictory()`（战斗结束）和 `bossArena.exit()`（离场）中解锁：`bossArena.viewportLocked = false`

涉及文件：
- `apk/src/modules/15-entities-boss.js`
- `apk/src/modules/13-game-loop.js`（或 `07-viewport.js`）

### 4.2 实现边界墙

操作：
1. BOSS 战开始时，记录左边界 `bossArena.leftWall = camX` 和右边界 `bossArena.rightWall = camX + canvasWidth`
2. 在玩家移动更新中，若 BOSS 战激活，限制 `player.x` 在 `[leftWall, rightWall - player.width]` 范围内

涉及文件：
- `apk/src/modules/15-entities-boss.js`
- `apk/src/modules/13-game-loop.js`

---

## Step 5：Playwright 测试（P0-T）

### 5.1 编写测试用例

创建 `tests/p0-stability.spec.js`，包含以下测试：

```js
// 测试 1：乱码验证
test('群系切换提示无乱码', async ({ page }) => {
  // 加载游戏 → 通过 debug 接口切换到 desert/mountain/volcano
  // 截图 toast 区域 → 验证不包含乱码字符（可用 OCR 或像素对比）
});

// 测试 2：树碰撞脱困
test('碰树后可反向移动', async ({ page }) => {
  // 加载游戏 → 移动玩家碰树 → 记录位置
  // 反向移动 → 验证位置变化 > 0
});

// 测试 3：BOSS 单轨化与场景锁定
test('BOSS战场景锁定', async ({ page }) => {
  // 加载游戏 → 通过 debug 接口设置分数 2000 触发凋零
  // 验证 bossArena.active === true
  // 验证视口不再跟随玩家移动
  // 验证玩家被限制在边界墙内
});
```

### 5.2 运行测试

```bash
cd d:\Workplace\mario-minecraft-game_V1
npm test -- tests/p0-stability.spec.js
```

验收标准：全部测试通过

---

## Step 6：版本发布（P0-V）

### 6.1 更新版本号

```bash
# apk/package.json: "version": "1.15.7" → "1.16.0"
# apk/android-app/android/app/build.gradle: versionCode 98→99, versionName "1.16.0"
```

### 6.2 更新版本记录

Progress.md 顶部插入：
```markdown
## v1.16.0（发布日期：2026-02-XX）
- 类型：MINOR
- APK 版本：versionName = 1.16.0，versionCode = 99
- 主要变更
  - 中文乱码治理：修复 Game.html 静态乱码，建立文案集中管理规则
  - BOSS 单轨化：下线旧 ender_dragon 触发链，统一 bossArena 链路
  - 树碰撞修复：方向判定 + 推离修正，解决碰树后双向卡死
  - BOSS 场景锁定：视口锁定 + 边界墙，BOSS 战不可逃离
  - 新增 Playwright P0 稳定性测试
```

CHANGELOG.md 顶部插入：
```markdown
## v1.16.0 (2026-02-XX)

### 稳定性修复
- 修复沙漠/山地/火山群系切换提示乱码
- 修复 Game.html 静态中文乱码
- 建立中文文案集中管理规则（BIOME_MESSAGES / UI_TEXTS）

### BOSS 系统
- 下线旧 ender_dragon 自动触发链，统一为 bossArena 单链路
- BOSS 战进入时锁定视口，设置左右边界墙

### 碰撞修复
- 树干碰撞加入方向判定与推离修正，解决碰树后双向卡死

### 测试
- 新增 p0-stability.spec.js 覆盖乱码/碰撞/BOSS 场景

---
```

VERSION-STATUS.md 替换为 v1.16.0 状态。

### 6.3 Git 提交

```bash
git add apk/package.json apk/android-app/android/app/build.gradle \
       apk/src/modules/01-config.js apk/src/modules/06-biome.js \
       apk/src/modules/13-game-loop.js apk/src/modules/15-entities-boss.js \
       apk/src/modules/14-renderer-main.js apk/src/modules/10-ui.js \
       apk/Game.html tools/build-singlefile.js \
       apk/docs/version/ tests/p0-stability.spec.js \
       apk/docs/development/游戏优化-0217/02-总体执行计划.md
git commit -m "release(v1.16.0): P0 stability - encoding fix, boss single-track, tree collision, boss arena lock"
git push origin main
```

### 6.4 更新总体计划进度

在 `02-总体执行计划.md` 中将 P0 行状态改为 ✅ 已完成，填入日期和 commit hash。
