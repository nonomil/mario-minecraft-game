# 游戏优化0220-2 实施计划

## 1. 目标与范围
- 需求来源：`apk/docs/development/游戏优化0220/游戏优化0220-2.md`
- 本次只处理三项问题：
1. 首页血量显示、钻石兑换提示出现乱码。
2. 村庄单词测试屋内仍有“桌子图标”遮挡；交易屋交互改为可点击选项，不再使用输入 `1/2/3`。
3. 狐狸偷分敌人不再显示为黄色方块，改为狐狸形象；并且狐狸可随机出现在多个地图，而非只在樱花地图。

## 2. 代码定位
- 文案与血量/钻石提示：`apk/src/modules/13-game-loop.js`
- 村庄建筑外观渲染：`apk/src/modules/18-village-render.js`
- 村庄室内/交易交互：`apk/src/modules/18-village.js`
- 狐狸敌人刷新策略：`apk/src/modules/20-enemies-new.js`
- 狐狸敌人渲染：`apk/src/modules/14-renderer-entities.js`

## 3. 实施方案
### 3.1 乱码修复（首页血量 + 钻石兑换提示）
1. 修复血量 UI 使用的心形字符，确保 `updateHpUI()` 生成正常 emoji。
2. 修复 `useDiamondForHp()` 的 toast 文案乱码。
3. 修复“背包点击钻石恢复生命”分支中的相关提示乱码。
4. 保持逻辑不变，仅替换显示文案与符号，避免行为回归。

### 3.2 村庄体验优化（单词屋 + 交易屋）
1. 去除（或不再绘制）单词屋容易误识别为“桌子图标”的外部图标层，避免遮挡角色视觉。
2. 保留单词屋室内“单词书”交互锚点，继续使用宝箱键触发测验。
3. 重构交易屋交互：
- 由 `window.prompt` 文本输入改为可点击弹层菜单。
- 主菜单提供“卖材料换钻石 / 买盔甲 / 买防晒霜 / 关闭”。
- 子菜单提供可点击的材料、盔甲与数量选项（如 `x1 / x5 / 全部`），不再要求输入数字。
4. 交易完成后刷新背包与提示，关闭或返回菜单，避免卡暂停态。

### 3.3 狐狸形象与刷新范围
1. 在敌人渲染器中新增 `drawFoxEnemy()`，替换当前狐狸使用的通用色块渲染。
2. 在 `drawEnemy()` 中对 `fox` 分支改用专属狐狸绘制函数。
3. 在 `spawnBiomeEnemy()` 中加入“跨地图随机狐狸注入”逻辑：
- 保留樱花地图高概率狐狸特性。
- 其他地图按较低概率注入狐狸（随机出现），保证“非樱花也可遇到”。
4. 不改狐狸偷分行为，仅改可见形象和生成范围。

## 4. 风险与回退
- 风险1：交易弹层与已有模态暂停状态冲突。
- 处理：统一在打开/关闭交易弹层时维护 `pausedByModal`，并提供兜底关闭按钮。
- 风险2：狐狸注入概率过高影响平衡。
- 处理：默认低概率注入（例如 15%），保留各地图原生敌池为主。
- 风险3：UI 文案修复误改业务逻辑。
- 处理：只替换文本和渲染分支，不改结算与扣血规则。

## 5. 验收清单
- 首页 HP 心形显示正常，无乱码。
- 点击钻石恢复生命提示正常（满血、钻石不足、兑换成功三种提示）。
- 进入村庄单词屋，不出现干扰性的桌子图标遮挡。
- 交易屋弹出点击菜单，无任何 `prompt` 输入 `1/2/3` 流程。
- 狐狸不再显示为黄色方块，具有狐狸外观。
- 狐狸可在非樱花地图随机出现并保持偷分行为。

## 6. 变更后建议验证步骤
1. 启动 `apk/Game.html`，进入首页观察 HP 显示与基础 HUD 文案。
2. 在背包中点击钻石，分别验证“满血/不足/成功”提示。
3. 进入村庄 -> 单词屋，确认图标与角色遮挡问题已消失。
4. 进入交易屋，完整点选一次卖材料与买盔甲流程。
5. 跑图切换多个群系，观察狐狸随机刷新与渲染形象。
