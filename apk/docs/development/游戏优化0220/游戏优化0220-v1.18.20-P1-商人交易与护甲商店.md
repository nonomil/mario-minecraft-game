# v1.18.20 (P1) - 商人交易与护甲商店

## 1. 版本目标

- 第三个房屋（商人房）开放交易 UI。
- 支持“材料卖出换钻石”。
- 支持钻石购买护甲（木/铁/金/钻石）。

## 2. 计划修改文件

- `apk/src/modules/18-village.js`
- `apk/src/modules/13-game-loop.js`（库存、护甲装备）
- `apk/src/modules/01-config.js`（价格表、卖出价值表）
- `apk/src/modules/10-ui.js`（如复用 modal 组件）

## 3. 经济设计草案

- 卖出价值（示例）
: `iron=2`, `gold=3`, `shell=1`, `gunpowder=2`, `string=1`
- 护甲价格（示例）
: `wood=10`, `iron=20`, `gold=30`, `diamond=40`

## 4. Step by Step

1. 商人入口
- 在 `specialBuilding` 为商人房类型时触发交易面板。
- 室内模式下同样支持进商店。

2. 卖出链路
- 列出可卖材料与持有数量。
- 点击卖出后：库存扣减、钻石增加、浮字提示。

3. 购买链路
- 检查钻石余额，余额不足 toast。
- 购买成功后将护甲加入 `armorInventory` 或直接装备（按设定）。

4. 保存与读取
- 确保账号系统、村庄存档都写入交易结果与护甲状态。

## 5. 验收标准

- 玩家可在商人房稳定完成卖出与购买。
- 钻石与库存变化正确且可持久化。
- 护甲可正常显示于背包/状态栏。

## 6. 风险与回滚

- 风险：经济膨胀导致钻石失去价值。
- 防护：先用保守价格上线，观察后再二次平衡。
