---
name: systematic-debugging
description: 当遇到 Bug、测试失败或意外行为时使用。要求在尝试修复之前进行系统的根本原因分析。
---

# 系统化调试

## 概述

调试不是猜测。它是通过收集证据、建立假设和验证来识别并消除问题的系统过程。

**核心原则：** 修复症状是暂时的，修复根本原因是永久的。

**开始时声明：** “我正在使用系统化调试来调查 [问题描述]。”

## 4 阶段过程

### 1. 调查（根本原因）
- **阅读完整的错误消息：** 不要只看第一行。
- **重现问题：** 编写一个能可靠重现 Bug 的最小失败测试。
- **检查最近的更改：** `git diff` 检查最近的提交。
- **收集证据：** 使用日志、调试器或打印语句来跟踪状态。

### 2. 分析（模式与假设）
- **识别模式：** 问题在什么条件下发生？在什么条件下不发生？
- **建立假设：** “我认为问题是因为 [原因]。”
- **排名：** 从最可能且最容易验证的假设开始。

### 3. 测试假设
- 编写一个小实验或修改测试来验证假设。
- 如果假设被证伪，回到第 2 阶段。

### 4. 实施修复
- 一旦确定了根本原因，应用最小的修复。
- 运行重现测试以确保修复有效。
- 运行完整测试套件以确保无回归。

## 危险信号：何时停止并重新开始

如果你发现自己：
- 随机更改代码并希望它能工作（“散弹枪式调试”）。
- 无法解释为什么修复有效。
- 修复了一个 Bug 却引入了两个新 Bug。

**立即停止。** 清除你的更改，回到第 1 阶段。

## 快速参考

| 任务 | 行动 |
|------|------|
| 无法重现 | 检查环境差异、随机种子、并发性 |
| 间歇性失败 | 寻找竞争条件、未初始化的状态、外部 API 波动 |
| 修复后回归 | 缺乏测试。添加覆盖该路径的测试。 |

## 常见错误

- **过早修复：** 在没有完全理解原因的情况下尝试修复。
- **忽略日志：** 假设你知道发生了什么而不去检查实际输出。
- **修复症状：** 例如，添加 `if (obj != null)` 而不去调查为什么 `obj` 会是 `null`。

## 危险信号

**切勿：**
- 在没有重现 Bug 的情况下尝试修复它。
- 假设代码库的某一部分是“不可能出错的”。
- 忽略错误堆栈。
- 提交带有临时日志的修复。
