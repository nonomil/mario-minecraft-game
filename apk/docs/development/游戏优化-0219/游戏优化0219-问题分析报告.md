# 游戏优化0219-问题分析报告

日期: 2026-02-19  
范围: `apk` 子项目，基于 `apk/docs/development/游戏优化-0219/游戏优化0219.md` 的 4 个问题（含新增“村庄测验显示异常与退出卡死”），结合当前代码与词库数据库现状。

## 1. 结论摘要

1. 村庄“有提示但看不见”的主因已定位为渲染坐标重复扣减相机偏移（`cameraX`），属于渲染链路问题，不是触发逻辑问题。  
2. 村庄测验“只显示字母 + 出现 `undefined` + 退出后卡死”由多因素叠加导致: 词源数据形态不统一、测验期间可重入触发交互、弹窗状态恢复链路不完整。  
3. 黄圈单词系统当前没有“单词后紧跟对应短语”的机制，`phrase` 仅用于卡片/挑战展示，未参与地图掉落调度。  
4. 幼儿园词库存在“范围过宽+部分字段质量不稳”的客观证据；CSV 导出能力已有，但产物目前不在 `docs` 目录，和需求不一致。

## 2. 项目现状（与本次问题相关）

- 主入口与模块加载: `apk/Game.html`
- 村庄核心逻辑: `apk/src/modules/18-village.js`
- 村庄渲染: `apk/src/modules/18-village-render.js`
- 主渲染循环: `apk/src/modules/14-renderer-main.js`
- 单词掉落与调度: `apk/src/modules/11-game-init.js`
- 词条展示/挑战: `apk/src/modules/12-challenges.js`
- 词库装载: `apk/src/modules/09-vocab.js`
- 词库数据库工具链: `apk/tools/vocab-db/README.md`

## 3. 问题一: 村庄触发后无可见内容

### 3.1 现象与复核结果

- 文档反馈: 500 分会触发村庄提示，但看不到背景/房子。  
- 代码复核: 触发链路正常，`update()` 每帧调用 `updateVillages()`，`maybeSpawnVillage()` 按 500 分间隔生成村庄。

相关代码:
- `apk/src/modules/13-game-loop.js:49`
- `apk/src/modules/18-village.js:93`
- `apk/src/modules/18-village.js:96`

### 3.2 根因定位

主渲染先做了全局平移:
- `apk/src/modules/14-renderer-main.js:14` -> `ctx.translate(-cameraX, 0)`

随后在已平移的坐标系里调用:
- `apk/src/modules/14-renderer-main.js:51` -> `drawVillages(ctx)`

但村庄渲染内部再次大量 `-cameraX`:
- `apk/src/modules/18-village-render.js:90`
- `apk/src/modules/18-village-render.js:107`
- `apk/src/modules/18-village-render.js:129`
- `apk/src/modules/18-village-render.js:147`
- `apk/src/modules/18-village-render.js:160`
- `apk/src/modules/18-village-render.js:182`
- `apk/src/modules/18-village-render.js:236`
- `apk/src/modules/18-village-render.js:239`
- `apk/src/modules/18-village-render.js:253`
- `apk/src/modules/18-village-render.js:293`

这会导致村庄元素屏幕坐标近似变成 `worldX - 2 * cameraX`，玩家中后程几乎必然偏出可视区。

对照证据:
- BOSS 渲染已显式规避这个问题，注释写明“主渲染已平移，不要重复偏移”  
  见 `apk/src/modules/14-renderer-entities.js:359`

### 3.3 影响评估

- 受影响: 村庄背景、建筑、装饰、NPC、横幅等视觉元素。  
- 不受影响: 村庄状态逻辑（进入提示、安全区清怪、村庄内刷词/宝箱）仍可能执行，因此会出现“有提示但没画面”。

### 3.4 伴随问题（非主因）

- `settings.villageFrequency` 已定义但未参与生成逻辑（当前只用 `villageConfig.spawnScoreInterval`）。  
  见 `apk/src/defaults.js:232`、`apk/src/modules/09-vocab.js:20`、`apk/src/modules/18-village.js:96`。  
- `loadVillageConfig()` 在 `18-village.js` 中存在，但当前启动流程由 `17-bootstrap.js` 统一加载配置，前者属于闲置路径，增加维护歧义。  
  见 `apk/src/modules/18-village.js:47`、`apk/src/modules/17-bootstrap.js`。
- `apk/scripts/sync-web.js` 仅做 `apk -> out -> android-app/web` 构建同步，不负责 `root <-> apk` 源码同步；双目录并行维护时需显式校验一致性。  
  见 `apk/scripts/sync-web.js`。

## 4. 问题二: 单词/短语出题顺序与重复频率

### 4.1 当前实现

- 掉落词来源于 `pickWordForSpawn()`，由 `buildWordPicker()` 调度。  
  见 `apk/src/modules/11-game-init.js:132`、`apk/src/modules/11-game-init.js:206`
- 黄圈仅绘制 `wordObj.en`。  
  见 `apk/src/modules/14-renderer-main.js:45`
- `phrase/phraseTranslation` 仅在词卡与挑战里展示，不参与“下一次掉落策略”。  
  见 `apk/src/modules/12-challenges.js:20`、`apk/src/modules/12-challenges.js:563`
- 当前“避免重复”仅排除地图上已存在词与 `lastWord`，无法保证“词->对应短语”串联。  
  见 `apk/src/modules/11-game-init.js:209`

### 4.2 与需求差距

需求点:
- “一个单词出现后，下一个是对应短语（或隔两个）”
- “单词重复频率可设计”

现状差距:
- 无“配对链路状态机”（pair queue / follow-up queue）。  
- 无“间隔参数”（gap=1 或 gap=2）配置。  
- `updateWordQuality()` 只在挑战对错后更新，对普通收集过程反馈弱，重复频率不够可控。  
  见 `apk/src/modules/12-challenges.js:601`、`apk/src/modules/12-challenges.js:618`

### 4.3 风险

- 学习强化路径不可预测，训练目标与游戏掉落节奏脱节。  
- 词条“看起来在复习”，但不保证复习的是“同一词的短语应用”。

## 5. 问题三: 幼儿园词库审查与导出

### 5.1 工具能力现状

- 词库数据库与 CSV 导出能力已具备（SQLite + CSV）。  
  见 `apk/tools/vocab-db/README.md`
- 当前标准导出位置: `apk/words/db/csv/entries.csv`  
- 与需求差距: 文档要求“整理后保存到 docs 目录并创建文件”。

### 5.2 数据证据（基于 `apk/words/db/vocab.db`）

- 全量 active 词条: 2981
- 幼儿园 pack 词条（`vocab.kindergarten*`）: 763
- 幼儿园“句子型词条”数量: 59
- 幼儿园非 `basic` 难度词条: 168
- 幼儿园词条中 `learn_type=phrase`: 756（以短语为主，不再是纯启蒙单词）
- 幼儿园 `phonetic` 含非 ASCII 异常字符: 423（存在编码/清洗质量风险）

典型样例（确实落在幼儿园 pack）:
- `What material should we use?`
- `I killed the skeleton`
- `Watch out for mobs!`
- `Can you revive me?`

主要来源文件（句子型词条）:
- `words/vocabs/01_幼儿园/幼儿园基础.js`
- `words/vocabs/01_幼儿园/幼儿园_4_沟通.js`

### 5.3 判断

- 目前“幼儿园完整包”并非纯启蒙级词汇，混入了较多场景句和游戏化表达。  
- 默认配置使用 `vocab.kindergarten`（完整包），会放大上述体感问题。  
  见 `apk/src/defaults.js` 中 `vocabSelection`。

## 6. 问题四: 村庄测验显示异常与退出后卡死（新增）

### 6.1 现象与复核结果

- 现象: 进入村庄学习屋后，题面只剩字母补空，出现 `undefined`；退出后短暂恢复，但后续会再次卡住。  
- 复核: 可在“触发村庄 -> 进入 `word_house` -> 退出挑战 -> 继续跑图”路径稳定复现（历史版本）。

### 6.2 根因定位（代码证据）

1. 村庄词源是字符串数组，测验渲染按对象字段读取  
证据:
- `getVillageWords()` 返回 `biomeWords[biomeId]`（字符串列表）: `apk/src/modules/18-village.js:409`
- 村庄配置 `biomeWords` 为字符串数组: `apk/config/village.json:21`
- 需要统一归一化为 `{ en, zh, phrase, phraseTranslation }` 才能安全渲染。

2. 测验流程缺少强互斥时，可能被交互键重入  
证据:
- 全局交互键入口: `apk/src/modules/17-bootstrap.js:142`
- 场景交互入口: `apk/src/modules/13-game-loop.js:1162`
- 若不判断 `paused/pausedByModal`，可能在 modal 期间重复触发 `startVillageChallenge`。

3. 退出流程若未完整恢复暂停状态，会出现“伪恢复后再次锁死”  
证据:
- 会话关闭与状态恢复函数: `closeVillageChallengeSession()`、`restorePauseStateFromSession()`  
  `apk/src/modules/12-village-challenges.js:69`
- 取消流程: `cancelVillageChallenge()` -> `closeVillageChallengeSession()`  
  `apk/src/modules/12-village-challenges.js:81`

4. `phrase` 中文字段历史命名混用，放大渲染空值风险  
证据:
- 词库归一化已同时保留 `phraseZh` 与 `phraseTranslation`: `apk/src/modules/09-vocab.js:332`
- 挑战渲染已兼容两者: `apk/src/modules/12-challenges.js:30`
- 新增/修复代码应统一以 `phraseTranslation` 为主，`phraseZh` 仅兼容旧数据。

### 6.3 验证结果（2026-02-19）

- 专项用例 `p0-village-quiz-stability.spec.mjs` 通过，断言包含:
1. 题面与选项不包含 `undefined`。
2. 退出后 `paused=false`、`pausedByModal=false`。
3. `gameFrame` 持续增长（证明主循环未冻结）。

- 对应测试文件: `apk/tests/e2e/specs/p0-village-quiz-stability.spec.mjs`

## 7. 优先级建议

- P0: 修复村庄渲染坐标体系（先恢复可见性）。  
- P0: 修复村庄测验 `undefined` 与退出卡死（互斥 + 状态恢复 + 字段归一化）。  
- P1: 增加“单词->对应短语”掉落调度机制与频率参数。  
- P1: 词库审查落地（先产出 docs 内可读审查文件+CSV，再做精修）。  
- P2: 清理闲置配置路径、补齐设置项实际生效关系（`villageFrequency` 等）。

## 8. 交付标准建议

- 村庄: 500 分触发后，屏幕内可见背景、建筑、装饰、NPC、横幅，且位置随相机移动正常。  
- 村庄测验: 不出现 `undefined`；退出后 30 秒内主循环持续推进，不再卡死。  
- 学习链路: 至少支持 2 种模式（紧邻/隔 2），并可验证“词后短语”的命中率。  
- 词库: 在 `docs` 下生成可审阅清单（含疑似超纲、句子型、翻译异常、音标异常），支持复核闭环。
