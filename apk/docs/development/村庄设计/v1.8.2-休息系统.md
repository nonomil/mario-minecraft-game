# v1.8.2 â€” ä¼‘æ¯ç³»ç»Ÿ + å›è¡€ + å•è¯å¡ç‰‡

> ç±»å‹ï¼šPATCH | versionName: 1.8.2 | versionCode: 61

## ä¸€ã€æœ¬ç‰ˆæœ¬ç›®æ ‡

å®ç°æ‘åº„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼šç©å®¶èµ°åˆ°"ä¼‘æ¯å±‹"ï¼ˆåºŠï¼‰æ—è¾¹ï¼ŒæŒ‰äº¤äº’é”®è§¦å‘ä¼‘æ¯ï¼Œå›æ»¡è¡€å¹¶å¼¹å‡ºå•è¯å¡ç‰‡å­¦ä¹ ã€‚è¿™æ˜¯æ‘åº„ä¸è‹±è¯­å­¦ä¹ æ ¸å¿ƒçš„ç¬¬ä¸€ä¸ªç»“åˆç‚¹ã€‚

## äºŒã€å‰ç½®ä¾èµ–

- v1.8.1 å·²å®Œæˆï¼ˆæ‘åº„å»ºç­‘æ¸²æŸ“ + NPC æ­£å¸¸å·¥ä½œï¼‰

## ä¸‰ã€ä¿®æ”¹æ–‡ä»¶

### 3.1 `src/modules/09-vocab.js` â€” æ–°å¢è·å–æ‘åº„å•è¯å‡½æ•°

åœ¨æ–‡ä»¶æœ«å°¾æ–°å¢ï¼š

```javascript
/**
 * è·å–æ‘åº„ä¸“å±å•è¯åˆ—è¡¨
 * ä¼˜å…ˆä»å½“å‰è¯åº“ä¸­åŒ¹é… village.json ä¸­å®šä¹‰çš„å•è¯
 * æ‰¾ä¸åˆ°çš„ç”¨ç®€å•å¯¹è±¡å…œåº•
 */
function getVillageWords(biomeId) {
  const wordKeys = (villageConfig.biomeWords || {})[biomeId] || [];
  if (!wordKeys.length) return [];

  const result = [];
  for (const key of wordKeys) {
    // å°è¯•ä»å½“å‰è¯åº“ä¸­æŸ¥æ‰¾åŒ¹é…çš„å•è¯
    const found = currentWordList.find(w =>
      (w.en || w.english || '').toLowerCase() === key.toLowerCase()
    );
    if (found) {
      result.push(found);
    } else {
      // å…œåº•ï¼šåˆ›å»ºç®€å•å•è¯å¯¹è±¡
      result.push({
        en: key,
        english: key,
        zh: key, // æ— ç¿»è¯‘æ—¶æ˜¾ç¤ºè‹±æ–‡
        chinese: key,
        image: ''
      });
    }
  }
  return result;
}
```

### 3.2 `src/modules/18-village.js` â€” æ–°å¢äº¤äº’æ£€æµ‹å’Œä¼‘æ¯é€»è¾‘

æ–°å¢ä»¥ä¸‹å‡½æ•°ï¼š

```javascript
// ========== å»ºç­‘äº¤äº’ç³»ç»Ÿ ==========

/**
 * è·å–ç©å®¶å½“å‰é è¿‘çš„å»ºç­‘ï¼ˆAABB ç¢°æ’æ£€æµ‹ï¼‰
 */
function getNearbyBuilding(village) {
  if (!village) return null;
  const px = player.x;
  const interactRange = 50; // äº¤äº’è·ç¦»

  for (const b of village.buildings) {
    if (Math.abs(px - (b.x + b.w / 2)) < b.w / 2 + interactRange) {
      return b;
    }
  }
  return null;
}

/**
 * å¤„ç†æ‘åº„äº¤äº’ï¼ˆç”± 13-game-loop.js çš„ handleInteraction è°ƒç”¨ï¼‰
 * è¿”å› true è¡¨ç¤ºå·²å¤„ç†äº¤äº’ï¼Œfalse è¡¨ç¤ºæœªå¤„ç†
 */
function handleVillageInteraction() {
  if (!playerInVillage || !currentVillage) return false;

  const building = getNearbyBuilding(currentVillage);
  if (!building) return false;

  switch (building.type) {
    case 'bed_house':
      restOnBed(currentVillage);
      return true;
    case 'word_house':
      // v1.8.3 å®ç°
      showToast('ğŸ“š å•è¯å±‹ï¼ˆå³å°†å¼€æ”¾ï¼‰');
      return true;
    case 'save_stone':
      // v1.8.4 å®ç°
      showToast('ğŸ’¾ å­˜æ¡£çŸ³ç¢‘ï¼ˆå³å°†å¼€æ”¾ï¼‰');
      return true;
    default:
      // ç‰¹è‰²å»ºç­‘ v1.8.4 å®ç°
      showToast('ğŸ  ç‰¹è‰²å»ºç­‘ï¼ˆå³å°†å¼€æ”¾ï¼‰');
      return true;
  }
}

// ========== ä¼‘æ¯ç³»ç»Ÿ ==========

let villageRestAnimating = false;

function restOnBed(village) {
  if (village.restUsed) {
    showToast('ğŸ’¤ å·²ç»ä¼‘æ¯è¿‡äº†');
    return;
  }
  if (villageRestAnimating) return;

  village.restUsed = true;
  villageRestAnimating = true;
  paused = true;

  // ä¼‘æ¯åŠ¨ç”»ï¼šæ¸é»‘ â†’ æ¢å¤ â†’ æ¸äº®
  startRestAnimation(() => {
    // 1. å›æ»¡è¡€
    playerHp = gameConfig.player.maxHp;
    updateHpUI();

    // 2. å¼¹å‡ºå•è¯å¡ç‰‡
    const words = getVillageWords(village.biomeId);
    if (words.length > 0) {
      const word = words[Math.floor(Math.random() * words.length)];
      showVillageWordCard(word);
    }

    // 3. å¥–åŠ±åˆ†æ•°
    score += 50;
    updateScoreUI();
    showFloatingText('+50 ğŸª™', player.x, player.y - 50);
    showFloatingText('â¤ï¸ æ»¡è¡€æ¢å¤!', player.x, player.y - 30);

    villageRestAnimating = false;
    paused = false;
  });
}

/**
 * ä¼‘æ¯æ¸é»‘æ¸äº®åŠ¨ç”»
 */
function startRestAnimation(onMidpoint) {
  let phase = 'fadeOut'; // fadeOut â†’ hold â†’ fadeIn
  let alpha = 0;
  const fadeSpeed = 0.03;
  const holdFrames = 40;
  let holdCount = 0;

  function animateRest() {
    const ctx = canvas.getContext('2d');

    if (phase === 'fadeOut') {
      alpha += fadeSpeed;
      if (alpha >= 1) {
        alpha = 1;
        phase = 'hold';
        // åœ¨æœ€é»‘çš„æ—¶å€™æ‰§è¡Œå›è¡€ç­‰é€»è¾‘
        if (onMidpoint) onMidpoint();
      }
    } else if (phase === 'hold') {
      holdCount++;
      if (holdCount >= holdFrames) {
        phase = 'fadeIn';
      }
    } else if (phase === 'fadeIn') {
      alpha -= fadeSpeed;
      if (alpha <= 0) {
        alpha = 0;
        return; // åŠ¨ç”»ç»“æŸ
      }
    }

    // ç»˜åˆ¶é»‘è‰²é®ç½©
    ctx.save();
    ctx.fillStyle = `rgba(0, 0, 20, ${alpha})`;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    // ä¸­é—´æ˜¾ç¤ºæ–‡å­—
    if (phase === 'hold' || (phase === 'fadeOut' && alpha > 0.7)) {
      ctx.fillStyle = `rgba(255, 255, 255, ${Math.min(alpha, 0.9)})`;
      ctx.font = '20px monospace';
      ctx.textAlign = 'center';
      ctx.fillText('ğŸ’¤ ä¼‘æ¯ä¸­...', canvas.width / 2, canvas.height / 2);
      ctx.textAlign = 'left';
    }
    ctx.restore();

    requestAnimationFrame(animateRest);
  }

  requestAnimationFrame(animateRest);
}

/**
 * æ˜¾ç¤ºæ‘åº„å•è¯å¡ç‰‡ï¼ˆç®€åŒ–ç‰ˆï¼Œä¸é˜»å¡æ¸¸æˆï¼‰
 */
function showVillageWordCard(word) {
  const en = word.en || word.english || '';
  const zh = word.zh || word.chinese || '';

  // æ’­æ”¾å‘éŸ³
  if (typeof speakWord === 'function') {
    speakWord(en);
  }

  // æ˜¾ç¤ºæµ®åŠ¨å•è¯å¡ç‰‡ï¼ˆ3ç§’åæ¶ˆå¤±ï¼‰
  showToast(`ğŸ“– ${en} - ${zh}`, 3000);

  // å¦‚æœæœ‰ç°æœ‰çš„å•è¯å¡ç‰‡ UIï¼Œä¹Ÿå¯ä»¥å¤ç”¨
  const wordCard = document.getElementById('word-card');
  if (wordCard) {
    const wordEn = wordCard.querySelector('.word-en') || wordCard.querySelector('#word-en');
    const wordZh = wordCard.querySelector('.word-zh') || wordCard.querySelector('#word-zh');
    if (wordEn) wordEn.textContent = en;
    if (wordZh) wordZh.textContent = zh;
    wordCard.style.display = 'block';
    setTimeout(() => { wordCard.style.display = 'none'; }, 3000);
  }
}
```

### 3.3 `src/modules/18-village-render.js` â€” æ–°å¢äº¤äº’æç¤ºæ¸²æŸ“

åœ¨ `drawVillages()` å‡½æ•°æœ«å°¾ï¼ŒNPC ç»˜åˆ¶ä¹‹ååŠ å…¥ï¼š

```javascript
// äº¤äº’æç¤º
if (playerInVillage && currentVillage === village) {
  const building = getNearbyBuilding(village);
  if (building) {
    drawBuildingInteractHint(ctx, building);
  }
}
```

æ–°å¢å‡½æ•°ï¼š

```javascript
function drawBuildingInteractHint(ctx, building) {
  const sx = building.x + building.w / 2 - cameraX;
  const sy = groundY - building.h - 45;

  // æç¤ºæ–‡å­—
  const hints = {
    bed_house: 'æŒ‰ Y ä¼‘æ¯',
    word_house: 'æŒ‰ Y å­¦ä¹ ',
    save_stone: 'æŒ‰ Y å­˜æ¡£'
  };
  const text = hints[building.type] || 'æŒ‰ Y äº¤äº’';

  // é—ªçƒæ•ˆæœ
  const blink = Math.sin(Date.now() / 300) * 0.3 + 0.7;

  ctx.save();
  ctx.globalAlpha = blink;
  ctx.fillStyle = '#FFF';
  ctx.strokeStyle = '#333';
  ctx.lineWidth = 1;
  ctx.font = '11px monospace';
  ctx.textAlign = 'center';

  // èƒŒæ™¯
  const tw = ctx.measureText(text).width + 12;
  ctx.fillStyle = 'rgba(0,0,0,0.6)';
  ctx.fillRect(sx - tw / 2, sy - 2, tw, 18);

  // æ–‡å­—
  ctx.fillStyle = '#FFD54F';
  ctx.fillText(text, sx, sy + 12);
  ctx.textAlign = 'left';
  ctx.restore();
}
```

### 3.4 `src/modules/13-game-loop.js` â€” é›†æˆæ‘åº„äº¤äº’

åœ¨ `handleInteraction()` å‡½æ•°çš„**æœ€å‰é¢**åŠ å…¥æ‘åº„äº¤äº’æ£€æŸ¥ï¼š

```javascript
// handleInteraction() å‡½æ•°å¼€å¤´åŠ å…¥ï¼š
if (handleVillageInteraction()) return; // æ‘åº„äº¤äº’ä¼˜å…ˆ
```

### 3.5 `src/modules/10-ui.js` â€” æ‘åº„äº¤äº’è§¦æ§æŒ‰é’®

åœ¨è§¦æ§æŒ‰é’®åŒºåŸŸï¼Œæ–°å¢æ‘åº„äº¤äº’æŒ‰é’®ï¼ˆä»…åœ¨æ‘åº„å†…ä¸”é è¿‘å»ºç­‘æ—¶æ˜¾ç¤ºï¼‰ï¼š

```javascript
// åœ¨è§¦æ§æŒ‰é’®æ›´æ–°é€»è¾‘ä¸­åŠ å…¥ï¼š
const btnVillageInteract = document.getElementById('btn-village-interact');
if (btnVillageInteract) {
  if (playerInVillage && currentVillage && getNearbyBuilding(currentVillage)) {
    btnVillageInteract.style.display = 'block';
  } else {
    btnVillageInteract.style.display = 'none';
  }
}
```

### 3.6 `Game.html` â€” æ–°å¢æ‘åº„äº¤äº’æŒ‰é’® DOM

åœ¨è§¦æ§æŒ‰é’®åŒºåŸŸæ–°å¢ï¼š

```html
<button id="btn-village-interact" class="touch-btn" style="display:none; position:absolute; right:80px; bottom:140px; font-size:24px; z-index:20;">ğŸ¤</button>
```

### 3.7 `src/modules/16-events.js` â€” ç»‘å®šæ‘åº„äº¤äº’æŒ‰é’®äº‹ä»¶

```javascript
// åœ¨äº‹ä»¶ç»‘å®šåŒºåŸŸæ–°å¢ï¼š
const btnVI = document.getElementById('btn-village-interact');
if (btnVI) {
  btnVI.addEventListener('touchstart', (e) => {
    e.preventDefault();
    handleVillageInteraction();
  });
  btnVI.addEventListener('click', () => {
    handleVillageInteraction();
  });
}
```

## å››ã€éªŒè¯æ¸…å•

- [ ] èµ°åˆ°ä¼‘æ¯å±‹é™„è¿‘ï¼Œæ˜¾ç¤º"æŒ‰ Y ä¼‘æ¯"æç¤ºï¼ˆé—ªçƒæ•ˆæœï¼‰
- [ ] ç§»åŠ¨ç«¯æ˜¾ç¤ºğŸ¤äº¤äº’æŒ‰é’®ï¼ˆä»…åœ¨æ‘åº„å†…é è¿‘å»ºç­‘æ—¶ï¼‰
- [ ] æŒ‰ Y / ç‚¹å‡»æŒ‰é’®è§¦å‘ä¼‘æ¯åŠ¨ç”»ï¼ˆæ¸é»‘ â†’ "ğŸ’¤ ä¼‘æ¯ä¸­..." â†’ æ¸äº®ï¼‰
- [ ] ä¼‘æ¯åè¡€é‡æ¢å¤æ»¡
- [ ] ä¼‘æ¯åå¼¹å‡ºå•è¯å¡ç‰‡ï¼ˆæ˜¾ç¤ºè‹±æ–‡ + ä¸­æ–‡ï¼‰
- [ ] ä¼‘æ¯åæ’­æ”¾å•è¯å‘éŸ³
- [ ] ä¼‘æ¯åè·å¾— +50 åˆ†
- [ ] åŒä¸€æ‘åº„åªèƒ½ä¼‘æ¯ä¸€æ¬¡ï¼Œå†æ¬¡äº¤äº’æç¤º"å·²ç»ä¼‘æ¯è¿‡äº†"
- [ ] èµ°åˆ°å•è¯å±‹/å­˜æ¡£çŸ³ç¢‘æ—æ˜¾ç¤º"å³å°†å¼€æ”¾"æç¤º
- [ ] ä¼‘æ¯åŠ¨ç”»æœŸé—´æ¸¸æˆæš‚åœ
- [ ] ç§»åŠ¨ç«¯è§¦æ§æ­£å¸¸

## äº”ã€ç‰ˆæœ¬æ›´æ–°æ“ä½œ

### 5.1 æ›´æ–°ç‰ˆæœ¬å·

**`package.json`**ï¼š`"version": "1.8.2"`

**`android-app/package.json`**ï¼š`"version": "1.8.2"`

**`android-app/android/app/build.gradle`**ï¼š
```
versionCode 61
versionName "1.8.2"
```

### 5.2 æ›´æ–° Progress.md

åœ¨ `docs/version/Progress.md` æ–‡ä»¶**é¡¶éƒ¨**æ’å…¥ï¼š

```markdown
## v1.8.2ï¼ˆå‘å¸ƒæ—¥æœŸï¼š2026-02-XXï¼‰
- ç±»å‹ï¼šPATCH
- APK ç‰ˆæœ¬ï¼šversionName = 1.8.2ï¼ŒversionCode = 61
- ä¸»è¦å˜æ›´
  - æ–°å¢ï¼šæ‘åº„ç³»ç»Ÿ - ä¼‘æ¯ç³»ç»Ÿ
  - ä¼‘æ¯å±‹äº¤äº’ï¼šæŒ‰ Y é”®/è§¦æ§æŒ‰é’®è§¦å‘ä¼‘æ¯
  - ä¼‘æ¯åŠ¨ç”»ï¼šæ¸é»‘ â†’ "ğŸ’¤ ä¼‘æ¯ä¸­..." â†’ æ¸äº®
  - ä¼‘æ¯æ•ˆæœï¼šå›æ»¡è¡€ + å¼¹å‡ºå•è¯å¡ç‰‡ + æ’­æ”¾å‘éŸ³ + å¥–åŠ± 50 åˆ†
  - æ¯ä¸ªæ‘åº„åªèƒ½ä¼‘æ¯ä¸€æ¬¡
  - å»ºç­‘äº¤äº’æç¤ºï¼ˆé—ªçƒ"æŒ‰ Y ä¼‘æ¯"ï¼‰
  - æ‘åº„è§¦æ§äº¤äº’æŒ‰é’®ï¼ˆç§»åŠ¨ç«¯ï¼‰
  - æ‘åº„å•è¯è·å–ç³»ç»Ÿï¼ˆä»è¯åº“åŒ¹é… biome ä¸“å±å•è¯ï¼‰
- æŠ€æœ¯æ”¹è¿›
  - 09-vocab.jsï¼šæ–°å¢ getVillageWords() å‡½æ•°
  - 18-village.jsï¼šæ–°å¢ handleVillageInteraction()ã€restOnBed()ã€startRestAnimation()ã€showVillageWordCard()
  - 18-village-render.jsï¼šæ–°å¢ drawBuildingInteractHint() äº¤äº’æç¤ºæ¸²æŸ“
  - 13-game-loop.jsï¼šhandleInteraction() é›†æˆæ‘åº„äº¤äº’
  - 10-ui.jsï¼šæ‘åº„äº¤äº’æŒ‰é’®æ˜¾ç¤º/éšè—é€»è¾‘
  - 16-events.jsï¼šç»‘å®šæ‘åº„äº¤äº’æŒ‰é’®äº‹ä»¶
  - Game.htmlï¼šæ–°å¢ btn-village-interact è§¦æ§æŒ‰é’®
```

### 5.3 Git æäº¤

```bash
git add src/modules/09-vocab.js src/modules/18-village.js src/modules/18-village-render.js
git add src/modules/13-game-loop.js src/modules/10-ui.js src/modules/16-events.js
git add Game.html
git add package.json android-app/package.json android-app/android/app/build.gradle
git add docs/version/Progress.md
git commit -m "feat(village): v1.8.2 ä¼‘æ¯ç³»ç»Ÿï¼ˆå›è¡€+å•è¯å¡ç‰‡+ä¼‘æ¯åŠ¨ç”»+è§¦æ§äº¤äº’ï¼‰"
git push
```
