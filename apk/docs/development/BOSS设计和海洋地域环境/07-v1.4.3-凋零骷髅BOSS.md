# Step 7: v1.4.3 - å‡‹é›¶éª·é«…BOSS

## ç‰ˆæœ¬ä¿¡æ¯
- **ç‰ˆæœ¬å·**: 1.4.3
- **versionCode**: 44
- **ä¸»é¢˜**: ç¬¬å››ä¸ªBOSS - å‡‹é›¶éª·é«…ï¼ˆè¿‘æˆ˜è‚‰æ + æ ¼æŒ¡ç ´é˜²ï¼‰
- **å‰ç½®ç‰ˆæœ¬**: v1.4.2

## ç›®æ ‡
å®ç°å‡‹é›¶éª·é«…BOSSï¼Œå”¯ä¸€ä¸ä¼šé£çš„BOSSï¼Œåœ°é¢è¿‘æˆ˜å¯¹å†³ï¼Œæœ‰ä¸‰è¿æ–©ã€è·³åŠˆã€æ ¼æŒ¡ã€å¬å”¤å°å…µã€‚

## ä¿®æ”¹æ¸…å•

### 1. åœ¨ `15-entities-boss.js` ä¸­æ–°å¢ WitherSkeletonBoss ç±»

```javascript
class WitherSkeletonBoss extends Boss {
    constructor() {
        super({
            name: 'å‡‹é›¶éª·é«… Wither Skeleton',
            maxHp: 40,
            color: '#1A1A1A',
            width: 48,
            height: 96, // 3æ ¼é«˜
            phaseThresholds: [0.6, 0.3]
        });
        this.grounded = true;     // åœ°é¢BOSS
        this.moveSpeed = 2.0;
        this.facing = -1;         // é¢æœæ–¹å‘
        this.state = 'patrol';    // patrol/combo/jump_attack/blocking/stunned/summoning
        this.comboStep = 0;       // è¿æ‹›æ­¥éª¤ 0-2
        this.comboTimer = 0;
        this.blockTimer = 0;
        this.blockHits = 0;       // æ ¼æŒ¡æœŸé—´è¢«æ”»å‡»æ¬¡æ•°
        this.stunTimer = 0;
        this.jumpAttackPhase = 0; // 0=æ— , 1=è“„åŠ›, 2=è·ƒèµ·, 3=ä¸‹è½
        this.minions = [];
        this.minionsSummoned = false;
        this.vy = 0;              // å‚ç›´é€Ÿåº¦ï¼ˆè·³åŠˆç”¨ï¼‰
        this.gravity = 0.5;
    }
}
```

### 2. æ ¸å¿ƒæˆ˜æ–—æœºåˆ¶

**ä¸‰è¿æ–©ï¼ˆç©å®¶åœ¨2æ ¼èŒƒå›´å†…è§¦å‘ï¼‰**:

```javascript
startCombo() {
    this.state = 'combo';
    this.comboStep = 0;
    this.comboTimer = 0;
}

updateCombo(dt) {
    this.comboTimer++;
    const stepDuration = 30; // æ¯æ­¥0.5ç§’

    if (this.comboTimer >= stepDuration) {
        this.comboTimer = 0;
        this.executeComboStep(this.comboStep);
        this.comboStep++;
        if (this.comboStep >= 3) {
            this.state = 'patrol';
            this.comboStep = 0;
        }
    }
}

executeComboStep(step) {
    const range = 60; // æ”»å‡»èŒƒå›´
    const playerDist = Math.abs(player.x - this.x);

    switch(step) {
        case 0: // æ¨ªæ‰« - èŒƒå›´æ”»å‡»
            if (playerDist < range + 20) {
                player.takeDamage(1);
                showFloatingText('æ¨ªæ‰«!', this.x, this.y - 20, '#FF4444');
            }
            break;
        case 1: // ä¸‹åŠˆ - å•ä½“é«˜ä¼¤
            if (playerDist < range) {
                player.takeDamage(1.5);
                showFloatingText('ä¸‹åŠˆ!', this.x, this.y - 20, '#FF0000');
            }
            break;
        case 2: // çªåˆº - å‡»é€€
            if (playerDist < range + 10) {
                player.takeDamage(0.5);
                player.vx = this.facing * -8; // å‡»é€€
                showFloatingText('çªåˆº!', this.x, this.y - 20, '#FF6600');
            }
            break;
    }
}
```

**è·³åŠˆï¼ˆç©å®¶è·ç¦»>3æ ¼æ—¶ä½¿ç”¨ï¼‰**:

```javascript
startJumpAttack() {
    this.state = 'jump_attack';
    this.jumpAttackPhase = 1; // è“„åŠ›
    this.comboTimer = 0;
}

updateJumpAttack(dt) {
    switch(this.jumpAttackPhase) {
        case 1: // è“„åŠ›ï¼ˆä¸‹è¹²0.5ç§’ï¼‰
            this.comboTimer++;
            if (this.comboTimer >= 30) {
                this.jumpAttackPhase = 2;
                this.vy = -12; // è·ƒèµ·
                // æœç©å®¶æ–¹å‘è·³
                this.facing = player.x > this.x ? 1 : -1;
            }
            break;
        case 2: // è·ƒèµ·+ä¸‹è½
            this.vy += this.gravity;
            this.y += this.vy;
            this.x += this.facing * 3;
            if (this.y >= groundY - this.height) { // ç€åœ°
                this.y = groundY - this.height;
                this.jumpAttackPhase = 3;
                this.comboTimer = 0;
                // AOEä¼¤å®³
                this.jumpAttackLand();
            }
            break;
        case 3: // ç€åœ°ç¡¬ç›´
            this.comboTimer++;
            if (this.comboTimer >= 30) {
                this.state = 'patrol';
                this.jumpAttackPhase = 0;
            }
            break;
    }
}

jumpAttackLand() {
    // ç€åœ°ç‚¹å‘¨å›´2æ ¼èŒƒå›´AOE
    const aoeRange = 64; // 2æ ¼
    const dist = Math.abs(player.x - this.x);
    if (dist < aoeRange) {
        player.takeDamage(2);
        player.vy = -6; // å‡»é£
        showFloatingText('ğŸ’¥ è·³åŠˆ!', this.x, this.y - 30, '#FF0000');
    }
    // åœ°é¢éœ‡åŠ¨ç²’å­
    for (let i = 0; i < 10; i++) {
        this.particles.push({
            x: this.x + (Math.random()-0.5) * aoeRange * 2,
            y: groundY,
            vx: (Math.random()-0.5) * 3,
            vy: -Math.random() * 4,
            life: 1.0
        });
    }
}
```

**æ ¼æŒ¡ä¸ç ´é˜²**:

```javascript
startBlocking() {
    this.state = 'blocking';
    this.blockTimer = 180; // 3ç§’
    this.blockHits = 0;
}

updateBlocking(dt) {
    this.blockTimer--;
    if (this.blockTimer <= 0) {
        this.state = 'patrol';
        return;
    }
    // è¢«æ”»å‡»æ—¶è®¡æ•°
    // ï¼ˆåœ¨ takeDamage ä¸­æ£€æµ‹ï¼‰
}

takeDamage(amount) {
    if (this.state === 'blocking') {
        this.blockHits++;
        showFloatingText('æ ¼æŒ¡!', this.x, this.y - 20, '#AAAAAA');
        if (this.blockHits >= 7) {
            // ç ´é˜²ï¼
            this.state = 'stunned';
            this.stunTimer = 180; // 3ç§’çœ©æ™•
            showFloatingText('â­ ç ´é˜²!', this.x, this.y - 30, '#FFD700');
        }
        return; // æ ¼æŒ¡æœŸé—´ä¸å—ä¼¤
    }
    super.takeDamage(amount);
}
```

**å¬å”¤å°å…µï¼ˆè¡€é‡<30%ï¼‰**:

```javascript
summonMinions() {
    if (this.minionsSummoned) return;
    this.minionsSummoned = true;
    this.state = 'summoning';

    for (let i = 0; i < 4; i++) {
        this.minions.push({
            x: this.x + (i - 1.5) * 50,
            y: groundY - 48,
            hp: 5, maxHp: 5,
            width: 24, height: 48,
            speed: 2.0,
            attackTimer: 0,
            alive: true
        });
    }
    showFloatingText('ğŸ’€ å¬å”¤éª·é«…å°å…µ!', this.x, this.y - 30, '#666');
}
```

### 3. å‡‹é›¶éª·é«…æ¸²æŸ“

```javascript
render(ctx) {
    const drawX = this.x;
    const drawY = this.y;

    // è“„åŠ›ä¸‹è¹²æ•ˆæœ
    const squash = this.jumpAttackPhase === 1 ? 0.8 : 1;

    // èº«ä½“ï¼ˆé»‘è‰²é«˜å¤§éª·é«…ï¼‰
    ctx.fillStyle = this.flashTimer > 0 ? '#FFF' : '#1A1A1A';
    ctx.fillRect(drawX, drawY + this.height * (1-squash), this.width, this.height * squash);

    // éª·é«…å¤´
    ctx.fillStyle = '#2A2A2A';
    ctx.fillRect(drawX + 8, drawY - 4 + this.height * (1-squash), 32, 28);
    // çœ¼ç›ï¼ˆçº¢è‰²ï¼‰
    ctx.fillStyle = '#FF0000';
    ctx.fillRect(drawX + 14, drawY + 4 + this.height * (1-squash), 6, 6);
    ctx.fillRect(drawX + 28, drawY + 4 + this.height * (1-squash), 6, 6);

    // çŸ³å‰‘
    ctx.fillStyle = '#808080';
    const swordX = this.facing > 0 ? drawX + this.width : drawX - 12;
    ctx.fillRect(swordX, drawY + 20, 8, 40);
    ctx.fillStyle = '#A0A0A0';
    ctx.fillRect(swordX - 4, drawY + 56, 16, 6); // å‰‘æŸ„

    // æ ¼æŒ¡çŠ¶æ€ - ç™½è‰²é˜²æŠ¤ç½©
    if (this.state === 'blocking') {
        ctx.strokeStyle = 'rgba(255,255,255,0.6)';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.arc(drawX + this.width/2, drawY + this.height/2, 50, 0, Math.PI*2);
        ctx.stroke();
    }

    // çœ©æ™•çŠ¶æ€ - å¤´é¡¶æ˜Ÿæ˜Ÿ
    if (this.state === 'stunned') {
        const starY = drawY - 20;
        for (let i = 0; i < 3; i++) {
            const sx = drawX + 10 + i * 14 + Math.sin(Date.now()/200 + i) * 5;
            ctx.fillStyle = '#FFD700';
            ctx.font = '14px Arial';
            ctx.fillText('â­', sx, starY);
        }
    }

    // æ¸²æŸ“å°å…µ
    this.minions.forEach(m => {
        if (!m.alive) return;
        ctx.fillStyle = '#333';
        ctx.fillRect(m.x, m.y, m.width, m.height);
        // å°è¡€æ¡
        ctx.fillStyle = '#F44336';
        ctx.fillRect(m.x, m.y - 5, m.width * (m.hp/m.maxHp), 3);
    });
}
```

### 4. AIçŠ¶æ€æœº

```javascript
updateBehavior(dt) {
    // é¢æœç©å®¶
    this.facing = player.x > this.x ? 1 : -1;
    const dist = Math.abs(player.x - this.x);

    switch(this.state) {
        case 'patrol':
            // å‘ç©å®¶ç§»åŠ¨
            this.x += this.facing * this.moveSpeed;

            // è¿‘è·ç¦» â†’ ä¸‰è¿æ–©
            if (dist < 64) {
                this.startCombo();
            }
            // è¿œè·ç¦» â†’ è·³åŠˆ
            else if (dist > 96 && Math.random() < 0.01) {
                this.startJumpAttack();
            }
            // éšæœºæ ¼æŒ¡
            if (Math.random() < 0.003) {
                this.startBlocking();
            }
            break;

        case 'combo':
            this.updateCombo(dt);
            break;

        case 'jump_attack':
            this.updateJumpAttack(dt);
            break;

        case 'blocking':
            this.updateBlocking(dt);
            break;

        case 'stunned':
            this.stunTimer--;
            if (this.stunTimer <= 0) this.state = 'patrol';
            break;
    }

    // è¡€é‡<30%å¬å”¤å°å…µ
    if (this.hp / this.maxHp < 0.3) {
        this.summonMinions();
    }

    this.updateMinions(dt);
}
```

## æµ‹è¯•è¦ç‚¹

1. ç¬¬20å…³åè¿›å…¥å‡‹é›¶éª·é«…BOSSæˆ˜
2. BOSSåœ¨åœ°é¢è¡Œèµ°ï¼Œä¸ä¼šé£
3. è¿‘è·ç¦»è§¦å‘ä¸‰è¿æ–©ï¼ˆæ¨ªæ‰«â†’ä¸‹åŠˆâ†’çªåˆºï¼‰
4. è¿œè·ç¦»è§¦å‘è·³åŠˆï¼ˆè“„åŠ›â†’è·ƒèµ·â†’AOEç€åœ°ï¼‰
5. éšæœºè¿›å…¥æ ¼æŒ¡çŠ¶æ€ï¼ˆæ”»å‡»æ— æ•ˆï¼‰
6. æ ¼æŒ¡æœŸé—´è¿ç»­æ”»å‡»7æ¬¡ â†’ ç ´é˜²çœ©æ™•3ç§’
7. è¡€é‡<30% â†’ å¬å”¤4åªéª·é«…å°å…µ
8. å‡»æ€BOSS â†’ å¥–åŠ±

## æäº¤ä¿¡æ¯

```
feat: å‡‹é›¶éª·é«…BOSS - è¿‘æˆ˜æ ¼æŒ¡ç ´é˜² (v1.4.3)

- æ–°å¢å‡‹é›¶éª·é«…BOSSï¼ˆ40è¡€ï¼Œåœ°é¢è¿‘æˆ˜ï¼‰
- ä¸‰è¿æ–©è¿æ‹›ï¼šæ¨ªæ‰«â†’ä¸‹åŠˆâ†’çªåˆº
- è·³åŠˆAOEæ”»å‡»
- æ ¼æŒ¡æœºåˆ¶ï¼šè¿å‡»7æ¬¡ç ´é˜²ï¼Œçœ©æ™•3ç§’
- è¡€é‡<30%å¬å”¤4åªéª·é«…å°å…µ
```
