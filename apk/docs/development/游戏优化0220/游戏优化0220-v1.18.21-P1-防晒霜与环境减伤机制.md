# v1.18.21 (P1) - 防晒霜与环境减伤机制

## 1. 版本目标

- 新增“防晒霜”商品（5 钻石，持续 3 分钟）。
- 防晒霜生效期间：沙漠减伤、地狱减伤、岩浆减伤（或免伤按最终规则）。
- 护甲减伤比例体系明确并接入伤害计算。

## 2. 计划修改文件

- `apk/src/modules/18-village.js`（商店出售防晒霜）
- `apk/src/modules/06-biome.js`（环境伤害判定）
- `apk/src/modules/13-game-loop.js`（通用 damagePlayer 减伤入口）
- `apk/src/modules/01-config.js`（防晒霜与护甲减伤配置）

## 3. 规则建议

- 防晒霜 Buff：
: `sunscreen`，持续 `180000ms`
- 护甲减伤（示例）：
: 木 10%，铁 20%，金 15%，钻石 30%
- 叠加策略：
: 防晒霜与护甲取“相加后上限 80%”或“取较大值”，建议先用“较大值”降低复杂度。

## 4. Step by Step

1. Buff 接入
- 复用 `setVillageBuff/hasVillageBuff`，新增 `sunscreen` 类型。

2. 环境伤害拦截
- 在 `updateExtremeHeatEnvironment` 与岩浆受伤点增加防晒霜判断。
- 输出可见提示：`🧴 防晒霜生效中`（低频提示，防刷屏）。

3. 护甲减伤落地
- `damagePlayer` 入口读取当前护甲，计算最终伤害。
- 兼容已有无敌帧与特殊免伤状态。

## 5. 验收标准

- 防晒霜购买后 3 分钟内效果稳定，超时自动失效。
- 沙漠/地狱/岩浆环境受伤显著下降或按规则免伤。
- 护甲减伤在普通敌人与环境伤害上均生效（按最终定义）。

## 6. 风险与回滚

- 风险：免伤过强造成关卡失衡。
- 防护：先上“减伤版”，免伤作为后续可配置开关。
