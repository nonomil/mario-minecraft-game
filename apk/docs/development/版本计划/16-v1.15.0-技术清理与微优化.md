# v1.15.0 — 技术清理与微优化

> **优先级**: P3
> **版本号**: 1.15.0 / versionCode: 93
> **前置版本**: v1.14.0（UI/UX 与性能优化完成）
> **预期效果**: 屏幕外实体更新节流扩展、删除废弃 main.js

---

## 问题描述

1. **屏幕外实体节流不完整**：`13-game-loop.js:5-13` 已有 `optimizedUpdate()` 对屏幕外实体每 3 帧更新一次，但只用于部分实体，装饰物和粒子未纳入。
2. **废弃文件占用仓库空间**：`src/main.js`（7,683 行）是拆分前的遗留文件，`Game.html` 已不引用它，但仍存在于仓库中造成维护困惑。

---

## 修改清单

### Step 1: 屏幕外实体更新节流扩展

#### 文件: `src/modules/13-game-loop.js`

**位置**: `optimizedUpdate()` 函数定义（约第 5-13 行）及主循环中装饰物/粒子更新逻辑

**当前 `optimizedUpdate` 实现**:
```javascript
function optimizedUpdate(entity, updateFn) {
    const onScreen = entity.x > cameraX - 100 &&
                     entity.x < cameraX + canvas.width + 100;
    if (onScreen || gameFrame % 3 === 0) {
        updateFn();
    }
}
```

**操作 A**: 将装饰物更新纳入节流（搜索装饰物 update 循环）:

找到类似以下的装饰物更新代码:
```javascript
decorations.forEach(d => {
    if (d.update) d.update();
});
```

**改为**:
```javascript
decorations.forEach(d => {
    if (d.update) {
        optimizedUpdate(d, () => d.update());
    }
});
```

**操作 B**: 粒子更新也纳入节流（仅对屏幕外粒子）:

找到粒子更新循环:
```javascript
particles.forEach(p => {
    if (p.update) p.update();
});
```

**改为**:
```javascript
particles.forEach(p => {
    if (p.update) {
        optimizedUpdate(p, () => p.update());
    }
});
```

**注意**: 粒子的 `life` 衰减仍需每帧执行（否则粒子不会消失）。如果粒子的 `update()` 内含 life 衰减，需要将 life 衰减提取到节流外:
```javascript
particles.forEach(p => {
    // life 衰减始终执行
    if (typeof p.life === "number") p.life -= p.decay || 0.01;
    // 位置/动画更新可节流
    if (p.update) {
        optimizedUpdate(p, () => p.update());
    }
});
```

具体是否需要提取 life 衰减，取决于各粒子类的 `update()` 实现。实施前需检查 `Snowflake.update()`、`LeafParticle.update()` 等是否在 update 内做 life 衰减。如果是，则需要上述提取；如果 life 衰减在 filter 阶段做，则不需要。

**验证**: 在有大量装饰物的群系（如蘑菇森林）中游玩，FPS 应略有提升或至少不下降。视觉效果不应有明显差异。

---

### Step 2: 删除废弃的 main.js

#### 文件: `src/main.js`

**操作**: 直接删除此文件。

**前置确认**（实施前必须验证）:
1. `Game.html` 中不存在 `<script src="main.js">` 或类似引用。
2. `GameDebug.html` 中不存在对 `main.js` 的引用。
3. 构建脚本 `tools/build-singlefile.js` 不引用 `main.js`。
4. 其他 HTML 文件不引用 `main.js`。

**验证命令**:
```bash
grep -r "main.js" --include="*.html" --include="*.js" --include="*.json" src/ *.html tools/
```

如果 grep 结果为空或仅在注释中出现，则可安全删除。

```bash
git rm src/main.js
```

**验证**: 删除后游戏正常运行，所有功能不受影响。

---

## 验证步骤

### A. 节流扩展验证

1. 进入蘑菇森林或樱花丛林（装饰物密集的群系）。
2. 快速移动使大量装饰物进出屏幕。
3. 确认装饰物在进入屏幕时正常显示和动画。
4. 确认粒子效果（雪花、树叶等）正常显示和消失。
5. 使用 DevTools Performance 面板对比改动前后的帧时间。

### B. main.js 删除验证

1. 删除后打开 `Game.html`，确认游戏正常启动。
2. 确认所有群系、BOSS、村庄、挑战功能正常。
3. 确认 `GameDebug.html` 正常工作。
4. 确认构建脚本 `tools/build-singlefile.js` 正常执行。

### C. 回归验证（必须）

1. 首页首次进入与重进后地面持续可见。
2. 触控按钮不丢失响应。
3. BOSS 与村庄触发链路不回归。
4. v1.12.0/v1.13.0/v1.14.0 功能正常。

---

## 版本发布步骤

```bash
# 1. 更新版本号
# apk/package.json → "version": "1.15.0"
# apk/android-app/package.json → "version": "1.15.0"
# build.gradle → versionName "1.15.0", versionCode 93

# 2. 更新版本文档
# docs/version/CHANGELOG.md → 追加 v1.15.0 条目
# docs/version/Progress.md → 追加 v1.15.0 条目

# 3. 提交
git rm src/main.js
git add src/modules/13-game-loop.js
git add apk/package.json apk/android-app/package.json
git add docs/version/CHANGELOG.md docs/version/Progress.md
git commit -m "feat(v1.15.0): extend off-screen throttling, remove deprecated main.js"

# 4. 推送
push.bat
```

---

## CHANGELOG 条目（预写）

```markdown
## v1.15.0 (2026-02-xx)

### 性能
- 装饰物和粒子更新纳入屏幕外节流（每 3 帧更新一次）

### 清理
- 删除废弃的 src/main.js（7,683 行），所有功能已在 modules/ 中
```

---

*编制日期：2026-02-16*
