# å­¦ä¹ æ€§ä¸æ¸¸æˆæ€§ä¼˜åŒ– â€” è¯¦ç»†å®æ–½è®¡åˆ’

> åŸºäºä»£ç å®¡æŸ¥å’Œç°çŠ¶åˆ†æï¼Œ2026-02-14

---

## å‰ç½®æ¡ä»¶ï¼šæ‰©å±•ç­”é¢˜æ•°æ®ç»“æ„

> æ‰€æœ‰åç»­æ”¹åŠ¨ï¼ˆå®ç®±å­¦ä¹ ã€ç»Ÿè®¡é¢æ¿ã€å¤ä¹ ç³»ç»Ÿï¼‰éƒ½ä¾èµ–ç­”é¢˜æ­£ç¡®ç‡æ•°æ®ã€‚å¿…é¡»å…ˆåšã€‚

### Step 1.1 â€” æ–°å¢ challengeStats å­˜å‚¨ç»“æ„

**æ–‡ä»¶**ï¼š`src/modules/09-vocab.js`

åœ¨ `normalizeProgress()` ä¸­æ‰©å±• progress ç»“æ„ï¼š

```javascript
// ç°æœ‰
p.vocab = { ... }

// æ–°å¢
p.challengeStats = p.challengeStats || {};
// ç»“æ„ï¼š
// p.challengeStats["apple"] = { correct: 3, wrong: 1, lastSeen: 1707900000000 }
```

### Step 1.2 â€” åœ¨ completeLearningChallenge ä¸­è®°å½•ç­”é¢˜ç»“æœ

**æ–‡ä»¶**ï¼š`src/modules/12-challenges.js`

åœ¨ `completeLearningChallenge(correct)` å‡½æ•°ä¸­ï¼ˆçº¦ç¬¬284è¡Œï¼‰ï¼Œ`hideLearningChallenge()` ä¹‹åã€å¥–æƒ©é€»è¾‘ä¹‹å‰ï¼Œæ’å…¥ï¼š

```javascript
// è®°å½•ç­”é¢˜ç»Ÿè®¡
const wordEn = currentLearningChallenge?.wordObj?.en;
if (wordEn) {
    if (!progress.challengeStats) progress.challengeStats = {};
    const stat = progress.challengeStats[wordEn] || { correct: 0, wrong: 0, lastSeen: 0 };
    if (correct) stat.correct++;
    else stat.wrong++;
    stat.lastSeen = Date.now();
    progress.challengeStats[wordEn] = stat;
    saveProgress();
}
```

### Step 1.3 â€” æä¾›ç»Ÿè®¡æŸ¥è¯¢è¾…åŠ©å‡½æ•°

**æ–‡ä»¶**ï¼š`src/modules/09-vocab.js`ï¼ˆæœ«å°¾è¿½åŠ ï¼‰

```javascript
function getChallengeStats() {
    const stats = progress.challengeStats || {};
    const words = Object.keys(stats);
    let totalCorrect = 0, totalWrong = 0;
    words.forEach(w => {
        totalCorrect += stats[w].correct || 0;
        totalWrong += stats[w].wrong || 0;
    });
    const total = totalCorrect + totalWrong;
    return {
        wordCount: words.length,
        totalCorrect,
        totalWrong,
        accuracy: total > 0 ? Math.round(totalCorrect / total * 100) : 0,
        details: stats
    };
}
```

### éªŒè¯æ–¹å¼

- æ‰“å¼€æ¸¸æˆï¼Œæ”¶é›†å•è¯è§¦å‘ Challenge
- ç­”é¢˜ååœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œ `JSON.parse(localStorage.getItem("mmwg:progress")).challengeStats`
- ç¡®è®¤æœ‰å¯¹åº”å•è¯çš„ correct/wrong/lastSeen æ•°æ®

---

## æ”¹åŠ¨ä¸€ï¼šå®ç®±ç»‘å®šå­¦ä¹ ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰

> å°†éšæœºå¼¹å‡ºçš„ Challenge æ”¹ä¸ºåœ¨å®ç®±äº¤äº’æ—¶è§¦å‘ï¼Œè§£å†³"æ‰“æ–­å¿ƒæµ"é—®é¢˜ã€‚

### Step 2.1 â€” ä¿®æ”¹ handleInteraction() æ‹¦æˆªå®ç®±å¼€å¯

**æ–‡ä»¶**ï¼š`src/modules/13-game-loop.js`ï¼ˆç¬¬733-753è¡Œï¼‰

å°† `handleInteraction()` ä¸­çš„ `nearestChest.open()` æ”¹ä¸ºå…ˆè§¦å‘ç­”é¢˜ï¼š

```javascript
// åŸä»£ç ï¼ˆç¬¬749-750è¡Œï¼‰ï¼š
} else {
    nearestChest.open();
}

// æ”¹ä¸ºï¼š
} else {
    if (settings.learningMode && settings.challengeEnabled && !currentLearningChallenge) {
        // ä»å½“å‰è¯åº“éšæœºå–ä¸€ä¸ªå•è¯
        const wordObj = pickNextWord();
        if (wordObj) {
            startLearningChallenge(wordObj, null, nearestChest);  // origin = chest å®ä¾‹
        } else {
            nearestChest.open();  // æ— å¯ç”¨å•è¯æ—¶ç›´æ¥å¼€ç®±
        }
    } else {
        nearestChest.open();  // å­¦ä¹ æ¨¡å¼å…³é—­æ—¶ç›´æ¥å¼€ç®±
    }
}
```

éœ€è¦ç¡®è®¤ `pickNextWord()` å‡½æ•°æ˜¯å¦å­˜åœ¨ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œéœ€è¦æ–°å¢ä¸€ä¸ªä» `wordDatabase` ä¸­éšæœºå–è¯çš„å‡½æ•°ã€‚

### Step 2.2 â€” ä¿®æ”¹ completeLearningChallenge() å¤„ç†å®ç®±æ¥æº

**æ–‡ä»¶**ï¼š`src/modules/12-challenges.js`ï¼ˆç¬¬284-309è¡Œï¼‰

åœ¨ `completeLearningChallenge(correct)` ä¸­ï¼Œç°æœ‰çš„ `challengeOrigin instanceof WordGate` åˆ†æ”¯ä¹‹åï¼Œæ–°å¢ Chest åˆ†æ”¯ï¼š

```javascript
// ç°æœ‰ä»£ç ï¼ˆç¬¬294-298è¡Œï¼‰ï¼š
if (challengeOrigin && challengeOrigin instanceof WordGate) {
    challengeOrigin.locked = false;
    challengeOrigin.remove = true;
    showToast("ğŸ’  è¯è¯­é—¸é—¨å·²è§£é”ï¼");
}

// åœ¨å…¶åè¿½åŠ ï¼š
if (challengeOrigin && challengeOrigin instanceof Chest) {
    if (correct) {
        // ç­”å¯¹ï¼šæå‡ç¨€æœ‰åº¦åå¼€ç®±
        challengeOrigin._rarityBoost = true;
    }
    challengeOrigin.open();  // æ— è®ºå¯¹é”™éƒ½å¼€ç®±
}
```

åŒæ ·åœ¨ `else`ï¼ˆç­”é”™ï¼‰åˆ†æ”¯ä¸­ï¼š

```javascript
// ç°æœ‰ä»£ç ï¼ˆç¬¬302-304è¡Œï¼‰ï¼š
if (challengeOrigin && challengeOrigin instanceof WordGate) {
    challengeOrigin.cooldown = 180;
}

// åœ¨å…¶åè¿½åŠ ï¼š
if (challengeOrigin && challengeOrigin instanceof Chest) {
    challengeOrigin.open();  // ç­”é”™ä¹Ÿå¼€ç®±ï¼Œåªæ˜¯ä¸æå‡ç¨€æœ‰åº¦
}
```

### Step 2.3 â€” ä¿®æ”¹ Chest.open() æ”¯æŒç¨€æœ‰åº¦æå‡

**æ–‡ä»¶**ï¼š`src/modules/15-entities-base.js`ï¼ˆç¬¬75-128è¡Œï¼‰

åœ¨ `open()` æ–¹æ³•ä¸­ï¼Œ`pickChestRarity()` ä¹‹ååŠ å…¥ç¨€æœ‰åº¦æå‡é€»è¾‘ï¼š

```javascript
// ç°æœ‰ä»£ç ï¼ˆç¬¬80è¡Œï¼‰ï¼š
const rarity = pickChestRarity(lootCfg.chestRarities, diff.chestRareBoost);

// æ”¹ä¸ºï¼š
let rarity = pickChestRarity(lootCfg.chestRarities, diff.chestRareBoost);
if (this._rarityBoost) {
    const levels = ['common', 'rare', 'epic', 'legendary'];
    const idx = levels.indexOf(rarity);
    if (idx >= 0 && idx < levels.length - 1) {
        rarity = levels[idx + 1];
    }
    this._rarityBoost = false;
}
```

### Step 2.4 â€” é™ä½éšæœº Challenge è§¦å‘é¢‘ç‡

**æ–‡ä»¶**ï¼š`src/modules/12-challenges.js`

åœ¨ `maybeTriggerLearningChallenge()` ä¸­ï¼ˆç¬¬188è¡Œï¼‰ï¼Œå½“å®ç®±å­¦ä¹ å¼€å¯æ—¶ï¼Œé™ä½æˆ–å…³é—­éšæœºè§¦å‘ï¼š

```javascript
function maybeTriggerLearningChallenge(wordObj) {
    if (!wordObj || !wordObj.en) return;
    registerCollectedWord(wordObj);
    // å¦‚æœå®ç®±å­¦ä¹ å·²å¼€å¯ï¼Œä¸å†éšæœºå¼¹å‡º Challengeï¼ˆé¿å…åŒé‡æ‰“æ–­ï¼‰
    // ä¿ç•™ WordGate è§¦å‘ä¸å—å½±å“
    if (settings.chestLearningEnabled) return;
    if (!shouldTriggerLearningChallenge(wordObj)) return;
    startLearningChallenge(wordObj);
}
```

### Step 2.5 â€” æ–°å¢é…ç½®é¡¹

**æ–‡ä»¶**ï¼š`src/defaults.js`ï¼ˆæˆ– `src/modules/01-config.js`ï¼Œå–å†³äº defaultSettings å®šä¹‰ä½ç½®ï¼‰

```javascript
chestLearningEnabled: true,  // å®ç®±æ˜¯å¦å…³è”å­¦ä¹ ç­”é¢˜
```

åœ¨ `normalizeSettings()` ä¸­åŠ å…¥ï¼š

```javascript
if (typeof merged.chestLearningEnabled !== "boolean")
    merged.chestLearningEnabled = defaultSettings.chestLearningEnabled ?? true;
```

### éªŒè¯æ–¹å¼

1. å¼€å¯ learningModeï¼Œé è¿‘å®ç®±æŒ‰äº¤äº’é”®
2. åº”å¼¹å‡º Challenge ç­”é¢˜ç•Œé¢ï¼ˆè€Œéç›´æ¥å¼€ç®±ï¼‰
3. ç­”å¯¹ â†’ å¼€ç®±ï¼ŒToast æ˜¾ç¤ºæ›´é«˜ç¨€æœ‰åº¦
4. ç­”é”™ â†’ å¼€ç®±ï¼Œç¨€æœ‰åº¦ä¸å˜
5. æ”¶é›†å•è¯æ—¶ä¸å†éšæœºå¼¹å‡º Challenge
6. å…³é—­ chestLearningEnabled â†’ å®ç®±ç›´æ¥å¼€å¯ï¼Œè¡Œä¸ºæ¢å¤åŸæ ·

---

## æ”¹åŠ¨äºŒï¼šç¯å¢ƒå•è¯æ ‡ç­¾ï¼ˆçº¯å¢é‡ï¼Œç‹¬ç«‹æ€§å¼ºï¼‰

> åœ¨æ•Œäºº/ç‰©å“ä¸Šæ–¹æ˜¾ç¤ºè‹±æ–‡åï¼Œå®ç°é›¶å‹åŠ›çš„è¢«åŠ¨æµ¸å…¥å­¦ä¹ ã€‚

### Step 3.1 â€” å®šä¹‰å®ä½“è‹±æ–‡åæ˜ å°„è¡¨

**æ–‡ä»¶**ï¼š`src/modules/01-config.js`ï¼ˆæˆ–æ–°å»º `src/modules/entity-names.js`ï¼Œåœ¨ Game.html ä¸­å¼•å…¥ï¼‰

```javascript
const ENTITY_NAMES = {
    // æ•Œäºº
    zombie:          { en: "ZOMBIE",          zh: "åƒµå°¸" },
    spider:          { en: "SPIDER",          zh: "èœ˜è››" },
    creeper:         { en: "CREEPER",         zh: "çˆ¬è¡Œè€…" },
    skeleton:        { en: "SKELETON",        zh: "éª·é«…" },
    enderman:        { en: "ENDERMAN",        zh: "æœ«å½±äºº" },
    ender_dragon:    { en: "ENDER DRAGON",    zh: "æœ«å½±é¾™" },
    // å‹æ–¹
    iron_golem:      { en: "IRON GOLEM",      zh: "é“å‚€å„¡" },
    snow_golem:      { en: "SNOW GOLEM",      zh: "é›ªå‚€å„¡" },
    // ç‰©å“ï¼ˆå®ç®±å†…ï¼‰
    diamond:         { en: "DIAMOND",         zh: "é’»çŸ³" },
    iron:            { en: "IRON",            zh: "é“" },
    pumpkin:         { en: "PUMPKIN",         zh: "å—ç“œ" },
    stick:           { en: "STICK",           zh: "æœ¨æ£" }
};
```

### Step 3.2 â€” æ–°å¢ drawEntityLabel() é€šç”¨å‡½æ•°

**æ–‡ä»¶**ï¼š`src/modules/14-renderer-entities.js`ï¼ˆæ–‡ä»¶é¡¶éƒ¨è¿½åŠ ï¼‰

```javascript
function drawEntityLabel(x, y, width, type) {
    if (!settings.showEnvironmentWords) return;
    const entry = ENTITY_NAMES[type];
    if (!entry) return;

    const centerX = x + width / 2;
    const labelY = y - 14;

    ctx.save();
    ctx.font = "bold 11px Arial";
    ctx.textAlign = "center";
    ctx.strokeStyle = "rgba(0,0,0,0.7)";
    ctx.lineWidth = 3;
    ctx.strokeText(entry.en, centerX, labelY);
    ctx.fillStyle = "rgba(255,255,255,0.9)";
    ctx.fillText(entry.en, centerX, labelY);
    ctx.restore();
}
```

### Step 3.3 â€” åœ¨ drawEnemy() æœ«å°¾è°ƒç”¨

**æ–‡ä»¶**ï¼š`src/modules/14-renderer-entities.js`ï¼ˆç¬¬69-102è¡Œï¼‰

åœ¨ `drawEnemy()` å‡½æ•°æœ«å°¾ï¼Œè¡€æ¡ç»˜åˆ¶ä¹‹åè¿½åŠ ï¼š

```javascript
// ç°æœ‰ä»£ç ï¼ˆç¬¬99-101è¡Œï¼‰ï¼š
if (enemy.hp < enemy.maxHp) {
    drawHealthBar(enemy.x, enemy.y - 8, enemy.width, enemy.hp, enemy.maxHp);
}

// åœ¨å…¶åè¿½åŠ ï¼š
drawEntityLabel(enemy.x, enemy.y - (enemy.hp < enemy.maxHp ? 16 : 0), enemy.width, enemy.type);
```

### Step 3.4 â€” åœ¨ drawGolem() æœ«å°¾è°ƒç”¨

**æ–‡ä»¶**ï¼š`src/modules/14-renderer-entities.js`ï¼ˆç¬¬255-277è¡Œï¼‰

åœ¨ `drawGolem()` æœ«å°¾è¿½åŠ ï¼š

```javascript
// ç°æœ‰ä»£ç ï¼ˆç¬¬276è¡Œï¼‰ï¼š
drawHealthBar(x, y - 8, golem.width, golem.hp, golem.maxHp);

// åœ¨å…¶åè¿½åŠ ï¼š
const golemType = golem.type === "iron" ? "iron_golem" : "snow_golem";
drawEntityLabel(x, y - 16, golem.width, golemType);
```

### Step 3.5 â€” åœ¨å®ç®±æ¸²æŸ“å¤„è°ƒç”¨

**æ–‡ä»¶**ï¼š`src/modules/14-renderer-main.js`ï¼ˆç¬¬32è¡Œé™„è¿‘ï¼‰

```javascript
// ç°æœ‰ä»£ç ï¼š
chests.forEach(c => drawChest(c.x, c.y, c.opened));

// æ”¹ä¸ºï¼š
chests.forEach(c => {
    drawChest(c.x, c.y, c.opened);
    if (!c.opened) drawEntityLabel(c.x, c.y, c.width || blockSize * 0.8, "chest");
});
```

æ³¨æ„ï¼šéœ€è¦ç¡®è®¤ `drawChest` å‡½æ•°ç­¾åå’Œ `c.width` æ˜¯å¦å¯ç”¨ã€‚Chest ç»§æ‰¿è‡ª Entityï¼Œæœ‰ width å±æ€§ã€‚

### Step 3.6 â€” æ–°å¢é…ç½®é¡¹

**æ–‡ä»¶**ï¼š`src/defaults.js`

```javascript
showEnvironmentWords: true,  // æ˜¯å¦æ˜¾ç¤ºç¯å¢ƒå•è¯æ ‡ç­¾
```

åœ¨ `normalizeSettings()` ä¸­åŠ å…¥ï¼š

```javascript
if (typeof merged.showEnvironmentWords !== "boolean")
    merged.showEnvironmentWords = defaultSettings.showEnvironmentWords ?? true;
```

### Step 3.7 â€” è®¾ç½®é¢æ¿å¢åŠ å¼€å…³ï¼ˆå¯é€‰ï¼‰

**æ–‡ä»¶**ï¼š`Game.html` è®¾ç½®é¢æ¿åŒºåŸŸ

åœ¨å­¦ä¹ ç›¸å…³è®¾ç½®åŒºåŸŸæ·»åŠ ï¼š

```html
<label><input type="checkbox" id="opt-env-words"> æ˜¾ç¤ºç¯å¢ƒå•è¯æ ‡ç­¾</label>
```

**æ–‡ä»¶**ï¼š`src/modules/16-events.js` è®¾ç½®è¯»å†™å¤„

```javascript
// è¯»å–
if (optEnvWords) optEnvWords.checked = !!settings.showEnvironmentWords;
// ä¿å­˜
if (optEnvWords) settings.showEnvironmentWords = !!optEnvWords.checked;
```

### éªŒè¯æ–¹å¼

1. å¼€å§‹æ¸¸æˆï¼Œé‡åˆ°åƒµå°¸ â†’ å¤´ä¸Šæ˜¾ç¤º "ZOMBIE"
2. é‡åˆ°èœ˜è›› â†’ æ˜¾ç¤º "SPIDER"
3. å®ç®±æœªå¼€å¯æ—¶æ˜¾ç¤º "CHEST"ï¼Œå¼€å¯åä¸æ˜¾ç¤º
4. è®¾ç½®ä¸­å…³é—­å¼€å…³ â†’ æ ‡ç­¾æ¶ˆå¤±

---

## æ”¹åŠ¨ä¸‰ï¼šBiome åˆ‡æ¢æ—¶è§¦å‘å¤ä¹ 

> åˆ©ç”¨ biome åˆ‡æ¢è¿™ä¸ªè‡ªç„¶åœé¡¿ç‚¹ï¼Œè§¦å‘å¿«é€Ÿå¤ä¹ ã€‚æ›¿ä»£æ–¹æ¡ˆ2ä¸­ä¸å¯è¡Œçš„"æ¯3å…³å¤ä¹ "ã€‚

### Step 4.1 â€” æ–°å¢ getWordsForReview() å‡½æ•°

**æ–‡ä»¶**ï¼š`src/modules/09-vocab.js`ï¼ˆæœ«å°¾è¿½åŠ ï¼‰

```javascript
function getWordsForReview(count) {
    count = count || 3;
    const stats = progress.challengeStats || {};
    const now = Date.now();
    const candidates = [];

    // ä»ç­”é¢˜è®°å½•ä¸­æ‰¾å‡º"è¯¥å¤ä¹ "çš„å•è¯
    for (const word in stats) {
        const s = stats[word];
        const total = (s.correct || 0) + (s.wrong || 0);
        if (total === 0) continue;

        // ç®€å•é—´éš”ç­–ç•¥ï¼šç­”å¯¹è¶Šå¤šï¼Œå¤ä¹ é—´éš”è¶Šé•¿
        const level = Math.min(s.correct || 0, 5);
        const intervals = [0, 60000, 300000, 900000, 3600000, 86400000]; // 0/1min/5min/15min/1h/1d
        const nextReview = (s.lastSeen || 0) + (intervals[level] || 0);

        if (now >= nextReview) {
            // ä¼˜å…ˆå¤ä¹ ï¼šé”™è¯¯ç‡é«˜çš„ + ä¹…æœªå¤ä¹ çš„
            const errorRate = (s.wrong || 0) / total;
            const timeSince = now - (s.lastSeen || 0);
            candidates.push({
                word,
                priority: errorRate * 100 + timeSince / 60000
            });
        }
    }

    candidates.sort((a, b) => b.priority - a.priority);
    return candidates.slice(0, count).map(c => {
        // æ‰¾åˆ°å®Œæ•´çš„ wordObj
        const found = wordDatabase.find(w => w.en === c.word);
        return found || { en: c.word, zh: stats[c.word]?.zh || "" };
    });
}
```

### Step 4.2 â€” åœ¨ updateCurrentBiome() ä¸­è§¦å‘å¤ä¹ 

**æ–‡ä»¶**ï¼š`src/modules/06-biome.js`ï¼ˆç¬¬54-77è¡Œï¼‰

åœ¨ `updateCurrentBiome()` ä¸­ï¼Œbiome åˆ‡æ¢æˆåŠŸåï¼ˆ`showToast` ä¹‹åï¼‰ï¼Œæ’å…¥å¤ä¹ è§¦å‘ï¼š

```javascript
// ç°æœ‰ä»£ç ï¼ˆç¬¬59è¡Œï¼‰ï¼š
showToast(`ğŸŒ è¿›å…¥${nextBiome.name}ç¾¤ç³»`);

// åœ¨å…¶åè¿½åŠ ï¼š
if (settings.reviewOnBiomeSwitch) {
    setTimeout(() => maybeShowReview(), 1500);  // å»¶è¿Ÿ1.5ç§’ï¼Œè®© biome åˆ‡æ¢åŠ¨ç”»å®Œæˆ
}
```

### Step 4.3 â€” æ–°å¢ maybeShowReview() å‡½æ•°

**æ–‡ä»¶**ï¼š`src/modules/12-challenges.js`ï¼ˆæœ«å°¾è¿½åŠ ï¼‰

```javascript
let reviewActive = false;
let reviewWords = [];
let reviewIndex = 0;
let reviewResults = [];

function maybeShowReview() {
    if (reviewActive || currentLearningChallenge || paused) return;
    const words = getWordsForReview(3);
    if (words.length === 0) return;

    reviewActive = true;
    reviewWords = words;
    reviewIndex = 0;
    reviewResults = [];
    paused = true;

    showToast("ğŸ“š å¿«é€Ÿå¤ä¹ ï¼");
    setTimeout(() => showReviewWord(), 500);
}

function showReviewWord() {
    if (reviewIndex >= reviewWords.length) {
        finishReview();
        return;
    }
    const wordObj = reviewWords[reviewIndex];
    // å¤ç”¨ç°æœ‰çš„ Challenge ç³»ç»Ÿæ¥æ˜¾ç¤ºé¢˜ç›®
    startLearningChallenge(wordObj, "translate", { _isReview: true, _reviewIndex: reviewIndex });
}
```

### Step 4.4 â€” ä¿®æ”¹ completeLearningChallenge() å¤„ç†å¤ä¹ æ¥æº

**æ–‡ä»¶**ï¼š`src/modules/12-challenges.js`

åœ¨ `completeLearningChallenge(correct)` ä¸­ï¼ŒChest åˆ†æ”¯ä¹‹åè¿½åŠ ï¼š

```javascript
if (challengeOrigin && challengeOrigin._isReview) {
    reviewResults.push({ word: currentLearningChallenge.wordObj.en, correct });
    reviewIndex++;
    // çŸ­æš‚å»¶è¿Ÿåæ˜¾ç¤ºä¸‹ä¸€ä¸ª
    setTimeout(() => showReviewWord(), 600);
    // ä¸æ¢å¤ paused çŠ¶æ€ï¼ˆç­‰å¤ä¹ å…¨éƒ¨å®Œæˆï¼‰
    currentLearningChallenge = null;
    challengeOrigin = null;
    return;  // æå‰è¿”å›ï¼Œä¸æ‰§è¡Œåé¢çš„ paused æ¢å¤
}
```

æ³¨æ„ï¼šè¿™ä¸ª return å¿…é¡»åœ¨ `paused = challengePausedBefore` ä¹‹å‰æ‰§è¡Œã€‚

### Step 4.5 â€” æ–°å¢ finishReview() å‡½æ•°

**æ–‡ä»¶**ï¼š`src/modules/12-challenges.js`

```javascript
function finishReview() {
    reviewActive = false;
    const correct = reviewResults.filter(r => r.correct).length;
    const total = reviewResults.length;

    // æ›´æ–°ç»Ÿè®¡
    reviewResults.forEach(r => {
        if (!progress.challengeStats) progress.challengeStats = {};
        const stat = progress.challengeStats[r.word] || { correct: 0, wrong: 0, lastSeen: 0 };
        if (r.correct) stat.correct++;
        else stat.wrong++;
        stat.lastSeen = Date.now();
        progress.challengeStats[r.word] = stat;
    });
    saveProgress();

    // å¥–åŠ±
    addScore(correct * 30);
    if (correct === total && total > 0) {
        inventory.diamond = (inventory.diamond || 0) + 1;
        updateInventoryUI();
        showToast(`ğŸ“š å¤ä¹ å®Œæˆï¼å…¨å¯¹ï¼+${correct * 30}åˆ† +1ğŸ’`);
    } else {
        showToast(`ğŸ“š å¤ä¹ å®Œæˆï¼${correct}/${total} +${correct * 30}åˆ†`);
    }

    paused = false;
}
```

### Step 4.6 â€” æ–°å¢é…ç½®é¡¹

**æ–‡ä»¶**ï¼š`src/defaults.js`

```javascript
reviewOnBiomeSwitch: true,  // biome åˆ‡æ¢æ—¶æ˜¯å¦è§¦å‘å¤ä¹ 
```

### éªŒè¯æ–¹å¼

1. ç©æ¸¸æˆï¼Œå…ˆç­”å‡ é“ Challenge ç§¯ç´¯ç­”é¢˜æ•°æ®
2. åˆ†æ•°è¾¾åˆ° biome åˆ‡æ¢é˜ˆå€¼ï¼ˆé»˜è®¤200åˆ†ï¼‰
3. åˆ‡æ¢ biome å 1.5 ç§’å¼¹å‡ºå¤ä¹ 
4. è¿ç»­3é“ç¿»è¯‘é¢˜ï¼Œç­”å®Œæ˜¾ç¤ºç»“æœå’Œå¥–åŠ±
5. å¦‚æœæ²¡æœ‰ç­”é¢˜è®°å½•ï¼ˆæ–°æ¸¸æˆï¼‰ï¼Œä¸å¼¹å‡ºå¤ä¹ 

---

## æ”¹åŠ¨å››ï¼šæ‰©å±•ä¸ªäººèµ„æ–™é¢æ¿ï¼ˆå¢åŠ ç­”é¢˜ç»Ÿè®¡å’Œå•è¯æœ¬ï¼‰

> ä¸ªäººèµ„æ–™é¢æ¿å·²æœ‰æ¡†æ¶ï¼ˆ`08-account.js` çš„ `showProfileModal()`ï¼‰ï¼Œåªéœ€æ‰©å±•å†…å®¹ã€‚

### Step 5.1 â€” åœ¨ä¸ªäººèµ„æ–™é¢æ¿ä¸­æ˜¾ç¤ºç­”é¢˜æ­£ç¡®ç‡

**æ–‡ä»¶**ï¼š`src/modules/08-account.js`ï¼ˆ`showProfileModal()` å‡½æ•°ï¼Œçº¦ç¬¬414è¡Œï¼‰

åœ¨ç°æœ‰çš„ç»Ÿè®¡æ˜¾ç¤ºä¹‹åè¿½åŠ ï¼š

```javascript
// ç°æœ‰ä»£ç ï¼š
if (profileGamesEl) profileGamesEl.innerText = currentAccount.stats?.gamesPlayed || 0;

// è¿½åŠ ï¼š
const challengeStatsEl = document.getElementById("profile-challenge-stats");
if (challengeStatsEl) {
    const cs = getChallengeStats();
    challengeStatsEl.innerHTML =
        `ç­”é¢˜ ${cs.totalCorrect + cs.totalWrong} æ¬¡ï¼Œ` +
        `æ­£ç¡®ç‡ ${cs.accuracy}%ï¼Œ` +
        `æ¶‰åŠ ${cs.wordCount} ä¸ªå•è¯`;
}
```

### Step 5.2 â€” åœ¨ Game.html ä¸­æ·»åŠ å¯¹åº” DOM å…ƒç´ 

**æ–‡ä»¶**ï¼š`Game.html`ï¼ˆprofile-modal åŒºåŸŸï¼‰

åœ¨ç°æœ‰çš„ç»Ÿè®¡é¡¹ä¹‹åè¿½åŠ ï¼š

```html
<div class="profile-stat">
    <span class="profile-stat-label">ğŸ“ ç­”é¢˜ç»Ÿè®¡</span>
    <span class="profile-stat-value" id="profile-challenge-stats">-</span>
</div>
```

### Step 5.3 â€” æ·»åŠ ç®€å•å•è¯æœ¬æŒ‰é’®å’Œå¼¹çª—

**æ–‡ä»¶**ï¼š`Game.html`

åœ¨ profile-modal ä¸­è¿½åŠ ï¼š

```html
<button id="btn-vocab-book" class="profile-btn">ğŸ“– æˆ‘çš„å•è¯æœ¬</button>

<div id="vocab-book-modal" class="modal-overlay" aria-hidden="true">
    <div class="modal-content vocab-book">
        <h3>ğŸ“– æˆ‘çš„å•è¯æœ¬</h3>
        <div id="vocab-book-list"></div>
        <button id="btn-close-vocab-book" class="modal-close-btn">å…³é—­</button>
    </div>
</div>
```

### Step 5.4 â€” å®ç°å•è¯æœ¬æ¸²æŸ“é€»è¾‘

**æ–‡ä»¶**ï¼š`src/modules/08-account.js`ï¼ˆæœ«å°¾è¿½åŠ ï¼‰

```javascript
function showVocabBook() {
    const modal = document.getElementById("vocab-book-modal");
    const list = document.getElementById("vocab-book-list");
    if (!modal || !list) return;

    const stats = progress.challengeStats || {};
    const words = Object.keys(stats).sort((a, b) => {
        // æŒ‰æŒæ¡ç¨‹åº¦æ’åºï¼šéœ€å¤ä¹ çš„åœ¨å‰
        const aRate = (stats[a].correct || 0) / ((stats[a].correct || 0) + (stats[a].wrong || 0) || 1);
        const bRate = (stats[b].correct || 0) / ((stats[b].correct || 0) + (stats[b].wrong || 0) || 1);
        return aRate - bRate;
    });

    if (words.length === 0) {
        list.innerHTML = '<div style="text-align:center;padding:20px;color:#888;">è¿˜æ²¡æœ‰ç­”é¢˜è®°å½•</div>';
    } else {
        list.innerHTML = words.map(word => {
            const s = stats[word];
            const total = (s.correct || 0) + (s.wrong || 0);
            const rate = total > 0 ? Math.round(s.correct / total * 100) : 0;
            // æ‰¾ä¸­æ–‡ç¿»è¯‘
            const found = wordDatabase.find(w => w.en === word);
            const zh = found?.zh || "";
            // æŒæ¡ç¨‹åº¦é¢œè‰²
            const color = rate >= 80 ? "#4CAF50" : rate >= 50 ? "#FFC107" : "#F44336";
            return `<div class="vocab-book-item">
                <span class="vocab-word">${word}</span>
                <span class="vocab-zh">${zh}</span>
                <span class="vocab-rate" style="color:${color}">${rate}%</span>
                <span class="vocab-count">âœ“${s.correct || 0} âœ—${s.wrong || 0}</span>
            </div>`;
        }).join("");
    }

    modal.classList.add("visible");
    modal.setAttribute("aria-hidden", "false");
}

function hideVocabBook() {
    const modal = document.getElementById("vocab-book-modal");
    if (modal) {
        modal.classList.remove("visible");
        modal.setAttribute("aria-hidden", "true");
    }
}
```

### Step 5.5 â€” ç»‘å®šäº‹ä»¶

**æ–‡ä»¶**ï¼š`src/modules/16-events.js`ï¼ˆ`wireLearningModals()` æˆ–ç±»ä¼¼äº‹ä»¶ç»‘å®šå¤„ï¼‰

```javascript
const btnVocabBook = document.getElementById("btn-vocab-book");
if (btnVocabBook) btnVocabBook.addEventListener("click", showVocabBook);

const btnCloseVocabBook = document.getElementById("btn-close-vocab-book");
if (btnCloseVocabBook) btnCloseVocabBook.addEventListener("click", hideVocabBook);
```

### Step 5.6 â€” æ·»åŠ åŸºç¡€æ ·å¼

**æ–‡ä»¶**ï¼š`Game.html`ï¼ˆstyle åŒºåŸŸï¼‰

```css
.vocab-book { max-height: 70vh; overflow-y: auto; }
.vocab-book-item {
    display: flex; justify-content: space-between; align-items: center;
    padding: 8px 12px; border-bottom: 1px solid rgba(255,255,255,0.1);
    font-size: 14px;
}
.vocab-word { font-weight: bold; min-width: 100px; }
.vocab-zh { color: #ccc; min-width: 60px; }
.vocab-rate { min-width: 40px; text-align: right; font-weight: bold; }
.vocab-count { color: #888; min-width: 60px; text-align: right; font-size: 12px; }
```

### éªŒè¯æ–¹å¼

1. æ‰“å¼€ä¸ªäººèµ„æ–™é¢æ¿ â†’ çœ‹åˆ°ç­”é¢˜ç»Ÿè®¡è¡Œ
2. ç‚¹å‡»"æˆ‘çš„å•è¯æœ¬" â†’ å¼¹å‡ºå•è¯åˆ—è¡¨
3. åˆ—è¡¨æŒ‰æŒæ¡ç¨‹åº¦æ’åºï¼Œé¢œè‰²åŒºåˆ†ï¼ˆçº¢/é»„/ç»¿ï¼‰
4. æ— ç­”é¢˜è®°å½•æ—¶æ˜¾ç¤ºç©ºçŠ¶æ€æç¤º

---

## å®æ–½é¡ºåºæ€»ç»“

| é¡ºåº | æ”¹åŠ¨ | ä¾èµ– | æ¶‰åŠæ–‡ä»¶ |
|------|------|------|---------|
| 1 | å‰ç½®ï¼šæ‰©å±•ç­”é¢˜æ•°æ®ç»“æ„ | æ—  | `09-vocab.js`, `12-challenges.js` |
| 2 | å®ç®±ç»‘å®šå­¦ä¹  | ä¾èµ– Step 1 | `13-game-loop.js`, `12-challenges.js`, `15-entities-base.js` |
| 3 | ç¯å¢ƒå•è¯æ ‡ç­¾ | æ— ä¾èµ–ï¼ˆå¯å¹¶è¡Œï¼‰ | `14-renderer-entities.js`, `14-renderer-main.js`, `01-config.js` |
| 4 | Biome åˆ‡æ¢å¤ä¹  | ä¾èµ– Step 1 | `06-biome.js`, `12-challenges.js`, `09-vocab.js` |
| 5 | æ‰©å±•ä¸ªäººèµ„æ–™é¢æ¿ | ä¾èµ– Step 1 | `08-account.js`, `16-events.js`, `Game.html` |

æ”¹åŠ¨ 2 å’Œ 3 å¯ä»¥å¹¶è¡Œå¼€å‘ï¼ˆæ— äº¤å‰ä¾èµ–ï¼‰ã€‚æ”¹åŠ¨ 4 å’Œ 5 éƒ½ä¾èµ–å‰ç½®æ¡ä»¶å®Œæˆã€‚

---

## é£é™©ç‚¹

1. **å…¨å±€çŠ¶æ€å†²çª**ï¼šå®ç®±è§¦å‘ Challenge æ—¶ï¼Œå¦‚æœç©å®¶åŒæ—¶ç¢°åˆ° WordGateï¼Œå¯èƒ½å‡ºç°ä¸¤ä¸ª Challenge ç«äº‰ã€‚éœ€è¦ç¡®ä¿ `currentLearningChallenge` çš„äº’æ–¥æ£€æŸ¥è¦†ç›–æ‰€æœ‰å…¥å£ã€‚

2. **å¤ä¹ ä¸­æ–­**ï¼šå¤ä¹ è¿‡ç¨‹ä¸­å¦‚æœç©å®¶å—åˆ°ä¼¤å®³ï¼ˆbiome ç¯å¢ƒä¼¤å®³ï¼‰ï¼Œ`paused = true` åº”è¯¥é˜»æ­¢ä¼¤å®³ã€‚éœ€è¦ç¡®è®¤ `damagePlayer()` æ˜¯å¦æ£€æŸ¥ paused çŠ¶æ€ã€‚ç»æŸ¥ `update()` å‡½æ•°ç¬¬27è¡Œæœ‰ `if (paused) return;`ï¼Œæ‰€ä»¥ paused æœŸé—´ä¸ä¼šæ‰§è¡Œ updateï¼Œå®‰å…¨ã€‚

3. **pickNextWord() å‡½æ•°**ï¼šStep 2.1 ä¸­ä½¿ç”¨äº† `pickNextWord()`ï¼Œéœ€è¦ç¡®è®¤æ­¤å‡½æ•°æ˜¯å¦å­˜åœ¨ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œéœ€è¦ä» `wordDatabase` ä¸­éšæœºå–ä¸€ä¸ª wordObjã€‚å¯ä»¥ç®€å•å®ç°ä¸ºï¼š
   ```javascript
   function pickNextWord() {
       if (!wordDatabase || !wordDatabase.length) return null;
       return wordDatabase[Math.floor(Math.random() * wordDatabase.length)];
   }
   ```

4. **ç¯å¢ƒæ ‡ç­¾æ€§èƒ½**ï¼šæ¯å¸§ä¸ºæ¯ä¸ªå¯è§æ•Œäººè°ƒç”¨ `drawEntityLabel()`ï¼Œæ¶‰åŠ `ctx.strokeText` + `ctx.fillText`ã€‚Canvas æ–‡å­—æ¸²æŸ“æœ‰ä¸€å®šå¼€é”€ï¼Œä½†æ•Œäººæ•°é‡é€šå¸¸ < 10ï¼Œä¸ä¼šæœ‰æ€§èƒ½é—®é¢˜ã€‚
