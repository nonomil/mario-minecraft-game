# v1.8.1 â€” NPC æ‘æ°‘ç³»ç»Ÿ

> ç±»å‹ï¼šPATCH | versionName: 1.8.1 | versionCode: 60

## ä¸€ã€æœ¬ç‰ˆæœ¬ç›®æ ‡

åœ¨æ‘åº„ä¸­æ·»åŠ å¯äº¤äº’çš„ NPC æ‘æ°‘ã€‚æ‘æ°‘æœ‰ç®€å• AIï¼ˆæ¥å›èµ°åŠ¨ï¼‰ï¼Œç©å®¶é è¿‘æ—¶æ˜¾ç¤ºå¯¹è¯æ°”æ³¡ã€‚ä¸ºåç»­ç‰ˆæœ¬çš„äº¤äº’åŠŸèƒ½ï¼ˆä¼‘æ¯ã€å­¦ä¹ ã€äº¤æ˜“ï¼‰æä¾› NPC åŸºç¡€ã€‚

## äºŒã€å‰ç½®ä¾èµ–

- v1.8.0 å·²å®Œæˆï¼ˆæ‘åº„åŒºåŸŸç”Ÿæˆ + å»ºç­‘æ¸²æŸ“æ­£å¸¸å·¥ä½œï¼‰

## ä¸‰ã€ä¿®æ”¹æ–‡ä»¶

### 3.1 `src/modules/18-village.js` â€” æ–°å¢ NPC é€»è¾‘

åœ¨æ–‡ä»¶æœ«å°¾æ–°å¢ä»¥ä¸‹å‡½æ•°ï¼š

```javascript
// ========== NPC æ‘æ°‘ç³»ç»Ÿ ==========

const NPC_ROLES = {
  greeter: {
    greeting: 'Welcome! æ¬¢è¿!',
    speed: 0.3,
    patrolRange: 120
  },
  teacher: {
    greeting: 'Come learn! æ¥å­¦ä¹ !',
    speed: 0.2,
    patrolRange: 80
  },
  trader: {
    greeting: 'Trade? äº¤æ˜“å—?',
    speed: 0.15,
    patrolRange: 60
  }
};

function createVillageNPC(baseX, role, villageX, villageWidth) {
  const cfg = NPC_ROLES[role] || NPC_ROLES.greeter;
  const minX = Math.max(villageX + 20, baseX - cfg.patrolRange);
  const maxX = Math.min(villageX + villageWidth - 20, baseX + cfg.patrolRange);
  return {
    x: baseX,
    y: 0, // ç«™åœ¨åœ°é¢ä¸Šï¼Œæ¸²æŸ“æ—¶ç”¨ groundY
    role: role,
    direction: 1,
    speed: cfg.speed,
    minX: minX,
    maxX: maxX,
    showBubble: false,
    bubbleText: cfg.greeting,
    bubbleTimer: 0,
    facingRight: true,
    animFrame: 0,
    animTimer: 0
  };
}

function updateVillageNPCs(village) {
  for (const npc of village.npcs) {
    // æ¥å›èµ°åŠ¨
    npc.x += npc.direction * npc.speed;
    if (npc.x <= npc.minX) {
      npc.x = npc.minX;
      npc.direction = 1;
      npc.facingRight = true;
    } else if (npc.x >= npc.maxX) {
      npc.x = npc.maxX;
      npc.direction = -1;
      npc.facingRight = false;
    }

    // èµ°è·¯åŠ¨ç”»å¸§
    npc.animTimer++;
    if (npc.animTimer >= 15) {
      npc.animTimer = 0;
      npc.animFrame = (npc.animFrame + 1) % 2;
    }

    // ç©å®¶é è¿‘æ—¶æ˜¾ç¤ºæ°”æ³¡
    const dist = Math.abs(player.x - npc.x);
    const greetDist = villageConfig.npcGreetDistance || 80;
    if (dist < greetDist) {
      npc.showBubble = true;
      // é¢å‘ç©å®¶
      npc.facingRight = player.x > npc.x;
      npc.direction = 0; // åœä¸‹æ¥
      npc.bubbleTimer = 120; // æ°”æ³¡æŒç»­ 2 ç§’
    } else if (npc.bubbleTimer > 0) {
      npc.bubbleTimer--;
      if (npc.bubbleTimer <= 0) {
        npc.showBubble = false;
        // æ¢å¤å·¡é€»
        npc.direction = npc.facingRight ? 1 : -1;
      }
    } else {
      npc.showBubble = false;
    }
  }
}
```

åŒæ—¶ä¿®æ”¹ `createVillage()` å‡½æ•°ï¼Œåœ¨ `npcs: []` å¤„æ”¹ä¸ºè‡ªåŠ¨ç”Ÿæˆ NPCï¼š

```javascript
// æ›¿æ¢ createVillage ä¸­çš„ npcs: [] ä¸ºï¼š
npcs: [
  createVillageNPC(startX + 200, 'greeter', startX, villageConfig.villageWidth || 800),
  createVillageNPC(startX + 450, 'teacher', startX, villageConfig.villageWidth || 800),
],
```

ä¿®æ”¹ `updateVillages()` å‡½æ•°ï¼Œåœ¨æ£€æµ‹ç©å®¶ä½ç½®çš„å¾ªç¯ä¸­åŠ å…¥ NPC æ›´æ–°ï¼š

```javascript
// åœ¨ updateVillages() çš„ for å¾ªç¯ä¸­ï¼ŒplayerInVillage åˆ¤æ–­ä¹‹ååŠ å…¥ï¼š
if (playerInVillage && currentVillage) {
  updateVillageNPCs(currentVillage);
}
// ä¹Ÿæ›´æ–°è§†å£é™„è¿‘çš„æ‘åº„ NPCï¼ˆå³ä½¿ç©å®¶ä¸åœ¨æ‘åº„å†…ï¼Œä½†æ‘åº„åœ¨è§†å£ä¸­ï¼‰
for (const v of activeVillages) {
  if (v !== currentVillage && v.x < cameraX + canvas.width + 200 && v.x + v.width > cameraX - 200) {
    updateVillageNPCs(v);
  }
}
```

### 3.2 `src/modules/18-village-render.js` â€” æ–°å¢ NPC æ¸²æŸ“

åœ¨æ–‡ä»¶æœ«å°¾æ–°å¢ï¼š

```javascript
// ========== NPC æ¸²æŸ“ ==========

function drawVillager(ctx, npc) {
  const sx = npc.x - cameraX;
  const npcH = 48;
  const sy = groundY - npcH;
  const flip = npc.facingRight ? 1 : -1;

  ctx.save();
  if (!npc.facingRight) {
    ctx.translate(sx + 13, 0);
    ctx.scale(-1, 1);
    ctx.translate(-(sx + 13), 0);
  }

  // å¤´ï¼ˆè‚¤è‰² + å¤§é¼»å­ = MC æ‘æ°‘ç‰¹å¾ï¼‰
  ctx.fillStyle = '#D2B48C'; // è‚¤è‰²
  ctx.fillRect(sx + 3, sy, 20, 16);
  // çœ¼ç›
  ctx.fillStyle = '#333';
  ctx.fillRect(sx + 7, sy + 5, 3, 3);
  ctx.fillRect(sx + 16, sy + 5, 3, 3);
  // å¤§é¼»å­
  ctx.fillStyle = '#C4A882';
  ctx.fillRect(sx + 10, sy + 8, 6, 6);

  // èº«ä½“ï¼ˆæ£•è‰²é•¿è¢ï¼‰
  ctx.fillStyle = '#8B4513';
  ctx.fillRect(sx + 4, sy + 16, 18, 20);
  // è…°å¸¦
  ctx.fillStyle = '#5D4037';
  ctx.fillRect(sx + 4, sy + 28, 18, 3);

  // æ‰‹è‡‚
  ctx.fillStyle = '#8B4513';
  if (npc.animFrame === 0) {
    ctx.fillRect(sx, sy + 18, 4, 14);
    ctx.fillRect(sx + 22, sy + 18, 4, 14);
  } else {
    ctx.fillRect(sx, sy + 16, 4, 14);
    ctx.fillRect(sx + 22, sy + 20, 4, 14);
  }

  // è…¿
  ctx.fillStyle = '#5D4037';
  if (npc.animFrame === 0) {
    ctx.fillRect(sx + 6, sy + 36, 6, 12);
    ctx.fillRect(sx + 14, sy + 36, 6, 12);
  } else {
    ctx.fillRect(sx + 4, sy + 36, 6, 12);
    ctx.fillRect(sx + 16, sy + 36, 6, 12);
  }

  ctx.restore();

  // è§’è‰²æ ‡è¯†
  const roleIcons = { greeter: 'ğŸ‘‹', teacher: 'ğŸ“–', trader: 'ğŸ’°' };
  ctx.font = '12px serif';
  ctx.textAlign = 'center';
  ctx.fillText(roleIcons[npc.role] || 'ğŸ§‘', sx + 13, sy - 5);
  ctx.textAlign = 'left';

  // å¯¹è¯æ°”æ³¡
  if (npc.showBubble) {
    drawSpeechBubble(ctx, sx + 13, sy - 25, npc.bubbleText);
  }
}

function drawSpeechBubble(ctx, x, y, text) {
  ctx.save();
  ctx.font = '10px monospace';
  const metrics = ctx.measureText(text);
  const tw = metrics.width;
  const padding = 6;
  const bw = tw + padding * 2;
  const bh = 18;
  const bx = x - bw / 2;
  const by = y - bh;

  // æ°”æ³¡èƒŒæ™¯
  ctx.fillStyle = 'rgba(255,255,255,0.92)';
  ctx.strokeStyle = '#333';
  ctx.lineWidth = 1;
  // åœ†è§’çŸ©å½¢
  const r = 4;
  ctx.beginPath();
  ctx.moveTo(bx + r, by);
  ctx.lineTo(bx + bw - r, by);
  ctx.quadraticCurveTo(bx + bw, by, bx + bw, by + r);
  ctx.lineTo(bx + bw, by + bh - r);
  ctx.quadraticCurveTo(bx + bw, by + bh, bx + bw - r, by + bh);
  ctx.lineTo(bx + r, by + bh);
  ctx.quadraticCurveTo(bx, by + bh, bx, by + bh - r);
  ctx.lineTo(bx, by + r);
  ctx.quadraticCurveTo(bx, by, bx + r, by);
  ctx.closePath();
  ctx.fill();
  ctx.stroke();

  // å°ä¸‰è§’
  ctx.fillStyle = 'rgba(255,255,255,0.92)';
  ctx.beginPath();
  ctx.moveTo(x - 4, by + bh);
  ctx.lineTo(x, by + bh + 6);
  ctx.lineTo(x + 4, by + bh);
  ctx.closePath();
  ctx.fill();

  // æ–‡å­—
  ctx.fillStyle = '#333';
  ctx.textAlign = 'center';
  ctx.fillText(text, x, by + 13);
  ctx.textAlign = 'left';
  ctx.restore();
}
```

ä¿®æ”¹ `drawVillages()` å‡½æ•°ï¼Œåœ¨å»ºç­‘ç»˜åˆ¶ä¹‹ååŠ å…¥ NPC ç»˜åˆ¶ï¼š

```javascript
// åœ¨ drawVillages() ä¸­ï¼Œfor (const b of village.buildings) å¾ªç¯ä¹‹ååŠ å…¥ï¼š
for (const npc of village.npcs) {
  drawVillager(ctx, npc);
}
```

## å››ã€éªŒè¯æ¸…å•

- [ ] æ‘åº„ä¸­å‡ºç° 2 ä¸ª NPC æ‘æ°‘ï¼ˆgreeter + teacherï¼‰
- [ ] æ‘æ°‘åœ¨æ‘åº„èŒƒå›´å†…æ¥å›èµ°åŠ¨
- [ ] æ‘æ°‘ä¸ä¼šèµ°å‡ºæ‘åº„è¾¹ç•Œ
- [ ] ç©å®¶é è¿‘æ‘æ°‘ï¼ˆ80px å†…ï¼‰æ—¶ï¼Œæ‘æ°‘åœä¸‹å¹¶é¢å‘ç©å®¶
- [ ] é è¿‘æ—¶æ˜¾ç¤ºå¯¹è¯æ°”æ³¡ï¼ˆgreeter: "Welcome! æ¬¢è¿!", teacher: "Come learn! æ¥å­¦ä¹ !"ï¼‰
- [ ] ç¦»å¼€åæ°”æ³¡æ¶ˆå¤±ï¼Œæ‘æ°‘æ¢å¤å·¡é€»
- [ ] æ‘æ°‘æœ‰èµ°è·¯åŠ¨ç”»ï¼ˆæ‰‹è‡‚/è…¿äº¤æ›¿ï¼‰
- [ ] åƒç´ é£æ ¼æ­£ç¡®ï¼ˆæ£•è‰²é•¿è¢ã€å¤§é¼»å­ã€è‚¤è‰²å¤´éƒ¨ï¼‰
- [ ] ç§»åŠ¨ç«¯æ­£å¸¸æ˜¾ç¤º

## äº”ã€ç‰ˆæœ¬æ›´æ–°æ“ä½œ

### 5.1 æ›´æ–°ç‰ˆæœ¬å·

**`package.json`**ï¼š`"version": "1.8.1"`

**`android-app/package.json`**ï¼š`"version": "1.8.1"`

**`android-app/android/app/build.gradle`**ï¼š
```
versionCode 60
versionName "1.8.1"
```

### 5.2 æ›´æ–° Progress.md

åœ¨ `docs/version/Progress.md` æ–‡ä»¶**é¡¶éƒ¨**æ’å…¥ï¼š

```markdown
## v1.8.1ï¼ˆå‘å¸ƒæ—¥æœŸï¼š2026-02-XXï¼‰
- ç±»å‹ï¼šPATCH
- APK ç‰ˆæœ¬ï¼šversionName = 1.8.1ï¼ŒversionCode = 60
- ä¸»è¦å˜æ›´
  - æ–°å¢ï¼šæ‘åº„ç³»ç»Ÿ - NPC æ‘æ°‘
  - æ‘åº„ä¸­ç”Ÿæˆ 2 ä¸ª NPCï¼ˆè¿æ¥è€… + æ•™å¸ˆï¼‰
  - NPC ç®€å• AIï¼šæ¥å›å·¡é€»ã€é¢å‘ç©å®¶ã€åœä¸‹äº¤è°ˆ
  - åƒç´ é£æ ¼æ‘æ°‘æ¸²æŸ“ï¼ˆæ£•è‰²é•¿è¢ã€å¤§é¼»å­ã€èµ°è·¯åŠ¨ç”»ï¼‰
  - å¯¹è¯æ°”æ³¡ç³»ç»Ÿï¼ˆåœ†è§’çŸ©å½¢ + å°ä¸‰è§’ï¼‰
  - ç©å®¶é è¿‘æ—¶è§¦å‘å¯¹è¯
- æŠ€æœ¯æ”¹è¿›
  - 18-village.jsï¼šæ–°å¢ NPC_ROLES é…ç½®ã€createVillageNPC()ã€updateVillageNPCs()
  - 18-village-render.jsï¼šæ–°å¢ drawVillager()ã€drawSpeechBubble()
  - createVillage() è‡ªåŠ¨ç”Ÿæˆ NPC å®ä¾‹
  - updateVillages() é›†æˆ NPC æ›´æ–°å¾ªç¯
```

### 5.3 Git æäº¤

```bash
git add src/modules/18-village.js src/modules/18-village-render.js
git add package.json android-app/package.json android-app/android/app/build.gradle
git add docs/version/Progress.md
git commit -m "feat(village): v1.8.1 NPCæ‘æ°‘ç³»ç»Ÿï¼ˆå·¡é€»AI+å¯¹è¯æ°”æ³¡+åƒç´ æ¸²æŸ“ï¼‰"
git push
```
