# 单词库管理：Skills 与工具链设计方案（2026-02-19）

## 0. 实施状态（更新于 2026-02-19）

| 模块 | 计划项 | 状态 | 备注 |
|------|------|------|------|
| 工具链 | `audit.mjs` | ✅ 已完成 | 已支持 `--pack/--rules/--out`，输出 JSON+CSV，含 `suggested_action/suggested_params` |
| 工具链 | `stats.mjs` | ⏳ 未开始 | 需实现分布统计与摘要输出 |
| 工具链 | `batch-update.mjs` | ⏳ 未开始 | 需实现 dry-run / apply / preview |
| 命令层 | `/vocab-audit` | ⏳ 未开始 | 计划放在 `.claude/commands/vocab-audit.md` |
| 命令层 | `/vocab-cleanup` | ⏳ 未开始 | 计划放在 `.claude/commands/vocab-cleanup.md` |
| 命令层 | `/vocab-add` | ⏳ 未开始 | 计划放在 `.claude/commands/vocab-add.md` |
| 命令层 | `/vocab-report` | ⏳ 未开始 | 计划放在 `.claude/commands/vocab-report.md` |

## 1. 目标与结论

目标：把“词库整理、去重、复杂度审查、新增单词、批量修订”做成可重复执行的工程化流程，降低人工成本并保证质量可追溯。

结论（推荐）：
1. 不引入 Python，继续使用现有 Node.js + SQLite 技术栈。
2. 用 `vocab-db` 脚本做“确定性数据处理”，用 Skills 做“流程编排与规则约束”。
3. 先补齐 3 个缺失脚本（`audit.mjs` / `stats.mjs` / `batch-update.mjs`），再建设 4 个技能。

## 2. 现状分析（基于当前仓库）

现有工具链（`apk/tools/vocab-db`）已覆盖：
- 初始化/Schema：`init.mjs`
- manifest 导入：`import.mjs`
- 导出：`export.mjs`
- 单条增删：`crud.mjs`（upsert/deactivate）
- 外部词表导入：`import-external-list.mjs`
- 去重报告：`dedup.mjs`
- 字段校验：`validate.mjs`
- 发布校验：`publish.mjs`
- Web 管理台：`admin-server.mjs`

质量基线（2026-02-19 实测）：
- `npm run vocab:db:validate`
  - active entries: `2981`
  - duplicate keys: `0`
  - missing chinese: `0`
- `npm run vocab:db:dedup`
  - exactDuplicateKeys: `0`
  - multiSourceEntries: `1886`
  - compactCollisions: `453`
- `npm run vocab:db:audit -- --pack vocab.kindergarten`（规则校准后）
  - `BLOCKER: 33`
  - `MAJOR: 69`
  - `MINOR: 283`

说明：当前“基础完整性”较好，但“跨来源碰撞、适龄复杂度、批量治理”仍缺自动化支撑。

## 3. 为什么是 Skills + Node 脚本

1. Skills 负责“怎么做”  
把多命令流程、阈值标准、确认机制写成稳定 SOP。
2. 脚本负责“做什么”  
把审计、统计、批量变更做成可复用、可 CI 的确定性执行单元。
3. 保持单栈  
避免 Python 运行时和依赖管理，减少维护面。

## 4. 两层架构设计

### 4.1 第 1 层：新增 3 个 Node 脚本

#### A. `audit.mjs`（复杂度/适龄性审计）
建议能力：
1. 输入参数：
   - `--pack <source_pack>`（可选，默认全量）
   - `--rules <path>`（可选，默认 `tools/vocab-db/rules/audit-rules.json`）
   - `--out <path>`（可选）
2. 输出：
   - `words/db/reports/audit-report.json`
   - `words/db/reports/audit-report.csv`（便于人工复核）
3. 规则（首版建议）：
   - `BLOCKER`：明显脏数据（乱码、不可见字符、非法难度值、空 word）
   - `MAJOR`：疑似超龄（幼儿园包中长词、超长短语、指令句/战斗句）
   - `MINOR`：风格不一致（大小写、标点、连字符规范）
4. 默认阈值（可配置）：
   - `word.length >= 12`
   - `phrase token >= 6`
   - `phrase` 包含 `!`/`?`（幼儿园包先标记为待复核，而非直接删除）
5. 报告条目格式（便于下游 `batch-update.mjs` 直接消费）：
   ```json
   {
     "entry_id": 123,
     "lemma_key": "adventure",
     "pack": "vocab.kindergarten",
     "severity": "MAJOR",
     "rule": "word_too_long",
     "detail": "word length 9 >= threshold 8 for kindergarten",
     "suggested_action": "move_pack|deactivate|update_difficulty|review",
     "suggested_params": { "target_pack": "vocab.elementary" }
   }
   ```
   `/vocab-cleanup` 可直接将 audit 报告过滤后作为 `batch-update --file` 的输入，无需手动转换。
6. 首次校准流程：
   - 全量运行 `audit --pack vocab.kindergarten`
   - 从报告中随机抽样 50 条人工复核，标记"误报/正确"
   - 根据误报率调整阈值（如幼儿园 `word.length` 从 12 降到 8）
   - 将校准后的阈值写入 `tools/vocab-db/rules/audit-rules.json`，不硬编码

#### B. `stats.mjs`（分布统计）
建议能力：
1. 按 `source_pack` 输出：
   - 词条数
   - `difficulty` 分布
   - `learn_type` 分布
   - 疑似复杂项比例（引用 `audit` 规则）
2. 输出：
   - `words/db/reports/stats-report.json`
   - 可选控制台表格摘要
3. 建议输出结构（JSON）：
   ```json
   {
     "generatedAt": "2026-02-19T00:00:00.000Z",
     "summary": { "totalActiveEntries": 2981 },
     "packs": [
       {
         "pack": "vocab.kindergarten",
         "entries": 763,
         "difficultyDist": { "basic": 595, "intermediate": 166, "advanced": 2 },
         "learnTypeDist": { "word": 7, "phrase": 756 },
         "auditRiskRatio": 0.12
       }
     ]
   }
   ```

#### C. `batch-update.mjs`（批量修订）
建议能力：
1. 输入：`--file <csv|json>`（变更清单）
2. 操作类型：
   - `upsert`
   - `deactivate`
   - `reactivate`
   - `update_fields`（difficulty/category/chinese/phrase 等）
3. 安全机制：
   - 默认 `dry-run`，必须 `--apply` 才落库
   - 生成 `batch-update-preview.json`
   - 单次事务提交 + 回滚
4. 建议输入结构（JSON）：
   ```json
   [
     {
       "entry_id": 123,
       "action": "update_fields",
       "params": { "difficulty": "basic", "category": "animals" }
     },
     {
       "entry_id": 456,
       "action": "deactivate",
       "params": { "reason": "duplicate" }
     }
   ]
   ```
5. 建议输入结构（CSV）：
   - 列：`entry_id,action,params_json`
   - `params_json` 为 JSON 字符串，如：`"{""difficulty"":""basic""}"`

### 4.2 第 2 层：4 个 Skills（流程编排）

> **重要**：Claude Code 的自定义 slash command 放在 `.claude/commands/` 目录下，文件名即命令名。
> 例如 `.claude/commands/vocab-audit.md` 对应 `/vocab-audit` 命令。

建议目录：

```text
.claude/commands/
  vocab-audit.md       # /vocab-audit
  vocab-cleanup.md     # /vocab-cleanup
  vocab-add.md         # /vocab-add
  vocab-report.md      # /vocab-report
```

建议触发定位：
1. `/vocab-audit`
   - 触发：词库质量检查、适龄性审查、发布前检查
   - 流程：`validate -> dedup -> audit -> 输出修复建议`
2. `/vocab-cleanup`
   - 触发：去重、碰撞合并、批量下架
   - 流程：`dedup -> 生成变更清单 -> batch-update(dry-run) -> 用户确认 -> --apply -> validate`
3. `/vocab-add`
   - 触发：批量新增主题词、导入外部词表
   - 流程：
     - 少量单词（< 10 条）→ 逐条 `crud.mjs upsert`
     - 批量/外部词表 → `import-external-list.mjs`
     - 最后统一 `validate` 校验
4. `/vocab-report`
   - 触发：阶段性汇报、版本前数据报告
   - 流程：`stats -> audit` 汇总为可读报告

## 5. 与当前 0219 执行计划的衔接

你在 `C1（幼儿园词库审查）` 里当前是”导出 + 人工审查”。建议升级为：

1. `npm run vocab:db:export`
2. `npm run vocab:db:validate`
3. `npm run vocab:db:dedup`
4. `npm run vocab:db:audit -- --pack vocab.kindergarten`
5. 从 audit 报告中筛选 `severity=BLOCKER|MAJOR` 的条目，人工确认 `suggested_action`
6. 将确认后的条目直接作为 `batch-update` 输入：
   `npm run vocab:db:batch-update -- --file reports/audit-confirmed.json`（默认 dry-run）
7. 检查 dry-run 预览无误后：
   `npm run vocab:db:batch-update -- --file reports/audit-confirmed.json --apply`
8. 再次 `validate + dedup + audit` 做闭环，确认问题数归零

等价的 Skill 操作：
- 步骤 1-4 → `/vocab-audit`
- 步骤 5-8 → `/vocab-cleanup`

## 6. 落地计划（建议顺序）

### 阶段 P1：补脚本（1-2 天）
1. 新增 `audit.mjs`、`stats.mjs`、`batch-update.mjs`
2. 在 `apk/package.json` 加脚本：
   - `vocab:db:audit`
   - `vocab:db:stats`
   - `vocab:db:batch-update`
3. 先跑幼儿园包，校准阈值

### 阶段 P2：建 Skills（0.5-1 天）
1. 建 4 个 slash command 文件（`.claude/commands/*.md`）
2. 每个 skill 只保留流程和规则，不复制大段背景说明
3. 先在 C1 场景试跑一轮

### 阶段 P3：纳入日常发布（持续）
1. 把 `audit + stats` 加入发布前检查清单
2. 批量修订强制 `dry-run -> 确认 -> apply`
3. 每次发布保留 `reports/*.json` 证据

## 7. 关键设计决策（建议值）

1. Skill 粒度：保留 4 个，不再细拆。  
原因：当前任务类型清晰，拆太细会增加触发歧义。

2. 复杂度规则：先“标记不自动删”。  
原因：你的幼儿园包存在 Minecraft 语境词，直接硬删会误伤。

3. 批量变更确认机制：强制 dry-run 默认开启。
原因：词库属于内容资产，必须可回放、可审计、可撤销。

4. 报告存档策略：
   - `words/db/reports/` 目录加入 `.gitignore`，日常开发不提交报告文件。
   - 报告文件名带时间戳：`audit-report-20260219.json`、`stats-report-20260219.json`。
   - 发布前手动归档：将当次报告复制到 `apk/docs/releases/<version>/` 作为发布证据。
   - 原因：报告是过程产物，频繁提交会污染 git 历史；但发布时需要留痕。

## 8. 下一步可直接执行的最小动作

1. 先实现 `audit.mjs`（优先级最高）。
2. 用 `vocab.kindergarten` 跑一版审计报告，确定阈值。
3. 再实现 `batch-update.mjs`，形成“审计 -> 修订 -> 回归校验”闭环。
