# v1.8.4 â€” å­˜æ¡£çŸ³ç¢‘ + ç¾¤ç³»ç‰¹è‰²å»ºç­‘

> ç±»å‹ï¼šPATCH | versionName: 1.8.4 | versionCode: 63

## ä¸€ã€æœ¬ç‰ˆæœ¬ç›®æ ‡

å®ç°æ‘åº„æœ€åä¸¤ä¸ªå»ºç­‘çš„äº¤äº’åŠŸèƒ½ï¼š
1. å­˜æ¡£çŸ³ç¢‘ï¼šä¿å­˜å½“å‰è¿›åº¦åˆ° localStorageï¼Œä½œä¸ºå¤æ´»æ£€æŸ¥ç‚¹
2. ç¾¤ç³»ç‰¹è‰²å»ºç­‘ï¼šæ¯ä¸ª biome ç‹¬æœ‰çš„åŠŸèƒ½å»ºç­‘ï¼Œæä¾› buff æˆ–é“å…·

## äºŒã€å‰ç½®ä¾èµ–

- v1.8.3 å·²å®Œæˆï¼ˆå•è¯å­¦ä¹ å±‹ + æŒ‘æˆ˜ç³»ç»Ÿ + grantBiomeReward æ­£å¸¸å·¥ä½œï¼‰

## ä¸‰ã€ä¿®æ”¹æ–‡ä»¶

### 3.1 `src/storage.js` â€” æ–°å¢æ‘åº„å­˜æ¡£åŠŸèƒ½

åœ¨æ–‡ä»¶æœ«å°¾æ–°å¢ï¼š

```javascript
/**
 * ä¿å­˜æ‘åº„æ£€æŸ¥ç‚¹
 * è®°å½•å½“å‰æ¸¸æˆçŠ¶æ€ï¼Œå¯ç”¨äºå¤æ´»æ—¶æ¢å¤
 */
function saveVillageCheckpoint(village) {
  const checkpoint = {
    version: 1,
    score: score,
    playerHp: playerHp,
    maxHp: gameConfig.player.maxHp,
    biome: currentBiome,
    villageId: village.id,
    villageX: village.x,
    playerX: player.x,
    diamonds: diamonds || 0,
    inventory: {},
    armor: typeof playerArmor !== 'undefined' ? playerArmor : null,
    weapon: typeof currentWeapon !== 'undefined' ? currentWeapon : null,
    timestamp: Date.now()
  };

  // å¤åˆ¶èƒŒåŒ…æ•°æ®
  if (typeof playerInventory !== 'undefined' && playerInventory) {
    for (const [key, val] of Object.entries(playerInventory)) {
      checkpoint.inventory[key] = val;
    }
  }

  try {
    localStorage.setItem('villageCheckpoint', JSON.stringify(checkpoint));
    console.log('[Village] å­˜æ¡£æˆåŠŸ:', checkpoint);
    return true;
  } catch (e) {
    console.error('[Village] å­˜æ¡£å¤±è´¥:', e);
    return false;
  }
}

/**
 * åŠ è½½æ‘åº„æ£€æŸ¥ç‚¹
 * è¿”å›å­˜æ¡£æ•°æ®ï¼Œæ— å­˜æ¡£è¿”å› null
 */
function loadVillageCheckpoint() {
  try {
    const data = localStorage.getItem('villageCheckpoint');
    if (!data) return null;
    const checkpoint = JSON.parse(data);
    // éªŒè¯æ•°æ®æœ‰æ•ˆæ€§
    if (!checkpoint.timestamp || !checkpoint.score) return null;
    return checkpoint;
  } catch (e) {
    console.error('[Village] è¯»æ¡£å¤±è´¥:', e);
    return null;
  }
}

/**
 * æ£€æŸ¥æ˜¯å¦æœ‰æ‘åº„å­˜æ¡£å¯ç”¨
 */
function hasVillageCheckpoint() {
  const cp = loadVillageCheckpoint();
  if (!cp) return false;
  // å­˜æ¡£è¶…è¿‡ 24 å°æ—¶è§†ä¸ºè¿‡æœŸ
  const maxAge = 24 * 60 * 60 * 1000;
  return (Date.now() - cp.timestamp) < maxAge;
}

/**
 * ä»æ‘åº„å­˜æ¡£æ¢å¤æ¸¸æˆçŠ¶æ€
 */
function restoreFromVillageCheckpoint() {
  const cp = loadVillageCheckpoint();
  if (!cp) return false;

  score = cp.score || 0;
  playerHp = cp.playerHp || gameConfig.player.maxHp;
  diamonds = cp.diamonds || 0;

  if (cp.inventory && typeof playerInventory !== 'undefined') {
    Object.assign(playerInventory, cp.inventory);
  }
  if (cp.armor && typeof playerArmor !== 'undefined') {
    playerArmor = cp.armor;
  }

  updateScoreUI();
  updateHpUI();

  console.log('[Village] ä»å­˜æ¡£æ¢å¤:', cp);
  return true;
}
```

### 3.2 `src/modules/18-village.js` â€” æ›´æ–°äº¤äº’åˆ†æ”¯

ä¿®æ”¹ `handleVillageInteraction()` ä¸­çš„ `save_stone` å’Œ `default` åˆ†æ”¯ï¼š

```javascript
case 'save_stone':
  interactSaveStone(currentVillage);
  return true;

default:
  // ç¾¤ç³»ç‰¹è‰²å»ºç­‘
  interactSpecialBuilding(currentVillage, building.type);
  return true;
```

æ–°å¢ä»¥ä¸‹å‡½æ•°ï¼š

```javascript
// ========== å­˜æ¡£çŸ³ç¢‘ ==========

function interactSaveStone(village) {
  if (village.saved) {
    showToast('ğŸ’¾ å·²å­˜æ¡£ï¼ˆæœ¬æ¬¡è®¿é—®ï¼‰');
    return;
  }

  const success = saveVillageCheckpoint(village);
  if (success) {
    village.saved = true;
    showToast('âœ… è¿›åº¦å·²å­˜æ¡£');
    showFloatingText('ğŸ’¾ å­˜æ¡£æˆåŠŸ', player.x, player.y - 30);

    // å­˜æ¡£çŸ³ç¢‘å‘å…‰åŠ¨ç”»
    village._saveStoneGlow = 60; // 60å¸§å‘å…‰æ•ˆæœ
  } else {
    showToast('âŒ å­˜æ¡£å¤±è´¥');
  }
}

// ========== ç¾¤ç³»ç‰¹è‰²å»ºç­‘ ==========

const SPECIAL_BUILDING_EFFECTS = {
  library: {
    name: 'ğŸ“– å›¾ä¹¦é¦†',
    description: 'é¢å¤–å­¦ä¹  2 ä¸ªå•è¯',
    action: (village) => {
      const words = getVillageWords(village.biomeId);
      if (words.length >= 2) {
        const selected = [...words].sort(() => Math.random() - 0.5).slice(0, 2);
        for (const w of selected) {
          const en = w.en || w.english || '';
          const zh = w.zh || w.chinese || '';
          showToast(`ğŸ“– ${en} - ${zh}`, 2500);
          if (typeof speakWord === 'function') {
            setTimeout(() => speakWord(en), 1000);
          }
        }
        score += 30;
        showFloatingText('+30 ğŸª™ +2ğŸ“–', player.x, player.y - 30);
      }
    }
  },
  hot_spring: {
    name: 'â™¨ï¸ æ¸©æ³‰å°å±‹',
    description: '30ç§’ä¸å—å†°å†»å‡é€Ÿ',
    action: (village) => {
      // è®¾ç½®æŠ—å†°å†» buff
      if (typeof playerBuffs === 'undefined') window.playerBuffs = {};
      playerBuffs.antiFreeze = { duration: 30 * 60, remaining: 30 * 60 }; // 30ç§’ Ã— 60fps
      showToast('â™¨ï¸ æ¸©æ³‰æ•ˆæœï¼š30ç§’ä¸å—å†°å†»', 2000);
      showFloatingText('â™¨ï¸ æ¸©æš–!', player.x, player.y - 30);
      // å›å¤ 2 å¿ƒ
      playerHp = Math.min(playerHp + 2, gameConfig.player.maxHp);
      updateHpUI();
      showFloatingText('+2 â¤ï¸', player.x, player.y - 50);
    }
  },
  water_station: {
    name: 'ğŸ’§ ç»¿æ´²æ°´ç«™',
    description: 'è·å¾—æ°´è¢‹ï¼ˆæ²™æ¼ ä¸æ‰è¡€30ç§’ï¼‰',
    action: (village) => {
      if (typeof playerBuffs === 'undefined') window.playerBuffs = {};
      playerBuffs.waterProtection = { duration: 30 * 60, remaining: 30 * 60 };
      if (typeof addToInventory === 'function') {
        addToInventory('water_bottle', 1);
      }
      showToast('ğŸ’§ è·å¾—æ°´è¢‹ï¼šæ²™æ¼ ä¸æ‰è¡€30ç§’', 2000);
      showFloatingText('ğŸ’§ æ°´è¢‹!', player.x, player.y - 30);
    }
  },
  blacksmith: {
    name: 'âš’ï¸ é“åŒ é“º',
    description: 'éšæœºå¼ºåŒ–è£…å¤‡',
    action: (village) => {
      // ç»™äºˆé“å—å¥–åŠ±
      if (typeof addToInventory === 'function') {
        addToInventory('iron_block', 3);
      }
      score += 50;
      showToast('âš’ï¸ é“åŒ èµ ç¤¼ï¼šé“å—Ã—3', 2000);
      showFloatingText('âš’ï¸ +3ğŸ”© +50ğŸª™', player.x, player.y - 30);
    }
  },
  lighthouse: {
    name: 'ğŸ—¼ ç¯å¡”',
    description: 'ç…§äº®å‰æ–¹500px',
    action: (village) => {
      if (typeof playerBuffs === 'undefined') window.playerBuffs = {};
      playerBuffs.lighthouse = { duration: 45 * 60, remaining: 45 * 60, range: 500 };
      showToast('ğŸ—¼ ç¯å¡”ä¹‹å…‰ï¼šç…§äº®å‰æ–¹', 2000);
      showFloatingText('ğŸ—¼ å…‰æ˜!', player.x, player.y - 30);
    }
  },
  brewing_stand: {
    name: 'âš—ï¸ ç‚¼è¯å°',
    description: 'è·å¾—æŠ—ç«è¯æ°´ï¼ˆåœ°ç‹±ä¸æ‰è¡€30ç§’ï¼‰',
    action: (village) => {
      if (typeof playerBuffs === 'undefined') window.playerBuffs = {};
      playerBuffs.fireResistance = { duration: 30 * 60, remaining: 30 * 60 };
      if (typeof addToInventory === 'function') {
        addToInventory('fire_resistance', 1);
      }
      showToast('âš—ï¸ æŠ—ç«è¯æ°´ï¼šåœ°ç‹±ä¸æ‰è¡€30ç§’', 2000);
      showFloatingText('âš—ï¸ æŠ—ç«!', player.x, player.y - 30);
    }
  }
};

function interactSpecialBuilding(village, buildingType) {
  if (village._specialUsed) {
    showToast('ğŸ  å·²ä½¿ç”¨è¿‡äº†');
    return;
  }

  const effect = SPECIAL_BUILDING_EFFECTS[buildingType];
  if (!effect) {
    showToast('ğŸ  è¿™é‡Œæš‚æ—¶æ²¡æœ‰ä»€ä¹ˆ...');
    return;
  }

  village._specialUsed = true;
  showToast(`${effect.name}ï¼š${effect.description}`, 2000);
  effect.action(village);
}
```

### 3.3 `src/modules/18-village-render.js` â€” å­˜æ¡£çŸ³ç¢‘å‘å…‰æ•ˆæœ

åœ¨ `drawVillageBuilding()` å‡½æ•°æœ«å°¾ï¼Œå»ºç­‘å›¾æ ‡ç»˜åˆ¶ä¹‹ååŠ å…¥ï¼š

```javascript
// å­˜æ¡£çŸ³ç¢‘å‘å…‰æ•ˆæœ
if (building.type === 'save_stone') {
  const village = getVillageAt(building.x);
  if (village && village._saveStoneGlow > 0) {
    village._saveStoneGlow--;
    const glowAlpha = village._saveStoneGlow / 60 * 0.5;
    ctx.save();
    ctx.fillStyle = `rgba(76, 175, 80, ${glowAlpha})`;
    ctx.beginPath();
    ctx.arc(sx + building.w / 2, sy + building.h / 2, 30, 0, Math.PI * 2);
    ctx.fill();
    ctx.restore();
  }
}
```

### 3.4 `src/modules/18-village-render.js` â€” æ›´æ–°äº¤äº’æç¤º

åœ¨ `drawBuildingInteractHint()` çš„ hints å¯¹è±¡ä¸­è¡¥å……ç‰¹è‰²å»ºç­‘æç¤ºï¼š

```javascript
const hints = {
  bed_house: 'æŒ‰ Y ä¼‘æ¯',
  word_house: 'æŒ‰ Y å­¦ä¹ ',
  save_stone: 'æŒ‰ Y å­˜æ¡£',
  library: 'æŒ‰ Y è¿›å…¥å›¾ä¹¦é¦†',
  hot_spring: 'æŒ‰ Y æ³¡æ¸©æ³‰',
  water_station: 'æŒ‰ Y å–æ°´',
  blacksmith: 'æŒ‰ Y æ‹œè®¿é“åŒ ',
  lighthouse: 'æŒ‰ Y ç‚¹äº®ç¯å¡”',
  brewing_stand: 'æŒ‰ Y ç‚¼è¯'
};
```

### 3.5 `src/modules/01-config.js` â€” æ–°å¢ buff å…¨å±€å˜é‡

```javascript
// ===== ç©å®¶ Buff ç³»ç»Ÿ =====
let playerBuffs = {};
```

### 3.6 `src/modules/13-game-loop.js` â€” Buff å€’è®¡æ—¶æ›´æ–°

åœ¨ `update()` å‡½æ•°ä¸­ï¼Œ`updateVillages()` ä¹‹ååŠ å…¥ï¼š

```javascript
// æ›´æ–°ç©å®¶ Buff å€’è®¡æ—¶
updatePlayerBuffs();
```

åœ¨æ–‡ä»¶ä¸­æ–°å¢ï¼š

```javascript
function updatePlayerBuffs() {
  if (!playerBuffs || typeof playerBuffs !== 'object') return;
  for (const key of Object.keys(playerBuffs)) {
    const buff = playerBuffs[key];
    if (buff && buff.remaining > 0) {
      buff.remaining--;
      if (buff.remaining <= 0) {
        delete playerBuffs[key];
        showToast(`â° ${key} æ•ˆæœç»“æŸ`);
      }
    }
  }
}
```

### 3.7 é›†æˆ Buff åˆ°ç°æœ‰ä¼¤å®³é€»è¾‘

åœ¨åœ°ç‹±ä¼¤å®³é€»è¾‘ï¼ˆ`06-biome.js` æˆ– `13-game-loop.js` ä¸­çš„ nether å…¥åœºæ‰£è¡€å¤„ï¼‰åŠ å…¥æ£€æŸ¥ï¼š

```javascript
// åœ¨åœ°ç‹±æ‰£è¡€å‰æ£€æŸ¥æŠ—ç« buff
if (playerBuffs.fireResistance) {
  // è·³è¿‡æ‰£è¡€
} else {
  playerHp = Math.max(0, playerHp - 1);
  // ...åŸæœ‰é€»è¾‘
}
```

åœ¨é›ªåœ°å‡é€Ÿé€»è¾‘ä¸­åŠ å…¥æ£€æŸ¥ï¼š

```javascript
// åœ¨é›ªåœ°å‡é€Ÿå‰æ£€æŸ¥æŠ—å†°å†» buff
if (playerBuffs.antiFreeze) {
  // è·³è¿‡å‡é€Ÿ
} else {
  // ...åŸæœ‰å‡é€Ÿé€»è¾‘
}
```

## å››ã€éªŒè¯æ¸…å•

### å­˜æ¡£çŸ³ç¢‘
- [ ] èµ°åˆ°å­˜æ¡£çŸ³ç¢‘é™„è¿‘ï¼Œæ˜¾ç¤º"æŒ‰ Y å­˜æ¡£"æç¤º
- [ ] æŒ‰ Y è§¦å‘å­˜æ¡£ï¼Œæ˜¾ç¤º"âœ… è¿›åº¦å·²å­˜æ¡£"
- [ ] å­˜æ¡£çŸ³ç¢‘å‘ç»¿è‰²å…‰æ•ˆï¼ˆæ¸æ¶ˆï¼‰
- [ ] localStorage ä¸­æ­£ç¡®å†™å…¥ villageCheckpoint æ•°æ®
- [ ] å­˜æ¡£æ•°æ®åŒ…å«ï¼šscoreã€playerHpã€biomeã€inventoryã€timestamp
- [ ] åŒä¸€æ‘åº„åªèƒ½å­˜æ¡£ä¸€æ¬¡

### ç¾¤ç³»ç‰¹è‰²å»ºç­‘
- [ ] forest/å›¾ä¹¦é¦†ï¼šæ˜¾ç¤º 2 ä¸ªå•è¯ + æ’­æ”¾å‘éŸ³ + 30 åˆ†
- [ ] snow/æ¸©æ³‰ï¼š30 ç§’æŠ—å†°å†» buff + å›å¤ 2 å¿ƒ
- [ ] desert/æ°´ç«™ï¼šè·å¾—æ°´è¢‹é“å…· + 30 ç§’æ²™æ¼ ä¿æŠ¤
- [ ] mountain/é“åŒ ï¼šè·å¾—é“å—Ã—3 + 50 åˆ†
- [ ] ocean/ç¯å¡”ï¼š45 ç§’ç…§äº®æ•ˆæœ
- [ ] nether/ç‚¼è¯å°ï¼šè·å¾—æŠ—ç«è¯æ°´ + 30 ç§’åœ°ç‹±ä¿æŠ¤
- [ ] æ¯ä¸ªæ‘åº„ç‰¹è‰²å»ºç­‘åªèƒ½ä½¿ç”¨ä¸€æ¬¡

### Buff ç³»ç»Ÿ
- [ ] Buff å€’è®¡æ—¶æ­£å¸¸é€’å‡
- [ ] Buff åˆ°æœŸåè‡ªåŠ¨ç§»é™¤ + Toast æç¤º
- [ ] æŠ—ç« buff ç”Ÿæ•ˆæ—¶åœ°ç‹±ä¸æ‰£è¡€
- [ ] æŠ—å†°å†» buff ç”Ÿæ•ˆæ—¶é›ªåœ°ä¸å‡é€Ÿ

## äº”ã€ç‰ˆæœ¬æ›´æ–°æ“ä½œ

### 5.1 æ›´æ–°ç‰ˆæœ¬å·

**`package.json`**ï¼š`"version": "1.8.4"`

**`android-app/package.json`**ï¼š`"version": "1.8.4"`

**`android-app/android/app/build.gradle`**ï¼š
```
versionCode 63
versionName "1.8.4"
```

### 5.2 æ›´æ–° Progress.md

åœ¨ `docs/version/Progress.md` æ–‡ä»¶**é¡¶éƒ¨**æ’å…¥ï¼š

```markdown
## v1.8.4ï¼ˆå‘å¸ƒæ—¥æœŸï¼š2026-02-XXï¼‰
- ç±»å‹ï¼šPATCH
- APK ç‰ˆæœ¬ï¼šversionName = 1.8.4ï¼ŒversionCode = 63
- ä¸»è¦å˜æ›´
  - æ–°å¢ï¼šæ‘åº„ç³»ç»Ÿ - å­˜æ¡£çŸ³ç¢‘
  - å­˜æ¡£çŸ³ç¢‘äº¤äº’ï¼šä¿å­˜å½“å‰è¿›åº¦åˆ° localStorage
  - å­˜æ¡£æ•°æ®ï¼šåˆ†æ•°ã€è¡€é‡ã€ç¾¤ç³»ã€èƒŒåŒ…ã€è£…å¤‡ã€æ—¶é—´æˆ³
  - å­˜æ¡£çŸ³ç¢‘å‘å…‰åŠ¨ç”»
  - æ–°å¢ï¼šæ‘åº„ç³»ç»Ÿ - ç¾¤ç³»ç‰¹è‰²å»ºç­‘
  - æ£®æ—/å›¾ä¹¦é¦†ï¼šé¢å¤–å­¦ä¹  2 ä¸ªå•è¯
  - é›ªåœ°/æ¸©æ³‰ï¼š30ç§’æŠ—å†°å†» + å›å¤2å¿ƒ
  - æ²™æ¼ /æ°´ç«™ï¼šæ°´è¢‹é“å…· + 30ç§’æ²™æ¼ ä¿æŠ¤
  - å±±åœ°/é“åŒ ï¼šé“å—Ã—3 + 50åˆ†
  - æµ·æ´‹/ç¯å¡”ï¼š45ç§’ç…§äº®æ•ˆæœ
  - åœ°ç‹±/ç‚¼è¯å°ï¼šæŠ—ç«è¯æ°´ + 30ç§’åœ°ç‹±ä¿æŠ¤
  - æ–°å¢ï¼šç©å®¶ Buff ç³»ç»Ÿï¼ˆå€’è®¡æ—¶ + è‡ªåŠ¨è¿‡æœŸï¼‰
- æŠ€æœ¯æ”¹è¿›
  - storage.jsï¼šæ–°å¢ saveVillageCheckpoint()ã€loadVillageCheckpoint()ã€hasVillageCheckpoint()ã€restoreFromVillageCheckpoint()
  - 18-village.jsï¼šæ–°å¢ interactSaveStone()ã€interactSpecialBuilding()ã€SPECIAL_BUILDING_EFFECTS
  - 18-village-render.jsï¼šå­˜æ¡£çŸ³ç¢‘å‘å…‰æ•ˆæœã€ç‰¹è‰²å»ºç­‘äº¤äº’æç¤º
  - 01-config.jsï¼šæ–°å¢ playerBuffs å…¨å±€å˜é‡
  - 13-game-loop.jsï¼šæ–°å¢ updatePlayerBuffs() Buff å€’è®¡æ—¶
  - 06-biome.jsï¼šåœ°ç‹±/é›ªåœ°ä¼¤å®³é€»è¾‘é›†æˆ Buff æ£€æŸ¥
```

### 5.3 Git æäº¤

```bash
git add src/storage.js src/modules/18-village.js src/modules/18-village-render.js
git add src/modules/01-config.js src/modules/13-game-loop.js src/modules/06-biome.js
git add package.json android-app/package.json android-app/android/app/build.gradle
git add docs/version/Progress.md
git commit -m "feat(village): v1.8.4 å­˜æ¡£çŸ³ç¢‘+ç¾¤ç³»ç‰¹è‰²å»ºç­‘+Buffç³»ç»Ÿ"
git push
```
