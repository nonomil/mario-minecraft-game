# 游戏优化-0219-2：需求9专项设计（单词-短语联动与重复频率）

日期：2026-02-19  
范围：仅针对“黄色圆圈单词与短语出现模式 + 重复频率”，基于当前代码现状给出可落地设计。

## 1. 现状与问题定位

## 1.1 已有能力（已实现基础链路）
- 掉落选词入口：`pickWordForSpawn()`（已集成 follow-up 优先出队）。  
- 基础复现机制：`buildWordPicker()` 的 `INTERVALS + updateWordQuality`。  
- 已有 follow-up 队列及入队/出队逻辑：`followUpQueue`、`createFollowUpPhraseItem()`、`maybeEnqueueFollowUpPhrase()`、`maybeTakeFollowUpPhrase()`。  
- 已有模式：`off / direct / gap2 / hybrid`。  
- 已有配置：`phraseFollowMode`、`phraseFollowGapCount`、`phraseFollowDirectRatio`、`wordRepeatWindow`。  
- `normalizeSettings()` 已对配置做合法化校验与 clamp。  
- `recentWords` 窗口去重已落地。  
- 词卡/挑战侧可展示 `phrase/phraseTranslation`。

## 1.2 缺口（真正未完成）
- `hybrid` 仍是固定随机比例（70/30），没有按词掌握度自适应（`hybrid-adaptive`）。  
- `stats[en]` 只有 `{ count, quality }`，缺少 `mastery/streak/wrong/seen`。  
- 选词仍偏“最小 count 的到期词”，没有完整优先级加权评分。  
- `updateWordQuality()` 只更新质量和 due，未更新 mastery 分。  
- 缺少统一观测指标输出（词后短语命中率、错词重现延迟）。

---

## 2. 目标

1. 支持三种节奏：  
- `direct`：下一个就是对应短语（gap=1）  
- `gap2`：隔两个普通词再出对应短语（gap=2）  
- `hybrid`：混合模式（推荐默认）

2. 重复频率可控：  
- 错误词更快重现；正确词逐步拉长间隔；避免短时间重复刷屏。

3. 与现有代码最小侵入：  
- 主要改 `apk/src/modules/11-game-init.js`，不改渲染主干。

---

## 3. 推荐模式（默认）

## 3.1 `hybrid-adaptive`（推荐）

### 规则
- 默认比例：`70% direct + 30% gap2`。  
- 若某词最近答错/反应慢：该词进入 `direct 强化`（100% direct）持续 3 次曝光。  
- 若某词连续掌握（快对>=3次）：该词短语跟随降为 `gap2`。

### 选择理由
- `direct` 提供强关联记忆。  
- `gap2` 避免节奏过密导致疲劳。  
- 自适应可把“强化成本”集中在薄弱词上。

---

## 4. 调度器设计

## 4.1 数据结构（在现有 `buildWordPicker()` 上增量）

```js
followUpQueue: Array<{
  baseEn: string,
  phraseEn: string,
  phraseZh: string,
  dueTick: number,
  priority: number
}>;

recentWindow: string[]; // 最近N次 baseEn

wordMemory: {
  [en: string]: {
    mastery: number,   // -3..+5
    lastTick: number,
    seen: number,
    wrong: number,
    streak: number
  }
}
```

## 4.2 选词主流程（在现有流程上增强）

1. `tick++`。  
2. 先尝试出队到期 `followUpQueue`（高优先）。  
- 条件：`dueTick <= tick` 且 `baseEn` 不在 `recentWindow` 冷却冲突中。  
3. 若无到期短语，再按“到期 + mastery + recentPenalty”选普通词。  
4. 选中普通词后：若有 `phrase + phraseTranslation`，计算 gap 并入队 follow-up。  
5. 更新 `recentWindow`。

## 4.3 gap 计算

- `direct`: `gap=1`  
- `gap2`: `gap=2`  
- `hybrid`: 按随机比例取 1 或 2  
- `hybrid-adaptive`: 先看该词 `mastery`：
  - `mastery <= -1` -> `gap=1`
  - `mastery >= 3` -> `gap=2`
  - 其他 -> 按 70/30

---

## 5. 重复频率策略

## 5.1 基础间隔（沿用并微调）

- `wrong`: `[0,1,2,4,8,16]`  
- `correct_slow`: `[0,3,8,20,45,90]`  
- `correct_fast`: `[0,5,15,40,100,220]`

说明：数组索引由 `seen stage` 决定，越熟练间隔越长。

## 5.2 记忆分 `mastery` 更新

- `wrong`: `mastery -= 2`（最低 -3）  
- `correct_slow`: `mastery += 1`  
- `correct_fast`: `mastery += 2`（最高 +5）

## 5.3 近期去重

- `recentWindowSize = 5`（可配置）  
- 同一 `baseEn` 在窗口内不允许再次作为主词出现。  
- 若是“到期短语任务”且冲突，最多延后 2 tick，避免永久饥饿。

## 5.4 最终权重（用于普通词备选排序）

`priority = dueReadyScore + weakWordBoost - recentPenalty`

- `dueReadyScore`: 到期越久分越高  
- `weakWordBoost`: `max(0, 2 - mastery)`  
- `recentPenalty`: 在近期窗口中则高惩罚

---

## 6. 配置项（与当前代码键名对齐）

建议放到 `settings`（并在 `defaults.js` 提供默认值）：

```json
{
  "phraseFollowMode": "hybrid",
  "phraseFollowDirectRatio": 0.7,
  "phraseFollowGapCount": 2,
  "phraseFollowAdaptive": true,
  "wordRepeatWindow": 6,
  "wordRepeatBias": "reinforce_wrong"
}
```

可选值：
- `phraseFollowMode`: `direct | gap2 | hybrid | off`
- `wordRepeatBias`: `balanced | reinforce_wrong`

---

## 7. 与现有模块的对接点

1. `apk/src/modules/11-game-init.js`  
- 主改造点：`buildWordPicker()` 与 `pickWordForSpawn()`。

2. `apk/src/modules/12-challenges.js`  
- 保持现有 `phrase/phraseTranslation` 展示逻辑。  
- 在挑战结果后继续调用 `updateWordQuality()`，让调度器学习。

3. `apk/src/modules/09-vocab.js`  
- 继续统一字段：`phrase` + `phraseTranslation`（`phraseZh` 仅兼容）。

---

## 8. 最小实现版本（MVP）

## M1（半天）
- 验证现有 `off/direct/gap2/hybrid + followUpQueue` 在实机链路稳定运行。  
- 修复已存在链路 bug（gap 计数、exclude 冲突、空字段兜底），不重写调度器。  
- 补最小观测日志：词后短语命中率、错词平均重现间隔。

## M2（半天）
- 在现有 `hybrid` 之上加入 `hybrid-adaptive`。  
- 给 `stats` 增加 `mastery/streak/wrong/seen`，并扩展 `updateWordQuality()`。

## M3（0.5天）
- 暴露设置项 + debug 指标（命中率、平均间隔、错词重现时延）。

---

## 9. 验收指标

1. 词短语联动命中率  
- `direct` 模式：>=95% 的短语出现在主词后第 1 个掉落位。  
- `gap2` 模式：>=90% 出现在第 3 个掉落位（允许少量冲突延后）。

2. 错词强化
- 错词平均重现间隔 < 正确词平均重现间隔的 60%。

3. 节奏稳定
- 连续 30 次掉落中，同一 `baseEn` 重复不超过 2 次（非错词强化场景）。

4. 稳定性
- 不出现 `undefined` 的 `en/zh/phraseTranslation` 渲染文本。

---

## 10. 结论

你说的“之前版本实现了部分功能但不完整”判断是准确的。当前已具备基础 follow-up 调度链路，缺的是“自适应强化层”和“观测闭环”。  
建议按 `M1 -> M2 -> M3` 递进：先稳现有、再做 adaptive、最后做配置与可观测。
