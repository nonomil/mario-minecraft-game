# v1.8.3 â€” å•è¯å­¦ä¹ å±‹ + æ‘åº„æŒ‘æˆ˜

> ç±»å‹ï¼šPATCH | versionName: 1.8.3 | versionCode: 62

## ä¸€ã€æœ¬ç‰ˆæœ¬ç›®æ ‡

å®ç°æ‘åº„æ ¸å¿ƒåŠŸèƒ½ä¹‹äºŒï¼šç©å®¶èµ°åˆ°"å•è¯å±‹"æ—è¾¹ï¼ŒæŒ‰äº¤äº’é”®è¿›å…¥å­¦ä¹ æŒ‘æˆ˜ï¼ˆ3 é“é¢˜ï¼‰ï¼Œæ ¹æ®æ­£ç¡®ç‡è·å¾—å¥–åŠ±ã€‚å¤ç”¨ç°æœ‰ `12-challenges.js` çš„æŒ‘æˆ˜ç³»ç»Ÿ UI å’Œé€»è¾‘ã€‚

## äºŒã€å‰ç½®ä¾èµ–

- v1.8.2 å·²å®Œæˆï¼ˆä¼‘æ¯ç³»ç»Ÿ + äº¤äº’æ¡†æ¶ + getVillageWords æ­£å¸¸å·¥ä½œï¼‰

## ä¸‰ã€ä¿®æ”¹æ–‡ä»¶

### 3.1 `src/modules/12-challenges.js` â€” æ–°å¢æ‘åº„æŒ‘æˆ˜å…¥å£

åœ¨æ–‡ä»¶ä¸­æ–°å¢ä»¥ä¸‹å‡½æ•°ï¼š

```javascript
/**
 * å¯åŠ¨æ‘åº„å­¦ä¹ æŒ‘æˆ˜
 * å¤ç”¨ç°æœ‰ showLearningChallenge çš„ UIï¼Œä¼ å…¥æ‘åº„ä¸“å±å•è¯
 *
 * @param {Object} village - å½“å‰æ‘åº„å®ä¾‹
 * @param {Function} onComplete - å®Œæˆå›è°ƒ (correctCount, totalCount)
 */
function startVillageChallenge(village, onComplete) {
  if (village.questCompleted) {
    showToast('ğŸ“š å·²å®Œæˆå­¦ä¹ ä»»åŠ¡');
    return;
  }

  const words = getVillageWords(village.biomeId);
  if (!words || words.length === 0) {
    showToast('ğŸ“š æš‚æ— å¯ç”¨å•è¯');
    return;
  }

  paused = true;

  // ä»æ‘åº„å•è¯ä¸­éšæœºé€‰å–é¢˜ç›®
  const questionCount = villageConfig.challengeQuestionCount || 3;
  const shuffled = [...words].sort(() => Math.random() - 0.5);
  const selectedWords = shuffled.slice(0, Math.min(questionCount, shuffled.length));

  // æ‘åº„æŒ‘æˆ˜çŠ¶æ€
  let currentIndex = 0;
  let correctCount = 0;

  function showNextQuestion() {
    if (currentIndex >= selectedWords.length) {
      // æŒ‘æˆ˜å®Œæˆ
      finishVillageChallenge(village, correctCount, selectedWords.length, onComplete);
      return;
    }

    const word = selectedWords[currentIndex];
    showVillageChallengeUI(word, (isCorrect) => {
      if (isCorrect) correctCount++;
      currentIndex++;

      // è®°å½•åˆ°ç­”é¢˜ç»Ÿè®¡ï¼ˆå¤ç”¨ç°æœ‰ challengeStatsï¼‰
      recordChallengeResult(word, isCorrect);

      // çŸ­æš‚å»¶è¿Ÿåæ˜¾ç¤ºä¸‹ä¸€é¢˜
      setTimeout(showNextQuestion, 500);
    });
  }

  // æ˜¾ç¤ºæŒ‘æˆ˜å¼€å§‹æç¤º
  showVillageChallengeIntro(village.biomeId, selectedWords.length, () => {
    showNextQuestion();
  });
}

/**
 * æ˜¾ç¤ºæ‘åº„æŒ‘æˆ˜å¼€å§‹ç•Œé¢
 */
function showVillageChallengeIntro(biomeId, count, onStart) {
  const modal = document.getElementById('challenge-modal');
  if (!modal) {
    // æ—  modal æ—¶ç›´æ¥å¼€å§‹
    onStart();
    return;
  }

  const biomeName = getBiomeById(biomeId)?.name || biomeId;

  modal.innerHTML = `
    <div style="text-align:center; padding:20px;">
      <div style="font-size:32px; margin-bottom:10px;">ğŸ“š</div>
      <h3 style="color:#FFD54F; margin:8px 0;">${biomeName}æ‘åº„ Â· å•è¯æŒ‘æˆ˜</h3>
      <p style="color:#EEE; font-size:14px;">å›ç­” ${count} é“å•è¯é¢˜</p>
      <p style="color:#AEA; font-size:12px;">å…¨å¯¹å¥–åŠ±ï¼šğŸ’Ã—1 + ğŸª™Ã—100 + ç¾¤ç³»é“å…·</p>
      <button id="btn-village-challenge-start"
        style="margin-top:16px; padding:10px 30px; font-size:16px;
               background:#4CAF50; color:#FFF; border:none; border-radius:8px;
               cursor:pointer;">
        å¼€å§‹æŒ‘æˆ˜
      </button>
    </div>
  `;
  modal.style.display = 'flex';

  document.getElementById('btn-village-challenge-start').addEventListener('click', () => {
    modal.style.display = 'none';
    onStart();
  });
}

/**
 * æ˜¾ç¤ºå•é“æ‘åº„æŒ‘æˆ˜é¢˜ç›®ï¼ˆå­—æ¯å¡«ç©ºé€‰æ‹©é¢˜ï¼‰
 * å¤ç”¨ç°æœ‰æŒ‘æˆ˜ UI æ¨¡å¼
 */
function showVillageChallengeUI(word, onAnswer) {
  const modal = document.getElementById('challenge-modal');
  if (!modal) {
    onAnswer(false);
    return;
  }

  const en = (word.en || word.english || '').toLowerCase();
  const zh = word.zh || word.chinese || '';

  // éšæœºéšè—ä¸€ä¸ªå­—æ¯
  const hideIndex = Math.floor(Math.random() * en.length);
  const displayed = en.split('').map((ch, i) => i === hideIndex ? '_' : ch).join('');
  const correctLetter = en[hideIndex];

  // ç”Ÿæˆé€‰é¡¹ï¼ˆæ­£ç¡®ç­”æ¡ˆ + 3 ä¸ªå¹²æ‰°é¡¹ï¼‰
  const allLetters = 'abcdefghijklmnopqrstuvwxyz';
  const options = [correctLetter];
  while (options.length < 4) {
    const rand = allLetters[Math.floor(Math.random() * 26)];
    if (!options.includes(rand)) options.push(rand);
  }
  options.sort(() => Math.random() - 0.5);

  modal.innerHTML = `
    <div style="text-align:center; padding:20px;">
      <p style="color:#AAA; font-size:12px; margin-bottom:8px;">é€‰æ‹©æ­£ç¡®çš„å­—æ¯å¡«ç©º</p>
      <div style="font-size:28px; color:#FFF; letter-spacing:4px; margin:12px 0; font-family:monospace;">
        ${displayed}
      </div>
      <p style="color:#FFD54F; font-size:14px; margin-bottom:16px;">${zh}</p>
      <div id="village-challenge-options" style="display:flex; gap:12px; justify-content:center; flex-wrap:wrap;">
        ${options.map(opt => `
          <button class="village-opt-btn"
            data-letter="${opt}"
            style="width:50px; height:50px; font-size:22px; font-family:monospace;
                   background:#37474F; color:#FFF; border:2px solid #546E7A;
                   border-radius:8px; cursor:pointer;">
            ${opt}
          </button>
        `).join('')}
      </div>
    </div>
  `;
  modal.style.display = 'flex';

  // ç»‘å®šé€‰é¡¹ç‚¹å‡»
  const btns = modal.querySelectorAll('.village-opt-btn');
  btns.forEach(btn => {
    btn.addEventListener('click', () => {
      const selected = btn.dataset.letter;
      const isCorrect = selected === correctLetter;

      // è§†è§‰åé¦ˆ
      btns.forEach(b => {
        b.style.pointerEvents = 'none';
        if (b.dataset.letter === correctLetter) {
          b.style.background = '#4CAF50';
          b.style.borderColor = '#66BB6A';
        } else if (b === btn && !isCorrect) {
          b.style.background = '#F44336';
          b.style.borderColor = '#EF5350';
        }
      });

      // æ’­æ”¾å•è¯å‘éŸ³
      if (typeof speakWord === 'function') {
        speakWord(en);
      }

      // æ˜¾ç¤ºå®Œæ•´å•è¯
      setTimeout(() => {
        modal.style.display = 'none';
        if (isCorrect) {
          showFloatingText('âœ… Correct!', player.x, player.y - 30);
        } else {
          showFloatingText(`âŒ ${en}`, player.x, player.y - 30);
        }
        onAnswer(isCorrect);
      }, 800);
    });
  });
}

/**
 * è®°å½•ç­”é¢˜ç»“æœåˆ° challengeStats
 */
function recordChallengeResult(word, isCorrect) {
  const en = (word.en || word.english || '').toLowerCase();
  if (typeof progress !== 'undefined' && progress.challengeStats) {
    if (!progress.challengeStats[en]) {
      progress.challengeStats[en] = { correct: 0, wrong: 0, lastTime: 0 };
    }
    if (isCorrect) {
      progress.challengeStats[en].correct++;
    } else {
      progress.challengeStats[en].wrong++;
    }
    progress.challengeStats[en].lastTime = Date.now();
  }
}

/**
 * æ‘åº„æŒ‘æˆ˜å®Œæˆç»“ç®—
 */
function finishVillageChallenge(village, correct, total, onComplete) {
  village.questCompleted = true;

  const reward = villageConfig.challengeReward || {};
  const isPerfect = correct === total;

  const modal = document.getElementById('challenge-modal');
  if (modal) {
    const rewardText = isPerfect
      ? `ğŸ‰ å…¨å¯¹! +${reward.perfect?.score || 100}ğŸª™ +${reward.perfect?.diamonds || 1}ğŸ’`
      : `ğŸ“ ${correct}/${total} +${reward.partial?.score || 50}ğŸª™`;

    modal.innerHTML = `
      <div style="text-align:center; padding:20px;">
        <div style="font-size:40px; margin-bottom:10px;">${isPerfect ? 'ğŸ†' : 'ğŸ“–'}</div>
        <h3 style="color:${isPerfect ? '#FFD54F' : '#EEE'}; margin:8px 0;">
          ${isPerfect ? 'å®Œç¾é€šå…³!' : 'æŒ‘æˆ˜å®Œæˆ'}
        </h3>
        <p style="color:#AEA; font-size:16px;">${correct} / ${total} æ­£ç¡®</p>
        <p style="color:#FFD54F; font-size:14px; margin-top:8px;">${rewardText}</p>
        <button id="btn-village-challenge-done"
          style="margin-top:16px; padding:10px 30px; font-size:16px;
                 background:#4CAF50; color:#FFF; border:none; border-radius:8px;
                 cursor:pointer;">
          ç»§ç»­å†’é™©
        </button>
      </div>
    `;
    modal.style.display = 'flex';

    document.getElementById('btn-village-challenge-done').addEventListener('click', () => {
      modal.style.display = 'none';
      paused = false;
    });
  } else {
    paused = false;
  }

  // å‘æ”¾å¥–åŠ±
  if (isPerfect) {
    score += reward.perfect?.score || 100;
    diamonds += reward.perfect?.diamonds || 1;
    grantBiomeReward(village.biomeId);
  } else {
    score += reward.partial?.score || 50;
  }
  updateScoreUI();

  if (onComplete) onComplete(correct, total);
}

/**
 * å‘æ”¾ç¾¤ç³»ä¸“å±é“å…·å¥–åŠ±
 */
function grantBiomeReward(biomeId) {
  const rewards = {
    forest: { item: 'golden_apple', name: 'ğŸ é‡‘è‹¹æœ', effect: 'å›å¤2å¿ƒ' },
    snow: { item: 'warm_coat', name: 'ğŸ§¥ ä¿æš–å¤–å¥—', effect: '30ç§’ä¸å—å†°å†»' },
    desert: { item: 'water_bottle', name: 'ğŸ’§ æ°´è¢‹', effect: 'æ²™æ¼ ä¸æ‰è¡€30ç§’' },
    mountain: { item: 'iron_pickaxe', name: 'â›ï¸ é“é•', effect: 'æ”»å‡»+2' },
    ocean: { item: 'trident', name: 'ğŸ”± ä¸‰å‰æˆŸ', effect: 'æ°´ä¸‹é€Ÿåº¦+50%' },
    nether: { item: 'fire_resistance', name: 'ğŸ§ª æŠ—ç«è¯æ°´', effect: 'åœ°ç‹±ä¸æ‰è¡€30ç§’' }
  };

  const reward = rewards[biomeId];
  if (reward) {
    // æ·»åŠ åˆ°èƒŒåŒ…
    if (typeof addToInventory === 'function') {
      addToInventory(reward.item, 1);
    }
    showToast(`ğŸ è·å¾— ${reward.name}ï¼ˆ${reward.effect}ï¼‰`, 3000);
  }
}
```

### 3.2 `src/modules/18-village.js` â€” æ›´æ–°äº¤äº’åˆ†æ”¯

ä¿®æ”¹ `handleVillageInteraction()` ä¸­çš„ `word_house` åˆ†æ”¯ï¼š

```javascript
// æ›¿æ¢åŸæ¥çš„ word_house caseï¼š
case 'word_house':
  startVillageChallenge(currentVillage);
  return true;
```

### 3.3 `Game.html` â€” ç¡®ä¿ challenge-modal å­˜åœ¨

ç¡®è®¤ `challenge-modal` DOM å…ƒç´ å­˜åœ¨ã€‚å¦‚æœç°æœ‰ HTML ä¸­å·²æœ‰ï¼Œåˆ™æ— éœ€ä¿®æ”¹ã€‚å¦‚æœæ²¡æœ‰ï¼Œæ–°å¢ï¼š

```html
<div id="challenge-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.85); z-index:100; justify-content:center; align-items:center;">
</div>
```

## å››ã€éªŒè¯æ¸…å•

- [ ] èµ°åˆ°å•è¯å±‹é™„è¿‘ï¼Œæ˜¾ç¤º"æŒ‰ Y å­¦ä¹ "æç¤º
- [ ] æŒ‰ Y / ç‚¹å‡»äº¤äº’æŒ‰é’®ï¼Œå¼¹å‡ºæŒ‘æˆ˜å¼€å§‹ç•Œé¢ï¼ˆæ˜¾ç¤ºç¾¤ç³»å + é¢˜æ•° + å¥–åŠ±è¯´æ˜ï¼‰
- [ ] ç‚¹å‡»"å¼€å§‹æŒ‘æˆ˜"ï¼Œæ˜¾ç¤ºç¬¬ä¸€é“å­—æ¯å¡«ç©ºé¢˜
- [ ] é¢˜ç›®æ˜¾ç¤ºï¼šéšè—ä¸€ä¸ªå­—æ¯çš„å•è¯ + ä¸­æ–‡é‡Šä¹‰ + 4 ä¸ªå­—æ¯é€‰é¡¹
- [ ] é€‰æ‹©æ­£ç¡®å­—æ¯ï¼šæŒ‰é’®å˜ç»¿ + æ˜¾ç¤º "âœ… Correct!" + æ’­æ”¾å‘éŸ³
- [ ] é€‰æ‹©é”™è¯¯å­—æ¯ï¼šæŒ‰é’®å˜çº¢ + æ­£ç¡®æŒ‰é’®å˜ç»¿ + æ˜¾ç¤ºå®Œæ•´å•è¯ + æ’­æ”¾å‘éŸ³
- [ ] 3 é“é¢˜å…¨éƒ¨å®Œæˆåæ˜¾ç¤ºç»“ç®—ç•Œé¢
- [ ] å…¨å¯¹å¥–åŠ±ï¼š+100åˆ† + 1ğŸ’ + ç¾¤ç³»ä¸“å±é“å…· + Toast æç¤º
- [ ] éƒ¨åˆ†å¯¹å¥–åŠ±ï¼š+50åˆ†
- [ ] åŒä¸€æ‘åº„åªèƒ½æŒ‘æˆ˜ä¸€æ¬¡ï¼Œå†æ¬¡äº¤äº’æç¤º"å·²å®Œæˆå­¦ä¹ ä»»åŠ¡"
- [ ] ç­”é¢˜ç»“æœè®°å½•åˆ° challengeStats
- [ ] æŒ‘æˆ˜æœŸé—´æ¸¸æˆæš‚åœ
- [ ] ç§»åŠ¨ç«¯è§¦æ§æ­£å¸¸ï¼ˆé€‰é¡¹æŒ‰é’®è¶³å¤Ÿå¤§ï¼‰

## äº”ã€ç‰ˆæœ¬æ›´æ–°æ“ä½œ

### 5.1 æ›´æ–°ç‰ˆæœ¬å·

**`package.json`**ï¼š`"version": "1.8.3"`

**`android-app/package.json`**ï¼š`"version": "1.8.3"`

**`android-app/android/app/build.gradle`**ï¼š
```
versionCode 62
versionName "1.8.3"
```

### 5.2 æ›´æ–° Progress.md

åœ¨ `docs/version/Progress.md` æ–‡ä»¶**é¡¶éƒ¨**æ’å…¥ï¼š

```markdown
## v1.8.3ï¼ˆå‘å¸ƒæ—¥æœŸï¼š2026-02-XXï¼‰
- ç±»å‹ï¼šPATCH
- APK ç‰ˆæœ¬ï¼šversionName = 1.8.3ï¼ŒversionCode = 62
- ä¸»è¦å˜æ›´
  - æ–°å¢ï¼šæ‘åº„ç³»ç»Ÿ - å•è¯å­¦ä¹ å±‹
  - å•è¯å±‹äº¤äº’ï¼šè¿›å…¥åè§¦å‘å­—æ¯å¡«ç©ºæŒ‘æˆ˜ï¼ˆ3é“é¢˜ï¼‰
  - æŒ‘æˆ˜å¼€å§‹ç•Œé¢ï¼ˆç¾¤ç³»åç§° + é¢˜æ•° + å¥–åŠ±è¯´æ˜ï¼‰
  - å­—æ¯å¡«ç©ºé€‰æ‹©é¢˜ï¼ˆéšè—ä¸€ä¸ªå­—æ¯ + 4é€‰é¡¹ + ä¸­æ–‡é‡Šä¹‰ï¼‰
  - ç­”é¢˜è§†è§‰åé¦ˆï¼ˆæ­£ç¡®ç»¿è‰²/é”™è¯¯çº¢è‰² + å•è¯å‘éŸ³ï¼‰
  - ç»“ç®—ç•Œé¢ï¼ˆæ­£ç¡®ç‡ + å¥–åŠ±æ˜ç»†ï¼‰
  - å…¨å¯¹å¥–åŠ±ï¼š+100åˆ† +1ğŸ’ + ç¾¤ç³»ä¸“å±é“å…·
  - 6ç§ç¾¤ç³»ä¸“å±é“å…·ï¼ˆé‡‘è‹¹æœ/ä¿æš–å¤–å¥—/æ°´è¢‹/é“é•/ä¸‰å‰æˆŸ/æŠ—ç«è¯æ°´ï¼‰
  - ç­”é¢˜ç»“æœè®°å½•åˆ° challengeStats
- æŠ€æœ¯æ”¹è¿›
  - 12-challenges.jsï¼šæ–°å¢ startVillageChallenge()ã€showVillageChallengeUI()ã€finishVillageChallenge()ã€grantBiomeReward()
  - 18-village.jsï¼šhandleVillageInteraction() é›†æˆå•è¯å±‹å…¥å£
  - å¤ç”¨ç°æœ‰ challenge-modal DOM å’Œ challengeStats æ•°æ®ç»“æ„
```

### 5.3 Git æäº¤

```bash
git add src/modules/12-challenges.js src/modules/18-village.js
git add Game.html
git add package.json android-app/package.json android-app/android/app/build.gradle
git add docs/version/Progress.md
git commit -m "feat(village): v1.8.3 å•è¯å­¦ä¹ å±‹ï¼ˆå­—æ¯å¡«ç©ºæŒ‘æˆ˜+ç¾¤ç³»å¥–åŠ±+ç­”é¢˜ç»Ÿè®¡ï¼‰"
git push
```
