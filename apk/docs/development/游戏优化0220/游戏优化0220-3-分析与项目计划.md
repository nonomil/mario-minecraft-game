# 游戏优化0220-3 分析与项目计划

## 1. 需求背景
来源：`apk/docs/development/游戏优化0220/游戏优化0220-3.md`

本轮聚焦 3 类问题：
1. 村庄单词测验屋仍有“桌子/书桌图案”残留，且交互触发体验异常（点一次无效、点两次变退出、疑似需要长按）。
2. 商人交易屋点击交互体验异常，用户反馈与“宝箱键触发”类似，存在长按/重复触发问题。
3. 盔甲系统虽可购买与装备，但角色外观无变化，受击体感变化不明显，不同盔甲缺少可感知差异。

---

## 2. 现状代码分析（结合项目）

### 2.1 单词屋图案残留
- 外部图标层已处理：`apk/src/modules/18-village-render.js:67`
  - `word_house` 图标已设为空字符串，不再绘制屋顶图标。
- 但室内渲染仍有“桌面+桌腿”结构：`apk/src/modules/18-village.js:673-676`
  - 在 `renderVillageInterior` 的 `word_house` 分支中，仍绘制木质台面与左右腿，视觉上容易被用户识别为“桌子图案”。

结论：外部图标问题已修，室内图案残留是当前主要来源。

### 2.2 交互“点一次不稳定/像长按”
- 统一入口在 `handleInteraction()`：`apk/src/modules/13-game-loop.js:1183`
  - 室内走 `handleVillageInteriorInteraction()`。
  - 室外村庄走 `checkVillageBuildings()`。
- 键盘触发位于 `keydown`：`apk/src/modules/17-bootstrap.js:142`
  - `isInteract` 每次 `keydown` 即调用 `handleInteraction()`，未对 `e.repeat` 做交互键抑制。
- 触控触发位于 `bindTap("interact")`：`apk/src/modules/16-events.js:400`
  - 当前主要绑定在 `pointerdown/touchstart`，在部分设备上易与系统手势、UI焦点切换产生误触或重复触发体感。
- 室内还存在自动门区触发：`apk/src/modules/18-village.js:727`
  - 当角色靠近门区会自动退出，若动作点与门区切换过快，用户体感可能是“点两次就退出”。

结论：交互体验问题是“输入触发策略 + 区域判定 + 自动门逻辑”叠加，而非单点故障。

### 2.3 盔甲“看起来无效果”
- 受击减伤已存在：`apk/src/modules/13-game-loop.js:575-578`
  - `reduction = min(0.5, defense * 0.1)`，最多仅减 50%，不会出现“完全不掉血”。
- 耐久消耗已存在：`apk/src/modules/13-game-loop.js:578-585`
  - 每次受击固定 -5。
- 盔甲装备 UI 已存在：`apk/src/modules/13-game-loop.js:1001+`
- 角色渲染无盔甲外观层：`apk/src/modules/14-renderer-main.js:113` 调用 `drawSteve`，而 `drawSteve` 本体未依据 `playerEquipment.armor` 绘制差异层。

结论：功能上“有减伤”，但“视觉无反馈 + 减伤不够显著”导致用户判定为无效。

---

## 3. 目标定义（0220-3）

### 3.1 交互目标
- 单词屋、商人屋、宝箱交互统一为“单击/单按一次生效”。
- 禁止依赖长按才能触发。
- 避免同一次输入触发两次行为（例如先交互再退出）。

### 3.2 盔甲目标
- 装备后角色外观有明确变化（至少颜色/轮廓可辨）。
- 不同盔甲有明确防护梯度，受击体感可区分。
- 钻石盔甲按产品定义给出“高防护”或“近免伤+耐久消耗”的清晰规则，并文案同步。

---

## 4. 实施方案（技术设计）

## 4.1 单词屋视觉清理
1. 删除 `word_house` 室内“桌腿”图形绘制（`18-village.js:673-676`）。
2. 保留“书本”作为唯一交互视觉锚点（`18-village.js:703-711`）。
3. 调整提示文案与锚点位置，避免与门区视觉重叠。

产出：单词屋仅保留“书本 + 提示文本”，无桌子误识别元素。

## 4.2 交互触发统一（一次点击）
1. 键盘交互防重复：
- 在 `17-bootstrap.js` 对 `isInteract` 增加 `!e.repeat` 防抖策略。
- 仅在首次 keydown 触发一次交互，按住不连发。

2. 触控交互改为“抬起触发优先”：
- 在 `16-events.js` 的 `bindTap` 对 `interact`/`attack` 使用 `pointerup`（保留兼容分支）。
- 增加 120-200ms 的输入级去重锁，避免某些 WebView 同次手势触发多事件。

3. 室内交互与自动门解耦：
- 在 `18-village.js` 给 `triggerVillageInteriorChestAction` 加独立短冷却（例如 250ms）。
- 当本次触发是“动作点交互”时，短时间内屏蔽自动门退出判定，避免“二次点击即退出”的体验。

4. 室外交互判定增强：
- `getNearbyBuilding` 交互 margin 适度增加（如 4 -> 8/12）并配合中心点判定，降低“点一次没反应”。

产出：单击稳定触发，长按不再是必要条件。

## 4.3 盔甲系统增强（外观 + 体感）
1. 渲染层：
- 在 `drawSteve` 增加盔甲覆盖层（头盔/胸甲/腿甲主色块）。
- 颜色使用 `ARMOR_TYPES[armorId].color`，不同材质呈现不同配色。

2. 防护模型：
- 方案A（推荐）：保持“HP仍掉但明显下降”，按材质阶梯提高减伤上限。
- 方案B（按你描述）：钻石盔甲在耐久>0时可实现近似免伤（或完全免伤），但每次受击耐久消耗更快。
- 最终以需求确认为准，计划先实现可配置（通过 config 控制）。

3. 反馈强化：
- 受击时显示“护甲吸收”浮字（可选）。
- 盔甲耐久降低时给出轻提示，破损时保持现有强提示。

4. 配置清理（并行）
- `01-config.js` 中盔甲名称存在乱码，需先修正文案，否则 UI 展示异常。

产出：装备后“看得见变装、打得出差异”。

---

## 5. 分阶段项目计划（Project Plan）

## Phase 0：基线与回归保护（0.5天）
- 建立回归清单：单词屋交互、交易屋交互、宝箱交互、盔甲装备后受击。
- 补一个 e2e 场景：单击交互不需长按（touch + keyboard 各一条）。

## Phase 1：单词屋视觉与交互稳定（1天）
- 去除桌子残留图案。
- 室内交互单击触发稳定化（输入去重 + 自动门短暂屏蔽）。
- 验证“点一次开始测验”。

## Phase 2：交易屋交互稳定（1天）
- 统一交易按钮触发策略（单击、去重、防重复提交）。
- 验证“卖材料/买护甲/买防晒”均一次点击生效。

## Phase 3：盔甲外观与防护体感（1.5天）
- 实现盔甲外观层。
- 调整减伤/耐久策略并可配置化。
- 完成“钻石盔甲”规则与文案对齐。

## Phase 4：联调、文档、发布准备（0.5天）
- 运行语法检查与 P0 e2e 集合。
- 更新版本记录与说明。

总工期：约 4.5 天（可并行压缩至 3~3.5 天）。

---

## 6. 验收标准（DoD）
1. 单词屋室内无桌子残留视觉，只有书本交互锚点。
2. 单词测验与交易屋均“单击一次触发”，无需长按。
3. 不出现“按一次无效、按两次退出”的交互异常。
4. 装备盔甲后角色外观可辨识变化。
5. 不同盔甲受击体感可区分；钻石盔甲行为与需求定义一致。
6. 关键检查通过：
- `node --check` 相关模块
- e2e：村庄可见性、单词屋稳定、交易与狐狸、交互单击专项

---

## 7. 风险与应对
- 风险A：输入去重过强导致“漏触发”。
  - 应对：去重仅针对同动作短时间重复，且按键/触控分层处理。
- 风险B：自动门屏蔽窗口过长影响退出体验。
  - 应对：窗口控制在 200~350ms，并仅在动作点交互后启用。
- 风险C：盔甲减伤改动影响整体难度平衡。
  - 应对：配置化 + A/B 参数回归（普通/困难模式都验证）。

---

## 8. 建议先决策项（需产品确认）
1. 钻石盔甲是否“完全不掉血”，还是“高减伤但仍掉少量血”。
2. 不同盔甲是否仅颜色区分，还是要做明显轮廓差异（头盔形状、肩甲）。
3. 交互失败提示文案是否保留（靠近床后按宝箱键/靠近单词书后按宝箱键）。

---

## 9. 变更文件清单（预计）
- `apk/src/modules/18-village.js`
- `apk/src/modules/16-events.js`
- `apk/src/modules/17-bootstrap.js`
- `apk/src/modules/13-game-loop.js`
- `apk/src/modules/14-renderer-entities.js`
- `apk/src/modules/01-config.js`（盔甲文案/参数）
- `apk/tests/e2e/specs/*`（新增/更新交互专项用例）
