# 游戏功能实施计划（2026年2月，修订版）

编制日期：2026-02-16  
修订日期：2026-02-16  
基线版本：`apk/` 当前代码（含已落地的 v1.10.3~v1.11.2 修复）  
目标版本：v1.16.0

---

## 一、修订背景

基于最新代码核对结果，旧实施计划存在两类偏差：

1. 将 `v1.10.3~v1.11.2` 误判为“未实现”；
2. 将重点放在“根目录同步”，而当前实际主缺口在 `apk/` 侧的 `v1.12.0~v1.15.0` 计划项。

因此本修订版改为：**先补学习链路核心缺口（v1.12.0/v1.13.0），再补UI/性能尾项（v1.14.0/v1.15.0），最后统一版本发布。**

---

## 二、当前真实状态（摘要）

### 2.1 已实现（无需重复开发）

- v1.10.3 海滨环境修复：已实现
- v1.11.0 蘑菇森林视觉：已实现
- v1.11.1 樱花丛林视觉：已实现
- v1.11.2 雪傀儡与猪灵：已实现

### 2.2 部分实现（需收尾）

- v1.11.3：海洋手感已实现；高温掉血仍为按帧计时（需改为真实时间）
- v1.15.0：`optimizedUpdate` 已有；装饰/粒子尚未纳入节流

### 2.3 未实现（核心缺口）

- v1.12.0：学习纠错反馈、phrase提取与词卡展示、学习模式重试
- v1.13.0：质量感知复习、难度平滑插值、新题型（multi_blank/unscramble）
- v1.14.0：词卡时长可配置、挑战频率语义化、GameOver本局词汇展示

---

## 三、总目标与原则

### 3.1 总目标

在不破坏现有群系/BOSS/村庄稳定性的前提下，完成 v1.12.0~v1.15.0 剩余计划项，并形成可回归测试的发布版本。

### 3.2 执行原则

- 只以 `apk/` 为交付基线，不再默认“根目录即真相”。
- 先功能正确，再视觉优化，再性能收尾。
- 每阶段必须有自动化回归（Playwright）和手工冒烟清单。

---

## 四、阶段计划（新）

## 阶段A（P1）：v1.12.0 学习反馈核心优化

### A.1 目标

完成“答错可学会”的闭环：答错反馈、正确答案展示、词卡例句、学习模式重试。

### A.2 实施项

1. `apk/src/modules/12-challenges.js`
- 增加 `showChallengeCorrection(wordObj)`。
- `completeLearningChallenge(false)` 改为：
  - 非学习模式：显示纠错 + 延时关闭；
  - 学习模式：不扣分 + 自动重试同词（可换题型）。

2. `apk/src/modules/09-vocab.js`
- `normalizeRawWord()` 增加字段：
  - `phrase`（来自 `raw.phrase`）
  - `phraseZh`（来自 `raw.phraseTranslation`）

3. `apk/Game.html` + `apk/src/modules/12-challenges.js`
- 在词卡新增 `word-card-phrase` 区域。
- `showWordCard()` 支持例句展示与隐藏逻辑。

### A.3 验收标准

- 答错后可见正确答案，不再“瞬间结束”。
- 开启学习模式时，答错不扣分并自动重试。
- 带 phrase 的词汇能在词卡显示例句。

### A.4 测试

- 自动化：新增/扩展 `requirements` 用例覆盖学习模式重试与纠错显示。
- 手工：3轮答错/答对混测，验证积分和UI状态。

---

## 阶段B（P1）：v1.13.0 学习算法与题型增强

### B.1 目标

让复习频率随答题质量变化，且题型不再单一。

### B.2 实施项

1. `apk/src/modules/11-game-init.js`
- `buildWordPicker()` 从固定间隔改为质量感知间隔：
  - `correct_fast` / `correct_slow` / `wrong`
- 暴露 `updateWordQuality()`。

2. `apk/src/modules/12-challenges.js`
- 在答题结果处调用 `wordPicker.updateWordQuality(...)`。
- 新增题型：
  - `multi_blank`
  - `unscramble`
- 注册到挑战类型池并加入随机选择。

3. `apk/src/modules/05-difficulty.js`
- `computeDifficultyState()` 在 auto 模式支持相邻tier线性插值。
- 手动难度选择保持原行为不变。

### B.3 验收标准

- 答错词条在更短间隔内再次出现。
- 快速答对词条复现间隔明显拉长。
- 挑战中可随机出现两种新题型。
- 自动难度在阈值附近无突变。

### B.4 测试

- 自动化：新增“错误词回流”“新题型可触发”“难度平滑”断言。
- 手工：用调试页设分数跨阈值观测敌人参数连续性。

---

## 阶段C（P2）：v1.14.0 UI与性能优化（功能侧）

### C.1 目标

补齐用户可感知的学习反馈UI配置项。

### C.2 实施项

1. `apk/src/modules/10-ui.js`
- GameOver面板增加“本局词汇（去重）”展示，超长折叠显示 `+N`。

2. `apk/Game.html` + `apk/src/modules/16-events.js` + `apk/src/modules/09-vocab.js`
- 新增 `opt-word-card-duration`，并保存到 settings。
- `showWordCard()` 改为读取 `settings.wordCardDuration`。

3. `apk/Game.html` + `apk/src/modules/16-events.js`
- 将 `opt-challenge-freq` 滑杆升级为语义化 `opt-challenge-frequency`（很少/适中/频繁）。

### C.3 验收标准

- GameOver可看到本局学习词汇摘要。
- 词卡时长配置可生效并持久化。
- 挑战频率配置可生效并持久化。

---

## 阶段D（P2）：v1.11.3 收尾（高温掉血真实时间）

### D.1 目标

将高温掉血从“按帧”改为“按真实时间”。

### D.2 实施项

1. `apk/src/modules/06-biome.js`
- 将 `biomeHeatDotTimer` 帧计数改为毫秒累计（建议基于 `Date.now()` 或 deltaTime）。
- 保留下界合金护甲免疫规则。

### D.3 验收标准

- `nether/volcano` 中无护甲时约每60秒掉0.5血（与帧率无关）。
- 30fps/60fps环境下掉血节奏一致。

---

## 阶段E（P3）：v1.15.0 收尾（节流扩展）

### E.1 目标

把装饰和粒子更新纳入 off-screen 节流，降低高密度场景负载。

### E.2 实施项

1. `apk/src/modules/13-game-loop.js`
- `decorations` 更新改为通过 `optimizedUpdate()`。
- `particles` 更新（位置/动画）改为通过 `optimizedUpdate()`。
- 生命衰减逻辑保持正确，避免粒子“常驻”。

### E.3 验收标准

- 屏幕外对象减少更新频率但不影响屏幕内表现。
- 蘑菇岛/樱花群系长跑时帧时间更稳定。

---

## 五、统一测试与发布门禁

## 5.1 自动化门禁

每阶段必须通过：

```powershell
$env:PLAYWRIGHT_CHROMIUM_USE_HEADLESS_SHELL='0'
npx playwright test --reporter=line
```

目标：在现有 13 条用例基础上持续扩展，保持全绿。

## 5.2 手工冒烟门禁

每次提测必做：

1. 首页进入/重进地面与触控正常。
2. 调试页动作：切换群系/村庄/BOSS均有效。
3. 学习挑战触发、答错反馈、词卡显示与设置项生效。

## 5.3 发布文件一致性

每次正式发版统一更新：

- `apk/package.json`
- `apk/android-app/package.json`
- `apk/android-app/android/app/build.gradle`
- `apk/docs/version/CHANGELOG.md`
- `apk/docs/version/Progress.md`

---

## 六、建议执行顺序与工期（建议）

1. 阶段A（1~2天）
2. 阶段B（2~3天）
3. 阶段C（1~2天）
4. 阶段D（0.5~1天）
5. 阶段E（0.5~1天）
6. 联调+回归+发版（1天）

总计建议：6~10个工作日。

---

## 七、风险与应对

### 风险1：学习链路改动引入UI竞态

应对：先补测试，再改逻辑；答错分支全部走统一出口函数。

### 风险2：节流扩展导致粒子生命周期异常

应对：把“生命周期衰减”与“位置更新”拆开验证，先灰度到单群系。

### 风险3：版本号再次不一致

应对：发布前增加版本一致性检查脚本，CI 或本地 pre-release 执行。

---

## 八、交付定义（Done Definition）

满足以下条件才算完成本次计划：

1. `v1.12.0~v1.15.0` 本文列出的未实现项全部落地。
2. Playwright 全量用例通过（含新增学习链路专项）。
3. 手工冒烟清单通过。
4. 版本与文档（CHANGELOG/Progress）一致更新。

