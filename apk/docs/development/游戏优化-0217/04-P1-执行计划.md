# P1 执行计划：主体验优化

目标版本：v1.17.0（versionCode 100）
前置版本：v1.16.0（P0 完成后）

---

## Step 1：群系难度分级（P1-1）

### 1.1 新增群系轮次追踪

操作：
1. 在 `apk/src/modules/06-biome.js` 中新增全局变量 `biomeVisitCount = {}`
2. 在 `updateCurrentBiome()` 或群系切换函数中，每次切入新群系时递增：
   ```js
   biomeVisitCount[newBiomeId] = (biomeVisitCount[newBiomeId] || 0) + 1;
   ```
3. 在游戏重置（`resetGame` / `start`）时清零 `biomeVisitCount`
4. 导出 `getBiomeVisitRound(biomeId)` 函数供其他模块调用

涉及文件：
- `apk/src/modules/06-biome.js`

### 1.2 配置群系敌人分层表

操作：
1. 在 `apk/config/biomes.json` 中为关键群系增加 `enemyTiers` 字段：
   ```json
   "cherry_grove": {
     "enemyTiers": [
       { "round": 1, "types": ["bee"], "spawnRate": 0.5, "poison": false, "eliteChance": 0 },
       { "round": 2, "types": ["bee", "spore_bug"], "spawnRate": 0.8, "poison": true, "eliteChance": 0.1 },
       { "round": 3, "types": ["bee", "spore_bug", "fox"], "spawnRate": 1.0, "poison": true, "eliteChance": 0.2 }
     ]
   }
   ```
2. 为以下群系配置分层表：cherry_grove、mushroom_island、ocean、volcano、nether、deep_dark
3. 未配置分层表的群系使用默认行为（不变）

涉及文件：
- `apk/config/biomes.json`

### 1.3 修改敌人生成逻辑

操作：
1. 在 `apk/src/modules/11-game-init.js` 或 `apk/src/modules/20-enemies-new.js` 的敌人生成函数中：
   - 获取当前群系 ID 和轮次：`const round = getBiomeVisitRound(currentBiome)`
   - 查询 `biomeConfigs[currentBiome].enemyTiers`，找到 `round` 对应的 tier（超出最大轮次则使用最后一级）
   - 根据 tier 的 `types` 过滤可生成敌人种类
   - 根据 tier 的 `spawnRate` 调整生成频率
   - 根据 tier 的 `poison` 决定是否启用中毒效果
2. 全局难度系统（`05-difficulty.js`）继续控制数值倍率（伤害、血量），与群系分层叠加但不重复放大

涉及文件：
- `apk/src/modules/11-game-init.js`
- `apk/src/modules/20-enemies-new.js`
- `apk/src/modules/05-difficulty.js`（确认接口兼容）

---

## Step 2：群系时长调整（P1-2）

### 2.1 配置双阈值

操作：
1. 在 `apk/config/biomes.json` 的每个群系中增加：
   ```json
   "minStayScore": 150,
   "minStayTimeSec": 30
   ```
2. 各群系建议值：

| 群系 | minStayScore | minStayTimeSec |
|------|-------------|----------------|
| forest | 100 | 20 |
| cherry_grove | 150 | 30 |
| snow | 150 | 30 |
| desert | 150 | 30 |
| mushroom_island | 200 | 40 |
| mountain | 200 | 35 |
| ocean | 200 | 40 |
| volcano | 200 | 40 |
| nether | 250 | 45 |
| deep_dark | 250 | 45 |
| end | 300 | 50 |
| sky_dimension | 300 | 50 |

涉及文件：
- `apk/config/biomes.json`

### 2.2 修改群系切换逻辑

操作：
1. 在 `apk/src/modules/06-biome.js` 中新增追踪变量：
   ```js
   let biomeEntryScore = 0;    // 进入当前群系时的分数
   let biomeEntryTime = 0;     // 进入当前群系时的时间戳(ms)
   ```
2. 在群系切换时记录：`biomeEntryScore = currentScore; biomeEntryTime = Date.now();`
3. 修改 `getBiomeIdForScore()` 或群系切换判断逻辑：
   ```js
   const cfg = biomeConfigs[currentBiome];
   const scoreInBiome = currentScore - biomeEntryScore;
   const timeInBiome = (Date.now() - biomeEntryTime) / 1000;
   const minScore = cfg.minStayScore || 100;
   const minTime = cfg.minStayTimeSec || 20;
   if (scoreInBiome < minScore || timeInBiome < minTime) {
       return currentBiome; // 不切换
   }
   ```

涉及文件：
- `apk/src/modules/06-biome.js`

---

## Step 3：海洋生态修正（P1-3）

### 3.1 禁止海洋生成树

操作：
1. 在 `apk/config/biomes.json` 的 `ocean` 配置中明确设置 `"treeTypes": []`
2. 在 `apk/src/modules/11-game-init.js` 的树生成函数中增加守卫：
   ```js
   if (currentBiome === 'ocean') return; // 海洋不生成树
   ```

涉及文件：
- `apk/config/biomes.json`
- `apk/src/modules/11-game-init.js`

### 3.2 海洋禁爆

操作：
1. 在 `apk/src/modules/15-entities-combat.js` 中定位苦力怕爆炸逻辑
2. 在爆炸伤害计算前增加守卫：
   ```js
   if (currentBiome === 'ocean') {
       // 海洋中苦力怕不爆炸，改为普通消失
       return;
   }
   ```
3. 在 `apk/src/modules/11-game-init.js` / `20-enemies-new.js` 的敌人生成中，海洋群系排除 creeper：
   ```js
   if (currentBiome === 'ocean' && enemyType === 'creeper') continue;
   ```

涉及文件：
- `apk/src/modules/15-entities-combat.js`
- `apk/src/modules/11-game-init.js`
- `apk/src/modules/20-enemies-new.js`

### 3.3 增加水中装饰

操作：
1. 在 `apk/src/modules/21-decorations-new.js` 中新增海洋装饰类型：
   - `large_seaweed`：大型水草，高度 60-100px，绿色半透明，轻微摆动动画
   - `coral`：珊瑚，多色（粉/橙/紫），固定在地面
2. 在海洋群系装饰生成中提升这些类型的权重

涉及文件：
- `apk/src/modules/21-decorations-new.js`

### 3.4 海洋敌人与海洋生物链路统一

操作：
1. 不重复新增 `Drowned` 类，优先复用现有敌人体系中的 `drowned`（由敌人生成链路管理）
2. 明确海洋中两条并行链路：
   - 敌人链路：`drowned/pufferfish` 等（战斗相关）
   - 海洋生物链路：`CodFish/Squid` 等（环境生物）
3. 统一刷怪/渲染入口，避免同类实体在两条链路重复生成或重复渲染

涉及文件：
- `apk/src/modules/11-game-init.js`（敌人生成）
- `apk/src/modules/20-enemies-new.js`（群系敌人扩展）
- `apk/src/modules/15-entities-particles.js`（海洋生物）
- `apk/src/modules/14-renderer-entities.js`（渲染调用）

---

## Step 4：火山贴地修正（P1-4）

### 4.1 排查装饰锚点

操作：
1. 在 `apk/src/modules/21-decorations-new.js` 中搜索火山相关装饰：`obsidian`、`hot_spring`、`magma_crack`、`volcano`
2. 检查每个装饰物的 y 坐标计算，确认是否使用了统一的 `groundY` 基准
3. 记录所有锚点不一致的位置

### 4.2 统一锚点

操作：
1. 确保所有火山装饰物的 y 坐标以 `groundY`（地面 y 坐标）为基准：
   ```js
   // 正确：从地面向上延伸
   this.y = groundY - this.height;
   // 错误：使用固定值或随机值导致悬浮
   this.y = 100; // ← 修正这类代码
   ```
2. 黑曜石柱：底部对齐地面，向上延伸
3. 热泉：嵌入地面，顶部与地面平齐或略低
4. 岩浆裂缝：与地面平齐

涉及文件：
- `apk/src/modules/21-decorations-new.js`

### 4.3 平台连续性

操作：
1. 在 `apk/src/modules/11-game-init.js` 的火山群系平台生成中：
   - 增加地面连续性约束：70% 以上平台 y 坐标贴近 `groundY`
   - 减少悬浮平台比例至 20% 以下
   - 火山锥体从地面向上延伸

涉及文件：
- `apk/src/modules/11-game-init.js`

---

## Step 5：单词挑战 UI 修正（P1-5）

### 5.1 自适应字体缩放

操作：
1. 在 `apk/src/modules/12-challenges.js` 的选项按钮创建处，增加动态字号：
   ```js
   const len = optionText.length;
   if (len > 20) btn.style.fontSize = '10px';
   else if (len > 15) btn.style.fontSize = '12px';
   else if (len > 10) btn.style.fontSize = '14px';
   // 短词保持默认
   ```

涉及文件：
- `apk/src/modules/12-challenges.js`

### 5.2 按钮样式优化

操作：
1. 在 `apk/src/styles.css` 中修改 `.challenge-option`：
   ```css
   .challenge-option {
       word-break: break-word;
       overflow-wrap: break-word;
       min-height: 36px;
       padding: 6px 10px;
       line-height: 1.3;
   }
   ```
2. 修改 `.challenge-fill-word` 增加字距衰减逻辑（通过 JS 动态设置）

涉及文件：
- `apk/src/styles.css`

### 5.3 双字母补全间隔

操作：
1. 在 `12-challenges.js` 的 `multi_blank` 选项生成中：
   - 获取原单词中两个空缺字母的索引位置
   - 计算两个空缺之间的字母数量
   - 在选项显示中插入对应数量的 `·` 作为间隔：如 `a··b` 表示中间隔了 2 个字母

涉及文件：
- `apk/src/modules/12-challenges.js`

---

## Step 6：Playwright 测试（P1-T）

### 6.1 编写测试用例

创建 `tests/p1-experience.spec.js`：

```js
// 测试 1：群系难度分级
test('首轮樱花群系敌人受限', async ({ page }) => {
  // 加载游戏 → debug 切换到 cherry_grove
  // 等待敌人生成 → 验证只有 bee 类型
  // 验证无 poison 效果
});

// 测试 2：群系最小停留
test('蘑菇群系不会立即切换', async ({ page }) => {
  // 加载游戏 → debug 切换到 mushroom_island
  // 快速加分 100 → 验证仍在 mushroom_island
  // 等待 minStayTimeSec → 加分超过 minStayScore → 验证可切换
});

// 测试 3：海洋无树无爆炸
test('海洋群系生态正确', async ({ page }) => {
  // 加载游戏 → debug 切换到 ocean
  // 行走 10 秒 → 验证无树木实体
  // 验证无 creeper 敌人
});

// 测试 4：单词 UI 不溢出
test('长词挑战不溢出', async ({ page }) => {
  // 触发挑战 → 注入长词测试数据
  // 截图选项区域 → 验证按钮内文字未超出边界
});
```

### 6.2 运行测试

```bash
npm test -- tests/p1-experience.spec.js
```

验收标准：全部测试通过

---

## Step 7：版本发布（P1-V）

### 7.1 更新版本号

- `apk/package.json`: `"version": "1.17.0"`
- `apk/android-app/android/app/build.gradle`: `versionCode 100`, `versionName "1.17.0"`

### 7.2 更新版本记录

Progress.md 顶部插入：
```markdown
## v1.17.0（发布日期：2026-02-XX）
- 类型：MINOR
- APK 版本：versionName = 1.17.0，versionCode = 100
- 主要变更
  - 群系难度分级：引入轮次计数 + 敌人分层表，首轮降低压制感
  - 群系最小停留：双阈值（分数+时间）防止快速切走
  - 海洋生态修正：禁爆 + 禁树 + 新增溺尸/水草/珊瑚
  - 火山贴地修正：装饰锚点统一 + 平台连续性
  - 单词挑战 UI：自适应字号 + 断词 + 双空补全间隔
  - 新增 Playwright P1 体验测试
```

CHANGELOG.md / VERSION-STATUS.md 同步更新。

### 7.3 Git 提交

```bash
git add apk/package.json apk/android-app/android/app/build.gradle \
       apk/config/biomes.json apk/src/modules/06-biome.js \
       apk/src/modules/11-game-init.js apk/src/modules/20-enemies-new.js \
       apk/src/modules/15-entities-combat.js apk/src/modules/21-decorations-new.js \
       apk/src/modules/15-entities-particles.js apk/src/modules/12-challenges.js \
       apk/src/styles.css apk/docs/version/ tests/p1-experience.spec.js \
       apk/docs/development/游戏优化-0217/02-总体执行计划.md
git commit -m "release(v1.17.0): P1 experience - biome difficulty tiers, ocean ecology, volcano fix, challenge UI"
git push origin main
```

### 7.4 更新总体计划进度

在 `02-总体执行计划.md` 中将 P1 行状态改为 ✅ 已完成。
