# 游戏优化0219-详细执行计划

日期: 2026-02-19
对应报告: `游戏优化0219-问题分析报告.md`

## 总览

本计划为每个阶段提供多个版本（最小→完整→高级），可根据时间和优先级灵活选择。

本次新增强制要求: **Playwright 触发并证明“村庄已出现”**。  
仅“村庄已生成”不算通过，必须有可见性断言 + 截图证据 + 测试报告。

推荐执行路径: **A1 → E1 → F1 → B1 → C1 → E2 → D → E3**

---

## 工具调用映射（必须在计划中体现）

- `npm run serve` -> `apk/tools/serve-apk.mjs`（Playwright `webServer` 自动调用）
- `npm run vocab:db:import` -> `apk/tools/vocab-db/import.mjs`
- `npm run vocab:db:export` -> `apk/tools/vocab-db/export.mjs`
- `npm run vocab:db:validate` -> `apk/tools/vocab-db/validate.mjs`
- `npm run vocab:db:dedup` -> `apk/tools/vocab-db/dedup.mjs`

---

## 阶段 A：村庄可见性修复（P0）

当前状态: `apk` 与 root 已同步移除重复相机偏移；E2 回归已通过（6/6）。

### 版本 A1：最小修复（推荐）

只做坐标修复，不动其他逻辑。

> **重要发现**: 村庄渲染修复同时涉及 `apk` 与 root 双目录，历史探查出现过两边不一致；执行前必须先做一致性比对。
> `apk/scripts/sync-web.js`（`npm run build`）方向是 `apk -> out -> android-app/web`，不负责 `root <-> apk` 源码同步，因此 root 目录需单独同步。

| 步骤 | 内容 | 涉及文件 |
|------|------|----------|
| 1 | 执行前先比对 apk/root 一致性：`rg -n -- "\\-\\s*cameraX" apk/src/modules/18-village-render.js src/modules/18-village-render.js` + `git diff --no-index -- src/modules/18-village-render.js apk/src/modules/18-village-render.js`。若存在差异，先同步再继续 | `apk/src/modules/18-village-render.js`, `src/modules/18-village-render.js` |
| 2 | 检查 `drawVillages()` 的可见性裁剪逻辑（228-229行）：用 `cameraX` 做视口裁剪，坐标修复后此逻辑仍然成立（裁剪比较的是世界坐标，不受 canvas transform 影响） | `apk/src/modules/18-village-render.js` |
| 3 | 将修复同步回 root 目录（手动复制或 diff patch） | `src/modules/18-village-render.js` ← `apk/src/modules/18-village-render.js` |
| 4 | 手动验证：分数到 500 时村庄可见，相机移动时位置正确，无闪烁/瞬移 | 手动测试 |
| 5 | 提交修复（apk + root 两处一起提交） | git commit |

### 版本 A2：修复 + 清理闲置配置

在 A1 基础上，顺带清理报告中提到的伴随问题。

| 步骤 | 内容 | 涉及文件 |
|------|------|----------|
| 1-4 | 同 A1 | — |
| 5 | 让 `settings.villageFrequency` 实际接入 `maybeSpawnVillage()` 的 interval 计算，或在 defaults 中标注废弃 | `apk/src/modules/18-village.js`, `apk/src/defaults.js` |
| 6 | 移除 `loadVillageConfig()` 闲置路径（已由 bootstrap 统一加载），减少维护歧义 | `apk/src/modules/18-village.js` |

### 版本 A3：修复 + E2E 联动

在 A1 基础上，补自动化回归联动（详细步骤见阶段 E）。

| 步骤 | 内容 | 涉及文件 |
|------|------|----------|
| 1-4 | 同 A1 | — |
| 5 | 使用现有用例 `p0-village-visibility.spec.mjs`，验证“生成 + 可见 + 截图证据”三件事 | `apk/tests/e2e/specs/p0-village-visibility.spec.mjs` |

---

## 阶段 B：单词-短语联动掉落（P1）

### 版本 B1：最小可用 - Follow-up Queue（推荐）

改动集中在 `pickWordForSpawn()`，不重构整个 wordPicker。

> **字段名修正**: 词库实际字段为 `phrase` + `phraseTranslation`（非 `phraseZh`）。
> 示例: `{ "word": "smile", "phrase": "Smile happily", "phraseTranslation": "开心地微笑" }`
> 代码中构造短语 item 时必须使用正确字段名。

| 步骤 | 内容 | 涉及文件 |
|------|------|----------|
| 1 | 在 `11-game-init.js` 顶部新增 `followUpQueue = []`（全局变量） | `apk/src/modules/11-game-init.js` |
| 2 | 修改 `pickWordForSpawn()`：先检查 `followUpQueue`，有待出短语则直接返回短语 item，否则走原逻辑 | `apk/src/modules/11-game-init.js` |
| 3 | 在原逻辑返回 wordObj 后，检查 `wordObj.phrase`，若存在则构造短语 item 压入队列。构造方式：`{ en: wordObj.phrase, zh: wordObj.phraseTranslation, isPhrase: true, parentWord: wordObj.word }` | `apk/src/modules/11-game-init.js` |
| 4 | 在 `defaults.js` 新增 `phraseFollowMode`，值为 `"direct"` / `"gap2"` / `"off"`，默认 `"direct"` | `apk/src/defaults.js` |
| 5 | `gap2` 模式实现：压入队列时附带 `gapRemaining = 2`，每次调用时先递减 gap | `apk/src/modules/11-game-init.js` |
| 6 | 黄圈渲染兼容：短语文本过长时缩小字号或截断显示 | `apk/src/modules/14-renderer-main.js` |
| 7 | 手动验证：连续收集 20 个词，观察“词后跟短语”是否符合模式 | 手动测试 |

### 版本 B2：完整版 - 含重复频率改造

在 B1 基础上，增强间隔重复控制。

| 步骤 | 内容 | 涉及文件 |
|------|------|----------|
| 1-7 | 同 B1 | — |
| 8 | 在 `buildWordPicker()` 增加短期重复保护窗口（recentWords 环形缓冲区） | `apk/src/modules/11-game-init.js` |
| 9 | 将普通收集（非挑战）也纳入 `updateWordQuality()` | `apk/src/modules/13-game-loop.js` |
| 10 | 在设置 UI 中暴露 `phraseFollowMode` 选项 | `apk/src/modules/10-ui.js` |

### 版本 B3：高级版 - hybrid 模式 + 数据统计

| 步骤 | 内容 | 涉及文件 |
|------|------|----------|
| 1-10 | 同 B2 | — |
| 11 | 实现 `hybrid` 模式：70% direct + 30% gap2 | `apk/src/modules/11-game-init.js` |
| 12 | 增加掉落统计：记录“词后短语命中率”到 localStorage | `apk/src/modules/11-game-init.js` |
| 13 | 在词卡展示中区分“短语 item”和“单词 item”的视觉样式 | `apk/src/modules/12-challenges.js` |

---

## 阶段 C：幼儿园词库审查与文档化（P1）

### 版本 C1：导出 + 人工审查（推荐）

| 步骤 | 内容 | 涉及文件 |
|------|------|----------|
| 1 | 运行导出: `npm run vocab:db:export` | `apk/tools/vocab-db/export.mjs` |
| 2 | 筛选幼儿园词条并输出 3 份 CSV 到 `apk/docs/development/游戏优化-0219/data/` | `apk/tools/vocab-db/*.mjs` |
| 3 | 人工审阅 CSV，标记需下架/迁移词条 | 人工 |
| 4 | 根据审阅结果批量更新词库 | `apk/words/vocabs/01_幼儿园/*.js` |

### 版本 C2：导出 + 自动分类 + 默认词库切换

| 步骤 | 内容 | 涉及文件 |
|------|------|----------|
| 1-4 | 同 C1 | — |
| 5 | 将句子型/战斗指令类词条迁移到小学或 Minecraft pack | `apk/words/vocabs/` |
| 6 | 修改默认词库为 `vocab.kindergarten.basic` | `apk/src/defaults.js` |
| 7 | 运行 `vocab:db:validate` 与 `vocab:db:dedup` 清理异常 | `apk/tools/vocab-db/validate.mjs`, `apk/tools/vocab-db/dedup.mjs` |

---

## 阶段 D：手工回归验证

| 步骤 | 内容 | 涉及文件 |
|------|------|----------|
| 1 | 手工回归：村庄触发与交互（休息屋/学习屋/存档石碑） | 浏览器 |
| 2 | 手工回归：词条掉落、词卡展示、挑战系统 | 浏览器 |
| 3 | 手工回归：词库切换、存档读档 | 浏览器 |
| 4 | 运行 E2E 回归命令确认无阻断问题 | `npm run test:e2e -- p0-render-path.spec.mjs p2-biome-config.spec.mjs p0-village-visibility.spec.mjs p0-village-quiz-stability.spec.mjs` |
| 5 | 提交并推送，触发 CI 构建 APK | git + GitHub Actions |

---

## 阶段 E：Playwright 触发测试与报告（强制）

目标: 用 Playwright 自动触发，并且必须证明“村庄已出现在画面里”。

### E0：E2E 当前现状快照（截至 2026-02-19）

- 专项用例现状:
  - `apk/tests/e2e/specs/p0-village-visibility.spec.mjs`
  - `apk/tests/e2e/specs/p0-village-quiz-stability.spec.mjs`
- 最近一次专项执行:  
  `npm run test:e2e -- p0-village-visibility.spec.mjs p0-village-quiz-stability.spec.mjs`
- 专项结果: 3 passed（村庄生成/可见 + 测验稳定性全部通过）。
- 证据产物:
  - `apk/test-results/evidence/village-visible-page.png`
  - `apk/test-results/evidence/village-visible-canvas.png`
- 最近一次“专项 + 基线”执行:  
  `npm run test:e2e -- p0-render-path.spec.mjs p2-biome-config.spec.mjs p0-village-visibility.spec.mjs p0-village-quiz-stability.spec.mjs`
- 回归结果: 6 passed / 0 failed。  
- 判定: “看到村庄出现”与“退出测验不再卡死”门槛均已满足，可继续后续阶段。

### 版本 E1：最小可验收（推荐先跑）

| Step | 执行内容 | 命令/产物 |
|------|----------|----------|
| 1 | 进入项目目录并安装依赖 | `cd apk` + `npm install` |
| 2 | 安装 Playwright 浏览器 | `npm run pw:install` |
| 3 | 执行村庄专项用例 | `npm run test:e2e -- p0-village-visibility.spec.mjs` |
| 4 | 校验通过标准 1：测试通过 | `P0 village should spawn...` 与 `P0 village should be visible...` 都 pass |
| 5 | 校验通过标准 2：截图证据存在 | `apk/test-results/evidence/village-visible-page.png`、`apk/test-results/evidence/village-visible-canvas.png` |
| 6 | 校验通过标准 3：报告可追溯 | Playwright HTML 报告位于 `apk/tests/e2e/test-results/playwright-report/` |

失败处理:
1. 执行有头模式复现: `npm run test:e2e:headed -- p0-village-visibility.spec.mjs`。
2. 查看 trace: `npx playwright show-trace <trace.zip 路径>`。
3. 若“spawn 通过但 visible 失败”，按失败截图判断是否真无村庄；无村庄即判失败，不可放行。

### 版本 E2：标准回归版（专项 + 基线）

| Step | 执行内容 | 命令/产物 |
|------|----------|----------|
| 1 | 运行村庄 + 基线用例集合 | `npm run test:e2e -- p0-render-path.spec.mjs p2-biome-config.spec.mjs p0-village-visibility.spec.mjs p0-village-quiz-stability.spec.mjs` |
| 2 | 记录每条用例结果（通过/失败） | 控制台 + HTML 报告 |
| 3 | 若失败，保存失败截图/视频/trace 路径到报告 | `apk/test-results/**` |

### 版本 E3：发布前严格版（含正式测试报告）

| Step | 执行内容 | 输出 |
|------|----------|------|
| 1 | 完整执行 E2 | 用例执行记录 |
| 2 | 生成正式测试报告文档 | `apk/docs/development/游戏优化-0219/游戏优化0219-Playwright测试报告.md` |
| 3 | 报告中必须包含环境、命令、结果表、截图路径、最终结论 | 发布前证据 |

---

## 阶段 F：村庄测验显示异常与退出卡死（P0）

问题描述（来自 `游戏优化0219.md`）:  
进入村庄后的单词测验环节，看不到完整单词，只看到字母，并出现 `undefined` 标志；退出后界面卡住，即便点暂停/恢复，短时间后仍会再次卡住。

### F0：根因分析（代码证据）

1. 根因 1（已修复）: 词源数据形态与题面渲染不一致  
说明: `getVillageWords()` 返回字符串数组，必须先归一化到 `{ en, zh, phrase, phraseTranslation }` 才能稳定渲染。  
证据:
- 字符串词源入口: `apk/src/modules/18-village.js:409`
- 新归一化函数: `resolveVillageChallengeWord()` in `apk/src/modules/12-village-challenges.js:103`

2. 根因 2（已修复）: modal 期间交互可重入，导致挑战流程叠加  
说明: 交互键与交互入口都必须阻断 `paused/pausedByModal` 状态。  
证据:
- 键盘入口增加拦截: `apk/src/modules/17-bootstrap.js:142`
- 场景交互入口增加早退: `apk/src/modules/13-game-loop.js:1163`
- 挑战会话互斥锁: `beginVillageChallengeSession()` in `apk/src/modules/12-village-challenges.js:87`

3. 根因 3（已修复）: 退出流程恢复不完整导致“伪恢复后再次冻结”  
说明: 退出必须统一走会话关闭并恢复暂停态，不能只隐藏 UI。  
证据:
- 会话关闭与状态恢复: `closeVillageChallengeSession()` in `apk/src/modules/12-village-challenges.js:69`
- 退出入口统一到取消函数: `cancelVillageChallenge()` in `apk/src/modules/12-village-challenges.js:81`

4. 根因 4（已修复）: 发音参数与短语字段兼容策略不统一  
说明: `speakWord` 需传对象；短语中文字段统一使用 `phraseTranslation`（兼容 `phraseZh` 旧数据）。  
证据:
- `speakWord({...})` 对象调用: `apk/src/modules/12-village-challenges.js:323`
- 挑战渲染兼容字段: `apk/src/modules/12-challenges.js:30`

### 版本 F1：最小修复（推荐）

| 步骤 | 内容 | 涉及文件 |
|------|------|----------|
| 1 | 复现场景并记录日志：进入村庄 -> 触发测验 -> 退出测验 -> 观察是否出现 `undefined` 与冻结 | `apk/src/modules/12-village-challenges.js`, `apk/src/modules/12-challenges.js`, `apk/src/modules/16-events.js` |
| 2 | 修复测验题面字段映射：统一使用 `word/phrase/phraseTranslation`，禁止使用不存在字段，所有渲染点增加空值兜底 | `apk/src/modules/12-village-challenges.js`, `apk/src/modules/12-challenges.js` |
| 3 | 修复退出流程状态机：退出测验时强制恢复 `paused`、`pausedByModal`、overlay/modal 可见状态，避免“伪恢复后再次锁死” | `apk/src/modules/12-village-challenges.js`, `apk/src/modules/10-ui.js`, `apk/src/modules/17-bootstrap.js` |
| 4 | 加入防御性保护：题目对象缺字段时显示可读降级文案并跳过异常题，不允许把 `undefined` 渲染到 UI | `apk/src/modules/12-village-challenges.js` |
| 5 | 手工回归：连续 5 次“进入测验->退出->继续跑图”不再出现卡住 | 手动测试 |

### 版本 F2：修复 + 自动化回归

| 步骤 | 内容 | 涉及文件 |
|------|------|----------|
| 1-5 | 同 F1 | — |
| 6 | 新增 Playwright 用例：触发村庄测验，断言题面文本不含 `undefined`，退出后 10 秒内角色位置持续变化（证明无冻结） | `apk/tests/e2e/specs/` 新增 `p0-village-quiz-stability.spec.mjs` |
| 7 | 将该用例加入 E2 回归集合 | `npm run test:e2e -- p0-render-path.spec.mjs p2-biome-config.spec.mjs p0-village-visibility.spec.mjs p0-village-quiz-stability.spec.mjs` |

验收标准:
1. 村庄测验界面显示完整题面，不出现 `undefined`。  
2. 退出测验后可持续操作，30 秒内不出现再次卡住。  
3. E2E 用例通过并留存报告/截图证据。

---

## Playwright 测试报告模板（写入 E3 报告）

1. 测试日期: `YYYY-MM-DD`  
2. 环境信息: Node 版本、Playwright 版本、浏览器项目（chromium）  
3. 执行命令: 逐条列出  
4. 结果表: 用例名 / 结果 / 耗时 / 备注  
5. 证据:
   - `apk/test-results/evidence/village-visible-page.png`
   - `apk/test-results/evidence/village-visible-canvas.png`
   - 失败时附 `trace.zip`、`video.webm` 路径
6. 结论: 是否满足“已看到村庄出现”的验收要求（并单列 P2 存量失败是否阻断）

---

## 风险与预案

| 风险 | 预案 |
|------|------|
| 村庄坐标修复后出现层级/遮挡问题 | 保留开关用于对照旧渲染分支 |
| 短语掉落导致黄圈文本过长影响可读性 | 增加短语渲染裁剪与词卡承载 |
| 词库清理影响已有学习进度映射 | 保持 `lemma_key` 稳定，迁移前导出映射表 |
| Playwright 只验证“生成”未验证“可见” | 强制执行 E1/E2/E3 的“截图证据 + 结论”链路 |

---

## 推荐执行路径

`A1（村庄坐标修复）→ E1（专项可见性）→ F1（测验显示与卡死修复）→ B1（Follow-up Queue）→ C1（词库导出审查）→ E2（回归）→ D（手工）→ E3（正式报告）`

每个阶段验证通过后再进入下一个，避免改动交叉。
