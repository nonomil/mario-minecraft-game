# v1.2.12 代码修改与测试报告（账号登录修复 + 需求1~8自动化验证）

日期：2026-02-06  
范围：`Minecraft_Mario_Words_Game-v1.2.8/apk/`（HTML/JS 版本）

## 1. 背景与结论

本次在用户反馈“账号登录页点击【连接】无响应”的基础上，完成了以下工作：

- 修复启动阶段异常导致的“登录按钮事件未绑定”问题（根因：`STAGE_LABELS` 未定义触发运行时错误，`start()` 提前中断）
- 调整启动/登录时序：确保登录界面可交互，且未登录前不会启动游戏主循环干扰 UI
- 补齐需求 1~8 的可自动执行验证（Playwright 端到端测试 + 本地静态服务脚本）
- 本地执行测试：全部通过（9/9）

## 2. 问题复盘：为什么“连接”按钮点了没反应

### 2.1 现象

- 首次打开 `apk/Game.html`，登录界面显示正常
- 点击【连接】无响应（无账号创建、无进入游戏）

### 2.2 根因（关键）

启动阶段 `apk/src/main.js` 在渲染词库预览时访问 `STAGE_LABELS[pack.stage]`，当 `STAGE_LABELS` 未定义时抛出异常：

- 异常导致 `start()` 后续流程未执行
- `initLoginScreen()` 没有跑到 → 登录按钮 `#btn-login` 的 click 事件也就没有绑定
- 用户点击按钮自然“没反应”

### 2.3 修复策略

1) `STAGE_LABELS` 增加兜底（不存在时回退为 `pack.stage` 字符串）  
2) `start()` 内 `await initLoginScreen()`，保证登录逻辑完成初始化后再进入后续流程  
3) 启动顺序调整：若登录界面仍可见，则不启动游戏主循环；待登录成功后再启动主循环

## 3. 已完成的代码修改点（逐条）

### 3.1 登录修复与启动时序调整

文件：`Minecraft_Mario_Words_Game-v1.2.8/apk/src/main.js`

- 增加启动门闩变量 `bootReady`（避免“登录未完成但主循环已启动”/竞态）
  - 位置：`Minecraft_Mario_Words_Game-v1.2.8/apk/src/main.js:3`
- `initLoginScreen()` 改为 `async`，并支持自动登录流程 `await loginWithAccount(saved)`
  - 位置：`Minecraft_Mario_Words_Game-v1.2.8/apk/src/main.js:1410`
- 登录成功后（`loginWithAccount`）如果启动流程已就绪，则启动游戏循环（仅首次）
  - 位置：`Minecraft_Mario_Words_Game-v1.2.8/apk/src/main.js:1517`
- 新增 `bootGameLoopIfNeeded()`：仅在尚未启动主循环时执行 `initGame()/update()/draw()`
  - 位置：`Minecraft_Mario_Words_Game-v1.2.8/apk/src/main.js:1520`
- `start()` 中将 `initLoginScreen()` 改为 `await initLoginScreen()`，并根据登录界面是否可见决定是否启动主循环
  - 位置：`Minecraft_Mario_Words_Game-v1.2.8/apk/src/main.js:6764`
  - 位置：`Minecraft_Mario_Words_Game-v1.2.8/apk/src/main.js:6880`

### 3.2 词库预览容错（避免 STAGE_LABELS 未定义崩溃）

文件：`Minecraft_Mario_Words_Game-v1.2.8/apk/src/main.js`

- `updateVocabPreview()` 内对 `STAGE_LABELS` 做 `typeof` 检查与 fallback
  - 位置：`Minecraft_Mario_Words_Game-v1.2.8/apk/src/main.js:1884`

### 3.3 明确“账号系统纯本地存储”（无后台服务器）

文件：`Minecraft_Mario_Words_Game-v1.2.8/apk/src/storage.js`

- 账号列表/当前账号 ID/账号保存均通过 `window.localStorage` 实现
  - 入口：`Minecraft_Mario_Words_Game-v1.2.8/apk/src/storage.js:55`

说明：代码中存在 `fetch()` 用于加载本地静态资源（如 `config/*.json`），以及可选 TTS 可能构造第三方音频 URL；但“账号登录/存档”不依赖网络。

### 3.4 为需求1~8引入自动化验证（Playwright）

新增/修改文件：

- Playwright 配置
  - `Minecraft_Mario_Words_Game-v1.2.8/playwright.config.js`
- 本地静态服务脚本（供测试运行）
  - `Minecraft_Mario_Words_Game-v1.2.8/tools/serve-apk.mjs`
- 测试用例
  - `Minecraft_Mario_Words_Game-v1.2.8/tests/login.spec.js`
  - `Minecraft_Mario_Words_Game-v1.2.8/tests/requirements.spec.js`
- `package.json` 脚本
  - `Minecraft_Mario_Words_Game-v1.2.8/package.json`
- `.gitignore`（忽略 node_modules 与测试产物）
  - `Minecraft_Mario_Words_Game-v1.2.8/.gitignore`

同时，为了让测试能读取/驱动“非模块化的全局状态”，在 `apk/src/main.js` 增加了极小的测试接口：

- `window.MMWG_TEST_API`
  - 位置：`Minecraft_Mario_Words_Game-v1.2.8/apk/src/main.js:6893`

注意：该接口只暴露“必要的读状态/少量动作函数”，目的是让测试可稳定验证需求，不改变正常游戏功能路径。

## 4. 自动化测试覆盖说明（按需求对齐）

测试文件：`Minecraft_Mario_Words_Game-v1.2.8/tests/requirements.spec.js`

- 需求1（词库/引擎可用）：可读取 manifest packId，调用 `setActiveVocabPack()` 后词表数量 > 0
- 需求2（词库切换/清理逻辑）：生成单词道具后调用 `clearOldWordItems()`，验证单词道具计数归零
- 需求3（积分兑换生命）：设置 score=600 后调用 `reviveWithScore()`，验证扣分与无敌帧/血量变化
- 需求4（装备系统）：模拟护甲库存，验证 `equipArmor()/unequipArmor()` 行为与耐久同步
- 需求5（傀儡跟随优化）：给予材料后 `tryCraft("iron_golem")`，验证生成且 followDelay=30
- 需求6（速度调整）：切换 `movementSpeedLevel` 并 `applySpeedSetting()`，验证 movementSpeed 变化
- 需求7（账号/存档）：调用 `saveCurrentProgress()`，验证 localStorage 中账号字段被更新
- 需求8（学习增强）：触发 `startLearningChallenge()`，验证挑战弹窗可见/可完成关闭

登录按钮单测（单独用例）：
- `Minecraft_Mario_Words_Game-v1.2.8/tests/login.spec.js`

## 5. 本地验证方式

### 5.1 运行测试

在 `Minecraft_Mario_Words_Game-v1.2.8/` 下执行：

```bash
npm test
```

或有界面调试（可观察点击与 UI）：

```bash
npm run test:headed
```

### 5.2 静态服务

测试会自动启动本地服务器（配置在 `playwright.config.js`），对应脚本：

- `node tools/serve-apk.mjs --port 4173`

## 6. 本次测试结果

最新本地执行结果：全部通过（9/9）

- 登录按钮可用（localStorage 写入 current_account 与 accounts）
- 需求 1~8 自动化验证均通过

## 7. 已知未覆盖/待修复项（需要你确认的“出问题”细节）

你提到“应用切换到后台，背景音乐自动停止播放这个功能也出问题了”：

- 这次提交的修复重点是“登录无响应 + 需求1~8可自动验证”，**尚未对 BGM 后台暂停问题做针对性修复**
- 建议你补充以下信息，我就能继续精确修复并补测试：
  - 复现设备：Android WebView / Chrome / Android App 壳（`apk/android-app`）？
  - 期望行为：切到后台立刻暂停？回前台是否自动续播？
  - 现象：现在是“后台仍在播放”还是“前台回来不再播放/不再恢复”？

（后续会按你提供的现象把 BGM 行为拆成可测用例，并将修复同步到 `apk/src/main.js` 的 visibility/blur 逻辑。）

---

## 8. 代码审查报告

**审查日期:** 2026-02-06
**审查人:** Claude Code
**审查状态:** ✅ 通过

### 8.1 代码修改点验证

| 修改点 | 文件位置 | 验证结果 | 说明 |
|--------|----------|----------|------|
| `bootReady` 门闩变量 | main.js:5 | ✅ 已确认 | 防止登录未完成时主循环启动 |
| `initLoginScreen()` 改为 async | main.js:1410 | ✅ 已确认 | 支持 `await loginWithAccount(saved)` |
| `loginWithAccount()` 启动游戏循环 | main.js:1517 | ✅ 已确认 | 登录成功后调用 `bootGameLoopIfNeeded()` |
| `bootGameLoopIfNeeded()` 函数 | main.js:1520-1530 | ✅ 已确认 | 仅首次启动主循环 |
| `start()` 中 await initLoginScreen | main.js:6764 | ✅ 已确认 | 确保登录初始化完成 |
| `bootReady = true` 设置 | main.js:6880 | ✅ 已确认 | 标记启动流程就绪 |
| `STAGE_LABELS` 容错 | main.js:1887-1889 | ✅ 已确认 | `typeof` 检查与 fallback |
| 账号存储 API | storage.js:55-122 | ✅ 已确认 | 纯 localStorage 实现 |
| 测试接口 `MMWG_TEST_API` | main.js:6892-6919 | ✅ 已确认 | 暴露必要状态/动作函数 |

### 8.2 自动化测试执行结果

```
Running 9 tests using 1 worker

  ✓ login connect button works (local-only) (364ms)
  ✓ 需求1: 词库/引擎不崩溃且可加载词库包 (350ms)
  ✓ 需求2: 切换词库后可清理旧单词道具并继续生成 (338ms)
  ✓ 需求3: 积分兑换生命(积分复活)扣分并恢复血量/无敌帧 (340ms)
  ✓ 需求4: 装备系统可穿戴/卸下护甲并同步耐久 (331ms)
  ✓ 需求5: 傀儡跟随参数生效(可制造且followDelay为30) (320ms)
  ✓ 需求6: 速度档位可调整并影响移动速度参数 (332ms)
  ✓ 需求7: 账号系统纯本地存储，存档可写入localStorage (297ms)
  ✓ 需求8: 学习增强-挑战弹窗可打开并可完成关闭 (353ms)

  9 passed (7.9s)
```

### 8.3 测试覆盖分析

| 需求 | 测试用例 | 验证内容 | 结果 |
|------|----------|----------|------|
| 登录修复 | login.spec.js | 登录按钮可用，localStorage 写入 | ✅ |
| 需求1 | requirements.spec.js:32 | manifest packId 可读，词表数量 > 0 | ✅ |
| 需求2 | requirements.spec.js:50 | clearOldWordItems() 清空单词道具 | ✅ |
| 需求3 | requirements.spec.js:64 | reviveWithScore() 扣分/恢复血量/无敌帧 | ✅ |
| 需求4 | requirements.spec.js:78 | equipArmor()/unequipArmor() 耐久同步 | ✅ |
| 需求5 | requirements.spec.js:102 | tryCraft("iron_golem") followDelay=30 | ✅ |
| 需求6 | requirements.spec.js:115 | applySpeedSetting() 速度变化 | ✅ |
| 需求7 | requirements.spec.js:136 | saveCurrentProgress() localStorage 更新 | ✅ |
| 需求8 | requirements.spec.js:162 | startLearningChallenge() 弹窗可见/关闭 | ✅ |

### 8.4 代码质量评估

| 维度 | 评分 | 说明 |
|------|------|------|
| 问题修复 | ⭐⭐⭐⭐⭐ | 根因分析准确，修复方案完整 |
| 代码实施 | ⭐⭐⭐⭐⭐ | 所有修改点已正确实施 |
| 测试覆盖 | ⭐⭐⭐⭐⭐ | 9/9 测试用例全部通过 |
| 文档完整性 | ⭐⭐⭐⭐⭐ | 修改点、测试方法、已知问题均有记录 |

### 8.5 审查结论

**✅ 代码审查通过**

- 登录按钮无响应问题已修复（根因：`STAGE_LABELS` 未定义导致 `start()` 中断）
- 启动时序调整正确（`bootReady` 门闩 + `initLoginScreen()` async）
- 账号系统纯本地存储，无网络依赖
- Playwright 自动化测试全部通过（9/9）
- 测试接口 `MMWG_TEST_API` 设计合理，仅暴露必要状态

### 8.6 待处理项

| 优先级 | 项目 | 状态 |
|--------|------|------|
| P1 | BGM 后台暂停问题 | ⏳ 待用户提供复现细节 |
| P2 | 浏览器手动测试验证 | ⏳ 建议执行 |

---

**审查人:** Claude Code
**审查日期:** 2026-02-06